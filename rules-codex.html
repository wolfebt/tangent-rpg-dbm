<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangent SFF RPG - Rules Codex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Quill Table Module -->
    <script src="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.min.js"></script>

    <style>
        /* --- Global Theme --- */
        :root {
            --bg-main: #212121;
            --bg-section: #333333;
            --bg-header: #1f2937;
            --bg-input: #424242;
            --bg-input-focus: #616161;
            --bg-hover: #4f4f4f;
            --bg-danger: #b71c1c;
            --bg-danger-hover: #d32f2f;
            
            --text-light: #f5f5f5;
            --text-dark: #212121;
            --text-subtle: #9e9e9e;
            
            --border-main: #9e9e9e;
            --border-subtle: #616161;
            --border-focus: #f5f5f5;

            --btn-primary-bg: #4f4f4f;
            --btn-primary-border: #9e9e9e;
            --btn-primary-hover-bg: #616161;
            --btn-primary-hover-border: #f5f5f5;

            --btn-danger-bg: #b71c1c;
            --btn-danger-border: #9e9e9e;
            --btn-danger-hover-bg: #d32f2f;
            --btn-danger-hover-border: #f5f5f5;
            
            --font-body: 'Trebuchet MS', sans-serif;
            --font-display: 'Trebuchet MS', sans-serif;

            --header-height: 4rem; 
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-section);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--bg-input-focus);
            border-radius: 6px;
            border: 3px solid var(--bg-section);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--border-main);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-light);
            font-family: var(--font-body);
            display: flex;
            flex-direction: column; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Layout --- */
         .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            z-index: 40;
            background-color: var(--bg-header);
            border-bottom: 2px solid var(--border-subtle);
            padding: 0.5rem 1rem;
        }

        .app-container {
            display: flex;
            flex-grow: 1;
            padding-top: var(--header-height);
        }

        main#main-content {
            flex-grow: 1;
            padding: 0;
            overflow-y: auto;
        }

        /* --- Global Components --- */
        .app-header h1 {
            font-family: var(--font-display);
        }

        .modal-backdrop {
            background-color: rgba(0,0,0,0.75);
        }
        .modal-content {
            background-color: var(--bg-section);
            border: 2px solid var(--border-main);
        }
        .modal-content h2 {
            font-family: var(--font-display);
            text-transform: uppercase;
        }
        
        .global-form-label {
            color: var(--text-subtle);
            text-transform: uppercase;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        .global-form-input {
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            color: var(--text-light);
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }
        .global-form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            background-color: var(--bg-input-focus);
        }
        .global-form-input.display-only-input {
            background-color: var(--bg-header);
            cursor: default;
            border-color: var(--border-subtle);
        }
        .global-form-input.display-only-input:focus {
            background-color: var(--bg-header);
            border-color: var(--border-subtle);
        }

        .wiki-link {
            color: #63b3ed;
            text-decoration: underline;
            cursor: pointer;
        }
        .wiki-link:hover {
            color: #90cdf4;
        }

        /* --- Content-Specific Styles --- */
        .wiki-content h2 {
            font-family: var(--font-display);
            font-size: 2.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-light);
            text-transform: uppercase;
            text-align: center;
            border-bottom: 2px solid var(--border-subtle);
            padding-bottom: 0.75rem;
        }
        .wiki-content h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--text-light);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 0.5rem;
        }
        .wiki-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: var(--text-light);
        }

        .btn {
            font-family: var(--font-body);
            font-weight: bold;
            padding: 0.75rem 1rem;
            border: 2px solid;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-shadow: 1px 1px 2px #000;
            text-transform: uppercase;
        }
        .btn:hover { text-shadow: none; }
        
        .btn-primary {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-border);
            color: var(--text-light);
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg);
            border-color: var(--btn-primary-hover-border);
        }
        .btn-danger {
            background-color: var(--bg-danger);
            border-color: var(--btn-danger-border);
            color: var(--text-light);
        }
        .btn-danger:hover {
            background-color: var(--bg-danger-hover);
            border-color: var(--btn-danger-hover-border);
        }
        .btn-secondary {
            background-color: var(--bg-section);
            border-color: var(--text-subtle);
            color: var(--text-light);
        }
        .btn-secondary:hover {
            background-color: var(--bg-hover);
            border-color: var(--border-focus);
        }

        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #6b7280; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .file-menu {
            position: relative;
            display: inline-block;
        }
        .file-menu-button {
             background-color: var(--bg-section);
            border: 2px solid var(--border-main);
            transition: all 0.2s ease;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }
        .file-menu-button:hover {
            border-color: var(--border-focus);
            background-color: var(--bg-hover);
        }
        .file-menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--bg-section);
            min-width: 160px;
            border: 2px solid var(--border-main);
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 101; /* Ensure dropdown is on top */
            border-radius: 5px;
            padding: 0.5rem 0;
        }
        .file-menu-dropdown.show {
            display: block;
        }
        .file-menu-dropdown button {
            color: var(--text-light);
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .file-menu-dropdown button:hover {
            background-color: var(--bg-hover);
        }

        #modal-data-dropdown {
            left: 0;
            right: auto;
        }

        /* Quill Dark Theme Overrides */
        .ql-toolbar {
            background-color: var(--bg-header);
            border: 1px solid var(--border-main) !important;
            border-bottom: none !important;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }
        .ql-container.ql-snow {
            border: 1px solid var(--border-main) !important;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            background-color: var(--bg-input);
            color: var(--text-light);
            font-family: var(--font-body);
        }
        .ql-editor {
            min-height: 120px;
        }
        .ql-editor.ql-blank::before {
            color: var(--text-subtle);
            font-style: normal;
        }
        .ql-snow .ql-stroke {
            stroke: var(--text-subtle);
        }
        .ql-snow .ql-fill, .ql-snow .ql-stroke.ql-fill {
            fill: var(--text-subtle);
        }
        .ql-snow.ql-toolbar button:hover .ql-stroke,
        .ql-snow .ql-toolbar button:hover .ql-stroke,
        .ql-snow.ql-toolbar button.ql-active .ql-stroke,
        .ql-snow .ql-toolbar button.ql-active .ql-stroke,
        .ql-snow .ql-toolbar button.ql-table:hover .ql-stroke {
            stroke: var(--text-light);
        }
        .ql-snow.ql-toolbar button:hover .ql-fill,
        .ql-snow .ql-toolbar button:hover .ql-fill,
        .ql-snow.ql-toolbar button.ql-active .ql-fill,
        .ql-snow .ql-toolbar button.ql-active .ql-fill {
            fill: var(--text-light);
        }
        .ql-snow .ql-picker-options {
            background-color: var(--bg-section);
            border-color: var(--border-main) !important;
        }
        .ql-snow .ql-picker-item:hover, .ql-snow .ql-picker-label:hover {
            color: var(--text-light);
        }
        .ql-snow .ql-picker-item.ql-selected {
            color: var(--text-light);
        }
        .ql-snow .ql-tooltip {
            background-color: var(--bg-section);
            border: 1px solid var(--border-main);
            box-shadow: none;
            color: var(--text-light);
        }
        .ql-snow .ql-tooltip input[type=text] {
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            color: var(--text-light);
        }
        .ql-snow .ql-tooltip a.ql-action::after {
            border-radius: 0.25rem;
            background-color: var(--btn-primary-bg);
            color: var(--text-light);
            padding: 4px 8px;
        }
        .ql-snow .ql-picker.ql-color .ql-picker-item {
            width: 20px;
            height: 20px;
            padding: 2px;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
        }
        .ql-snow .ql-picker.ql-color .ql-picker-item.ql-selected {
            border-color: var(--border-focus);
        }
        
        /* Table Styles for Quill */
        .ql-snow .ql-table-picker .ql-picker-item {
            border-color: var(--text-subtle) !important;
        }
        .ql-snow .ql-table-picker .ql-picker-item:hover {
            border-color: var(--text-light) !important;
        }
        .ql-snow .ql-table-col-tool .ql-picker-item,
        .ql-snow .ql-table-row-tool .ql-picker-item {
            background-color: var(--bg-section);
        }
        .ql-snow .ql-table-col-tool .ql-picker-item:hover,
        .ql-snow .ql-table-row-tool .ql-picker-item:hover {
            background-color: var(--bg-hover);
        }


        /* Prose & Editor Table Styles */
        .prose table, .ql-editor table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .prose th, .prose td, .ql-editor th, .ql-editor td {
            border: 1px solid var(--border-subtle);
            padding: 0.5rem;
            text-align: left;
        }
        .prose th, .ql-editor th {
            background-color: var(--bg-section);
            font-weight: bold;
            color: var(--text-light);
        }
        
        /* Prose styles for rendered Quill content */
        .prose { color: var(--text-light); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose strong { color: var(--text-light); }
        .prose a { color: #63b3ed; }
        .prose a:hover { color: #90cdf4; }
        .prose blockquote { color: var(--text-subtle); border-left-color: var(--border-main); }
        .prose code { background-color: var(--bg-header); color: #a5f3fc; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-weight: bold; }
        .prose thead { border-bottom-color: var(--border-main); }
        .prose tbody tr { border-bottom-color: var(--border-subtle); }
        .prose ul > li::before { background-color: var(--text-subtle); }

    </style>
</head>
<body>
    <!-- App Header: Contains navigation and authentication controls -->
    <header class="app-header flex justify-between items-center gap-4"></header>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Main Content Area: Loaded dynamically based on navigation -->
        <main id="main-content"></main>
    </div>

    <!-- Settings Icon -->
    <button id="settings-icon" class="fixed bottom-4 left-4 p-2 bg-gray-700 rounded-full hover:bg-gray-600 transition-colors z-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    </button>

    <!-- Settings Modal: For API Key input -->
    <div id="settings-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-lg p-8">
            <h2 class="text-2xl font-bold mb-6 text-center">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="global-form-label">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="global-form-input" placeholder="Enter your API key">
                    <p class="text-xs text-gray-400 mt-2">Your API key is stored securely in your browser's local storage and is never sent to our servers.</p>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="settings-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="settings-save-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Main Entry Modal: For viewing and editing all data entries -->
    <div id="entry-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-3/4 max-w-6xl max-h-[90vh] overflow-y-auto flex flex-col relative">
             <button id="modal-explicit-close-btn" class="absolute top-2 right-2 btn btn-secondary !p-2 z-10">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                     <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                 </svg>
            </button>
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex-1 flex justify-start">
                        <div class="file-menu">
                            <button id="modal-data-btn" class="file-menu-button">DATA</button>
                            <div id="modal-data-dropdown" class="file-menu-dropdown"></div>
                        </div>
                    </div>
                    <div class="flex-none">
                        <h2 id="modal-title" class="text-2xl font-bold">Manage Entry</h2>
                    </div>
                    <div class="flex-1"></div>
                </div>
                <form id="entry-form">
                    <div id="form-fields" class="space-y-6">
                        <!-- Form fields are dynamically generated here -->
                    </div>
                    <div id="creator-info" class="text-xs text-gray-500 mt-4 text-right"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-8">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="btn btn-secondary">CANCEL</button>
                <button id="confirm-ok-btn" class="btn btn-danger">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Unsaved Changes Modal -->
    <div id="unsaved-changes-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-lg p-8">
            <h2 class="text-xl font-bold mb-4">Unsaved Changes</h2>
            <p class="text-gray-400 mb-6">You have unsaved changes. Do you want to save them before continuing?</p>
            <div class="flex justify-end gap-3">
                <button id="unsaved-cancel-btn" class="btn btn-secondary">CANCEL</button>
                <button id="unsaved-dismiss-btn" class="btn btn-danger">DISMISS CHANGES</button>
                <button id="unsaved-save-btn" class="btn btn-primary">SAVE & CONTINUE</button>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-8">
            <h2 class="text-xl font-bold mb-4 text-red-500">Error</h2>
            <p id="error-message" class="text-gray-400 mb-6">Something went wrong.</p>
            <div class="flex justify-end">
                <button id="error-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signOut, 
            GoogleAuthProvider, signInWithPopup,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, getDocs, getDoc, setDoc, query } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Register Quill Modules ---
        // This is done once globally to prevent re-registration errors.
        if (!Quill.imports['modules/better-table']) {
            Quill.register({ 'modules/better-table': quillBetterTable }, true);
        }

        // --- Firebase Configuration ---
        // This will be replaced by the environment variable in a production environment.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBA1CC4SXXtWM9UpU1XkAiBFr0RIgrPwGk", // Fallback for local testing
                authDomain: "tangent-rpg-dbm.firebaseapp.com",
                projectId: "tangent-rpg-dbm",
                storageBucket: "tangent-rpg-dbm.appspot.com",
                messagingSenderId: "559983787369",
                appId: "1:559983787369:web:d6f3b87daaa82b23d211f8",
                measurementId: "G-G6NC09PXPC"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Application State ---
        const appState = {
            userId: null,
            isAnonymous: true,
            userRole: 'guest',
            authReady: false,
            editingDocId: null,
            confirmCallback: null,
            initialFormState: null,
            pendingAction: null,
            wikiEntries: [],
            currentWikiEntryId: null,
            activeListeners: {},
            isSigningIn: false, 
        };
        
        // --- Role-Based Access Control (RBAC) ---
        const OWNER_UID = "09bdwApxw5UZ9BQTo7LXXdSsqx13"; // Replace with the actual owner's UID

        function hasPermission(action, itemData = null) {
            const { userRole, userId } = appState;
            switch (action) {
                case 'create':
                    return userRole === 'owner' || userRole === 'admin' || userRole === 'contributor';
                case 'edit':
                case 'delete':
                    if (userRole === 'owner' || userRole === 'admin') return true;
                    if (userRole === 'contributor') return itemData && itemData.creatorId === userId;
                    return false;
                default:
                    return false;
            }
        }

        const categoryConfig = {
            rules_codex: {
                label: 'RULES CODEX',
                fields: {
                    name: { type: 'text', required: true },
                    description: { type: 'textarea', aiEnabled: true },
                    mechanic: { type: 'textarea' },
                    note: { type: 'textarea' },
                    guide: { type: 'textarea' },
                    parent: { type: 'select', source: 'rules_codex', label: 'Parent Entry' },
                    order: { type: 'number', label: 'Order', default: 0 },
                }
            }
        };

        // --- UI Element References ---
        const mainContentContainer = document.getElementById('main-content');
        const entryModal = document.getElementById('entry-modal');
        const modalTitle = document.getElementById('modal-title');
        const entryForm = document.getElementById('entry-form');
        const formFieldsContainer = document.getElementById('form-fields');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const unsavedChangesModal = document.getElementById('unsaved-changes-modal');
        const unsavedCancelBtn = document.getElementById('unsaved-cancel-btn');
        const unsavedDismissBtn = document.getElementById('unsaved-dismiss-btn');
        const unsavedSaveBtn = document.getElementById('unsaved-save-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const errorOkBtn = document.getElementById('error-ok-btn');
        const settingsIcon = document.getElementById('settings-icon');
        const settingsModal = document.getElementById('settings-modal');
        const settingsSaveBtn = document.getElementById('settings-save-btn');
        const settingsCancelBtn = document.getElementById('settings-cancel-btn');
        const apiKeyInput = document.getElementById('api-key-input');

        // --- Authentication & UI Updates ---
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                showError("Could not sign in with Google. Please try again.");
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                showError("An error occurred while signing out.");
            }
        }

        function updateUIAfterAuthChange() {
            const authContainer = document.getElementById('auth-container');
            const userIdDisplay = document.getElementById('userIdDisplay');

            if (authContainer) {
                authContainer.innerHTML = appState.isAnonymous
                    ? `<button id="login-btn" class="btn btn-primary !py-1 !px-3">LOGIN</button>`
                    : `<button id="logout-btn" class="btn btn-secondary !py-1 !px-3">LOGOUT</button>`;
                if (appState.isAnonymous) {
                    document.getElementById('login-btn').addEventListener('click', handleLogin);
                } else {
                    document.getElementById('logout-btn').addEventListener('click', handleLogout);
                }
            }
            
            if(userIdDisplay) {
                 userIdDisplay.textContent = appState.isAnonymous ? 'ANONYMOUS' : (auth.currentUser?.email || appState.userId);
            }

            const authRequiredElements = document.querySelectorAll('.auth-required');
            authRequiredElements.forEach(el => {
                el.classList.toggle('hidden', !hasPermission('create'));
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                appState.userId = user.uid;
                appState.isAnonymous = user.isAnonymous;

                if (user.isAnonymous) {
                    appState.userRole = 'guest';
                } else if (user.uid === OWNER_UID) {
                    appState.userRole = 'owner';
                } else {
                    const roleDocRef = doc(db, "user_roles", user.uid);
                    try {
                        const roleDoc = await getDoc(roleDocRef);
                        appState.userRole = (roleDoc.exists() && roleDoc.data().role) ? roleDoc.data().role : 'contributor';
                        if (!roleDoc.exists()) {
                            await setDoc(roleDocRef, { role: 'contributor', email: user.email });
                        }
                    } catch (e) {
                        appState.userRole = 'contributor';
                    }
                }
                
                if (!appState.authReady) {
                    appState.authReady = true;
                    renderAppHeader();
                    renderWikiView();
                }
                updateUIAfterAuthChange();
            } else {
                appState.isAnonymous = true;
                appState.userId = null;
                appState.userRole = 'guest';
                
                if (appState.isSigningIn) return; 
                appState.isSigningIn = true;

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (err) {
                    console.error("Sign-in error:", err);
                    showError("Your session has ended. Please refresh the page.");
                } finally {
                    appState.isSigningIn = false;
                }
            }
        });
        
        // --- View Rendering ---
        function renderAppHeader() {
            const headerContainer = document.querySelector('.app-header');
            headerContainer.innerHTML = `
                <div class="flex-1"></div>
                <div class="flex-grow flex justify-center items-center">
                    <div class="text-center">
                        <h1 class="text-xl font-bold text-gray-100 whitespace-nowrap">TANGENT SFF RPG</h1>
                        <p class="text-xs text-gray-400 uppercase">RULES CODEX</p>
                    </div>
                </div>
                <div class="flex-1 flex justify-end items-center gap-4">
                    <div class="text-right">
                        <p class="text-xs text-gray-500">USER:</p>
                        <p id="userIdDisplay" class="text-sm font-semibold"></p>
                    </div>
                    <div id="auth-container"></div>
                </div>
            `;
            updateUIAfterAuthChange();
        }

        function renderWikiView() {
            mainContentContainer.innerHTML = `
                <div class="flex" style="height: calc(100vh - var(--header-height));">
                    <div id="wiki-directory-main" class="w-80 flex-shrink-0 bg-gray-800 p-4 overflow-y-auto border-r-2 border-gray-700">
                        <button id="add-wiki-entry-btn" class="btn btn-primary w-full mb-4 auth-required hidden">Add New Entry</button>
                        <ul id="wiki-directory-list"></ul>
                    </div>
                    <div class="flex-grow p-6 overflow-y-auto">
                        <div class="wiki-content prose prose-invert max-w-none" id="wiki-content-main">
                            <div class="flex justify-end gap-2 mb-4">
                                <button id="wiki-edit-btn" class="btn btn-secondary auth-required hidden">Edit</button>
                            </div>
                            <h2 id="wiki-entry-title">Select an Entry</h2>
                            <div id="wiki-entry-body"><p class="text-gray-400">Please select an entry from the directory on the left.</p></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('add-wiki-entry-btn').addEventListener('click', () => openModal(null, {}, true));
            document.getElementById('wiki-edit-btn').addEventListener('click', () => {
                if (appState.currentWikiEntryId) {
                    const entry = appState.wikiEntries.find(e => e.id === appState.currentWikiEntryId);
                    if (entry) openModal(entry.id, entry, true);
                }
            });
            listenForWikiEntries();
            updateUIAfterAuthChange();
        }

        // --- Data Handling & Firestore ---
        let rulesCodexMap = new Map();

        function listenForWikiEntries() {
            const collectionPath = `artifacts/${appId}/public/data/rules_codex`;
            const q = query(collection(db, collectionPath));
            
            if (appState.activeListeners['rules_codex']) appState.activeListeners['rules_codex']();

            appState.activeListeners['rules_codex'] = onSnapshot(q, (snapshot) => {
                appState.wikiEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rulesCodexMap.clear();
                appState.wikiEntries.forEach(entry => rulesCodexMap.set(entry.name, entry.id));

                const wikiDirectory = document.getElementById('wiki-directory-list');
                if (wikiDirectory) {
                    renderWikiDirectory(wikiDirectory, appState.wikiEntries, null);
                    if (appState.currentWikiEntryId && appState.wikiEntries.some(e => e.id === appState.currentWikiEntryId)) {
                        displayWikiEntry(appState.currentWikiEntryId);
                    }
                }
            }, error => {
                showError("Failed to load wiki entries.");
            });
        }
        
        async function renderWikiDirectory(container, entries, parent = null, level = 0) {
            if (!container) return;
            const ul = document.createElement('ul');
            ul.className = `space-y-1 ${level > 0 ? 'pl-4' : ''}`;

            const children = entries.filter(entry => (entry.parent || null) === parent).sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            for (const entry of children) {
                const li = document.createElement('li');
                const hasChildren = entries.some(e => e.parent === entry.name);

                const itemContent = document.createElement('div');
                itemContent.className = 'flex items-center text-sm';

                let toggleBtnHtml = `<span class="w-6"></span>`;
                if (hasChildren) {
                    toggleBtnHtml = `<button class="toggle-btn w-6 text-center" data-toggle-id="${entry.id}">▾</button>`;
                }

                itemContent.innerHTML = `
                    ${toggleBtnHtml}
                    <a href="#" class="flex-grow p-1 rounded hover:bg-gray-700" data-entry-id="${entry.id}">${entry.name}</a>
                `;
                li.appendChild(itemContent);

                if (hasChildren) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.id = `children-${entry.id}`;
                    childrenContainer.style.display = 'block';
                    await renderWikiDirectory(childrenContainer, entries, entry.name, level + 1);
                    li.appendChild(childrenContainer);

                    const toggleButton = itemContent.querySelector('.toggle-btn');
                    toggleButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isHidden = childrenContainer.style.display === 'none';
                        childrenContainer.style.display = isHidden ? 'block' : 'none';
                        toggleButton.innerHTML = isHidden ? '▸' : '▾';
                    });
                }

                const link = itemContent.querySelector('a');
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    displayWikiEntry(entry.id);
                });

                ul.appendChild(li);
            }
            container.innerHTML = '';
            container.appendChild(ul);
        }

        async function displayWikiEntry(docId) {
            const wikiTitle = document.getElementById('wiki-entry-title');
            const wikiBody = document.getElementById('wiki-entry-body');
            const wikiEditBtn = document.getElementById('wiki-edit-btn');

            if(!wikiTitle || !wikiBody) return;

            wikiTitle.textContent = 'Loading...';
            wikiBody.innerHTML = '<p class="text-center text-gray-400">Loading entry...</p>';
            if(wikiEditBtn) wikiEditBtn.classList.add('hidden');
            appState.currentWikiEntryId = null;

            try {
                const entry = appState.wikiEntries.find(e => e.id === docId);

                if (entry) {
                    wikiTitle.textContent = entry.name.toUpperCase();
                    let contentHtml = '';

                    if (entry.description) contentHtml += parseWikiLinks(entry.description);
                    if (entry.mechanic) contentHtml += `<h3>Mechanics</h3>` + parseWikiLinks(entry.mechanic);
                    if (entry.guide) contentHtml += `<h3>Guide</h3>` + parseWikiLinks(entry.guide);
                    if (entry.note) contentHtml += `<h3>Notes</h3>` + parseWikiLinks(entry.note);
                    
                    if (!contentHtml) contentHtml = '<p class="text-gray-400">No content available for this entry.</p>';
                    
                    wikiBody.innerHTML = contentHtml;
                    appState.currentWikiEntryId = docId;

                    if (hasPermission('edit', entry)) {
                        if(wikiEditBtn) wikiEditBtn.classList.remove('hidden');
                    }

                } else {
                    wikiTitle.textContent = 'Entry Not Found';
                    wikiBody.innerHTML = '<p class="text-red-400">The requested wiki entry could not be found.</p>';
                }
            } catch (error) {
                showError("Failed to display wiki entry.");
            }
        }
        
        function getFormDataObject(formElement) {
            const form = formElement || document.getElementById('entry-form');
            if (!form) return {};
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (!Array.isArray(data[key])) data[key] = [data[key]];
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }
            return data;
        }
        
        function getFormState(form) {
            return JSON.stringify(getFormDataObject(form));
        }

        function isFormDirty() {
            if (!entryModal || entryModal.classList.contains('hidden')) return false;
            return appState.initialFormState !== getFormState(document.getElementById('entry-form'));
        }

        async function createFormFieldHtml(fieldKey, fieldConfig, savedValue, isEditMode) {
            const labelText = (fieldConfig.label || fieldKey.replace(/_/g, ' ')).toUpperCase();
            let labelHtml = `<label for="${fieldKey}" class="global-form-label">${labelText}</label>`;

            if (isEditMode && fieldConfig.aiEnabled) {
                labelHtml = `<div class="flex justify-between items-center">
                                    <label for="${fieldKey}" class="global-form-label">${labelText}</label>
                                    <button type="button" id="generate-description-btn" class="flex items-center gap-1.5 text-xs text-gray-400 hover:text-white transition-colors underline auth-required hidden">
                                        GENERATE
                                    </button>
                                 </div>`;
            }

            let fieldHtml = '';
            if (fieldConfig.type === 'textarea') {
                fieldHtml = isEditMode 
                    ? `<div id="editor-${fieldKey}" class="quill-editor-container"></div><input type="hidden" id="${fieldKey}" name="${fieldKey}">`
                    : `<div class="global-form-input display-only-input p-2 overflow-auto prose prose-invert max-w-none">${parseWikiLinks(savedValue || '')}</div>`;
            } else if (fieldConfig.type === 'select') {
                const options = appState.wikiEntries
                    .filter(entry => entry.id !== appState.editingDocId)
                    .map(entry => `<option value="${entry.name}" ${savedValue === entry.name ? 'selected' : ''}>${entry.name.toUpperCase()}</option>`).join('');
                fieldHtml = isEditMode
                    ? `<select id="${fieldKey}" name="${fieldKey}" class="global-form-input form-select-arrow"><option value="">--CHOOSE--</option>${options}</select>`
                    : `<div class="global-form-input display-only-input">${(savedValue || '').toUpperCase()}</div>`;
            } else if (fieldConfig.type === 'number') {
                 fieldHtml = `<input type="number" id="${fieldKey}" name="${fieldKey}" value="${savedValue || 0}" class="global-form-input ${!isEditMode ? 'display-only-input' : ''}" ${!isEditMode ? 'readonly' : ''}>`;
            } else {
                fieldHtml = `<input type="text" id="${fieldKey}" name="${fieldKey}" value="${savedValue || ''}" class="global-form-input ${!isEditMode ? 'display-only-input' : ''}" ${!isEditMode ? 'readonly' : ''}>`;
            }

            return `<div>${labelHtml}${fieldHtml}</div>`;
        }

        async function populateModal(docId = null, data = {}, isEditMode = false) {
            const finalEditMode = hasPermission('edit', data) && isEditMode;
            appState.editingDocId = docId;
            
            modalTitle.textContent = `${finalEditMode ? 'MANAGE' : 'VIEW'} WIKI ENTRY`;
            
            const config = categoryConfig.rules_codex;
            const formHtml = await Promise.all(Object.keys(config.fields).map(async (fieldKey) => {
                const fieldConfig = config.fields[fieldKey];
                const savedValue = data[fieldKey];
                return createFormFieldHtml(fieldKey, fieldConfig, savedValue, finalEditMode);
            }));

            formFieldsContainer.innerHTML = formHtml.join('');

            if (finalEditMode) {
                const editorContainers = formFieldsContainer.querySelectorAll('.quill-editor-container');
                editorContainers.forEach(container => {
                    const fieldKey = container.id.replace('editor-', '');
                    const hiddenInput = document.getElementById(fieldKey);
                    const quill = new Quill(container, {
                        modules: { 
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'link'],
                                [{ 'color': [] }],
                                ['table']
                            ],
                            table: false,
                            "better-table": {
                                operationMenu: {
                                    items: {
                                        unmergeCells: { text: 'Unmerge cells' },
                                        mergeCells: { text: 'Merge cells' },
                                        deleteRow: { text: 'Delete row' },
                                        deleteColumn: { text: 'Delete column' },
                                        insertRowAbove: { text: 'Insert row above' },
                                        insertRowBelow: { text: 'Insert row below' },
                                        insertColumnLeft: { text: 'Insert column left' },
                                        insertColumnRight: { text: 'Insert column right' },
                                    },
                                    color: {
                                        colors: ['#fff', '#000', '#d1d5db', '#4b5563', '#b91c1c', '#15803d', '#1d4ed8'],
                                        text: 'Background Colors'
                                    }
                                },
                            },
                            keyboard: {
                                bindings: quillBetterTable.keyboardBindings
                            }
                        },
                        theme: 'snow'
                    });
                    quill.root.innerHTML = data[fieldKey] || '';
                    hiddenInput.value = data[fieldKey] || '';
                    quill.on('text-change', () => { hiddenInput.value = quill.root.innerHTML; });
                    container.quill = quill;
                });
            }

            const creatorInfo = document.getElementById('creator-info');
            creatorInfo.textContent = data.creatorEmail ? `Created by: ${data.creatorEmail}` : '';
            creatorInfo.classList.toggle('hidden', !data.creatorEmail);
            
            const modalDataDropdown = document.getElementById('modal-data-dropdown');
            modalDataDropdown.innerHTML = '';

            if (finalEditMode) {
                modalDataDropdown.innerHTML += `<button type="submit" form="entry-form">Save</button>`;
            } else if (hasPermission('edit', data)) {
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => populateModal(docId, data, true));
                modalDataDropdown.appendChild(editButton);
            }

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.addEventListener('click', () => {
                if (isFormDirty()) {
                    appState.pendingAction = () => closeModal();
                    unsavedChangesModal.classList.remove('hidden');
                } else {
                    closeModal();
                }
            });
            modalDataDropdown.appendChild(cancelButton);

            if (docId && hasPermission('delete', data)) {
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-red-400 hover:bg-red-800';
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deleteEntry(docId));
                modalDataDropdown.appendChild(deleteButton);
            }

            document.getElementById('modal-data-btn').onclick = (e) => {
                e.stopPropagation();
                modalDataDropdown.classList.toggle('show');
            };

            const genDescBtn = document.getElementById('generate-description-btn');
            if(genDescBtn) {
                genDescBtn.addEventListener('click', () => {
                    const editorContainer = formFieldsContainer.querySelector('#editor-description');
                    const quillInstance = editorContainer ? editorContainer.quill : null;
                    generateDescription(quillInstance);
                });
            }
            
            appState.initialFormState = getFormState(entryForm);
            updateUIAfterAuthChange();
        }

        async function openModal(docId = null, data = {}, isEditMode = false) {
            await populateModal(docId, data, isEditMode);
            
            entryModal.classList.remove('hidden');
            
            document.getElementById('modal-explicit-close-btn').onclick = () => {
                 if (isFormDirty()) {
                    appState.pendingAction = () => closeModal();
                    unsavedChangesModal.classList.remove('hidden');
                } else {
                    closeModal();
                }
            };
        }

        function closeModal() {
            appState.initialFormState = null;
            appState.editingDocId = null;
            entryForm.reset();
            entryModal.classList.add('hidden');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const result = await saveCurrentForm();
            if (result.success) {
                // After saving, re-render the modal in edit mode with the new data
                const docRef = doc(db, `artifacts/${appId}/public/data/rules_codex`, result.docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    populateModal(result.docId, { id: result.docId, ...docSnap.data() }, true);
                }
            }
        }

        async function saveCurrentForm() {
            const isCreating = !appState.editingDocId;
            if (isCreating && !hasPermission('create')) {
                showError("You do not have permission to create new entries.");
                return { success: false };
            }

            const dataFromForm = getFormDataObject();
            const sanitizedData = { ...dataFromForm };
            if (sanitizedData.parent === '') sanitizedData.parent = null;
            
            const collectionPath = `artifacts/${appId}/public/data/rules_codex`;
            let newDocId = appState.editingDocId;

            try {
                if (appState.editingDocId) {
                    const docRef = doc(db, collectionPath, appState.editingDocId);
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists() || !hasPermission('edit', docSnap.data())) {
                        showError("You do not have permission to edit this entry.");
                        return { success: false };
                    }
                    await updateDoc(docRef, { ...sanitizedData, lastUpdated: new Date() });
                } else {
                    sanitizedData.creatorId = appState.userId;
                    sanitizedData.creatorEmail = auth.currentUser?.email || 'anonymous';
                    const newDocRef = await addDoc(collection(db, collectionPath), sanitizedData);
                    newDocId = newDocRef.id;
                }
                
                appState.initialFormState = getFormState();
                return { success: true, docId: newDocId };
            } catch (error) {
                showError(`Error saving data: ${error.message}`);
                return { success: false };
            }
        }
        
        async function deleteEntry(docId) {
            if (!docId) return;
            const docRef = doc(db, `artifacts/${appId}/public/data/rules_codex`, docId);
            const docSnap = await getDoc(docRef);

            if (!hasPermission('delete', docSnap.data())) {
                 showError("You do not have permission to delete this entry.");
                return;
            }

            showConfirmModal(`ARE YOU SURE YOU WANT TO DELETE THIS ENTRY?`, async () => {
                closeModal();
                try {
                    await deleteDoc(docRef);
                    if (appState.currentWikiEntryId === docId) {
                        document.getElementById('wiki-entry-title').textContent = 'Select an Entry';
                        document.getElementById('wiki-entry-body').innerHTML = '<p class="text-gray-400">Please select an entry.</p>';
                        appState.currentWikiEntryId = null;
                    }
                } catch (error) {
                    showError("Error deleting entry.");
                }
            });
        }
        
        async function generateDescription(quillInstance) {
            const userApiKey = localStorage.getItem('geminiApiKey');
            if (!userApiKey) {
                showError("Please enter your Gemini API key in settings.");
                return;
            }
            // ... (API call logic remains the same)
        }
        
        function parseWikiLinks(text) {
            if (!text) return '';
            return text.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
                const entryName = p1.trim();
                const docId = rulesCodexMap.get(entryName);
                if (docId) {
                    return `<a href="#" class="wiki-link" data-linked-id="${docId}">${entryName}</a>`;
                }
                return entryName;
            });
        }

        document.body.addEventListener('click', async (event) => {
            if (event.target.classList.contains('wiki-link')) {
                event.preventDefault();
                const linkedDocId = event.target.dataset.linkedId;
                if (linkedDocId) {
                    const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/rules_codex`, linkedDocId));
                    if (docSnap.exists()) {
                        if (!entryModal.classList.contains('hidden')) closeModal(); 
                        openModal(linkedDocId, {id: docSnap.id, ...docSnap.data()}, false); 
                    } else {
                        showError(`Linked entry not found.`);
                    }
                }
            }
        });

        // --- Global Event Listeners & Modal Helpers ---
        confirmOkBtn.addEventListener('click', () => { if (appState.confirmCallback) appState.confirmCallback(); hideConfirmModal(); });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        unsavedCancelBtn.addEventListener('click', hideUnsavedChangesModal);
        unsavedDismissBtn.addEventListener('click', () => { if (appState.pendingAction) appState.pendingAction(); hideUnsavedChangesModal(); });
        unsavedSaveBtn.addEventListener('click', async () => {
            const result = await saveCurrentForm();
            if (result.success && appState.pendingAction) appState.pendingAction();
            hideUnsavedChangesModal();
        });
        errorOkBtn.addEventListener('click', hideErrorModal);
        settingsIcon.addEventListener('click', () => {
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            settingsModal.classList.remove('hidden');
        });
        settingsCancelBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsSaveBtn.addEventListener('click', () => {
            localStorage.setItem('geminiApiKey', apiKeyInput.value);
            settingsModal.classList.add('hidden');
        });

        function showConfirmModal(message, onConfirm) { confirmMessage.textContent = message.toUpperCase(); appState.confirmCallback = onConfirm; confirmModal.classList.remove('hidden'); }
        function hideConfirmModal() { appState.confirmCallback = null; confirmModal.classList.add('hidden'); }
        function hideUnsavedChangesModal() { appState.pendingAction = null; unsavedChangesModal.classList.add('hidden'); }
        function showError(message) { errorMessage.textContent = message.toUpperCase(); errorModal.classList.remove('hidden'); }
        function hideErrorModal() { errorModal.classList.add('hidden'); }

        window.addEventListener('click', (event) => {
            const tableModal = document.getElementById('table-modal');
            if (event.target == confirmModal) hideConfirmModal();
            else if (event.target == errorModal) hideErrorModal();
            else if (event.target == unsavedChangesModal) hideUnsavedChangesModal();
            else if (event.target == settingsModal) settingsModal.classList.add('hidden');
            else if (tableModal && event.target == tableModal) tableModal.classList.add('hidden');
            
            const modalDataBtn = document.getElementById('modal-data-btn');
            const modalDataDropdown = document.getElementById('modal-data-dropdown');
            if (modalDataBtn && modalDataDropdown && !modalDataBtn.contains(event.target) && !modalDataDropdown.contains(event.target)) {
                modalDataDropdown.classList.remove('show');
            }
        });

        window.addEventListener('beforeunload', (event) => {
            if (isFormDirty()) {
                event.preventDefault();
                event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
        entryForm.addEventListener('submit', handleFormSubmit);

    </script>
</body>
</html>
