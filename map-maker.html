<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="mmstyle.css">
</head>
<body>
    <!-- SVG Definitions for Patterns -->
    <svg width="0" height="0" style="position:absolute;z-index:-1;">
        <defs>
            <pattern id="pattern-water" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#4c92c8"/><path d="M-5,5 Q-2.5,0 0,5 T5,5 T10,5 T15,5" stroke="#2b5a7a" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-sand" width="6" height="6" patternUnits="userSpaceOnUse"><rect width="6" height="6" fill="#f0d9a0"/><circle cx="1" cy="1" r="1" fill="#b59a72"/><circle cx="4" cy="4" r="1" fill="#b59a72"/></pattern>
            <pattern id="pattern-grass" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#86c440"/><path d="M0,10 L5,0 L10,10" stroke="#4d7225" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-plains" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#a6d15a"/><path d="M0 6 H12 M6 0 V12" stroke="#6d8e35" stroke-width="0.5"/></pattern>
            <pattern id="pattern-forest" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#4a8232"/><path d="M2 10 L6 2 L10 10 Z" fill="#2a4d1c"/></pattern>
            <pattern id="pattern-hills" width="15" height="15" patternUnits="userSpaceOnUse"><rect width="15" height="15" fill="#a08b6b"/><path d="M0 15 C 5 0, 10 0, 15 15" stroke="#6b5a46" stroke-width="2" fill="none"/></pattern>
            <pattern id="pattern-mountain" width="16" height="16" patternUnits="userSpaceOnUse"><rect width="16" height="16" fill="#6f6f6f"/><path d="M0 16 L8 0 L16 16 Z" stroke="#404040" stroke-width="1" fill="#707070"/></pattern>
            <pattern id="pattern-snow" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#ffffff"/><path d="M0 5 H10 M5 0 V10 M2 2 L8 8 M2 8 L8 2" stroke="#c0c0c0" stroke-width="1"/></pattern>
            <pattern id="pattern-dirt" width="8" height="8" patternUnits="userSpaceOnUse"><rect width="8" height="8" fill="#a07040"/><path d="M0 0 L8 8 M8 0 L0 8" stroke="#6b4a25" stroke-width="0.5"/></pattern>
            <pattern id="pattern-road" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#b0a89f"/><rect x="3" y="0" width="4" height="10" fill="#888279"/></pattern>
            <pattern id="pattern-lava" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#e25822"/><circle cx="6" cy="6" r="5" fill="#e06030" opacity="0.5"/><circle cx="3" cy="9" r="3" fill="#cc3700" opacity="0.6"/></pattern>
            <pattern id="pattern-crags" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#5a5a5a"/><path d="M0 10 L5 0 L10 10" stroke="#303030" stroke-width="1.5" fill="none"/><path d="M0 5 L10 5" stroke="#303030" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-swamp" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#4d6642"/><path d="M-2,6 Q1,3 4,6 T10,6" stroke="#2c3e23" stroke-width="1.5" fill="none"/><circle cx="9" cy="3" r="1" fill="#526d1a"/></pattern>
            <pattern id="pattern-tundra" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#cdd3d6"/><path d="M0 0 L10 10 M10 0 L0 10" stroke="#90989a" stroke-width="0.5"/></pattern>
            
            <!-- NEW TERRAIN PATTERNS -->
            <pattern id="pattern-dungeon-floor" width="16" height="16" patternUnits="userSpaceOnUse"><rect width="16" height="16" fill="#4a5568"/><path d="M0 8 H16 M8 0 V16" stroke="#2d3748" stroke-width="1"/></pattern>
            <pattern id="pattern-dungeon-wall" width="16" height="16" patternUnits="userSpaceOnUse"><rect width="16" height="16" fill="#2d3748"/><path d="M0 0 L16 16 M16 0 L0 16" stroke="#1a202c" stroke-width="1.5"/></pattern>
            <pattern id="pattern-pavement" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#6b7280"/><rect x="0" y="0" width="6" height="6" fill="#718096"/><rect x="6" y="6" width="6" height="6" fill="#718096"/></pattern>
            <pattern id="pattern-metal-plating" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#71717a"/><path d="M0 0 L10 10" stroke="#4a5568" stroke-width="1.5"/><circle cx="1" cy="1" r="1" fill="#4a5568"/><circle cx="9" cy="9" r="1" fill="#4a5568"/></pattern>
            <pattern id="pattern-wasteland" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#a16207"/><path d="M0 5 L5 0 L7 8 L12 3" stroke="#78350f" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-cobblestone" width="16" height="16" patternUnits="userSpaceOnUse"><rect width="16" height="16" fill="#718096"/><path d="M0 8 a8 8 0 0 1 8 -8 a8 8 0 0 1 8 8 M-8 8 a8 8 0 0 1 8 8 a8 8 0 0 1 8 -8" stroke="#4a5568" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-wooden-planks" width="20" height="20" patternUnits="userSpaceOnUse"><rect width="20" height="20" fill="#854d0e"/><path d="M0 0 H20 M0 10 H20" stroke="#522c04" stroke-width="2"/><path d="M5 0 V10 M15 10 V20" stroke="#522c04" stroke-width="1"/></pattern>
            <pattern id="pattern-cavern-floor" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#78716c"/><circle cx="3" cy="3" r="2" fill="#57534e" opacity="0.5"/><circle cx="8" cy="9" r="1.5" fill="#57534e" opacity="0.5"/></pattern>
        </defs>
    </svg>

    <!-- Main Container -->
    <div id="main-container">
        <!-- Control Panel -->
        <div id="panelWrapper">
            <div id="controlContainer" class="control-container p-4 flex flex-col shadow-lg">
                <!-- Panel Header -->
                <div class="flex justify-between items-center mb-4 flex-shrink-0 relative">
                    <div class="flex items-center">
                        <h2 class="text-2xl font-bold text-gray-100">Map Controls</h2>
                        <button id="userGuideBtn" class="ml-2 p-1 rounded-md hover:bg-gray-700" title="Open User Guide">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                        </button>
                        <button id="settingsBtn" class="ml-1 p-1 rounded-md hover:bg-gray-700" title="Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </button>
                        <button id="mapKeyBtn" class="ml-1 p-1 rounded-md hover:bg-gray-700" title="Toggle Map Key">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></svg>
                        </button>
                        <!-- GM View Toggle Button -->
                        <button id="gmViewToggleBtn" class="ml-1 p-1 rounded-md hover:bg-gray-700" title="Toggle GM View">
                            <svg id="gmViewIconOn" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <svg id="gmViewIconOff" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                        </button>
                    </div>
                    <div class="flex items-center">
                        <button id="fileMenuBtn" class="p-2 rounded-md hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        </button>
                        <button id="collapseBtn" class="p-2 rounded-md hover:bg-gray-700 ml-2" title="Hide Panel">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                    </div>
                    <div id="fileDropdownMenu" class="file-dropdown hidden mt-2 right-0 top-full">
                        <button id="saveProjectBtn" class="file-dropdown-item">Save Project (.json)</button>
                        <button id="loadProjectBtn" class="file-dropdown-item">Load Project (.json)</button>
                        <button id="savePngBtn" class="file-dropdown-item">Save Current Map as PNG</button>
                    </div>
                    <input type="file" id="loadJsonInput" class="hidden" accept=".json">
                </div>
                
                <!-- Scrollable Controls Area -->
                <div class="flex-grow overflow-y-auto pr-2">
                    <div class="control-panel mb-4">
                        <div id="actionsHeader" class="collapsible-header">
                            <h3>Actions</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div id="actionsContent" class="collapsible-content">
                            <button id="addNewMapBtn" class="w-full mb-2">Add New Map</button>
                            <button id="assetEditorBtn" class="w-full mb-2">Create New Asset</button>
                            <div class="grid grid-cols-4 gap-2 my-2">
                                <button id="undoBtn" title="Undo" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-2.9-6.7"/><path d="M21 2v6h-6"/></svg>
                                </button>
                                <button id="redoBtn" title="Redo" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 2.9-6.7"/><path d="M3 2v6h6"/></svg>
                                </button>
                                <div class="relative">
                                    <button id="eraserToolBtn" title="Eraser">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                                    </button>
                                    <div id="eraserDropdownMenu" class="file-dropdown hidden -left-1/2 top-full mt-2 !w-48">
                                        <button id="eraseTerrainBtn" class="file-dropdown-item">Erase Terrain</button>
                                        <button id="eraseObjectsBtn" class="file-dropdown-item">Erase Objects</button>
                                        <button id="eraseDrawingsBtn" class="file-dropdown-item">Erase Drawings</button>
                                    </div>
                                </div>
                                <button id="resetViewBtn" title="Reset View & Zoom">Center</button>
                            </div>
                            <!-- TOOLS -->
                            <div class="control-panel !p-0 !border-0 mt-4">
                                <h3 class="!border-b-0 !pb-2 text-base font-semibold">Tools</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <button id="toolTerrainBtn" class="tool-btn active">Terrain</button>
                                    <button id="toolObjectBtn" class="tool-btn">Object</button>
                                    <button id="toolPencilBtn" class="tool-btn">Pencil</button>
                                    <button id="toolSelectBtn" class="tool-btn">Select</button>
                                    <button id="toolTokenBtn" class="tool-btn">Token</button>
                                    <button id="toolTextBtn" class="tool-btn">Text</button>
                                    <button id="toolFogBtn" class="tool-btn">Fog</button>
                                </div>
                            </div>
                            <div id="graphicsDropdown" class="mt-4 control-panel !p-0 !border-0">
                                 <div id="graphicsBtn" class="collapsible-header collapsed !border-t !pt-4">
                                     <h3>Graphics Options</h3>
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                 </div>
                                 <div id="graphicsContent" class="collapsible-content hidden">
                                     <!-- Layers -->
                                     <div class="control-panel mb-4">
                                         <h3 class="!border-b-0 !pb-2 text-base font-semibold">Layers</h3>
                                         <div id="layerContent" class="collapsible-content">
                                             <div id="layerList" class="flex flex-col gap-2 mb-4"></div>
                                             <div class="grid grid-cols-2 gap-2">
                                                 <button id="addLayerBtn">Add Layer</button>
                                                 <button id="deleteLayerBtn">Delete Layer</button>
                                             </div>
                                         </div>
                                     </div>
                                     <!-- Grid Options -->
                                     <div class="control-panel mb-4">
                                         <h3 class="!border-b-0 !pb-2 text-base font-semibold">Grid Options</h3>
                                         <div class="mb-4">
                                             <label for="gridTypeSelect">Grid Type</label>
                                             <select id="gridTypeSelect">
                                                 <option value="hex">Hex</option>
                                                 <option value="square">Square</option>
                                             </select>
                                         </div>
                                         <div class="grid grid-cols-2 gap-4 items-center">
                                             <div>
                                                 <label for="gridColorPicker" class="text-sm">Color</label>
                                                 <input type="color" id="gridColorPicker" value="#111827" class="!p-1 !h-9 !mb-0">
                                             </div>
                                             <div class="flex items-center justify-end pt-5">
                                                 <input type="checkbox" id="gridVisibleCheckbox" class="h-4 w-4 rounded !mb-0" checked>
                                                 <label for="gridVisibleCheckbox" class="ml-2 !mb-0">Visible</label>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <div id="terrainOptionsPanel" class="control-panel mb-4">
                         <div class="collapsible-header">
                            <h3>Brush Options</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="collapsible-content">
                            <label for="terrainBrushMode">Terrain Brush</label>
                            <select id="terrainBrushMode">
                                <option value="hex">Hex</option>
                                <option value="spray">Spray</option>
                                <option value="line">Line</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="ellipse">Ellipse</option>
                                <option value="polygon">Polygon</option>
                            </select>
                            <label for="brushSize">Brush/Object Size: <span id="brushSizeValue">1</span></label>
                            <input type="range" id="brushSize" min="1" max="10" value="1" class="mb-3">
                        </div>
                    </div>

                    <div id="pencilOptionsPanel" class="control-panel mb-4 hidden">
                        <div class="collapsible-header">
                            <h3>Pencil Options</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="collapsible-content">
                            <label for="pencilBrushMode">Pencil Mode</label>
                            <select id="pencilBrushMode">
                                <option value="freestyle">Freestyle</option>
                                <option value="line">Line</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="ellipse">Ellipse</option>
                            </select>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="pencilColorPicker">Color</label>
                                    <input type="color" id="pencilColorPicker" value="#FFFFFF" class="!mb-0">
                                </div>
                                 <div>
                                    <label for="pencilWidth">Width: <span id="pencilWidthValue">5</span></label>
                                    <input type="range" id="pencilWidth" min="1" max="50" value="5" class="!mb-0">
                                </div>
                            </div>
                            <div class="flex items-center mt-4">
                                <input type="checkbox" id="pencilGmOnlyCheckbox" class="h-4 w-4 rounded !mb-0">
                                <label for="pencilGmOnlyCheckbox" class="ml-2 !mb-0 text-sm">Draw as GM-Only (Secret)</label>
                            </div>
                        </div>
                    </div>

                    <div id="tokenOptionsPanel" class="control-panel mb-4 hidden">
                        <div class="collapsible-header">
                            <h3>Token Options</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="collapsible-content">
                            <label for="tokenLightRadius">Light Radius (in hexes): <span id="tokenLightRadiusValue">5</span></label>
                            <input type="range" id="tokenLightRadius" min="0" max="30" value="5" class="mb-2">
                             <div class="grid grid-cols-2 gap-4 items-center">
                                 <div>
                                     <label for="tokenColor" class="text-sm">Color</label>
                                     <input type="color" id="tokenColor" value="#facc15" class="!p-1 !h-9 !mb-0">
                                 </div>
                                 <div class="flex items-center justify-end pt-5">
                                     <button id="deleteTokenBtn" class="w-full">Delete Token</button>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div id="fogPanel" class="control-panel mb-4 hidden">
                        <div class="collapsible-header">
                            <h3>Fog of War</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="toolFogRevealBtn">Reveal</button>
                                <button id="toolFogHideBtn">Hide</button>
                            </div>
                            <label for="fogBrushSize" class="mt-4">Brush Size: <span id="fogBrushSizeValue">5</span></label>
                            <input type="range" id="fogBrushSize" min="1" max="20" value="5" class="mb-2">
                            <button id="resetFogBtn" class="w-full">Reset Fog (Cover All)</button>
                        </div>
                    </div>
                                    
                    <div id="terrainContentPanel" class="control-panel mb-4">
                         <div id="terrainHeader" class="collapsible-header">
                            <h3>Terrain Type</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div id="terrainContent" class="collapsible-content">
                            <div id="terrainSelector" class="flex flex-col gap-2"></div>
                        </div>
                    </div>

                    <div id="objectOptionsPanel" class="control-panel mb-4 hidden">
                        <div id="objectHeader" class="collapsible-header">
                            <h3>Objects</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                         <div id="objectContent" class="collapsible-content">
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="objectGmOnlyCheckbox" class="h-4 w-4 rounded !mb-0">
                                <label for="objectGmOnlyCheckbox" class="ml-2 !mb-0 text-sm">Place as GM-Only (Secret)</label>
                            </div>
                            <div id="objectSelector" class="flex flex-col gap-2"></div>
                         </div>
                    </div>

                    <div id="selectedObjectPanel" class="control-panel mb-4 hidden">
                        <div class="collapsible-header">
                           <h3 id="selection-panel-header">Selected Item</h3>
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div id="selection-panel-content" class="collapsible-content">
                           <!-- Content is now dynamically inserted by JS -->
                        </div>
                    </div>

                    <div id="textToolPanel" class="control-panel mb-4 hidden">
                        <div id="textHeader" class="collapsible-header">
                            <h3>Text & GM Notes</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                         <div id="textContent" class="collapsible-content">
                            <label for="textInput">Text</label>
                            <input type="text" id="textInput" value="Label">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                     <label for="fontSizeInput">Size</label>
                                     <input type="number" id="fontSizeInput" value="20" min="1">
                                </div>
                                <div>
                                     <label for="fontColorInput">Color</label>
                                     <input type="color" id="fontColorInput" value="#FFFFFF">
                                </div>
                            </div>
                            <div class="flex items-center mt-2">
                                <input type="checkbox" id="textGmOnlyCheckbox" class="h-4 w-4 rounded !mb-0">
                                <label for="textGmOnlyCheckbox" class="ml-2 !mb-0 text-sm">Place as GM-Only (Secret)</label>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Resizer Handle -->
        <div id="resizer" class="resizer"></div>
        <!-- Canvas Area -->
        <div id="canvas-container" class="relative">
            <div id="breadcrumb-nav" class="absolute top-2 left-2 z-20 bg-gray-900 bg-opacity-70 p-2 rounded-md text-sm"></div>
            <canvas id="mapCanvas"></canvas>
            <canvas id="wallCanvas"></canvas>
            <canvas id="lightCanvas"></canvas>
            <canvas id="drawingCanvas"></canvas>
            <canvas id="fogCanvas"></canvas>
            
            <div id="asset-context-menu" class="asset-context-menu hidden">
                <button id="asset-rotate-left-btn" title="Rotate Left (r)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-2.9-6.7"/><path d="M21 2v6h-6"/></svg>
                </button>
                <button id="asset-rotate-right-btn" title="Rotate Right (R)">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 2.9-6.7"/><path d="M3 2v6h6"/></svg>
                </button>
                <button id="asset-scale-up-btn" title="Scale Up (+)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                </button>
                <button id="asset-scale-down-btn" title="Scale Down (-)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                </button>
            </div>

            <!-- AI Bottom Panel -->
            <div id="aiBottomPanel" class="closed">
                <div id="aiBottomPanelHeader">
                    <span>AI Assistant & Prompt Editor</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </div>
                <div id="aiBottomPanelContent" class="p-4 space-y-4">
                    <!-- Step 1: Landform Generation -->
                    <div class="control-panel">
                        <h4 class="text-md font-semibold text-gray-200 mb-2 border-b border-gray-600 pb-1">Step 1: Generate Landform Foundation</h4>
                        <label for="aiLandformPrompt">Describe the basic landscape</label>
                        <textarea id="aiLandformPrompt" placeholder="e.g., A rugged mountain range with a central volcano. A coastline with sandy beaches and a large bay." class="mb-2"></textarea>
                        <button id="generateLandformBtn" class="w-full">
                            <span class="btn-text">Generate Grayscale Landform</span>
                            <span class="spinner hidden"></span>
                        </button>
                    </div>

                    <!-- Step 2: Biome Application -->
                    <div class="control-panel">
                        <h4 class="text-md font-semibold text-gray-200 mb-2 border-b border-gray-600 pb-1">Step 2: Apply Biomes & Features</h4>
                        <textarea id="aiBiomePrompt" placeholder="e.g., Cover the mountains in snow and the lowlands in a dense pine forest. Add a large river flowing from the mountains to the bay." class="mb-2"></textarea>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button id="applyBiomesBtn" class="w-full" disabled>
                                <span class="btn-text">Apply Biomes to Map</span>
                                <span class="spinner hidden"></span>
                            </button>
                            <button id="generateColorVariantBtn" class="w-full" disabled>
                                <span class="btn-text">Try New Colors</span>
                                <span class="spinner hidden"></span>
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Step 3: Dungeon Layout Generation -->
                    <div class="control-panel">
                        <h4 class="text-md font-semibold text-gray-200 mb-2 border-b border-gray-600 pb-1">Step 3: Generate Dungeon Layout</h4>
                        <label for="aiLayoutPrompt">Describe the dungeon or building layout</label>
                        <textarea id="aiLayoutPrompt" placeholder="e.g., A small goblin hideout in a cave with a main chamber, a treasure room, and a barracks. Roughly 20x20." class="mb-2"></textarea>
                        <button id="generateLayoutBtn" class="w-full">
                            <span class="btn-text">Generate Layout</span>
                            <span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Collapsed Panel Handle -->
        <div id="collapsedBar" class="collapsed-bar hidden">MAP CONTROLS</div>
        <!-- Top Right Controls -->
        <div id="topRightControls">
            <div>
                <label for="projectNameInput">Project Name</label>
                <input type="text" id="projectNameInput" placeholder="Untitled Campaign" class="text-lg w-48">
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="newMapModal" class="modal-backdrop hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-white">
            <h3 class="text-lg font-bold mb-4">Create New Map</h3>
            <label for="newMapNameInput">Map Name</label>
            <input type="text" id="newMapNameInput" class="w-full" placeholder="e.g., Kingdom of Eldoria">
            <label for="newMapScaleSelect" class="mt-4">Map Scale</label>
            <select id="newMapScaleSelect" class="w-full">
                <option value="world">World</option>
                <option value="region">Region</option>
                <option value="area">Area</option>
                <option value="encounter">Encounter</option>
            </select>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                    <label for="newMapWidthInput">Width</label>
                    <input type="number" id="newMapWidthInput" value="50" min="1">
                </div>
                <div>
                    <label for="newMapHeightInput">Height</label>
                    <input type="number" id="newMapHeightInput" value="50" min="1">
                </div>
            </div>
            <div class="flex items-center mt-4">
                <input type="checkbox" id="newMapAsChildCheckbox" class="h-4 w-4 rounded !mb-0">
                <label for="newMapAsChildCheckbox" class="ml-2 !mb-0 text-sm">Set as child of current map</label>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancelNewMapBtn" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 transition">Cancel</button>
                <button id="confirmNewMapBtn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 transition">Create</button>
            </div>
        </div>
    </div>

    <div id="apiKeyModal" class="modal-backdrop hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-white">
            <h3 class="text-lg font-bold mb-4">AI Settings</h3>
            <p class="mb-4 text-sm text-gray-400">Enter your generative AI API key below. Your key is stored locally and never shared.</p>
            <div>
                <label for="apiKeyInput" class="block text-sm font-medium text-gray-300">API Key</label>
                <input type="password" id="apiKeyInput" class="w-full p-2 mt-1 rounded border border-gray-600 bg-gray-700 text-white">
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancelApiKey" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 transition">Cancel</button>
                <button id="saveApiKey" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 transition">Save</button>
            </div>
        </div>
    </div>
    
    <div id="asset-editor-overlay" class="hidden">
        <div class="asset-editor-main">
            <div class="asset-editor-top-bar">
                <h2 class="text-2xl font-bold text-gray-100">AI-Assisted Asset Editor</h2>
                <button id="asset-editor-close-btn" title="Close Editor">&times;</button>
            </div>
            <div class="asset-editor-content">
                <!-- LEFT PANEL -->
                <div class="asset-editor-left-panel">
                    <div class="control-panel">
                        <label for="asset-type-select">Asset Type</label>
                        <select id="asset-type-select">
                            <option value="object">Object / Icon</option>
                            <option value="terrain">Terrain Pattern</option>
                        </select>
                    </div>
                    <div class="control-panel">
                        <h3>AI Generation</h3>
                        <label for="asset-prompt">Prompt</label>
                        <textarea id="asset-prompt" rows="4" placeholder="e.g., A single, stylized fantasy oak tree icon, no background, watercolor style..."></textarea>
                        <button id="asset-generate-btn">Generate</button>
                    </div>
                    <div class="control-panel">
                        <h3>Manual Tools</h3>
                        <div class="asset-tool-palette">
                            <button class="asset-tool active" data-tool="pencil" title="Pencil"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                            <button class="asset-tool" data-tool="eraser" title="Eraser"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg></button>
                            <input type="color" id="asset-color-picker" value="#FFFFFF" title="Color Picker">
                        </div>
                        <label for="asset-brush-size">Brush Size: <span id="asset-brush-size-value">5</span></label>
                        <input type="range" id="asset-brush-size" min="1" max="50" value="5">
                    </div>
                </div>
                <!-- CENTER PANEL -->
                <div class="asset-editor-center-panel">
                    <div id="loading-overlay" class="hidden">Generating...</div>
                    <div id="asset-canvas-container">
                        <canvas id="asset-canvas-main" width="512" height="512"></canvas>
                        <canvas id="asset-canvas-draw" width="512" height="512"></canvas>
                    </div>
                </div>
                <!-- RIGHT PANEL -->
                <div class="asset-editor-right-panel">
                    <div id="asset-preview-panel" class="control-panel hidden">
                        <h3>Tiling Preview</h3>
                        <canvas id="asset-preview-canvas" width="240" height="240"></canvas>
                    </div>
                     <div class="control-panel">
                        <h3>Save to Library</h3>
                        <label for="asset-name">Asset Name</label>
                        <input type="text" id="asset-name" placeholder="e.g., Oak Tree">
                        <label for="asset-tags">Tags (comma-separated)</label>
                        <input type="text" id="asset-tags" placeholder="fantasy, world, vegetation">
                        <button id="asset-export-btn">Save to Library</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Toast Notification Container -->
    <div id="toast-container"></div>

    <script type="module" src="state.js"></script>
    <script type="module" src="mmtools-script.js"></script>
    <script type="module" src="mmassist-script.js"></script>
    <script type="module" src="asset-editor.js"></script>
</body>
</html>
