<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Consolidated Theme & Variables --- */
        :root {
            --bg-main: #212121;
            --bg-panel: rgba(31, 41, 55, 0.85); /* gray-800 with 85% opacity */
            --bg-input: #424242;
            --bg-input-focus: #616161;
            --bg-hover: #4f4f4f;
            --text-light: #f5f5f5;
            --text-subtle: #9e9e9e;
            --text-header: #60a5fa; /* blue-400 */
            --border-main: #9e9e9e;
            --border-subtle: #616161;
            --border-focus: #f5f5f5;
            --btn-primary-bg: #2563EB; /* blue-600 */
            --btn-primary-hover-bg: #1D4ED8; /* blue-700 */
            --btn-secondary-bg: #4B5563; /* gray-600 */
            --btn-secondary-hover-bg: #374151; /* gray-700 */
            --font-body: 'Inter', sans-serif;
            --font-display: 'Trebuchet MS', sans-serif;
        }

        /* --- General Styles & Tab System --- */
        body {
            font-family: var(--font-body);
            background-image: url('https://wolfebt.github.io/tangent-rpg-dbm/spaceport-background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #111827; /* Fallback color */
            color: var(--text-light);
        }
        .tab-button {
            transition: all 0.3s ease-in-out;
        }
        .tab-button.active {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            font-weight: 600;
        }
        .tab-content {
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Shown when active */
        }

        /* --- Unified Content Panel Style --- */
        .content-panel {
            background-color: var(--bg-panel);
            backdrop-filter: blur(4px);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* --- Unified Form & Input Styles --- */
        .form-input {
            background-color: var(--bg-input);
            border: 1px solid var(--border-subtle);
            color: var(--text-light);
            width: 100%;
            padding: 0.5rem 1rem; /* Adjusted padding */
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            line-height: 1.5; /* Use a specific line-height */
        }
        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            background-color: var(--bg-input-focus);
        }
        textarea.form-input {
            resize: vertical;
            overflow-y: hidden; /* Hide scrollbar for auto-resize */
            min-height: calc(1.5em + 1.2rem); /* Ensure it's tall enough for one line of text + padding */
        }
        .form-section-header {
            font-weight: bold;
            font-size: 1.25rem;
            color: var(--text-header);
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* --- Unified Button Styles --- */
        .btn {
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            text-transform: uppercase;
            border: none;
        }
        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg);
        }
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover-bg);
        }
        .btn:disabled {
            background-color: #4B5563; /* gray-600 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- Specific Component Styles --- */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-radio-label {
            display: block;
            background-color: var(--bg-input);
            color: var(--text-subtle);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .custom-radio-label:hover {
            background-color: var(--bg-input-focus);
        }
        input[type="radio"]:checked + .custom-radio-label {
            background-color: var(--btn-primary-bg);
            color: white;
            border-color: var(--text-header);
        }
        
        #profiler-content .input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        #profiler-content input[type="checkbox"] {
            appearance: none; -webkit-appearance: none;
            width: 1.5em; height: 1.5em;
            border: 2px solid var(--border-subtle);
            border-radius: 50%;
            background-color: var(--bg-input);
            display: grid; place-content: center;
            cursor: pointer; transition: all 120ms ease-in-out;
            flex-shrink: 0;
        }
        #profiler-content input[type="checkbox"]::before {
            content: ""; width: 0.8em; height: 0.8em;
            border-radius: 50%; transform: scale(0);
            transition: 120ms transform ease-in-out;
            background-color: var(--text-light);
        }
        #profiler-content input[type="checkbox"]:checked {
            background-color: var(--btn-primary-bg);
            border-color: var(--text-header);
        }
        #profiler-content input[type="checkbox"]:checked::before {
            transform: scale(1);
        }
        #profiler-content .output-box {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-subtle);
            padding: 1rem; border-radius: 0.5rem;
            height: 300px; overflow-y: auto;
            font-family: monospace;
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.75); backdrop-filter: blur(5px); }
        .modal-content {
            background-color: var(--bg-panel);
            border: 2px solid var(--border-main);
        }
    </style>
</head>
<body class="text-white">

    <!-- Tab Navigation -->
    <div class="p-4 bg-gray-900 bg-opacity-50 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex space-x-2 rounded-lg bg-gray-700 bg-opacity-50 p-1">
                <button data-tab="imager" class="tab-button w-full py-2 px-4 rounded-md text-gray-300">Character Imager</button>
                <button data-tab="profiler" class="tab-button w-full py-2 px-4 rounded-md text-gray-300">Character Profiler</button>
            </div>
            <button id="global-settings-btn" class="p-2 rounded-full hover:bg-gray-700" title="API Key Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
    </div>

    <!-- Tab Content -->
    <div id="imager-content" class="tab-content p-4 sm:p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white" style="font-family: var(--font-display);">Character Imager</h1>
                <p class="text-lg text-gray-400 mt-2">Create detailed prompts and generate character portraits with AI.</p>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="content-panel">
                    <form id="character-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 form-section-header">Physique & Appearance</div>
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-300 mb-1">Gender / Sex</label>
                                <input type="text" id="gender" name="gender" placeholder="e.g., Female, Male" class="form-input">
                            </div>
                            <div>
                                <label for="build" class="block text-sm font-medium text-gray-300 mb-1">Build</label>
                                <input type="text" id="build" name="build" placeholder="e.g., Athletic, Slender" class="form-input">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Height</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="height_ft" name="height_ft" placeholder="5" class="form-input">
                                    <span class="text-gray-400">ft</span>
                                    <input type="number" id="height_in" name="height_in" placeholder="7" class="form-input">
                                    <span class="text-gray-400">in</span>
                                </div>
                            </div>
                            <div>
                                <label for="weight" class="block text-sm font-medium text-gray-300 mb-1">Weight (lbs)</label>
                                <input type="number" id="weight" name="weight" placeholder="145" class="form-input">
                            </div>
                            <div>
                                <label for="hairStyle" class="block text-sm font-medium text-gray-300 mb-1">Hair Style</label>
                                <input type="text" id="hairStyle" name="hairStyle" placeholder="e.g., Long and straight" class="form-input">
                            </div>
                            <div>
                                <label for="hairColor" class="block text-sm font-medium text-gray-300 mb-1">Hair Color</label>
                                <input type="text" id="hairColor" name="hairColor" placeholder="e.g., Black, Blonde" class="form-input">
                            </div>
                            <div>
                                <label for="eyeColor" class="block text-sm font-medium text-gray-300 mb-1">Eye Color</label>
                                <input type="text" id="eyeColor" name="eyeColor" placeholder="e.g., Brown, Blue" class="form-input">
                            </div>
                            <div>
                                <label for="faceShape" class="block text-sm font-medium text-gray-300 mb-1">Face Shape</label>
                                <input type="text" id="faceShape" name="faceShape" placeholder="e.g., Oval, Square" class="form-input">
                            </div>
                             <div class="md:col-span-2">
                                <label for="skinTone" class="block text-sm font-medium text-gray-300 mb-1">Skin Tone</label>
                                <input type="text" id="skinTone" name="skinTone" placeholder="e.g., Fair, Dark" class="form-input">
                            </div>
                            <div class="md:col-span-2">
                                <label for="scars" class="block text-sm font-medium text-gray-300 mb-1">Scars</label>
                                <textarea id="scars" name="scars" class="form-input"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tattoos" class="block text-sm font-medium text-gray-300 mb-1">Tattoos</label>
                                <textarea id="tattoos" name="tattoos" class="form-input"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="details" class="block text-sm font-medium text-gray-300 mb-1">Other Details (Race, Species, etc.)</label>
                                <textarea id="details" name="details" class="form-input" placeholder="e.g., Human with rounded ears, Elf with pointed ears..."></textarea>
                            </div>
                            <div class="md:col-span-2 form-section-header mt-4">Outfit</div>
                            <div class="md:col-span-2">
                                <label for="clothing" class="block text-sm font-medium text-gray-300 mb-1">Clothing</label>
                                <textarea id="clothing" name="clothing" class="form-input"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="accessories" class="block text-sm font-medium text-gray-300 mb-1">Accessories</label>
                                <textarea id="accessories" name="accessories" class="form-input"></textarea>
                            </div>
                            <div class="md:col-span-2 form-section-header mt-4">Persona & Setting</div>
                            <div class="md:col-span-2">
                                <label for="archetype" class="block text-sm font-medium text-gray-300 mb-1">Archetype</label>
                                <input type="text" id="archetype" name="archetype" class="form-input" placeholder="e.g., Warrior, Rogue, Merchant...">
                            </div>
                            <div class="md:col-span-2">
                                <label for="expression" class="block text-sm font-medium text-gray-300 mb-1">Expression / Mood</label>
                                <textarea id="expression" name="expression" class="form-input"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="background" class="block text-sm font-medium text-gray-300 mb-1">Background / Setting</label>
                                <textarea id="background" name="background" class="form-input"></textarea>
                            </div>
                            <div class="md:col-span-2 form-section-header mt-4 text-red-400">Negative Prompts</div>
                            <div class="md:col-span-2">
                                <label for="negative_prompts" class="block text-sm font-medium text-gray-300 mb-1">Features to Exclude</label>
                                <textarea id="negative_prompts" name="negative_prompts" class="form-input" placeholder="e.g., eyepatch, pointed ears, helmet, blurry background..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="space-y-8">
                    <div class="content-panel">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 form-section-header flex items-center justify-between">
                                <span>Image Composition</span>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Framing</label>
                                <div class="space-y-2">
                                    <input type="radio" name="framing" value="portrait" id="framing_portrait" class="hidden" checked>
                                    <label for="framing_portrait" class="custom-radio-label">Portrait</label>
                                    <input type="radio" name="framing" value="full_body" id="framing_full_body" class="hidden">
                                    <label for="framing_full_body" class="custom-radio-label">Full Body</label>
                                    <input type="radio" name="framing" value="sheet" id="framing_sheet" class="hidden">
                                    <label for="framing_sheet" class="custom-radio-label">Concept Sheet</label>
                                </div>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Style</label>
                                <div class="space-y-2">
                                    <input type="radio" name="style" value="painting" id="style_painting" class="hidden" checked>
                                    <label for="style_painting" class="custom-radio-label">Painting</label>
                                    <input type="radio" name="style" value="photorealistic" id="style_photorealistic" class="hidden">
                                    <label for="style_photorealistic" class="custom-radio-label">Photorealistic</label>
                                    <input type="radio" name="style" value="anime" id="style_anime" class="hidden">
                                    <label for="style_anime" class="custom-radio-label">Anime</label>
                                    <input type="radio" name="style" value="sketch" id="style_sketch" class="hidden">
                                    <label for="style_sketch" class="custom-radio-label">Sketch</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="content-panel">
                        <h2 class="text-2xl font-bold mb-4 text-white">Generated Prompt</h2>
                        <div class="flex items-center space-x-4 mb-4">
                            <button id="generate-prompt-btn" class="btn btn-primary w-full">1. Generate Prompt</button>
                        </div>
                        <textarea id="generated-prompt" rows="10" class="form-input" readonly placeholder="Your detailed character prompt will appear here..."></textarea>
                        <button id="copy-prompt-btn" class="mt-2 btn btn-secondary w-full">Copy Prompt</button>
                        <div id="copy-message" class="text-green-400 text-sm mt-2 text-center h-5"></div>
                    </div>
                    <div class="content-panel">
                        <h2 class="text-2xl font-bold mb-4 text-white">Generated Image</h2>
                         <button id="generate-image-btn" class="btn btn-primary w-full bg-green-600 hover:bg-green-700">2. Generate Image</button>
                        <button id="download-image-btn" class="hidden mt-2 btn btn-primary w-full">Download Image</button>
                        <div id="error-message" class="text-red-400 text-sm my-4 text-center h-5"></div>
                        <div id="image-container" class="mt-4 w-full aspect-square bg-gray-900 rounded-md flex items-center justify-center border border-gray-700">
                            <div id="loading-spinner" class="spinner hidden"></div>
                            <img id="generated-image" src="" alt="Generated Character" class="hidden w-full h-full object-cover rounded-md">
                            <span id="image-placeholder" class="text-gray-500">Your character image will appear here</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="profiler-content" class="tab-content">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative">
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white" style="font-family: var(--font-display);">Character Profiler</h1>
                <p class="mt-3 text-md sm:text-lg text-gray-400 max-w-2xl mx-auto">Fill in the fields or check the box for AI generation.</p>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="content-panel">
                    <form id="character-form-profiler">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="name-profiler" class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                                <div class="input-wrapper"><input type="text" id="name-profiler" name="name" placeholder="e.g., Alistair Croft" class="form-input"><input type="checkbox" id="cb-name" name="cb-name" checked title="Check to generate with AI"></div>
                            </div>
                            <div>
                                <label for="genre-profiler" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                                <div class="input-wrapper"><input type="text" id="genre-profiler" name="genre" placeholder="e.g., Sci-Fi, Fantasy, Noir" class="form-input"><input type="checkbox" id="cb-genre" name="cb-genre" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="core-description" class="block text-sm font-medium text-gray-300 mb-1">Core Description</label>
                                <div class="input-wrapper"><textarea id="core-description" name="core-description" placeholder="A high-level summary of the character." class="form-input"></textarea><input type="checkbox" id="cb-core-description" name="cb-core-description" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="appearance" class="block text-sm font-medium text-gray-300 mb-1">Appearance</label>
                                <div class="input-wrapper"><textarea id="appearance" name="appearance" placeholder="Describe their physical looks, clothing, and style." class="form-input"></textarea><input type="checkbox" id="cb-appearance" name="cb-appearance" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="backstory" class="block text-sm font-medium text-gray-300 mb-1">Backstory</label>
                                <div class="input-wrapper"><textarea id="backstory" name="backstory" placeholder="Detail their history, significant life events, and origins." class="form-input"></textarea><input type="checkbox" id="cb-backstory" name="cb-backstory" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="personality" class="block text-sm font-medium text-gray-300 mb-1">Personality</label>
                                <div class="input-wrapper"><textarea id="personality" name="personality" placeholder="e.g., Witty, cautious, fiercely loyal..." class="form-input"></textarea><input type="checkbox" id="cb-personality" name="cb-personality" checked title="Check to generate with AI"></div>
                            </div>
                            <div>
                                <label for="skills" class="block text-sm font-medium text-gray-300 mb-1">Skills</label>
                                <div class="input-wrapper"><input type="text" id="skills" name="skills" placeholder="e.g., Lockpicking, alchemy" class="form-input"><input type="checkbox" id="cb-skills" name="cb-skills" checked title="Check to generate with AI"></div>
                            </div>
                            <div>
                                <label for="abilities" class="block text-sm font-medium text-gray-300 mb-1">Abilities</label>
                                <div class="input-wrapper"><input type="text" id="abilities" name="abilities" placeholder="e.g., Minor pyromancy" class="form-input"><input type="checkbox" id="cb-abilities" name="cb-abilities" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="goals" class="block text-sm font-medium text-gray-300 mb-1">Goals</label>
                                <div class="input-wrapper"><textarea id="goals" name="goals" placeholder="Short-term and long-term goals." class="form-input"></textarea><input type="checkbox" id="cb-goals" name="cb-goals" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="motivations" class="block text-sm font-medium text-gray-300 mb-1">Motivations</label>
                                <div class="input-wrapper"><textarea id="motivations" name="motivations" placeholder="What drives them?" class="form-input"></textarea><input type="checkbox" id="cb-motivations" name="cb-motivations" checked title="Check to generate with AI"></div>
                            </div>
                             <div>
                                <label for="weaknesses" class="block text-sm font-medium text-gray-300 mb-1">Weaknesses</label>
                                <div class="input-wrapper"><input type="text" id="weaknesses" name="weaknesses" placeholder="e.g., Fear of heights, overly trusting" class="form-input"><input type="checkbox" id="cb-weaknesses" name="cb-weaknesses" checked title="Check to generate with AI"></div>
                            </div>
                             <div>
                                <label for="equipment" class="block text-sm font-medium text-gray-300 mb-1">Equipment</label>
                                <div class="input-wrapper"><textarea id="equipment" name="equipment" placeholder="What items do they carry?" class="form-input"></textarea><input type="checkbox" id="cb-equipment" name="cb-equipment" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="relationships" class="block text-sm font-medium text-gray-300 mb-1">Relationships</label>
                                <div class="input-wrapper"><textarea id="relationships" name="relationships" placeholder="Family, friends, rivals, etc." class="form-input"></textarea><input type="checkbox" id="cb-relationships" name="cb-relationships" checked title="Check to generate with AI"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="notes" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                                <div class="input-wrapper"><textarea id="notes" name="notes" placeholder="Any other important details, quirks, or information." class="form-input"></textarea><input type="checkbox" id="cb-notes" name="cb-notes" checked title="Check to generate with AI"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-end mt-8 border-t border-gray-700 pt-6">
                            <button type="button" id="generate-btn-profiler" class="btn btn-primary">Generate</button>
                        </div>
                    </form>
                </div>
                <div class="space-y-8">
                    <div class="content-panel output-container">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-bold text-white">Workup</h2>
                            <div class="flex space-x-2">
                                 <button class="copy-btn btn btn-secondary !py-1 !px-2" data-target="output-workup">Copy</button>
                                 <button class="save-btn btn btn-secondary !py-1 !px-2" data-target="output-workup" data-format="txt">Save</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Full character details.</p>
                        <div class="output-box"><pre id="output-workup" class="whitespace-pre-wrap text-sm"></pre></div>
                    </div>
                    <div class="content-panel output-container">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-bold text-white">Markdown</h2>
                             <div class="flex space-x-2">
                                <button class="copy-btn btn btn-secondary !py-1 !px-2" data-target="output-markdown">Copy</button>
                                <button class="save-btn btn btn-secondary !py-1 !px-2" data-target="output-markdown" data-format="md">Save</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Condensed for short notes.</p>
                         <div class="output-box"><pre id="output-markdown" class="whitespace-pre-wrap text-sm"></pre></div>
                    </div>
                    <div class="content-panel output-container">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-bold text-white">JSON</h2>
                            <div class="flex space-x-2">
                                 <button class="copy-btn btn btn-secondary !py-1 !px-2" data-target="output-json">Copy</button>
                                 <button class="save-btn btn btn-secondary !py-1 !px-2" data-target="output-json" data-format="json">Save</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Optimized for token economy.</p>
                         <div class="output-box"><pre id="output-json" class="whitespace-pre-wrap text-sm"></pre></div>
                    </div>
                     <p id="copy-feedback-profiler" class="text-sm text-green-400 mt-2 h-4 text-center"></p>
                </div>
            </main>
        </div>
    </div>

    <!-- Global API Key Modal -->
    <div id="api-key-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="modal-content rounded-lg p-8 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-4">API Key Settings</h2>
            <p class="text-gray-400 mb-4">Please provide your Google AI API key. This will be stored in your browser's local storage and will not be shared.</p>
            <div>
                <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Google AI API Key</label>
                <input type="password" id="api-key-input" class="form-input">
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="close-modal-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-api-key-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let userApiKey = '';

            // --- Global API Key Management ---
            const globalSettingsBtn = document.getElementById('global-settings-btn');
            const apiKeyModal = document.getElementById('api-key-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiKeyInput = document.getElementById('api-key-input');

            function openModal() {
                apiKeyInput.value = localStorage.getItem('googleApiKey') || 'AIzaSyC2hF_f2tJGsQG6bp-zHnGmNLYf-1QbRxk';
                apiKeyModal.classList.remove('hidden');
            }

            function closeModal() {
                apiKeyModal.classList.add('hidden');
            }

            function saveApiKey() {
                const key = apiKeyInput.value.trim();
                localStorage.setItem('googleApiKey', key);
                userApiKey = key;
                if (!key) localStorage.removeItem('googleApiKey');
                closeModal();
            }
            
            globalSettingsBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            apiKeyModal.addEventListener('click', (e) => {
                if (e.target === apiKeyModal) closeModal();
            });

            // Check for API key on page load
            function checkApiKeyOnLoad() {
                userApiKey = localStorage.getItem('googleApiKey') || 'AIzaSyC2hF_f2tJGsQG6bp-zHnGmNLYf-1QbRxk';
                 if (!localStorage.getItem('googleApiKey')) {
                    localStorage.setItem('googleApiKey', userApiKey);
                }
            }
            checkApiKeyOnLoad();


            // --- Tab Switching Logic ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            function switchTab(targetTab) {
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === targetTab + '-content');
                });
                tabButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.tab === targetTab);
                });
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });
            switchTab('imager'); // Set default tab

            // --- Universal auto-resize for textareas ---
            function autoResizeTextarea(event) {
                const textarea = event.target;
                textarea.style.height = 'auto'; // Reset height
                textarea.style.height = (textarea.scrollHeight) + 'px'; // Set to scroll height
            }
            document.querySelectorAll('textarea.form-input').forEach(textarea => {
                autoResizeTextarea({ target: textarea }); // Set initial height
                textarea.addEventListener('input', autoResizeTextarea, false);
            });


            // --- Character Imager Script ---
            (() => {
                const imagerContent = document.getElementById('imager-content');
                const form = imagerContent.querySelector('#character-form');
                const generatePromptBtn = imagerContent.querySelector('#generate-prompt-btn');
                const copyPromptBtn = imagerContent.querySelector('#copy-prompt-btn');
                const generateImageBtn = imagerContent.querySelector('#generate-image-btn');
                const downloadImageBtn = imagerContent.querySelector('#download-image-btn');
                const generatedPromptEl = imagerContent.querySelector('#generated-prompt');
                const generatedImageEl = imagerContent.querySelector('#generated-image');
                const loadingSpinner = imagerContent.querySelector('#loading-spinner');
                const imagePlaceholder = imagerContent.querySelector('#image-placeholder');
                const errorMessageEl = imagerContent.querySelector('#error-message');
                const copyMessageEl = imagerContent.querySelector('#copy-message');

                generatePromptBtn.addEventListener('click', () => {
                    const formData = new FormData(form);
                    const attributes = Object.fromEntries(formData.entries());
                    
                    attributes.framing = imagerContent.querySelector('input[name="framing"]:checked').value;
                    attributes.style = imagerContent.querySelector('input[name="style"]:checked').value;

                    generatedImageEl.classList.add('hidden');
                    imagePlaceholder.classList.remove('hidden');
                    downloadImageBtn.classList.add('hidden');
                    errorMessageEl.textContent = '';
                    copyMessageEl.textContent = '';

                    let styleDescription = "";
                    switch (attributes.style) {
                        case 'photorealistic': styleDescription = "photorealistic, hyperdetailed, 8k, high quality"; break;
                        case 'anime': styleDescription = "anime art style, vibrant colors, clean line art, by studio ghibli"; break;
                        case 'sketch': styleDescription = "detailed pencil sketch, monochrome, cross-hatching, on textured paper"; break;
                        default: styleDescription = "realistic digital painting, detailed brushwork, dramatic lighting"; break;
                    }

                    let emphasizedDetails = (attributes.details && attributes.details.trim() !== '') ? `(${(attributes.details.trim())}:1.5)` : "";
                    let characterDescription = `a ${attributes.gender.toLowerCase() || 'character'} ${attributes.archetype.toLowerCase() || 'figure'}`;
                    let framingDescription = "";
                    switch (attributes.framing) {
                        case 'full_body': framingDescription = `Full body portrait of ${characterDescription}.`; break;
                        case 'sheet': framingDescription = `Character concept sheet for ${characterDescription}, multiple views including front, side, and back, plus a headshot. Plain background.`; break;
                        default: framingDescription = `Bust portrait (head and shoulders) of ${characterDescription}.`; break;
                    }
                    
                    const prompt = `${framingDescription}
                    **Appearance:** ${emphasizedDetails} ${attributes.build.toLowerCase()} build, ${attributes.height_ft} ft ${attributes.height_in} in tall, ~${attributes.weight} lbs. They have a ${attributes.faceShape.toLowerCase()} face, ${attributes.eyeColor.toLowerCase()} eyes, and ${attributes.skinTone.toLowerCase()} skin tone. Their hair is ${attributes.hairColor.toLowerCase()} and styled as ${attributes.hairStyle.toLowerCase()}. Notable features: ${attributes.scars || 'none'}, ${attributes.tattoos || 'none'}.
                    **Outfit:** Dressed in ${attributes.clothing.toLowerCase()}, wearing ${attributes.accessories.toLowerCase()}.
                    **Persona:** Their expression is ${attributes.expression.toLowerCase()}.
                    **Setting:** The background is a ${attributes.background.toLowerCase()}.
                    **Style:** ${styleDescription}`.replace(/\s+/g, ' ').trim();
                    
                    const negativePrompts = attributes.negative_prompts;
                    generatedPromptEl.value = `POSITIVE PROMPT:\n${prompt}\n\nNEGATIVE PROMPT:\n${negativePrompts}`;
                });

                copyPromptBtn.addEventListener('click', () => {
                    if (generatedPromptEl.value) {
                        navigator.clipboard.writeText(generatedPromptEl.value).then(() => {
                            copyMessageEl.textContent = 'Prompt copied to clipboard!';
                            setTimeout(() => { copyMessageEl.textContent = ''; }, 3000);
                        });
                    }
                });

                generateImageBtn.addEventListener('click', async () => {
                    if (!userApiKey) {
                        errorMessageEl.textContent = 'API Key not set. Please add it in the settings (gear icon).';
                        openModal();
                        return;
                    }
                    
                    const fullPromptText = generatedPromptEl.value;
                    if (!fullPromptText) {
                        errorMessageEl.textContent = 'Please generate a prompt first.';
                        return;
                    }

                    const promptParts = fullPromptText.split('NEGATIVE PROMPT:');
                    const positivePrompt = promptParts[0].replace('POSITIVE PROMPT:', '').trim();
                    const negativePrompt = promptParts[1] ? promptParts[1].trim() : "";

                    setIsLoading(true);

                    try {
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${userApiKey}`;
                        const payload = {
                            instances: [{ prompt: positivePrompt, negativePrompt: negativePrompt }],
                            parameters: { "sampleCount": 1 }
                        };
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }
                        const result = await response.json();
                        if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                            const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                            generatedImageEl.src = imageUrl;
                            generatedImageEl.classList.remove('hidden');
                            imagePlaceholder.classList.add('hidden');
                            downloadImageBtn.classList.remove('hidden');
                        } else {
                            throw new Error('API returned a valid response but no image data was found.');
                        }
                    } catch (err) {
                        console.error("Image generation failed:", err);
                        errorMessageEl.textContent = `Error: ${err.message}`;
                    } finally {
                        setIsLoading(false);
                    }
                });

                downloadImageBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.href = generatedImageEl.src;
                    link.download = 'character_image.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });

                function setIsLoading(loading) {
                    generateImageBtn.disabled = loading;
                    loadingSpinner.classList.toggle('hidden', !loading);
                    imagePlaceholder.classList.toggle('hidden', loading);
                    generatedImageEl.classList.add('hidden');
                    downloadImageBtn.classList.add('hidden');
                    if(loading) errorMessageEl.textContent = '';
                }
            })();

            // --- Character Profiler Script ---
            (() => {
                const fieldDefinitions = [
                    { name: 'name', label: 'Name' },
                    { name: 'genre', label: 'Genre' },
                    { name: 'core-description', label: 'Core Description' },
                    { name: 'appearance', label: 'Appearance' },
                    { name: 'backstory', label: 'Backstory' },
                    { name: 'personality', label: 'Personality' },
                    { name: 'skills', label: 'Skills' },
                    { name: 'abilities', label: 'Abilities' },
                    { name: 'goals', label: 'Goals' },
                    { name: 'motivations', label: 'Motivations' },
                    { name: 'weaknesses', label: 'Weaknesses' },
                    { name: 'equipment', label: 'Equipment' },
                    { name: 'relationships', label: 'Relationships' },
                    { name: 'notes', label: 'Notes' }
                ];

                const profilerContainer = document.getElementById('profiler-content');
                if (!profilerContainer) return;

                const form = profilerContainer.querySelector('#character-form-profiler');
                const generateBtn = profilerContainer.querySelector('#generate-btn-profiler');
                const copyFeedbackEl = profilerContainer.querySelector('#copy-feedback-profiler');
                
                const outputs = {
                    workup: profilerContainer.querySelector('#output-workup'),
                    markdown: profilerContainer.querySelector('#output-markdown'),
                    json: profilerContainer.querySelector('#output-json')
                };

                async function callGemini(prompt, outputElement) {
                    outputElement.textContent = 'Generating...';
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${userApiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            let errorMsg = errorData.error?.message || 'An unknown error occurred.';
                            if (response.status === 403) errorMsg = "API Key is invalid or missing. Please provide a valid key in Settings. " + errorMsg;
                            displayError(outputElement, `API Request Failed (Status: ${response.status})`, errorMsg);
                            return null;
                        }

                        const result = await response.json();
                         if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            let errorMessage = "No content generated. The model returned an empty response.";
                            if (result.promptFeedback?.blockReason) errorMessage = `Request blocked. Reason: ${result.promptFeedback.blockReason}. Please adjust your input.`;
                            displayError(outputElement, "Generation Error", errorMessage);
                            return null;
                        }
                    } catch (error) {
                        console.error("Error during API call:", error);
                        displayError(outputElement, "An unexpected error occurred.", `Failed to connect to the API. Check your network connection. Error: ${error.message}`);
                        return null;
                    }
                }

                function displayError(element, message, details = '') {
                    element.innerHTML = `<div class="error-message" style="height: auto; overflow: visible;"><p class="font-bold">${message}</p><p class="text-sm mt-2">${details}</p></div>`;
                }
                
                function setupEventListeners() {
                    profilerContainer.querySelectorAll('.form-input').forEach(input => {
                         const wrapper = input.closest('.input-wrapper');
                         if (!wrapper) return;
                         const checkbox = wrapper.querySelector('input[type="checkbox"]');
                         if(input && checkbox) {
                            input.addEventListener('input', () => {
                                if (input.value.trim() !== '') {
                                    checkbox.checked = false;
                                }
                            });
                        }
                    });
                }

                async function generateAllOutputs() {
                    if (!userApiKey) {
                        openModal();
                        return;
                    }

                    generateBtn.disabled = true;
                    generateBtn.textContent = 'Generating...';
                    
                    Object.values(outputs).forEach(o => o.textContent = '');

                    const formData = new FormData(form);
                    const allFieldsData = [];
                    const sectionsToGenerate = [];
                    let isAnyBoxChecked = false;

                    fieldDefinitions.forEach(field => {
                        const value = formData.get(field.name)?.trim() || '';
                        allFieldsData.push(`- **${field.label}:** ${value}`);
                        const checkbox = profilerContainer.querySelector(`#cb-${field.name}`);
                        if (checkbox && checkbox.checked) {
                            isAnyBoxChecked = true;
                            sectionsToGenerate.push(field.label);
                        }
                    });

                    if (!isAnyBoxChecked) {
                        displayError(outputs.workup, "No fields to generate.", "Please check the box next to at least one field.");
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'Generate';
                        return;
                    }

                    let basePrompt = `Generate a complete and cohesive character profile based on the following data.
**USER-PROVIDED DATA:**
Here is the information provided by the user. Use this as the primary context for the entire character.
${allFieldsData.join('\n')}

**YOUR TASK:**
Your goal is to create a single, complete, and cohesive character profile based on the data above. Follow these rules:
1. **Integrate Existing Data:** All non-empty fields from the "USER-PROVIDED DATA" must be thoughtfully integrated into the final character.
2. **Generate and Refine:** You must generate new, compelling content for any empty fields. Additionally, you must specifically focus on the following sections, even if they already have content: **${sectionsToGenerate.join(', ')}**. For these specific sections, treat any existing user data as a suggestion to be expanded upon, refined, or improved to create a more compelling character.

**OUTPUT FORMAT:**
Return the **complete and final character profile** as a single document. Use each field name from the original list as a bold heading (e.g., **Name**), followed by the full content for that section. Ensure every single field is present in your output.`;
                    
                    const workupOutput = await callGemini(basePrompt, outputs.workup);
                    if (!workupOutput) {
                        generateBtn.disabled = false; generateBtn.textContent = 'Generate'; return;
                    }
                    outputs.workup.textContent = workupOutput;
                    
                    const markdownPrompt = `Take the following character workup and condense it into a Markdown format. It should be optimized for short notes, using headings and bullet points for clarity. Do not omit key information, but be concise.\n\n---START WORKUP---\n${workupOutput}\n---END WORKUP---`;
                    const markdownOutput = await callGemini(markdownPrompt, outputs.markdown);
                    if (!markdownOutput) {
                         generateBtn.disabled = false; generateBtn.textContent = 'Generate'; return;
                    }
                    outputs.markdown.textContent = markdownOutput;

                    const jsonPrompt = `Distill the following Markdown character sheet into a basic and simplified JSON object. The JSON should be optimized for chatbot token economy. Use simple key-value pairs. For lists like skills or equipment, use an array of strings. The entire output must be a single, valid JSON object only.\n\n---START MARKDOWN---\n${markdownOutput}\n---END MARKDOWN---`;
                    const jsonOutput = await callGemini(jsonPrompt, outputs.json);
                    if (jsonOutput) {
                        let cleanedJson = jsonOutput.trim().replace(/^```json\s*|```$/g, '');
                        try {
                            const parsed = JSON.parse(cleanedJson);
                            outputs.json.textContent = JSON.stringify(parsed, null, 2);
                        } catch (e) {
                            console.error("Failed to parse JSON:", e);
                            displayError(outputs.json, "JSON Parsing Error", "The model returned invalid JSON. Raw output:\n" + cleanedJson);
                        }
                    }
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                }
                
                function copyToClipboard(elementId) {
                    const textToCopy = profilerContainer.querySelector("#" + elementId).textContent;
                    if (textToCopy && !profilerContainer.querySelector("#" + elementId).querySelector('.error-message')) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                           copyFeedbackEl.textContent = `Copied ${elementId.split('-')[1]}!`;
                           setTimeout(() => { copyFeedbackEl.textContent = ''; }, 2000);
                        });
                    }
                }

                function saveAsTextFile(elementId, format) {
                    const textToSave = profilerContainer.querySelector("#" + elementId).textContent;
                     if (!textToSave || profilerContainer.querySelector("#" + elementId).querySelector('.error-message')) return;

                    const characterName = profilerContainer.querySelector('#name-profiler').value.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'character';
                    const filename = `${characterName}_profile.${format}`;
                    const blob = new Blob([textToSave], { type: `text/${format};charset=utf-8` });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }

                setupEventListeners();
                if(generateBtn) generateBtn.addEventListener('click', generateAllOutputs);
                
                profilerContainer.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', (e) => copyToClipboard(e.currentTarget.getAttribute('data-target')));
                });
                profilerContainer.querySelectorAll('.save-btn').forEach(button => {
                    button.addEventListener('click', (e) => saveAsTextFile(e.currentTarget.getAttribute('data-target'), e.currentTarget.getAttribute('data-format')));
                });
            })();
        });
    </script>
</body>
</html>
