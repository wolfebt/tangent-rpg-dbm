<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRPG Map Maker</title>
    <link rel="stylesheet" href="../css/dbm-style.css">
    <link rel="stylesheet" href="../css/mmstyle.css">
</head>
<body>
    <svg width="0" height="0" style="position:absolute;z-index:-1;">
        <defs>
            <pattern id="pattern-water" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#4c92c8"/><path d="M-5,5 Q-2.5,0 0,5 T5,5 T10,5 T15,5" stroke="#2b5a7a" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-sand" width="6" height="6" patternUnits="userSpaceOnUse"><rect width="6" height="6" fill="#f0d9a0"/><circle cx="1" cy="1" r="1" fill="#b59a72"/><circle cx="4" cy="4" r="1" fill="#b59a72"/></pattern>
            <pattern id="pattern-grass" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#86c440"/><path d="M0,10 L5,0 L10,10" stroke="#4d7225" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-plains" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#a6d15a"/><path d="M0 6 H12 M6 0 V12" stroke="#6d8e35" stroke-width="0.5"/></pattern>
            <pattern id="pattern-forest" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#4a8232"/><path d="M2 10 L6 2 L10 10 Z" fill="#2a4d1c"/></pattern>
            <pattern id="pattern-hills" width="15" height="15" patternUnits="userSpaceOnUse"><rect width="15" height="15" fill="#a08b6b"/><path d="M0 15 C 5 0, 10 0, 15 15" stroke="#6b5a46" stroke-width="2" fill="none"/></pattern>
            <pattern id="pattern-mountain" width="16" height="16" patternUnits="userSpaceOnUse"><rect width="16" height="16" fill="#6f6f6f"/><path d="M0 16 L8 0 L16 16 Z" stroke="#404040" stroke-width="1" fill="#707070"/></pattern>
            <pattern id="pattern-snow" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#ffffff"/><path d="M0 5 H10 M5 0 V10 M2 2 L8 8 M2 8 L8 2" stroke="#c0c0c0" stroke-width="1"/></pattern>
            <pattern id="pattern-dirt" width="8" height="8" patternUnits="userSpaceOnUse"><rect width="8" height="8" fill="#a07040"/><path d="M0 0 L8 8 M8 0 L0 8" stroke="#6b4a25" stroke-width="0.5"/></pattern>
            <pattern id="pattern-road" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#b0a89f"/><rect x="3" y="0" width="4" height="10" fill="#888279"/></pattern>
            <pattern id="pattern-lava" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#e25822"/><circle cx="6" cy="6" r="5" fill="#e06030" opacity="0.5"/><circle cx="3" cy="9" r="3" fill="#cc3700" opacity="0.6"/></pattern>
            <pattern id="pattern-crags" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#5a5a5a"/><path d="M0 10 L5 0 L10 10" stroke="#303030" stroke-width="1.5" fill="none"/><path d="M0 5 L10 5" stroke="#303030" stroke-width="1" fill="none"/></pattern>
            <pattern id="pattern-swamp" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="#4d6642"/><path d="M-2,6 Q1,3 4,6 T10,6" stroke="#2c3e23" stroke-width="1.5" fill="none"/><circle cx="9" cy="3" r="1" fill="#526d1a"/></pattern>
            <pattern id="pattern-tundra" width="10" height="10" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="#cdd3d6"/><path d="M0 0 L10 10 M10 0 L0 10" stroke="#90989a" stroke-width="0.5"/></pattern>
        </defs>
    </svg>

    <div id="main-container" class="app-container">
        <div id="panelWrapper">
            <div class="control-container p-4 flex flex-col">
                <!-- Header -->
                <div class="sidebar-header flex-shrink-0">
                    <div class="flex justify-between items-center mb-4 relative">
                        <h2 class="text-2xl font-bold">Map Maker</h2>
                        <div>
                            <button id="fileMenuBtn" class="p-2 rounded-md hover:bg-gray-700">File</button>
                            <div id="fileDropdownMenu" class="file-dropdown hidden">
                                <button id="saveProjectBtn" class="file-dropdown-item">Save Project</button>
                                <button id="loadProjectBtn" class="file-dropdown-item">Load Project</button>
                                <button id="savePngBtn" class="file-dropdown-item">Export as PNG</button>
                            </div>
                            <input type="file" id="loadJsonInput" class="hidden" accept=".json">
                        </div>
                    </div>

                    <!-- Project Name -->
                    <div class="control-panel mb-4">
                        <label for="projectNameInput">Project Name</label>
                        <input type="text" id="projectNameInput" value="Untitled Campaign">
                    </div>
                </div>

                <div class="sidebar-content flex-grow">
                    <!-- Tools -->
                    <div class="control-panel mb-4">
                        <h3 class="accordion-header">Tools</h3>
                        <div class="accordion-content">
                            <div class="grid grid-cols-3 gap-2">
                                <button id="toolTerrainBtn" class="tool-btn active">Terrain</button>
                                <button id="toolObjectBtn" class="tool-btn">Object</button>
                                <button id="toolPencilBtn" class="tool-btn">Pencil</button>
                                <button id="toolTokenBtn" class="tool-btn">Token</button>
                                <button id="toolTextBtn" class="tool-btn">Text</button>
                                <button id="toolFogBtn" class="tool-btn">Fog</button>
                                <button id="toolSelectBtn" class="tool-btn">Select</button>
                                <div class="relative">
                                    <button id="eraserToolBtn">Eraser</button>
                                    <div id="eraserDropdownMenu" class="file-dropdown hidden">
                                        <button id="eraseTerrainBtn" class="file-dropdown-item">Erase Terrain</button>
                                        <button id="eraseObjectsBtn" class="file-dropdown-item">Erase Objects</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Tool Options -->
                            <div id="terrainContentPanel">
                                <div class="control-panel mb-4">
                                    <label for="brushSize">Brush Size: <span id="brushSizeValue">1</span></label>
                                    <input type="range" id="brushSize" min="1" max="10" value="1">
                                    <div id="terrainSelector" class="flex flex-col gap-2 mt-2"></div>
                                </div>
                            </div>
                            <div id="objectOptionsPanel" class="hidden">
                                 <div class="control-panel mb-4">
                                    <div id="objectSelector" class="flex flex-col gap-2"></div>
                                </div>
                            </div>
                            <div id="pencilOptionsPanel" class="hidden">
                                <div class="control-panel mb-4">
                                     <label for="pencilColorPicker">Color</label>
                                     <input type="color" id="pencilColorPicker" value="#FFFFFF">
                                     <label for="pencilWidth">Width: <span id="pencilWidthValue">5</span></label>
                                     <input type="range" id="pencilWidth" min="1" max="50" value="5">
                                     <input type="checkbox" id="pencilGmOnlyCheckbox"> <label for="pencilGmOnlyCheckbox">GM Only</label>
                                </div>
                            </div>
                            <!-- Other tool panels here -->
                            <div id="selectedObjectPanel" class="hidden">
                                <div class="control-panel mb-4">
                                    <h3>Selected Object</h3>
                                    <button id="asset-delete-btn">Delete</button>
                                    <button id="asset-rotate-left-btn">Rotate Left</button>
                                    <button id="asset-rotate-right-btn">Rotate Right</button>
                                    <button id="asset-scale-up-btn">Scale Up</button>
                                    <button id="asset-scale-down-btn">Scale Down</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Actions -->
                    <div class="control-panel mb-4">
                        <h3 class="accordion-header">Actions</h3>
                        <div class="accordion-content">
                            <button id="addNewMapBtn">New Map</button>
                            <button id="assetEditorBtn">Asset Editor</button>
                            <button id="resetViewBtn">Center View</button>
                            <button id="undoBtn">Undo</button>
                            <button id="redoBtn">Redo</button>
                        </div>
                    </div>

                    <!-- AI Assistant -->
                    <div class="control-panel mb-4">
                        <h3 class="accordion-header">AI Assistant</h3>
                        <div class="accordion-content">
                            <div class="ai-controls-column">
                                <input type="text" id="ai-prompt-initial" placeholder="Describe an asset to generate...">
                                <select id="ai-drawing-style">
                                    <option>Watercolor</option>
                                    <option>Oil Painting</option>
                                    <option>Pixel Art</option>
                                </select>
                                <select id="ai-color-style">
                                    <option>Vibrant</option>
                                    <option>Muted</option>
                                    <option>Sepia</option>
                                </select>
                                <button id="ai-generate-btn"><span class="btn-text">Generate</span><span class="spinner hidden"></span></button>
                                <hr>
                                <input type="text" id="ai-prompt-refine" placeholder="Describe changes...">
                                <button id="ai-update-btn" disabled><span class="btn-text">Update</span><span class="spinner hidden"></span></button>
                                <button id="ai-transfer-btn" disabled>Transfer to Layer</button>
                            </div>
                            <div id="ai-render-area">
                                <span>AI generations will appear here</span>
                                <img id="ai-image-output" class="hidden"/>
                            </div>
                        </div>
                    </div>

                    <!-- Layers -->
                    <div class="control-panel mb-4">
                        <h3 class="accordion-header">Layers</h3>
                        <div class="accordion-content">
                            <div id="layerList" class="flex flex-col gap-2"></div>
                            <button id="addLayerBtn">Add Layer</button>
                            <button id="deleteLayerBtn">Delete Layer</button>
                        </div>
                    </div>

                    <!-- Grid -->
                    <div class="control-panel mb-4">
                        <h3 class="accordion-header">Grid</h3>
                        <div class="accordion-content">
                            <input type="checkbox" id="gridVisibleCheckbox" checked> <label for="gridVisibleCheckbox">Visible</label>
                            <input type="color" id="gridColorPicker" value="#000000">
                        </div>
                    </div>

                    <!-- Procedural Generation -->
                    <div class="control-panel mb-4">
                        <h3 class="accordion-header">Procedural Generation</h3>
                        <div class="accordion-content">
                            <button id="proceduralGenBtn">Generate Landmass</button>
                        </div>
                    </div>

                     <!-- General Buttons -->
                    <div class="control-panel">
                        <button id="userGuideBtn">User Guide</button>
                        <button id="settingsBtn">Settings</button>
                        <button id="mapKeyBtn">Map Key</button>
                        <button id="gmViewToggleBtn">
                            <span id="gmViewIconOn">GM View ON</span>
                            <span id="gmViewIconOff" class="hidden">GM View OFF</span>
                        </button>
                    </div>
                </div>

            </div>
            <div id="resizer"></div>
        </div>
        <div id="canvas-container">
            <canvas id="mapCanvas"></canvas>
            <canvas id="uiCanvas"></canvas>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="apiKeyModal" class="modal-backdrop hidden">
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-lg font-bold mb-4">Enter API Key</h3>
            <input type="text" id="apiKeyInput" class="w-full p-2 rounded border">
            <button id="saveApiKey">Save</button>
            <button id="cancelApiKey">Cancel</button>
        </div>
    </div>

    <div id="newMapModal" class="modal-backdrop hidden">
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-lg font-bold mb-4">Create New Map</h3>
            <input type="text" id="newMapNameInput" placeholder="Map Name">
            <input type="number" id="newMapWidthInput" placeholder="Width" value="50">
            <input type="number" id="newMapHeightInput" placeholder="Height" value="50">
            <button id="confirmNewMapBtn">Create</button>
            <button id="cancelNewMapBtn">Cancel</button>
        </div>
    </div>

    <!-- Map Key -->
    <div id="mapKeyWindow" class="hidden" style="position: absolute; top: 100px; left: 350px; width: 200px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; z-index: 10;">
        <div id="mapKeyHeader" style="padding: 5px; cursor: move; background: #444;">Map Key <button id="mapKeyCloseBtn" style="float: right;">X</button></div>
        <div id="mapKeyContent" style="padding: 5px;"></div>
    </div>

    <!-- Asset Context Menu -->
    <div id="asset-context-menu" class="hidden" style="position: absolute; background: #333; color: white; border: 1px solid #555; border-radius: 5px; z-index: 10;">
        <button id="asset-delete-btn">Delete</button>
    </div>

    <!-- Asset Editor -->
    <div id="asset-editor-overlay" class="hidden">
        <div class="asset-editor-main">
            <div class="asset-editor-top-bar">
                <h2 class="text-2xl font-bold text-gray-100">AI-Assisted Asset Editor</h2>
                <button id="asset-editor-close-btn" title="Close Editor">&times;</button>
            </div>
            <div class="asset-editor-content">
                <!-- LEFT PANEL -->
                <div class="asset-editor-left-panel">
                    <div class="control-panel">
                        <label for="asset-type-select">Asset Type</label>
                        <select id="asset-type-select">
                            <option value="object">Object / Icon</option>
                            <option value="terrain">Terrain Pattern</option>
                        </select>
                    </div>
                    <div class="control-panel">
                        <h3>AI Generation</h3>
                        <label for="asset-prompt">Prompt</label>
                        <textarea id="asset-prompt" rows="4" placeholder="e.g., A single, stylized fantasy oak tree icon, no background, watercolor style..."></textarea>
                        <button id="asset-generate-btn">Generate</button>
                    </div>
                    <div class="control-panel">
                        <h3>Manual Tools</h3>
                        <div class="asset-tool-palette">
                            <button class="asset-tool active" data-tool="pencil" title="Pencil"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                            <button class="asset-tool" data-tool="eraser" title="Eraser"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg></button>
                            <input type="color" id="asset-color-picker" value="#FFFFFF" title="Color Picker">
                        </div>
                        <label for="asset-brush-size">Brush Size: <span id="asset-brush-size-value">5</span></label>
                        <input type="range" id="asset-brush-size" min="1" max="50" value="5">
                    </div>
                </div>
                <!-- CENTER PANEL -->
                <div class="asset-editor-center-panel">
                    <div id="loading-overlay" class="hidden">Generating...</div>
                    <div id="asset-canvas-container">
                        <canvas id="asset-canvas-main" width="512" height="512"></canvas>
                        <canvas id="asset-canvas-draw" width="512" height="512"></canvas>
                    </div>
                </div>
                <!-- RIGHT PANEL -->
                <div class="asset-editor-right-panel">
                    <div id="asset-preview-panel" class="control-panel hidden">
                        <h3>Tiling Preview</h3>
                        <canvas id="asset-preview-canvas" width="240" height="240"></canvas>
                    </div>
                     <div class="control-panel">
                        <h3>Save to Library</h3>
                        <label for="asset-name">Asset Name</label>
                        <input type="text" id="asset-name" placeholder="e.g., Oak Tree">
                        <label for="asset-tags">Tags (comma-separated)</label>
                        <input type="text" id="asset-tags" placeholder="fantasy, world, vegetation">
                        <button id="asset-export-btn">Save to Library</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/noisejs@2.1.0/index.min.js"></script>
    <script type="module" src="../js/state.js"></script>
    <script type="module" src="../js/mmtools-script.js"></script>
    <script type="module" src="../js/mmassist-script.js"></script>
    <script type="module" src="../js/asset-editor.js"></script>
</body>
</html>
