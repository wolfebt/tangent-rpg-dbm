<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Wolfe.bt@TangentLLC">
    <title>Writer AId</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Verdana', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stage { display: none; }
        .stage.active { display: block; }
        .idea-card {
            border: 2px solid #374151;
            transition: border-color 0.3s, transform 0.2s;
        }
        .idea-card.selected-card {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #374151; }
        :disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #status-message {
            transition: opacity 0.5s ease-in-out;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        #project-title {
            outline: none;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s;
        }
        #project-title:focus {
            border-bottom-color: #3b82f6;
        }
        .editable-area {
            outline: none;
            transition: box-shadow 0.2s;
        }
        .editable-area:focus {
            box-shadow: 0 0 0 2px #2563eb;
        }
        .asset-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .asset-input {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            color: #d1d5db;
        }
        .asset-input:focus {
            outline: none;
            border-color: #2563eb;
        }
        .storyboard-panel {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .storyboard-panel .panel-loader {
            width: 3rem;
            height: 3rem;
        }
        .main-tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            transition: all 0.2s;
        }
        .main-tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .main-tab-btn:not(.active):hover {
            color: white;
            border-bottom-color: #4b5563;
        }
        .nav-btn-side {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            color: #9ca3af;
        }
        .nav-btn-side.active {
            background-color: #2563eb;
            color: white;
        }
        .nav-btn-side:not(.active):hover {
            background-color: #374151;
            color: white;
        }
        /* Styles adapted for Character/Scene Tools */
        .tool-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        textarea.tool-input {
            resize: vertical;
            overflow-y: hidden;
            line-height: 1.5;
            min-height: calc(1.5em + 1.2rem); 
        }
        .tool-input:focus {
            outline: none;
            border-color: #2563eb;
            background-color: #4b5563;
        }
        .tool-section-header {
            font-weight: bold;
            font-size: 1.25rem;
            color: #60a5fa;
            border-bottom: 1px solid #4b5563;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
         .tool-output-box {
            background-color: #111827;
            border: 1px solid #374151;
            padding: 1rem; border-radius: 0.5rem;
            min-height: 250px; overflow-y: auto;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-custom-radio-label {
            display: block;
            background-color: #374151;
            color: #9ca3af;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .tool-custom-radio-label:hover { background-color: #4b5563; }
        input[type="radio"]:checked + .tool-custom-radio-label {
            background-color: #2563eb;
            color: white;
            border-color: #60a5fa;
        }
        .collapsible-content {
            margin-top: 1rem;
        }
        .path-gem {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            min-height: 3.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            background-color: #374151;
            border: 1px solid #4b5563;
            text-align: left;
            transition: all 0.2s;
            cursor: pointer;
        }
        .path-gem:hover {
            border-color: #2563eb;
            background-color: #4b5563;
        }
        .path-gem-label {
            font-weight: 600;
            color: #9ca3af;
            font-size: 0.75rem;
            line-height: 1;
        }
        .path-gem-value {
            display: none; /* Hidden by default */
            color: #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 0.125rem;
        }
        /* When gem has a value, show the value span */
        .path-gem.has-value .path-gem-value {
            display: block;
        }
        /* When gem has no value, center the label and make it bigger */
        .path-gem:not(.has-value) {
            align-items: center;
        }
        .path-gem:not(.has-value) .path-gem-label {
            font-size: 0.875rem;
        }
        .ai-toggle-btn {
            background-color: #374151;
            border: 2px solid #4b5563;
            border-radius: 50%;
            width: 1.5rem; /* ~24px */
            height: 1.5rem;
            flex-shrink: 0;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 120ms ease-in-out;
        }
        .ai-toggle-btn::before {
            content: "";
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            background-color: #d1d5db;
        }
        .ai-toggle-btn.active {
            background-color: #2563eb;
            border-color: #60a5fa;
        }
        .ai-toggle-btn.active::before {
            transform: scale(1);
        }
        .tool-input:disabled {
            background-color: #262e3d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .accordion-section {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .accordion-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #e5e7eb;
            background-color: #374151;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .accordion-header.needs-attention {
             border-bottom-color: #FBBF24;
        }
        .accordion-header svg {
            transition: transform 0.2s;
        }
        .accordion-section.open .accordion-header svg {
            transform: rotate(180deg);
        }
        .accordion-content {
            display: none;
            padding: 1.5rem;
        }
        .accordion-section.open .accordion-content {
            display: block;
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-screen-xl p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-4 relative">
            <h1 class="text-4xl font-bold text-white">Writer AId</h1>
            <p class="text-lg text-gray-400 mt-2">Your AI-powered partner for literary creation, character design, and scene building.</p>
             <button id="settings-btn" class="absolute top-0 right-0 p-2 rounded-lg btn-secondary bg-gray-700/50 hover:bg-gray-600/50" title="Settings">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0l-.1.41a2 2 0 01-2.23 1.52l-.4-.1a2 2 0 00-2.2 2.2l.1.4a2 2 0 01-1.52 2.23l-.41.1c-1.56.38-1.56 2.6 0 2.98l.41.1a2 2 0 011.52 2.23l-.1.4a2 2 0 002.2 2.2l.4-.1a2 2 0 012.23 1.52l.1.41c.38 1.56 2.6 1.56 2.98 0l.1-.41a2 2 0 012.23-1.52l.4.1a2 2 0 002.2-2.2l-.1-.4a2 2 0 011.52-2.23l.41-.1c-1.56-.38-1.56-2.6 0-2.98l-.41-.1a2 2 0 01-1.52-2.23l.1-.4a2 2 0 00-2.2-2.2l-.4.1a2 2 0 01-2.23-1.52l-.1-.41zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
            </button>
             <div class="mt-4">
                  <h2 id="project-title" contenteditable="true" title="Click to edit project title" class="text-2xl font-semibold text-gray-300 inline-block p-1 rounded-md hover:bg-gray-700/50 cursor-pointer">Untitled Project</h2>
             </div>
        </header>

        <!-- MAIN TABS -->
        <div class="border-b border-gray-700 mb-6">
            <nav class="-mb-px flex space-x-6 justify-center" aria-label="Tabs">
                <button id="tab-story" data-tab="story-weaver" class="main-tab-btn active">Story Weaver</button>
                <button id="tab-character" data-tab="character-tool" class="main-tab-btn">Character Tool</button>
                <button id="tab-scene" data-tab="scene-builder" class="main-tab-btn">Scene Builder</button>
                <button id="tab-setting" data-tab="setting-tool" class="main-tab-btn">Setting Tool</button>
            </nav>
        </div>
        
        <div id="story-weaver-content-wrapper" class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:items-start">
            <aside id="story-weaver-sidebar" class="lg:col-span-3 h-fit lg:sticky top-8 space-y-6">
                <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between gap-4 mb-4">
                        <button id="project-options-btn" class="flex-1 py-2 px-3 text-sm rounded-lg font-semibold btn-primary">
                            Project
                        </button>
                    </div>

                    <!-- Guidance Block -->
                    <div class="accordion-section open">
                        <button type="button" class="accordion-header !p-3 !bg-gray-800">
                            <span>Guidance</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content !p-3">
                            <p class="text-xs text-gray-400 mb-3">Define the core parameters for generation.</p>
                            <div id="form-guidance-gems-container" class="space-y-2">
                                <!-- JS Populated -->
                            </div>
                        </div>
                    </div>

                    <!-- Components Block -->
                    <div class="accordion-section mt-4">
                         <button type="button" class="accordion-header !p-3 !bg-gray-800">
                            <span>Components</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content !p-3">
                            <p class="text-xs text-gray-400 mb-3">Add deeper narrative layers to guide the AI.</p>
                            <div id="optional-gems-container" class="space-y-2">
                                <!-- JS Populated -->
                            </div>
                        </div>
                    </div>
                    
                    <span id="status-message" class="text-sm text-gray-400 opacity-0 h-4 block text-center mt-4"></span>
                </div>

                <nav class="bg-gray-900/50 border border-gray-700 rounded-lg p-4 space-y-2">
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">Story Workflow</h3>
                    <button data-stage="brainstorm" class="nav-btn-side active">1. Brainstorm</button>
                    <button data-stage="outline" class="nav-btn-side">2. Outline</button>
                    <button data-stage="treatment" class="nav-btn-side">3. Treatment</button>
                    <button data-stage="write" class="nav-btn-side">4. Write</button>
                    <button data-stage="storyboard" class="nav-btn-side">5. Storyboard</button>
                </nav>

                <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                    <h2 class="text-xl font-bold mb-4 text-blue-400">Story Assets</h2>
                    <p class="text-sm text-gray-400 mb-4">Load assets to provide context for the Story Weaver AI.</p>
                    <button id="load-asset-btn" class="w-full py-2 px-4 rounded-lg font-semibold btn-secondary mb-4">Load Asset(s)</button>
                    <input type="file" id="asset-file-input" class="hidden" accept=".json,.txt,.md,.markdown,image/*" multiple>
                    
                    <div id="asset-container" class="space-y-4 max-h-[40vh] overflow-y-auto">
                        <!-- Loaded assets will be dynamically inserted here -->
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-9">
                <!-- STORY WEAVER TAB CONTENT -->
                <div id="story-weaver" class="tab-content active">
                    
                    <div id="brainstorm" class="stage active">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-2 text-white">Creative Brainstorming</h2>
                            <p class="text-gray-400 mb-6">Kickstart your creativity. Select what you want to brainstorm by clicking the "Type" gem above. Then give the AI a theme (e.g., 'a detective in a cyberpunk city'), and it will generate unique, detailed concepts to build upon.</p>
                            <textarea id="brainstorm-input" class="w-full h-32 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter a theme or concept..."></textarea>
                            <label for="brainstorm-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2 mt-4">Secondary Guidance (Optional)</label>
                            <textarea id="brainstorm-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Focus on a tragic hero, set it in a post-apocalyptic world..."></textarea>
                            <button id="generate-ideas-btn" class="mt-4 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Concepts</button>
                        </div>
                        <div id="ideas-output" class="mt-8 grid gap-6 md:grid-cols-1"></div>
                        <div id="ideas-loader" class="hidden"><div class="loader"></div></div>
                    </div>
                    <div id="outline" class="stage">
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                              <h2 class="text-2xl font-semibold mb-2 text-white">Create a Story Outline</h2>
                              <p class="text-gray-400 mb-6">Give your story a backbone. Your chosen concept from the Brainstorm stage will appear below, but you can also type or paste your own. Choose a narrative structure and audience by clicking the gems above. Use 'Secondary Guidance' to add specific instructions, like 'make sure the protagonist has a secret'.</p>
                              <label class="block text-sm font-medium text-gray-400 mb-2">Your Concept</label>
                              <div id="chosen-idea-display" contenteditable="true" class="editable-area p-4 mb-4 bg-gray-900 border-2 border-gray-700 rounded-lg text-gray-300 min-h-[5rem]"><span class="text-gray-500">Select a concept from the Brainstorm tab, or type/paste your own concept here.</span></div>
                              <label for="outline-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2 mt-4">Secondary Guidance (Optional)</label>
                              <textarea id="outline-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Make the second act focus on a betrayal, ensure the ending is a cliffhanger..."></textarea>
                              <button id="generate-outline-btn" class="mt-4 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Outline</button>
                         </div>
                        <div id="outline-output" class="mt-8"></div>
                        <div id="outline-loader" class="hidden"><div class="loader"></div></div>
                    </div>
                    <div id="treatment" class="stage">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                              <h2 class="text-2xl font-semibold mb-2 text-white">Develop a Story Treatment</h2>
                              <p class="text-gray-400 mb-6">Bring your outline to life. A 'treatment' is a prose summary of your entire story, like a detailed short story. It helps you understand the flow and key moments before you start writing scenes. Your outline will be loaded automatically. Tell the AI the final format by clicking the "Format" gem above.</p>
                              <label class="block text-sm font-medium text-gray-400 mb-2">Your Outline</label>
                              <div id="chosen-outline-display" contenteditable="true" class="editable-area p-4 mb-4 bg-gray-900 border-2 border-gray-700 rounded-lg text-gray-300 min-h-[5rem] max-h-48 overflow-y-auto"><span class="text-gray-500">Generate an outline in the previous step, or type/paste your own outline here.</span></div>
                              <label for="treatment-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2 mt-4">Secondary Guidance (Optional)</label>
                              <textarea id="treatment-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Emphasize the romantic subplot, write in a gritty, noir style..."></textarea>
                              <button id="generate-treatment-btn" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Treatment from Outline</button>
                        </div>
                        <div id="treatment-output" class="mt-8"></div>
                        <div id="treatment-loader" class="hidden"><div class="loader"></div></div>
                    </div>
                    <div id="write" class="stage">
                        <div id="ai-action-bar" class="hidden sticky top-8 z-10 bg-gray-800/95 backdrop-blur-sm border border-gray-700 p-2 rounded-lg flex items-center gap-4 mb-4">
                            <span class="text-sm font-semibold text-gray-300">AI Toolkit:</span>
                            <div id="ai-toolbar-buttons" class="flex items-center gap-2">
                                <button class="ai-toolbar-btn" id="ai-expand-btn">Expand</button>
                                <button class="ai-toolbar-btn" id="ai-rewrite-btn">Rewrite</button>
                                <div id="ai-custom-prompt-container" class="hidden items-center gap-2">
                                    <input type="text" id="ai-toolbar-prompt" placeholder="Your prompt...">
                                    <button class="ai-toolbar-btn" id="ai-custom-submit-btn">Submit</button>
                                </div>
                                <button class="ai-toolbar-btn" id="ai-ask-btn">Ask AI...</button>
                            </div>
                            <div id="ai-toolbar-loader" class="hidden">
                                <div class="loader" style="width: 24px; height: 24px; border-width: 2px; margin: 0.5rem;"></div>
                            </div>
                        </div>
                         <div id="ai-response-panel" class="hidden bg-gray-900/50 border-2 border-dashed border-blue-500/50 p-4 rounded-lg mb-6">
                              <h3 class="text-lg font-semibold text-blue-400 mb-2">AI Suggestion</h3>
                              <div id="ai-response-content" contenteditable="true" class="w-full min-h-[150px] p-4 bg-gray-800 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 overflow-y-auto"></div>
                              <div class="flex gap-2 mt-3 justify-end">
                                   <button id="copy-ai-response-btn" class="py-2 px-4 rounded-lg font-semibold btn-primary">Copy</button>
                                   <button id="dismiss-ai-response-btn" class="py-2 px-4 rounded-lg font-semibold btn-secondary">Close</button>
                              </div>
                         </div>
                        <div class="bg-gray-800 rounded-lg shadow-lg">
                            <div class="flex border-b border-gray-700 justify-between items-center">
                                <div class="flex">
                                    <button id="work-tab" class="py-3 px-6 font-semibold border-b-2 border-blue-500 text-white">Work</button>
                                    <button id="reference-tab" class="py-3 px-6 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">Reference</button>
                                </div>
                            </div>
                            <div id="work-panel" class="p-6">
                                <h2 class="text-2xl font-semibold mb-4 text-white">Your Story</h2>
                                <p class="text-sm text-gray-400 mb-4">This is your main writing space. Write freely, and when you need assistance, simply highlight any text. The AI Toolkit will appear at the top, allowing you to expand, rewrite, or give custom instructions for the selected passage. AI suggestions will appear in a separate panel for you to review, edit, and copy.</p>
                                <div class="mb-4">
                                    <label for="write-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2">Secondary Guidance (Optional)</label>
                                    <textarea id="write-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Provide consistent instructions for the AI Toolkit, e.g., 'write in a formal tone', 'always use first-person perspective'..."></textarea>
                                </div>
                                <div id="main-editor" contenteditable="true" class="relative w-full min-h-[70vh] p-4 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Main story editor"></div>
                            </div>
                            <div id="reference-panel" class="p-6 hidden">
                                <h3 class="text-xl font-semibold mb-2 text-white">Reference Panel</h3>
                                <p class="text-sm text-gray-400 mb-4">You can use this area to see your Treatment or other reference material while you write.</p>
                                <div id="write-treatment-reference" class="p-4 bg-gray-900 border border-gray-700 rounded-lg text-gray-300 max-h-[70vh] overflow-y-auto prose prose-invert max-w-none text-sm">
                                    <span class="text-gray-500">Your generated treatment will appear here once created.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="storyboard" class="stage">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-2 text-white">Create a Storyboard</h2>
                            <p class="text-gray-400 mb-6">Turn your words into images. Paste a scene description from your story or treatment into the box below. The AI will first act as a director, breaking your scene into key shots. Then, it will generate a unique image for each shot, creating a visual storyboard to help you picture the action.</p>
                            <div class="flex space-x-2 mb-4">
                                <button id="load-treatment-to-storyboard" class="flex-1 py-2 px-4 text-sm rounded-lg font-semibold btn-secondary">Load from Treatment</button>
                                <button id="load-story-to-storyboard" class="flex-1 py-2 px-4 text-sm rounded-lg font-semibold btn-secondary">Load from Story</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label for="storyboard-panels" class="block text-sm font-medium text-gray-400 mb-2">Number of Panels</label>
                                    <input type="number" id="storyboard-panels" class="w-full p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" value="4" min="1" max="8">
                                </div>
                                <div id="storyboard-style-gems-container" class="md:col-span-2 grid grid-cols-2 gap-4">
                                    <!-- Storyboard style gems will be injected here -->
                                </div>
                            </div>
                            <label for="storyboard-description" class="block text-sm font-medium text-gray-400 mb-2">Scene Description</label>
                            <textarea id="storyboard-description" class="w-full h-48 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Paste or write the scene you want to visualize..."></textarea>
                            <label for="storyboard-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2 mt-4">Secondary Guidance (Optional)</label>
                            <textarea id="storyboard-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Maintain a consistent color palette of blues and grays, ensure the main character always wears a red scarf..."></textarea>
                            <button id="generate-storyboard-btn" class="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Storyboard</button>
                        </div>
                        <div id="storyboard-loader" class="hidden text-center mt-4">
                            <p class="mb-2 text-gray-400">Generating visual seeds...</p>
                            <div class="loader inline-block"></div>
                        </div>
                        <div id="storyboard-output" class="mt-8 grid gap-6 grid-cols-1 md:grid-cols-2"></div>
                        <div id="storyboard-save-container" class="hidden mt-6 text-center flex justify-center gap-4">
                           <button id="reiterate-storyboard-btn" class="py-3 px-6 rounded-lg font-semibold btn-secondary">Reiterate Selected Images</button>
                           <button id="save-storyboard-btn" class="py-3 px-6 rounded-lg font-semibold btn-primary">Save Selected Images</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- CHARACTER TOOL & SCENE BUILDER (NO SIDEBAR) -->
        <div id="character-tool" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- LEFT COLUMN -->
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-6">
                        <form id="character-form-unified">
                            <p class="text-sm text-gray-400 mb-6">Fill in the fields yourself or click the toggle to have the AI generate content for you.</p>
                            
                            <div class="space-y-4" id="character-accordion">
                                <!-- Section 1: Core Concept -->
                                <div class="accordion-section open">
                                    <button type="button" class="accordion-header">
                                        <span>Core Concept</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="char-name" class="block text-sm font-medium text-gray-300 mb-1">Character Name</label>
                                                <div class="flex items-center gap-3"><input type="text" id="char-name" data-field-name="name" placeholder="e.g., Alistair Croft" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                                                <div class="flex items-center gap-3"><input type="text" id="char-genre" data-field-name="genre" placeholder="e.g., Sci-Fi, Fantasy" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-core-description" class="block text-sm font-medium text-gray-300 mb-1">Core Description</label>
                                                <div class="flex items-start gap-3"><textarea id="char-core-description" data-field-name="core-description" placeholder="A high-level summary..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 2: Personal History -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Personal History</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="char-backstory" class="block text-sm font-medium text-gray-300 mb-1">Backstory</label>
                                                <div class="flex items-start gap-3"><textarea id="char-backstory" data-field-name="backstory" placeholder="Detail their history..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-motivations" class="block text-sm font-medium text-gray-300 mb-1">Motivations</label>
                                                <div class="flex items-start gap-3"><textarea id="char-motivations" data-field-name="motivations" placeholder="What drives them?" class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                             <div>
                                                <label for="char-goals" class="block text-sm font-medium text-gray-300 mb-1">Goals</label>
                                                <div class="flex items-start gap-3"><textarea id="char-goals" data-field-name="goals" placeholder="Short-term and long-term goals." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 3: Abilities & Traits -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Abilities & Traits</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="char-personality" class="block text-sm font-medium text-gray-300 mb-1">Personality</label>
                                                <div class="flex items-start gap-3"><textarea id="char-personality" data-field-name="personality" placeholder="e.g., Witty, cautious..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-weaknesses" class="block text-sm font-medium text-gray-300 mb-1">Weaknesses</label>
                                                <div class="flex items-start gap-3"><textarea id="char-weaknesses" data-field-name="weaknesses" placeholder="e.g., Fear of heights" class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-skills" class="block text-sm font-medium text-gray-300 mb-1">Skills</label>
                                                <div class="flex items-center gap-3"><input type="text" id="char-skills" data-field-name="skills" placeholder="e.g., Lockpicking" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-abilities" class="block text-sm font-medium text-gray-300 mb-1">Abilities</label>
                                                <div class="flex items-center gap-3"><input type="text" id="char-abilities" data-field-name="abilities" placeholder="e.g., Minor pyromancy" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-equipment" class="block text-sm font-medium text-gray-300 mb-1">Equipment</label>
                                                <div class="flex items-start gap-3"><textarea id="char-equipment" data-field-name="equipment" placeholder="What items do they carry?" class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 4: Relationships & Notes -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Relationships & Notes</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                         <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="char-relationships" class="block text-sm font-medium text-gray-300 mb-1">Relationships</label>
                                                <div class="flex items-start gap-3"><textarea id="char-relationships" data-field-name="relationships" placeholder="Family, friends, rivals, etc." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="char-notes" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                                                <div class="flex items-start gap-3"><textarea id="char-notes" data-field-name="notes" placeholder="Any other important details..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 5: Appearance -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Appearance</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                             <div><label for="char-gender" class="block text-sm font-medium text-gray-300 mb-1">Gender Representation</label><input type="text" id="char-gender" data-field-name="gender" placeholder="e.g., Female, Male" class="tool-input"></div>
                                             <div><label for="char-build" class="block text-sm font-medium text-gray-300 mb-1">Build</label><input type="text" id="char-build" data-field-name="build" placeholder="e.g., Athletic, Slender" class="tool-input"></div>
                                             <div><label for="char-hairColor" class="block text-sm font-medium text-gray-300 mb-1">Hair Color</label><input type="text" id="char-hairColor" data-field-name="hairColor" placeholder="e.g., Black, Blonde" class="tool-input"></div>
                                             <div><label for="char-eyeColor" class="block text-sm font-medium text-gray-300 mb-1">Eye Color</label><input type="text" id="char-eyeColor" data-field-name="eyeColor" placeholder="e.g., Brown, Blue" class="tool-input"></div>
                                             <div><label for="char-details" class="block text-sm font-medium text-gray-300 mb-1">Other Details (Race, etc.)</label><textarea id="char-details" data-field-name="details" class="tool-input" rows="1" placeholder="e.g., Human with rounded ears..."></textarea></div>
                                             <div><label for="char-clothing" class="block text-sm font-medium text-gray-300 mb-1">Clothing</label><textarea id="char-clothing" data-field-name="clothing" class="tool-input" rows="1" placeholder="e.g., Leather armor..."></textarea></div>
                                             <div><label for="char-expression" class="block text-sm font-medium text-gray-300 mb-1">Expression / Mood</label><textarea id="char-expression" data-field-name="expression" class="tool-input" rows="1" placeholder="e.g., Determined, smiling..."></textarea></div>
                                             <div><label for="char-background" class="block text-sm font-medium text-gray-300 mb-1">Background / Setting</label><textarea id="char-background" data-field-name="background" class="tool-input" rows="1" placeholder="e.g., Bustling city street..."></textarea></div>
                                             <div><label for="char-negative_prompts" class="block text-sm font-medium text-gray-300 mb-1 text-red-400">Negative Prompts</label><textarea id="char-negative_prompts" data-field-name="negative_prompts_char" class="tool-input" rows="1" placeholder="e.g., eyepatch, helmet..."></textarea></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-400">Character Assets</h2>
                        <p class="text-sm text-gray-400 mb-4">Load existing character profiles (JSON), text notes, or inspirational images. The AI will use any assets you 'include' to inform its generation and maintain consistency.</p>
                        <button id="load-asset-btn-char" class="w-full py-2 px-4 rounded-lg font-semibold btn-secondary mb-4">Load Asset(s)</button>
                        <div id="asset-container-char" class="space-y-4 max-h-[40vh] overflow-y-auto"></div>
                    </div>
                </div>
                <!-- RIGHT COLUMN -->
                <div class="space-y-6">
                    <div class="accordion-section">
                        <button type="button" class="accordion-header">
                            <span>Generation Controls</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <p class="text-sm text-gray-400 mb-4">Once you've filled out the fields or toggled them for AI generation, click the button below. The AI will create a complete character profile, which will appear in the collapsible sections below.</p>
                            <div class="mb-4">
                                <label for="char-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2">Secondary Guidance (Optional)</label>
                                <textarea id="char-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Make the backstory tragic, ensure they have a witty sense of humor..."></textarea>
                            </div>
                            <div class="space-y-4">
                                <button id="generate-text-btn-char" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary bg-green-600 hover:bg-green-700">Generate Full Profile</button>
                            </div>
                            <div id="char-outputs" class="space-y-6 mt-6">
                                <!-- Outputs will be injected here -->
                            </div>
                        </div>
                    </div>
                     <div class="accordion-section">
                        <button type="button" class="accordion-header">
                            <span>Image Generation</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <p class="text-sm text-gray-400 mb-4">Bring your character to life. The AI uses the 'Image Details' from the Appearance section to create a visual representation. Select an art style and click generate.</p>
                            <div class="space-y-4">
                                <div class="border-t border-gray-700 pt-4">
                                     <label class="block text-sm font-medium text-gray-300 mb-2 text-center">Image Style</label>
                                    <div id="character-path-display" class="grid grid-cols-2 gap-2 mb-4"></div>
                                </div>
                                <div class="mb-4">
                                    <label for="char-image-guidance" class="block text-sm font-medium text-gray-400 mb-2">Image Guidance (Optional)</label>
                                    <textarea id="char-image-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., in the style of Greg Rutkowski, dramatic lighting..."></textarea>
                                </div>
                                <button id="generate-image-btn-char" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Image</button>
                            </div>
                            <div id="image-container-char" class="w-full aspect-square bg-gray-900 rounded-md flex items-center justify-center border border-gray-700 mt-6">
                                <div id="loading-spinner-image-char" class="loader hidden"></div>
                                <img id="generated-image-char" src="" alt="Generated Character" class="hidden w-full h-full object-cover rounded-md">
                                <span id="image-placeholder-char" class="text-gray-500">Your character image will appear here</span>
                            </div>
                            <button id="download-image-btn-char" class="hidden mt-4 w-full py-2 px-4 rounded-lg font-semibold btn-secondary">Save Image</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="scene-builder" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- LEFT COLUMN -->
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-6">
                        <form id="scene-form-unified">
                            <p class="text-sm text-gray-400 mb-6">Fill in the fields yourself or click the toggle to have the AI generate content for you.</p>
                            
                            <div class="space-y-4" id="scene-accordion">
                                <!-- Section 1: Core Concept -->
                                <div class="accordion-section open">
                                    <button type="button" class="accordion-header">
                                        <span>Core Concept</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="scene-name" class="block text-sm font-medium text-gray-300 mb-1">Scene Name</label>
                                                <div class="flex items-center gap-3"><input type="text" id="scene-name" data-field-name="name" placeholder="e.g., The Whispering Caverns" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="scene-genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                                                <div class="flex items-center gap-3"><input type="text" id="scene-genre" data-field-name="genre" placeholder="e.g., High Fantasy, Cyberpunk" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="scene-overview" class="block text-sm font-medium text-gray-300 mb-1">Overview</label>
                                                <div class="flex items-start gap-3"><textarea id="scene-overview" data-field-name="overview" placeholder="A high-level summary of the scene..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 2: Sensory Details -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Sensory Details</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="scene-atmosphere" class="block text-sm font-medium text-gray-300 mb-1">Atmosphere / Mood</label>
                                                <div class="flex items-start gap-3"><textarea id="scene-atmosphere" data-field-name="atmosphere" placeholder="e.g., Oppressive and tense, or calm and serene..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="scene-exterior" class="block text-sm font-medium text-gray-300 mb-1">Exterior Description</label>
                                                <div class="flex items-start gap-3"><textarea id="scene-exterior" data-field-name="exterior" placeholder="Describe the scene from the outside..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="scene-interior" class="block text-sm font-medium text-gray-300 mb-1">Interior Description</label>
                                                <div class="flex items-start gap-3"><textarea id="scene-interior" data-field-name="interior" placeholder="Describe the scene from the inside..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 3: Context & Setting -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Context & Setting</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="scene-history" class="block text-sm font-medium text-gray-300 mb-1">History</label>
                                                <div class="flex items-start gap-3"><textarea id="scene-history" data-field-name="history" placeholder="What is the history of this location?" class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 4: Visuals & Style (for Image Gen) -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Visuals & Style</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div class="tool-section-header !mb-0 !pb-2 !mt-2">Image Details</div>
                                             <div><label for="scene-time_of_day" class="block text-sm font-medium text-gray-300 mb-1">Time of Day</label><input type="text" id="scene-time_of_day" data-field-name="time_of_day" placeholder="e.g., Sunrise, Night" class="tool-input"></div>
                                             <div><label for="scene-weather" class="block text-sm font-medium text-gray-300 mb-1">Weather</label><input type="text" id="scene-weather" data-field-name="weather" placeholder="e.g., Sunny, Raining" class="tool-input"></div>
                                             <div><label for="scene-architectural_style" class="block text-sm font-medium text-gray-300 mb-1">Architectural Style</label><input type="text" id="scene-architectural_style" data-field-name="architectural_style" placeholder="e.g., Gothic, Modern" class="tool-input"></div>
                                             <div><label for="scene-other_details" class="block text-sm font-medium text-gray-300 mb-1">Other Details</label><textarea id="scene-other_details" data-field-name="other_details" class="tool-input" rows="1" placeholder="e.g., specific flora..."></textarea></div>
                                             <div><label for="scene-negative_prompts" class="block text-sm font-medium text-gray-300 mb-1 text-red-400">Negative Prompts</label><textarea id="scene-negative_prompts" data-field-name="negative_prompts_scene" class="tool-input" rows="1" placeholder="e.g., people, vehicles..."></textarea></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-400">Scene Assets</h2>
                        <button id="load-asset-btn-scene" class="w-full py-2 px-4 rounded-lg font-semibold btn-secondary mb-4">Load Asset(s)</button>
                        <div id="asset-container-scene" class="space-y-4 max-h-[40vh] overflow-y-auto"></div>
                    </div>
                </div>
                <!-- RIGHT COLUMN -->
                <div class="space-y-6">
                    <div class="accordion-section">
                        <button type="button" class="accordion-header">
                            <span>Generation Controls</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <p class="text-sm text-gray-400 mb-4">Define your scene, then click the button below. The AI will generate detailed descriptions which will appear below.</p>
                            <div class="mb-4">
                                <label for="scene-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2">Secondary Guidance (Optional)</label>
                                <textarea id="scene-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Describe the scene in a poetic style, focus on the sounds..."></textarea>
                            </div>
                            <div class="space-y-4">
                                <button id="generate-text-btn-scene" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary bg-green-600 hover:bg-green-700">Generate Full Profile</button>
                            </div>
                            <div id="scene-outputs" class="space-y-6 mt-6">
                                <!-- Outputs will be injected here -->
                            </div>
                        </div>
                    </div>
                     <div class="accordion-section">
                        <button type="button" class="accordion-header">
                            <span>Image Generation</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <p class="text-sm text-gray-400 mb-4">Create a stunning visual for your scene. Choose an art style that fits the mood and let the AI bring your words to life.</p>
                            <div class="space-y-4">
                                <div class="border-t border-gray-700 pt-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2 text-center">Image Style</label>
                                    <div id="scene-path-display" class="grid grid-cols-2 gap-2 mb-4"></div>
                                </div>
                                <div class="mb-4">
                                    <label for="scene-image-guidance" class="block text-sm font-medium text-gray-400 mb-2">Image Guidance (Optional)</label>
                                    <textarea id="scene-image-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., wide-angle shot, moody lighting..."></textarea>
                                </div>
                                <button id="generate-image-btn-scene" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Image</button>
                            </div>
                            <div id="image-container-scene" class="w-full aspect-square bg-gray-900 rounded-md flex items-center justify-center border border-gray-700 mt-6">
                                <div id="loading-spinner-image-scene" class="loader hidden"></div>
                                <img id="generated-image-scene" src="" alt="Generated Scene" class="hidden w-full h-full object-cover rounded-md">
                                <span id="image-placeholder-scene" class="text-gray-500">Your scene image will appear here</span>
                            </div>
                            <button id="download-image-btn-scene" class="hidden mt-4 w-full py-2 px-4 rounded-lg font-semibold btn-secondary">Save Image</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="setting-tool" class="tab-content">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- LEFT COLUMN -->
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-6">
                        <form id="setting-form-unified">
                            <p class="text-sm text-gray-400 mb-6">Fill in the fields yourself or click the toggle to have the AI generate content for you.</p>
                            
                            <div class="space-y-4" id="setting-accordion">
                                <!-- Section 1: Core Concept -->
                                <div class="accordion-section open">
                                    <button type="button" class="accordion-header">
                                        <span>Core Concept</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="setting-name" class="block text-sm font-medium text-gray-300 mb-1">Setting Name</label>
                                                <div class="flex items-center gap-3"><input type="text" id="setting-name" data-field-name="name" placeholder="e.g., The Clockwork City" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-genre" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                                                <div class="flex items-center gap-3"><input type="text" id="setting-genre" data-field-name="genre" placeholder="e.g., Steampunk, High Fantasy" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                             <div>
                                                <label for="setting-timePeriod" class="block text-sm font-medium text-gray-300 mb-1">Time Period / Era</label>
                                                <div class="flex items-center gap-3"><input type="text" id="setting-timePeriod" data-field-name="timePeriod" placeholder="e.g., Victorian Era, Far Future" class="tool-input"><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-corePremise" class="block text-sm font-medium text-gray-300 mb-1">Core Premise</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-corePremise" data-field-name="corePremise" placeholder="A one-sentence summary..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 2: Physical Environment -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Physical Environment</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="setting-geography" class="block text-sm font-medium text-gray-300 mb-1">Geography & Topography</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-geography" data-field-name="geography" placeholder="e.g., Floating islands, vast deserts..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-climate" class="block text-sm font-medium text-gray-300 mb-1">Climate & Weather</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-climate" data-field-name="climate" placeholder="e.g., Perpetual twilight, acid rain..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                             <div>
                                                <label for="setting-floraFauna" class="block text-sm font-medium text-gray-300 mb-1">Flora & Fauna</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-floraFauna" data-field-name="floraFauna" placeholder="e.g., Carnivorous plants, metallic birds..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 3: Society & Culture -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Society & Culture</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="setting-population" class="block text-sm font-medium text-gray-300 mb-1">Population & Demographics</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-population" data-field-name="population" placeholder="e.g., A melting pot of elves and dwarves..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-government" class="block text-sm font-medium text-gray-300 mb-1">Government & Politics</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-government" data-field-name="government" placeholder="e.g., Corporate technocracy, monarchy..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-economy" class="block text-sm font-medium text-gray-300 mb-1">Economy & Trade</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-economy" data-field-name="economy" placeholder="e.g., Barter system, post-scarcity..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-culture" class="block text-sm font-medium text-gray-300 mb-1">Arts & Culture</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-culture" data-field-name="culture" placeholder="e.g., Dominant art forms, aesthetics..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 4: Systems & Rules -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Systems & Rules</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                         <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="setting-technology" class="block text-sm font-medium text-gray-300 mb-1">Technology Level</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-technology" data-field-name="technology" placeholder="e.g., Stone Age, Information Age..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-magic" class="block text-sm font-medium text-gray-300 mb-1">Magic System</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-magic" data-field-name="magic" placeholder="e.g., Source, availability, rules, costs..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                             <div>
                                                <label for="setting-religion" class="block text-sm font-medium text-gray-300 mb-1">Religion & Cosmology</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-religion" data-field-name="religion" placeholder="e.g., Beliefs about the universe, deities..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 5: History & Lore -->
                                <div class="accordion-section">
                                     <button type="button" class="accordion-header">
                                        <span>History & Lore</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                     <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="setting-history" class="block text-sm font-medium text-gray-300 mb-1">Key Historical Events</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-history" data-field-name="history" placeholder="e.g., Major wars, discoveries, cataclysms..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                            <div>
                                                <label for="setting-lore" class="block text-sm font-medium text-gray-300 mb-1">Myths & Legends</label>
                                                <div class="flex items-start gap-3"><textarea id="setting-lore" data-field-name="lore" placeholder="e.g., Foundational stories about heroes, monsters..." class="tool-input" rows="2"></textarea><button type="button" class="ai-toggle-btn" title="Toggle AI Generation"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 6: Visuals & Style -->
                                <div class="accordion-section">
                                    <button type="button" class="accordion-header">
                                        <span>Visuals & Style</span>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content">
                                        <div class="grid grid-cols-1 gap-4">
                                            <div class="tool-section-header !mb-0 !pb-2 !mt-2">Image Details</div>
                                             <div><label for="setting-architectural_style" class="block text-sm font-medium text-gray-300 mb-1">Architectural Style</label><input type="text" id="setting-architectural_style" data-field-name="architectural_style" placeholder="e.g., Gothic, Modern, Alien" class="tool-input"></div>
                                             <div><label for="setting-time_of_day" class="block text-sm font-medium text-gray-300 mb-1">Time of Day</label><input type="text" id="setting-time_of_day" data-field-name="time_of_day" placeholder="e.g., Sunrise, Twin Moons Night" class="tool-input"></div>
                                             <div><label for="setting-weather_vis" class="block text-sm font-medium text-gray-300 mb-1">Weather</label><input type="text" id="setting-weather_vis" data-field-name="weather_vis" placeholder="e.g., Light snow, heavy fog" class="tool-input"></div>
                                             <div><label for="setting-other_details" class="block text-sm font-medium text-gray-300 mb-1">Other Visual Details</label><textarea id="setting-other_details" data-field-name="other_details" class="tool-input" rows="1" placeholder="e.g., Glowing crystals, strange colors..."></textarea></div>
                                             <div><label for="setting-negative_prompts" class="block text-sm font-medium text-gray-300 mb-1 text-red-400">Negative Prompts</label><textarea id="setting-negative_prompts" data-field-name="negative_prompts_setting" class="tool-input" rows="1" placeholder="e.g., people, vehicles, text..."></textarea></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-400">Setting Assets</h2>
                        <p class="text-sm text-gray-400 mb-4">Load existing setting profiles (JSON), text notes, or inspirational images. The AI will use any assets you 'include' to inform its generation.</p>
                        <button id="load-asset-btn-setting" class="w-full py-2 px-4 rounded-lg font-semibold btn-secondary mb-4">Load Asset(s)</button>
                        <div id="asset-container-setting" class="space-y-4 max-h-[40vh] overflow-y-auto"></div>
                    </div>
                </div>
                <!-- RIGHT COLUMN -->
                <div class="space-y-6">
                    <div class="accordion-section">
                        <button type="button" class="accordion-header">
                            <span>Generation Controls</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <p class="text-sm text-gray-400 mb-4">Once you've filled out the fields or toggled them for AI generation, click the button below. The AI will create a complete setting profile.</p>
                            <div class="mb-4">
                                <label for="setting-secondary-guidance" class="block text-sm font-medium text-gray-400 mb-2">Secondary Guidance (Optional)</label>
                                <textarea id="setting-secondary-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Emphasize the magical elements, write in a dark fantasy tone..."></textarea>
                            </div>
                            <div class="space-y-4">
                                <button id="generate-text-btn-setting" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary bg-green-600 hover:bg-green-700">Generate Full Profile</button>
                            </div>
                            <div id="setting-outputs" class="space-y-6 mt-6">
                                <!-- Outputs will be injected here -->
                            </div>
                        </div>
                    </div>
                     <div class="accordion-section">
                        <button type="button" class="accordion-header">
                            <span>Image Generation</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <p class="text-sm text-gray-400 mb-4">Bring your setting to life. The AI uses the 'Image Details' from the Visuals & Style section to create a representation. Select an art style and click generate.</p>
                            <div class="space-y-4">
                                <div class="border-t border-gray-700 pt-4">
                                     <label class="block text-sm font-medium text-gray-300 mb-2 text-center">Image Style</label>
                                    <div id="setting-path-display" class="grid grid-cols-2 gap-2 mb-4"></div>
                                </div>
                                <div class="mb-4">
                                    <label for="setting-image-guidance" class="block text-sm font-medium text-gray-400 mb-2">Image Guidance (Optional)</label>
                                    <textarea id="setting-image-guidance" class="w-full h-24 p-3 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., hyperrealistic, volumetric lighting..."></textarea>
                                </div>
                                <button id="generate-image-btn-setting" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary">Generate Image</button>
                            </div>
                            <div id="image-container-setting" class="w-full aspect-square bg-gray-900 rounded-md flex items-center justify-center border border-gray-700 mt-6">
                                <div id="loading-spinner-image-setting" class="loader hidden"></div>
                                <img id="generated-image-setting" src="" alt="Generated Setting" class="hidden w-full h-full object-cover rounded-md">
                                <span id="image-placeholder-setting" class="text-gray-500">Your setting image will appear here</span>
                            </div>
                            <button id="download-image-btn-setting" class="hidden mt-4 w-full py-2 px-4 rounded-lg font-semibold btn-secondary">Save Image</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <footer class="text-center mt-12 pb-8">
        <p class="text-sm text-gray-500">Writer AId by Wolfe.BT@TangentLLC</p>
    </footer>

    <!-- MODALS (SHARED) -->
    <div id="path-settings-modal" class="modal fixed inset-0 bg-black/60 items-start justify-center pt-20 hidden z-50 opacity-0">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative border border-gray-700">
            <h2 id="path-modal-title" class="text-2xl font-bold text-white mb-6">Edit Path</h2>
            <div id="path-modal-content" class="space-y-2"></div>
            <div id="path-modal-custom-input-container" class="hidden mt-4 pt-4 border-t border-gray-700">
                <label id="path-modal-custom-label" for="path-modal-custom-input" class="block text-sm font-medium text-gray-300 mb-2">Enter Custom Value</label>
                <div class="flex gap-2">
                    <input type="text" id="path-modal-custom-input" class="tool-input flex-grow">
                    <button id="path-modal-custom-save-btn" class="btn-primary py-2 px-4 rounded-lg font-semibold">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div id="project-modal" class="modal fixed inset-0 bg-black/60 items-center justify-center hidden z-50 opacity-0">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative border border-gray-700">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold text-white mb-6">Project Options</h2>
            <div class="space-y-4">
                <button id="new-project-btn" class="w-full py-3 px-4 rounded-lg font-semibold btn-secondary bg-red-600/50 hover:bg-red-600/80">New Project (Clear All)</button>
                <button id="load-json-btn" class="w-full py-3 px-4 rounded-lg font-semibold btn-secondary">Load Project from JSON File</button>
                <input type="file" id="json-file-input" class="hidden" accept=".json">
                <button id="export-json-btn" class="w-full py-3 px-4 rounded-lg font-semibold btn-secondary">Export Project to JSON File</button>
                <button id="export-text-btn" class="w-full py-3 px-4 rounded-lg font-semibold btn-secondary">Export Story as Text File</button>
                <button id="print-project-btn" class="w-full py-3 px-4 rounded-lg font-semibold btn-primary">Print Project</button>
            </div>
             <div id="print-options" class="mt-6 pt-4 border-t border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-3">Print Selection</h3>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div class="flex items-center">
                        <input id="print-check-brainstorm" type="checkbox" checked class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="print-check-brainstorm" class="ml-2 text-gray-300">Brainstorm</label>
                    </div>
                    <div class="flex items-center">
                        <input id="print-check-outline" type="checkbox" checked class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="print-check-outline" class="ml-2 text-gray-300">Outline</label>
                    </div>
                    <div class="flex items-center">
                        <input id="print-check-treatment" type="checkbox" checked class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="print-check-treatment" class="ml-2 text-gray-300">Treatment</label>
                    </div>
                    <div class="flex items-center">
                        <input id="print-check-story" type="checkbox" checked class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="print-check-story" class="ml-2 text-gray-300">Story</label>
                    </div>
                    <div class="flex items-center">
                        <input id="print-check-storyboard" type="checkbox" checked class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="print-check-storyboard" class="ml-2 text-gray-300">Storyboard</label>
                    </div>
                </div>
                 <div class="flex space-x-2 mt-4">
                    <button id="print-select-all-btn" class="flex-1 py-1 px-2 text-xs rounded-md font-semibold btn-secondary">Select All</button>
                    <button id="print-deselect-all-btn" class="flex-1 py-1 px-2 text-xs rounded-md btn-secondary">Deselect All</button>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="modal fixed inset-0 bg-black/60 items-center justify-center hidden z-50 opacity-0">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative border border-gray-700">
            <button id="close-settings-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold text-white mb-4">Settings</h2>
            <p class="text-sm text-gray-400 mb-4">Your Gemini API key is stored locally in your browser and is never sent to our servers.</p>
            <div class="space-y-2">
                <label for="api-key-input" class="block text-sm font-medium text-gray-300">Writer AId API Key</label>
                <input type="password" id="api-key-input" class="w-full p-2 bg-gray-900 text-gray-300 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter your API key">
            </div>
            <button id="save-api-key-btn" class="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Save Key</button>
        </div>
    </div>
    
    <!-- ASSET PREVIEW MODAL -->
    <div id="asset-preview-modal" class="modal fixed inset-0 bg-black/60 items-center justify-center hidden z-50 opacity-0">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl relative border border-gray-700 flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0 flex justify-between items-center pb-4 border-b border-gray-700">
                <h2 id="asset-modal-title" class="text-2xl font-bold text-white truncate pr-8">Asset Preview</h2>
                <button id="close-asset-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="asset-modal-content" class="flex-grow my-4 overflow-y-auto">
                <!-- Asset content will be injected here -->
            </div>
            <div class="flex-shrink-0 pt-4 border-t border-gray-700 space-y-4">
                 <textarea id="asset-modal-notes" class="asset-input" rows="2" placeholder="Notes..."></textarea>
                 <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="asset-modal-include-checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="asset-modal-include-checkbox" class="text-gray-300">Include in AI Prompt</label>
                    </div>
                    <button id="asset-modal-delete-btn" class="py-2 px-4 rounded-lg font-semibold btn-secondary bg-red-600/50 hover:bg-red-600/80">Delete Asset</button>
                 </div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- GLOBAL STATE & API CONFIG ---
        let userApiKey = '';
        const globalState = {
            projectTitle: 'Untitled Project',
            story: {
                brainstormConcept: '',
                storyOutline: '',
                storyTreatment: '',
                storyboardVisualSeed: '',
                storyboardPanelPrompts: [],
                storyboardArtStyle: 'Painting',
                storyboardSubstyle: '',
                brainstormType: '',
                outlineStructure: '',
                writingFormat: '',
                targetAudience: '',
                writingStyle: '',
                plot: '',
                conflict: '',
                theme: '',
                pointOfView: '',
                tone: '',
                symbolism: ''
            },
            character: {
                artStyle: 'Painting',
                substyle: '',
                pose: 'Close Up'
            },
            scene: {
                artStyle: 'Painting',
                substyle: ''
            },
            setting: {
                artStyle: 'Painting',
                substyle: ''
            },
            assets: {
                story: [],
                character: [],
                scene: [],
                setting: [],
            }
        };
        
        // --- GLOBAL DOM ELEMENTS ---
        const assetContainers = {
            story: document.getElementById('asset-container'),
            character: document.getElementById('asset-container-char'),
            scene: document.getElementById('asset-container-scene'),
            setting: document.getElementById('asset-container-setting')
        };
        const pathSettingsModal = document.getElementById('path-settings-modal');
        const pathModalTitle = document.getElementById('path-modal-title');
        const pathModalContent = document.getElementById('path-modal-content');
        const pathModalCustomInputContainer = document.getElementById('path-modal-custom-input-container');
        const pathModalCustomLabel = document.getElementById('path-modal-custom-label');
        const pathModalCustomInput = document.getElementById('path-modal-custom-input');
        let pathModalCustomSaveBtn = document.getElementById('path-modal-custom-save-btn');
        const characterPathDisplay = document.getElementById('character-path-display');
        const scenePathDisplay = document.getElementById('scene-path-display');
        const settingPathDisplay = document.getElementById('setting-path-display');
        const projectTitleEl = document.getElementById('project-title');
        const mainEditor = document.getElementById('main-editor');
        const chosenIdeaDisplay = document.getElementById('chosen-idea-display');
        const outlineOutput = document.getElementById('outline-output');
        const chosenOutlineDisplay = document.getElementById('chosen-outline-display');
        const treatmentOutput = document.getElementById('treatment-output');
        const writeTreatmentReference = document.getElementById('write-treatment-reference');
        const ideasOutput = document.getElementById('ideas-output');
        const storyboardOutput = document.getElementById('storyboard-output');
        const jsonFileInput = document.getElementById('json-file-input');
        const optionalGemsContainer = document.getElementById('optional-gems-container');
        const formGuidanceGemsContainer = document.getElementById('form-guidance-gems-container');

        const assetPreviewModal = document.getElementById('asset-preview-modal');
        const assetModalTitle = document.getElementById('asset-modal-title');
        const assetModalContent = document.getElementById('asset-modal-content');
        let assetModalNotes = document.getElementById('asset-modal-notes');
        let assetModalIncludeCheckbox = document.getElementById('asset-modal-include-checkbox');
        let assetModalDeleteBtn = document.getElementById('asset-modal-delete-btn');
        const closeAssetModalBtn = document.getElementById('close-asset-modal-btn');


        // --- SHARED PATH/GEM LOGIC ---
        const PATH_OPTIONS = {
            'brainstorm-type': { title: 'Brainstorming', options: { 'Story Writing': ['Story Ideas', 'Characters', 'Settings', 'Plot Twists', 'Story Hooks'], 'General Purpose': ['Design Concept', 'Shopping List', 'Travel Ideas'], 'Custom': ['Other...'] }, stateKey: 'brainstormType', stateObject: 'story' },
            'target-audience': { title: 'Target Audience', options: { 'Youth': ['Children', 'Teen', 'Young Adult'], 'Adult': ['Mature', 'Graphic'], 'Technical': ['Academic'], 'Custom': ['Other...'] }, stateKey: 'targetAudience', stateObject: 'story' },
            'outline-structure': { title: 'Outline Structure', options: { 'Classic Structures': ['Three-Act Structure', "The Hero's Journey", 'Five-Act Structure'], 'Novel Writing': ['Save the Cat Beat Sheet', 'Snowflake Method', 'Fichtean Curve'], 'Custom': ['Other...'] }, stateKey: 'outlineStructure', stateObject: 'story' },
            'treatment-format': { title: 'Treatment Format', options: { 'Prose & Narrative': ['Novel / Book Chapter', 'Short Story', 'Flash Fiction'], 'Scripts & Performance': ['Screenplay Scene', 'Dialogue Only', 'Stage Play Scene', 'Comic Book Script'], 'Custom': ['Other...'] }, stateKey: 'writingFormat', stateObject: 'story' },
            'writing-style': { 
                title: 'Writing Style', 
                options: {
                    'Common Tones': ['Professional', 'Casual', 'Humorous', 'Formal', 'Serious'],
                    'Literary Styles': ['Poetic', 'Minimalist', 'Journalistic', 'Satirical', 'Gritty / Noir'],
                    'Genre Styles': ['Epic Fantasy', 'Hard Sci-Fi', 'Cozy Mystery', 'Young Adult Dystopian'],
                    'Custom': ['Other...']
                }, 
                stateKey: 'writingStyle', 
                stateObject: 'story' 
            },

            // Character Styles
            'character-art-style': { title: 'Art Style', options: { 'Styles': ['Sketch', 'Painting', 'Anime', 'Photorealistic', 'Comic Book', 'Cinematic'] }, stateKey: 'artStyle', stateObject: 'character' },
            'character-substyle-sketch': { title: 'Sketch Substyle', options: { 'Substyles': ['Line Drawing', 'Doodling', 'Cartoon', 'Pointillism', 'Architectural'] }, stateKey: 'substyle', stateObject: 'character' },
            'character-substyle-painting': { title: 'Painting Substyle', options: { 'Substyles': ['Realism', 'Impressionism', 'Expressionism', 'Abstract', 'Surrealism', 'Pop Art', 'No Outline'] }, stateKey: 'substyle', stateObject: 'character' },
            'character-substyle-anime': { title: 'Anime Substyle', options: { 'Substyles': ['Shjo', 'Shnen', 'Chibi', 'Seinen', 'Kodomomuke'] }, stateKey: 'substyle', stateObject: 'character' },
            'character-substyle-photorealistic': { title: 'Photorealistic Substyle', options: { 'Substyles': ["Hyperrealism", "Trompe-l'il"] }, stateKey: 'substyle', stateObject: 'character' },
            'character-substyle-comic-book': { title: 'Comic Book Substyle', options: { 'Substyles': ['Golden Age (1930s-1950s)', 'Silver Age (1950s-1970s)', 'Bronze Age (1970s-1985)', 'Modern Age (1985-Present)', 'Manga Style'] }, stateKey: 'substyle', stateObject: 'character' },
            'character-substyle-cinematic': { title: 'Cinematic Substyle', options: { 'Substyles': ['Film Noir', 'German Expressionism', 'New Wave', 'Italian Neorealism', 'Hollywood Golden Age', 'Modern'] }, stateKey: 'substyle', stateObject: 'character' },
            'character-pose': {
                title: 'Pose',
                options: {
                    'Portrait': ['Close Up'],
                    'Full Body': ['Modeling Pose', 'Action Pose', 'In Scene'],
                    'Reference': ['Concept Sheet'],
                    'Custom': ['Other...']
                },
                stateKey: 'pose',
                stateObject: 'character'
            },

            // Scene Styles
            'scene-art-style': { title: 'Art Style', options: { 'Styles': ['Sketch', 'Painting', 'Anime', 'Photorealistic', 'Comic Book', 'Cinematic'] }, stateKey: 'artStyle', stateObject: 'scene' },
            'scene-substyle-sketch': { title: 'Sketch Substyle', options: { 'Substyles': ['Line Drawing', 'Doodling', 'Cartoon', 'Pointillism', 'Architectural'] }, stateKey: 'substyle', stateObject: 'scene' },
            'scene-substyle-painting': { title: 'Painting Substyle', options: { 'Substyles': ['Realism', 'Impressionism', 'Expressionism', 'Abstract', 'Surrealism', 'Pop Art', 'No Outline'] }, stateKey: 'substyle', stateObject: 'scene' },
            'scene-substyle-anime': { title: 'Anime Substyle', options: { 'Substyles': ['Shjo', 'Shnen', 'Chibi', 'Seinen', 'Kodomomuke'] }, stateKey: 'substyle', stateObject: 'scene' },
            'scene-substyle-photorealistic': { title: 'Photorealistic Substyle', options: { 'Substyles': ["Hyperrealism", "Trompe-l'il"] }, stateKey: 'substyle', stateObject: 'scene' },
            'scene-substyle-comic-book': { title: 'Comic Book Substyle', options: { 'Substyles': ['Golden Age (1930s-1950s)', 'Silver Age (1950s-1970s)', 'Bronze Age (1970s-1985)', 'Modern Age (1985-Present)', 'Manga Style'] }, stateKey: 'substyle', stateObject: 'scene' },
            'scene-substyle-cinematic': { title: 'Cinematic Substyle', options: { 'Substyles': ['Film Noir', 'German Expressionism', 'New Wave', 'Italian Neorealism', 'Hollywood Golden Age', 'Modern'] }, stateKey: 'substyle', stateObject: 'scene' },

            // Setting Styles
            'setting-art-style': { title: 'Art Style', options: { 'Styles': ['Sketch', 'Painting', 'Anime', 'Photorealistic', 'Comic Book', 'Cinematic'] }, stateKey: 'artStyle', stateObject: 'setting' },
            'setting-substyle-sketch': { title: 'Sketch Substyle', options: { 'Substyles': ['Line Drawing', 'Doodling', 'Cartoon', 'Pointillism', 'Architectural'] }, stateKey: 'substyle', stateObject: 'setting' },
            'setting-substyle-painting': { title: 'Painting Substyle', options: { 'Substyles': ['Realism', 'Impressionism', 'Expressionism', 'Abstract', 'Surrealism', 'Pop Art', 'No Outline'] }, stateKey: 'substyle', stateObject: 'setting' },
            'setting-substyle-anime': { title: 'Anime Substyle', options: { 'Substyles': ['Shjo', 'Shnen', 'Chibi', 'Seinen', 'Kodomomuke'] }, stateKey: 'substyle', stateObject: 'setting' },
            'setting-substyle-photorealistic': { title: 'Photorealistic Substyle', options: { 'Substyles': ["Hyperrealism", "Trompe-l'il"] }, stateKey: 'substyle', stateObject: 'setting' },
            'setting-substyle-comic-book': { title: 'Comic Book Substyle', options: { 'Substyles': ['Golden Age (1930s-1950s)', 'Silver Age (1950s-1970s)', 'Bronze Age (1970s-1985)', 'Modern Age (1985-Present)', 'Manga Style'] }, stateKey: 'substyle', stateObject: 'setting' },
            'setting-substyle-cinematic': { title: 'Cinematic Substyle', options: { 'Substyles': ['Film Noir', 'German Expressionism', 'New Wave', 'Italian Neorealism', 'Hollywood Golden Age', 'Modern'] }, stateKey: 'substyle', stateObject: 'setting' },
            
            // Storyboard Styles
            'storyboard-art-style': { title: 'Art Style', options: { 'Styles': ['Sketch', 'Painting', 'Anime', 'Photorealistic', 'Comic Book', 'Cinematic'] }, stateKey: 'storyboardArtStyle', stateObject: 'story' },
            'storyboard-substyle-sketch': { title: 'Sketch Substyle', options: { 'Substyles': ['Line Drawing', 'Doodling', 'Cartoon', 'Pointillism', 'Architectural'] }, stateKey: 'storyboardSubstyle', stateObject: 'story' },
            'storyboard-substyle-painting': { title: 'Painting Substyle', options: { 'Substyles': ['Realism', 'Impressionism', 'Expressionism', 'Abstract', 'Surrealism', 'Pop Art', 'No Outline'] }, stateKey: 'storyboardSubstyle', stateObject: 'story' },
            'storyboard-substyle-anime': { title: 'Anime Substyle', options: { 'Substyles': ['Shjo', 'Shnen', 'Chibi', 'Seinen', 'Kodomomuke'] }, stateKey: 'storyboardSubstyle', stateObject: 'story' },
            'storyboard-substyle-photorealistic': { title: 'Photorealistic Substyle', options: { 'Substyles': ["Hyperrealism", "Trompe-l'il"] }, stateKey: 'storyboardSubstyle', stateObject: 'story' },
            'storyboard-substyle-comic-book': { title: 'Comic Book Substyle', options: { 'Substyles': ['Golden Age (1930s-1950s)', 'Silver Age (1950s-1970s)', 'Bronze Age (1970s-1985)', 'Modern Age (1985-Present)', 'Manga Style'] }, stateKey: 'storyboardSubstyle', stateObject: 'story' },
            'storyboard-substyle-cinematic': { title: 'Cinematic Substyle', options: { 'Substyles': ['Film Noir', 'German Expressionism', 'New Wave', 'Italian Neorealism', 'Hollywood Golden Age', 'Modern'] }, stateKey: 'storyboardSubstyle', stateObject: 'story' },
            
            // Narrative Components
            'plot': { title: 'Plot', options: { 'Structures': ['Linear', 'Episodic', 'Parallel', 'Circular', 'Flashback-driven'], 'Custom': ['Other...'] }, stateKey: 'plot', stateObject: 'story' },
            'conflict': { title: 'Conflict', options: { 'Types': ['Character vs. Self', 'Character vs. Character', 'Character vs. Society', 'Character vs. Nature'], 'Custom': ['Other...'] }, stateKey: 'conflict', stateObject: 'story' },
            'theme': { title: 'Theme', options: { 'Ideas': ['Love vs. Hate', 'Good vs. Evil', 'Coming of Age', 'Redemption', 'Humanity vs. Technology', 'Survival'], 'Custom': ['Other...'] }, stateKey: 'theme', stateObject: 'story' },
            'pointOfView': { title: 'Point of View', options: { 'Perspectives': ['First Person', 'Second Person', 'Third Person Limited', 'Third Person Omniscient'], 'Custom': ['Other...'] }, stateKey: 'pointOfView', stateObject: 'story' },
            'tone': { title: 'Tone', options: { 'Attitudes': ['Serious', 'Humorous', 'Satirical', 'Suspenseful', 'Formal', 'Casual', 'Melancholy'], 'Custom': ['Other...'] }, stateKey: 'tone', stateObject: 'story' },
            'symbolism': { title: 'Symbolism', options: { 'Archetypes': ['Light vs. Dark', 'The Journey', 'Seasonal Cycles', 'Water (Purity/Rebirth)'], 'Custom': ['Other...'] }, stateKey: 'symbolism', stateObject: 'story' }
        };

        const createDisplayGem = (label, value, setting) => {
            const hasValue = !!value;
            const gemClass = `path-gem ${hasValue ? 'has-value' : ''}`;
            const gemContent = `
                <span class="path-gem-label">${label}:</span>
                <span class="path-gem-value">${value || ''}</span>
            `;
            return `<button class="${gemClass}" data-setting="${setting}">${gemContent}</button>`;
        };

        function updateCharacterPathDisplay() {
            characterPathDisplay.innerHTML = '';
            characterPathDisplay.innerHTML += createDisplayGem('Art Style', globalState.character.artStyle, 'character-art-style');
            
            const mainStyle = globalState.character.artStyle.toLowerCase().replace(/\s+/g, '-');
            const substyleSetting = `character-substyle-${mainStyle}`;
            if (PATH_OPTIONS[substyleSetting]) {
                characterPathDisplay.innerHTML += createDisplayGem(PATH_OPTIONS[substyleSetting].title, globalState.character.substyle, substyleSetting);
            }
            
            characterPathDisplay.innerHTML += createDisplayGem('Pose', globalState.character.pose, 'character-pose');
        }

        function updateScenePathDisplay() {
            scenePathDisplay.innerHTML = '';
            scenePathDisplay.innerHTML += createDisplayGem('Art Style', globalState.scene.artStyle, 'scene-art-style');

            const mainStyle = globalState.scene.artStyle.toLowerCase().replace(/\s+/g, '-');
            const substyleSetting = `scene-substyle-${mainStyle}`;
            if (PATH_OPTIONS[substyleSetting]) {
                scenePathDisplay.innerHTML += createDisplayGem(PATH_OPTIONS[substyleSetting].title, globalState.scene.substyle, substyleSetting);
            }
        }

        function updateSettingPathDisplay() {
            settingPathDisplay.innerHTML = '';
            settingPathDisplay.innerHTML += createDisplayGem('Art Style', globalState.setting.artStyle, 'setting-art-style');

            const mainStyle = globalState.setting.artStyle.toLowerCase().replace(/\s+/g, '-');
            const substyleSetting = `setting-substyle-${mainStyle}`;
            if (PATH_OPTIONS[substyleSetting]) {
                settingPathDisplay.innerHTML += createDisplayGem(PATH_OPTIONS[substyleSetting].title, globalState.setting.substyle, substyleSetting);
            }
        }

        function updateSidebarGems(container, gemList) {
            container.innerHTML = '';
            gemList.forEach(gemInfo => {
                const settingConfig = PATH_OPTIONS[gemInfo.setting];
                if (!settingConfig) return;

                const currentValue = globalState[settingConfig.stateObject][settingConfig.stateKey];

                const button = document.createElement('button');
                button.className = 'path-gem';
                button.dataset.setting = gemInfo.setting;
                
                button.innerHTML = `
                    <span class="path-gem-label">${settingConfig.title}:</span>
                    <span class="path-gem-value">${currentValue || ''}</span>
                `;
                
                if (currentValue) {
                    button.classList.add('has-value');
                }
                
                container.appendChild(button);
            });
        }
        
        function updateAllSidebarGems() {
            const formGems = [
                { setting: 'brainstorm-type' }, { setting: 'target-audience' },
                { setting: 'outline-structure' }, { setting: 'treatment-format' },
                { setting: 'writing-style' }
            ];
            const optionalGems = [
                { setting: 'plot' }, { setting: 'conflict' }, { setting: 'theme' },
                { setting: 'pointOfView' }, { setting: 'tone' }, { setting: 'symbolism' }
            ];
            updateSidebarGems(formGuidanceGemsContainer, formGems);
            updateSidebarGems(optionalGemsContainer, optionalGems);
        }


        function handleOptionSelection(setting, option) {
            const settingConfig = PATH_OPTIONS[setting];
            const stateKey = settingConfig.stateKey;
            const stateObject = globalState[settingConfig.stateObject];

            // When a main art style is selected, reset the substyle
            if (setting === 'storyboard-art-style' && stateObject[stateKey] !== option) {
                globalState.story.storyboardSubstyle = '';
            }
            if (setting === 'character-art-style' && stateObject[stateKey] !== option) {
                globalState.character.substyle = '';
            }
            if (setting === 'scene-art-style' && stateObject[stateKey] !== option) {
                globalState.scene.substyle = '';
            }
            if (setting === 'setting-art-style' && stateObject[stateKey] !== option) {
                globalState.setting.substyle = '';
            }


            if (option === 'Other...') {
                pathModalCustomInputContainer.classList.remove('hidden');
                pathModalCustomLabel.textContent = `Enter custom ${settingConfig.title.toLowerCase()}:`;
                pathModalCustomInput.value = '';
                pathModalCustomInput.focus();

                const newSaveBtn = pathModalCustomSaveBtn.cloneNode(true);
                pathModalCustomSaveBtn.parentNode.replaceChild(newSaveBtn, pathModalCustomSaveBtn);
                pathModalCustomSaveBtn = newSaveBtn;
                
                pathModalCustomSaveBtn.addEventListener('click', () => {
                    const customValue = pathModalCustomInput.value.trim();
                    if (customValue) {
                        stateObject[stateKey] = customValue;
                        closePathModal();
                    }
                });
            } else {
                stateObject[stateKey] = option;
                closePathModal();
            }
        }
        
        function openPathModal(setting) {
            pathModalContent.innerHTML = '';
            pathModalCustomInputContainer.classList.add('hidden');
            const settingConfig = PATH_OPTIONS[setting];
            if (!settingConfig) return;

            const stateObject = globalState[settingConfig.stateObject];
            pathModalTitle.textContent = `Select ${settingConfig.title}`;
            pathModalContent.innerHTML = ''; // Clear previous content

            for (const groupName in settingConfig.options) {
                const groupContainer = document.createElement('div');
                const groupHeader = document.createElement('h3');
                groupHeader.className = 'w-full text-sm font-semibold text-gray-400 mt-4 first:mt-0 mb-2';
                groupHeader.textContent = groupName;
                groupContainer.appendChild(groupHeader);
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-wrap gap-2';
                groupContainer.appendChild(buttonContainer);

                settingConfig.options[groupName].forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'py-2 px-3 rounded-md font-semibold btn-secondary text-sm';
                    const isCustom = !Object.values(settingConfig.options).flat().includes(stateObject[settingConfig.stateKey]);

                    if (stateObject[settingConfig.stateKey] === option || (option === 'Other...' && isCustom)) {
                        button.classList.replace('btn-secondary', 'btn-primary');
                    }
                    button.textContent = option;
                    button.addEventListener('click', () => handleOptionSelection(setting, option));
                    buttonContainer.appendChild(button);
                });
                pathModalContent.appendChild(groupContainer);
            }

            pathSettingsModal.classList.remove('hidden');
            pathSettingsModal.classList.add('flex');
            setTimeout(() => pathSettingsModal.style.opacity = 1, 10);
        }

        function closePathModal() {
            pathSettingsModal.style.opacity = 0;
            setTimeout(() => { 
                pathSettingsModal.classList.add('hidden'); 
                pathSettingsModal.classList.remove('flex');
                pathModalCustomInputContainer.classList.add('hidden');
            }, 250);
            updateAllSidebarGems();
            updateCharacterPathDisplay();
            updateScenePathDisplay();
            updateSettingPathDisplay();
            updateStoryboardStyleGems();
            saveStateToLocalStorage();
        }

        function openAssetModal(assetId, assetType) {
            const asset = globalState.assets[assetType].find(a => a.id === assetId);
            if (!asset) return;

            assetModalTitle.textContent = asset.fileName;
            assetModalContent.innerHTML = ''; // Clear previous content

            if (asset.type === 'image') {
                assetModalContent.innerHTML = `<img src="${asset.content}" class="rounded w-full h-auto max-h-[50vh] object-contain">`;
            } else if (asset.type === 'text') {
                assetModalContent.innerHTML = `<pre class="whitespace-pre-wrap text-sm w-full h-full">${asset.content}</pre>`;
            } else if (asset.type === 'json') {
                assetModalContent.innerHTML = `<pre class="whitespace-pre-wrap text-sm w-full h-full">${JSON.stringify(asset.content, null, 2)}</pre>`;
            }

            assetModalNotes.value = asset.notes || '';
            assetModalIncludeCheckbox.checked = asset.includeInPrompt;

            // Clone and replace buttons/inputs to remove old event listeners
            const newDeleteBtn = assetModalDeleteBtn.cloneNode(true);
            assetModalDeleteBtn.parentNode.replaceChild(newDeleteBtn, assetModalDeleteBtn);
            assetModalDeleteBtn = newDeleteBtn;
            
            assetModalDeleteBtn.addEventListener('click', () => {
                if(confirm(`Are you sure you want to delete "${asset.fileName}"?`)) {
                    globalState.assets[assetType] = globalState.assets[assetType].filter(a => a.id !== assetId);
                    renderAssets(assetType);
                    saveStateToLocalStorage();
                    closeAssetModal();
                }
            });

            const newIncludeCheckbox = assetModalIncludeCheckbox.cloneNode(true);
            assetModalIncludeCheckbox.parentNode.replaceChild(newIncludeCheckbox, assetModalIncludeCheckbox);
            assetModalIncludeCheckbox = newIncludeCheckbox;

            assetModalIncludeCheckbox.addEventListener('change', (e) => {
                asset.includeInPrompt = e.target.checked;
                saveStateToLocalStorage();
            });

            const newNotesTextarea = assetModalNotes.cloneNode(true);
            assetModalNotes.parentNode.replaceChild(newNotesTextarea, assetModalNotes);
            assetModalNotes = newNotesTextarea;
            assetModalNotes.value = asset.notes || '';

            assetModalNotes.addEventListener('input', (e) => {
                asset.notes = e.target.value;
                // This will save frequently, which is fine for local storage.
                // For a database, you might want to add a save button or debounce this.
                saveStateToLocalStorage();
            });
            
            assetPreviewModal.classList.remove('hidden');
            assetPreviewModal.classList.add('flex');
            setTimeout(() => assetPreviewModal.style.opacity = 1, 10);
        }

        function closeAssetModal() {
            assetPreviewModal.style.opacity = 0;
            setTimeout(() => {
                assetPreviewModal.classList.add('hidden');
                assetPreviewModal.classList.remove('flex');
            }, 250);
        }

        // --- GLOBAL UTILITY FUNCTIONS ---
        function showStatus(message, isError = false) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? '#ef4444' : '#9ca3af';
            statusMessage.style.opacity = '1';
            setTimeout(() => { statusMessage.style.opacity = '0'; }, 3000);
        }

        function cleanAndFormat(text) {
            if (!text) return '';
            // Basic Markdown to HTML conversion
            return text
                .replace(/^\s*#\s(.*)$/gm, '<h3>$1</h3>') // H3
                .replace(/^\s*##\s(.*)$/gm, '<h4>$1</h4>') // H4
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italics
                .replace(/\n/g, '<br>'); // Newlines
        }

        async function callGeminiAPI(prompt, loaderElement) {
            if (loaderElement) loaderElement.classList.remove('hidden');

            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${userApiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (response.ok) {
                        const result = await response.json();
                        if(loaderElement) loaderElement.classList.add('hidden');
                        return result.candidates?.[0]?.content?.parts?.[0]?.text;
                    }
                    
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error && errorData.error.message.includes("API key not valid")) {
                        showStatus("Error: API Key is not valid. Please check settings.", true);
                        openModal('settings');
                        if(loaderElement) loaderElement.classList.add('hidden');
                        return `Error: ${errorData.error.message}`;
                    }

                    if (response.status === 503 || response.status === 429) {
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                    }
                    
                    if(loaderElement) loaderElement.classList.add('hidden');
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                } catch (e) {
                    if (i === maxRetries - 1) {
                        console.error(e);
                        if(loaderElement) loaderElement.classList.add('hidden');
                        return `Error: ${e.message}`;
                    }
                }
            }
        }

        async function callImagenAPI(positivePrompt, negativePrompt) {
            if (!userApiKey) {
                showStatus("API Key is missing for image generation.", true);
                openModal('settings');
                return null;
            }
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${userApiKey}`;
                const payload = {
                    instances: [{ prompt: positivePrompt, negativePrompt: negativePrompt }],
                    parameters: { "sampleCount": 1 }
                };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                }
                throw new Error('API returned a valid response but no image data was found.');
            } catch(e) {
                console.error("Imagen API Error:", e);
                showStatus(`Image Gen Error: ${e.message}`, true);
                return null;
            }
        }
        
        function autoResizeTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function getAssetContextForAI(assetType = 'story') {
            const includedAssets = globalState.assets[assetType].filter(asset => asset.includeInPrompt);
            if (includedAssets.length === 0) return "";

            let context = "\n\n--- ASSETS CONTEXT ---\n";
            includedAssets.forEach(asset => {
                context += `\n[${asset.fileName} | Label: ${asset.label || 'N/A'}]\n`;
                if (asset.notes) context += `Notes: ${asset.notes}\n`;
                
                if (asset.type === 'json' && asset.content) {
                    if (asset.content.name && asset.content.personality) {
                        context += `Type: Character\n  Name: ${asset.content.name}\n  Description: ${asset.content['core-description'] || ''}\n`;
                    } else if (asset.content['location-name'] && asset.content.atmosphere) {
                        context += `Type: Scene\n  Location: ${asset.content['location-name']}\n  Description: ${asset.content.overview || ''}\n`;
                    }
                } else if (asset.type === 'text' && asset.content) {
                    context += `Content:\n${asset.content}\n`;
                }
            });
            context += "--- END ASSETS CONTEXT ---\n\n";
            return context;
        }

        function addAssetToState(assetData, assetType) {
            const asset = { id: `asset-${Date.now()}-${Math.random()}`, label: '', notes: '', includeInPrompt: true, ...assetData };
            globalState.assets[assetType].push(asset);
            renderAssets(assetType);
            showStatus(`Asset "${assetData.fileName}" loaded to ${assetType} tool.`);
        }

        function renderAssets(assetType) {
            const container = assetContainers[assetType];
            if (!container) return;
            container.innerHTML = '';

            if (assetType === 'story') {
                const assetGroups = {
                    character: [],
                    scene: [],
                    setting: [],
                    image: [],
                    text: []
                };

                globalState.assets.story.forEach(asset => {
                    if (asset.type === 'image') {
                        assetGroups.image.push(asset);
                    } else if (asset.type === 'text') {
                        assetGroups.text.push(asset);
                    } else if (asset.type === 'json' && asset.content) {
                        if (asset.content.characterName || (asset.content.name && asset.content.personality)) {
                            assetGroups.character.push(asset);
                        } else if (asset.content.sceneName || asset.content['location-name']) {
                             assetGroups.scene.push(asset);
                        } else if (asset.content.settingName || asset.content.corePremise) {
                             assetGroups.setting.push(asset);
                        } else {
                            assetGroups.text.push(asset); // Fallback for unknown JSON
                        }
                    }
                });

                const renderGroup = (title, assets) => {
                    if (assets.length === 0) return;
                    const header = document.createElement('h4');
                    header.className = 'text-md font-semibold text-blue-300 border-b border-gray-700 pb-1 mb-2 mt-3';
                    header.textContent = title;
                    container.appendChild(header);
                    assets.forEach(asset => renderAssetCard(asset, assetType, container));
                };

                renderGroup('Characters', assetGroups.character);
                renderGroup('Scenes', assetGroups.scene);
                renderGroup('Settings', assetGroups.setting);
                renderGroup('Images', assetGroups.image);
                renderGroup('Other Text', assetGroups.text);
                
            } else {
                globalState.assets[assetType].forEach(asset => renderAssetCard(asset, assetType, container));
            }
        }

        function renderAssetCard(asset, assetType, container) {
            const card = document.createElement('button');
            card.className = 'asset-card !p-2 !text-left w-full hover:border-blue-500 transition-colors flex items-center min-h-[40px]'; // adjusted padding, added flex and min-height
            card.dataset.id = asset.id;
            card.dataset.assetType = assetType;
            
            // Clean the filename to create a title, removing special and file extensions.
            const cleanTitle = asset.fileName
                .replace(/\.(char|scen|sett)\b/g, '') // Remove special extensions like .char, .scen, .sett
                .replace(/\.[^/.]+$/, ""); // Remove the final file extension (e.g., .json, .txt)

            card.innerHTML = `<strong class="text-blue-400 pointer-events-none break-words text-sm font-semibold">${cleanTitle}</strong>`; // No truncate, adjusted text style
            container.appendChild(card);
        }
        
        // --- GLOBAL SETUP & MODAL LOGIC ---
        const settingsModal = document.getElementById('settings-modal');
        const projectModal = document.getElementById('project-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        
        function openModal(type) {
            const modal = (type === 'settings') ? settingsModal : projectModal;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => modal.style.opacity = 1, 10);
        }

        function closeModal(type) {
            const modal = (type === 'settings') ? settingsModal : projectModal;
            modal.style.opacity = 0;
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            localStorage.setItem('writerAIdApiKey', key);
            userApiKey = key;
            showStatus(key ? "API Key saved." : "API Key removed.");
            closeModal('settings');
        }

        function loadApiKey() {
            let key = localStorage.getItem('writerAIdApiKey');
            if (!key) key = localStorage.getItem('geminiApiKey'); // Legacy fallback
            if (!key) key = localStorage.getItem('googleApiKey'); // Legacy fallback
            
            userApiKey = key || '';
            apiKeyInput.value = userApiKey;
            if (key) {
                localStorage.setItem('writerAIdApiKey', key); // Migrate to new key
            }
        }

        // --- GLOBAL PROJECT MANAGEMENT FUNCTIONS ---
        function saveStateToLocalStorage() {
            try {
                const projectData = { ...globalState, editorContent: mainEditor.innerHTML };
                localStorage.setItem('writerAIdProject', JSON.stringify(projectData));
            } catch (error) { showStatus("Could not save project data.", true); }
        }

        function loadStateFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('writerAIdProject');
                if (savedData) {
                    updateUiFromState(JSON.parse(savedData));
                    showStatus("Project restored from last session.");
                }
            } catch (error) {
                showStatus("Failed to load saved project.", true);
                localStorage.removeItem('writerAIdProject');
            }
        }

        function updateUiFromState(data) {
            // Deep merge to avoid overwriting nested objects, checking for existence to ensure backward compatibility
            if (data.story) Object.assign(globalState.story, data.story);
            if (data.character) Object.assign(globalState.character, data.character);
            if (data.scene) Object.assign(globalState.scene, data.scene);
            if (data.setting) Object.assign(globalState.setting, data.setting);
            if (data.assets) {
                if (data.assets.story) globalState.assets.story = data.assets.story;
                if (data.assets.character) globalState.assets.character = data.assets.character;
                if (data.assets.scene) globalState.assets.scene = data.assets.scene;
                if (data.assets.setting) globalState.assets.setting = data.assets.setting;
            }
            globalState.projectTitle = data.projectTitle || 'Untitled Project';

            projectTitleEl.textContent = globalState.projectTitle;
            mainEditor.innerHTML = data.editorContent || '';
            chosenIdeaDisplay.innerHTML = globalState.story.brainstormConcept || `<span class="text-gray-500">Select a concept...</span>`;
            if (globalState.story.storyOutline) {
                const formatted = cleanAndFormat(globalState.story.storyOutline);
                chosenOutlineDisplay.innerHTML = `<div class="prose prose-invert max-w-none text-gray-300 text-sm">${formatted}</div>`;
                outlineOutput.innerHTML = `<div class="bg-gray-900 p-6 rounded-lg shadow-inner"><div class="prose prose-invert max-w-none">${formatted}</div></div><button id="use-outline-btn" class="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Develop Treatment </button>`;
            } else {
                 chosenOutlineDisplay.innerHTML = `<span class="text-gray-500">Generate or paste an outline.</span>`;
                 outlineOutput.innerHTML = '';
            }
            if (globalState.story.storyTreatment) {
                const formatted = cleanAndFormat(globalState.story.storyTreatment);
                treatmentOutput.innerHTML = `<div class="bg-gray-900 p-6 rounded-lg shadow-inner"><div class="prose prose-invert max-w-none">${formatted}</div></div><button id="use-treatment-btn" class="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Start Writing </button>`;
                writeTreatmentReference.innerHTML = formatted;
            } else {
                 treatmentOutput.innerHTML = '';
                 writeTreatmentReference.innerHTML = `<span class="text-gray-500">Your treatment will appear here.</span>`;
            }
            renderAssets('story');
            renderAssets('character');
            renderAssets('scene');
            renderAssets('setting');
            updateAllSidebarGems();
            updateCharacterPathDisplay();
            updateScenePathDisplay();
            updateSettingPathDisplay();
            updateStoryboardStyleGems();
        }

        function handleJsonLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm("Loading this file will overwrite your current project. Are you sure?")) {
                        updateUiFromState(data);
                        showStatus("Project loaded successfully.");
                        closeModal('project');
                    }
                } catch (error) { alert("Error: Invalid JSON file."); }
            };
            reader.readAsText(file);
            event.target.value = null; 
        }

        function sanitizeFilename(name) { return (name || 'untitled').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''); }

        function exportToJson() {
            const projectData = { ...globalState, editorContent: mainEditor.innerHTML };
            const dataStr = JSON.stringify(projectData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sanitizeFilename(globalState.projectTitle)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus("Project exported as JSON.");
            closeModal('project');
        }

        function htmlToText(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || "";
        }

        function exportAsText() {
            const separator = "\n\n========================================\n\n";
            let textContent = `PROJECT TITLE: ${globalState.projectTitle}\n`;
            textContent += separator + "BRAINSTORM CONCEPT:\n\n" + htmlToText(globalState.story.brainstormConcept);
            textContent += separator + "STORY OUTLINE:\n\n" + globalState.story.storyOutline;
            textContent += separator + "STORY TREATMENT:\n\n" + globalState.story.storyTreatment;
            textContent += separator + "YOUR STORY:\n\n" + htmlToText(mainEditor.innerHTML);
            const blob = new Blob([textContent], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sanitizeFilename(globalState.projectTitle)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus("Project exported as Text.");
            closeModal('project');
        }

        function clearProject() {
            if (confirm("Are you sure you want to clear your entire project?")) {
                localStorage.removeItem('writerAIdProject');
                const initialState = {
                    projectTitle: 'Untitled Project',
                    story: {
                        brainstormConcept: '', storyOutline: '', storyTreatment: '',
                        storyboardArtStyle: 'Painting', storyboardSubstyle: '',
                        brainstormType: '', outlineStructure: '',
                        writingFormat: '', targetAudience: '',
                        writingStyle: '',
                        plot: '', conflict: '', theme: '', pointOfView: '', tone: '', symbolism: ''
                    },
                    character: { artStyle: 'Painting', substyle: '', pose: 'Close Up' },
                    scene: { artStyle: 'Painting', substyle: '' },
                    setting: { artStyle: 'Painting', substyle: '' },
                    assets: { story: [], character: [], scene: [], setting: [] },
                    editorContent: ''
                };
                updateUiFromState(initialState);
                ideasOutput.innerHTML = '';
                outlineOutput.innerHTML = '';
                treatmentOutput.innerHTML = '';
                storyboardOutput.innerHTML = '';
                resetAllToolForms();
                showStatus("New project started.");
                closeModal('project');
            }
        }

        function printProject() {
            const checks = {
                brainstorm: document.getElementById('print-check-brainstorm').checked,
                outline: document.getElementById('print-check-outline').checked,
                treatment: document.getElementById('print-check-treatment').checked,
                story: document.getElementById('print-check-story').checked,
                storyboard: document.getElementById('print-check-storyboard').checked,
            };
            let content = '';
            if (checks.brainstorm && globalState.story.brainstormConcept) content += `<h2>Brainstorm Concept</h2><div>${globalState.story.brainstormConcept}</div>`;
            if (checks.outline && globalState.story.storyOutline) content += `<h2>Story Outline</h2><div>${cleanAndFormat(globalState.story.storyOutline)}</div>`;
            if (checks.treatment && globalState.story.storyTreatment) content += `<h2>Story Treatment</h2><div>${cleanAndFormat(globalState.story.storyTreatment)}</div>`;
            if (checks.story && mainEditor.innerHTML) content += `<h2>Your Story</h2><div>${mainEditor.innerHTML}</div>`;
            if (checks.storyboard && storyboardOutput.innerHTML.trim() !== '') content += `<h2>Storyboard</h2><div class="storyboard-print-container">${storyboardOutput.innerHTML}</div>`;

            if (!content.trim()) { showStatus("No content selected to print.", true); return; }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>Print - ${globalState.projectTitle}</title><style>body{font-family:sans-serif;line-height:1.6} h1{font-size:2em} h2{font-size:1.5em;margin-top:1.5em} .storyboard-print-container{display:grid;grid-template-columns:1fr 1fr;gap:20px} img{max-width:100%}</style></head><body><h1>${globalState.projectTitle}</h1>${content}</body></html>`);
            printWindow.document.close();
            printWindow.print();
        }
        
        // --- TAB SWITCHING LOGIC ---
        const tabButtons = document.querySelectorAll('.main-tab-btn');
        const storyWeaverContentWrapper = document.getElementById('story-weaver-content-wrapper');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTabId = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.getElementById('story-weaver').style.display = 'none';
                document.getElementById('character-tool').style.display = 'none';
                document.getElementById('scene-builder').style.display = 'none';
                document.getElementById('setting-tool').style.display = 'none';
                storyWeaverContentWrapper.style.display = 'none';


                if (targetTabId === 'story-weaver') {
                    storyWeaverContentWrapper.style.display = 'grid';
                    document.getElementById('story-weaver').style.display = 'block';
                } else {
                    document.getElementById(targetTabId).style.display = 'block';
                }
            });
        });


        // --- STORY WEAVER INITIALIZATION ---
        function updateStoryboardStyleGems() {
            const container = document.getElementById('storyboard-style-gems-container');
            container.innerHTML = '';
            
            // Always show the main art style gem
            container.innerHTML += createDisplayGem('Art Style', globalState.story.storyboardArtStyle, 'storyboard-art-style');

            // Conditionally show the substyle gem
            const mainStyle = globalState.story.storyboardArtStyle.toLowerCase().replace(/\s+/g, '-');
            const substyleSetting = `storyboard-substyle-${mainStyle}`;
            
            if (PATH_OPTIONS[substyleSetting]) {
                container.innerHTML += createDisplayGem(PATH_OPTIONS[substyleSetting].title, globalState.story.storyboardSubstyle, substyleSetting);
            }
        }

        function initStoryWeaver() {
            const navButtons = document.querySelectorAll('aside .nav-btn-side');
            const stages = document.querySelectorAll('#story-weaver .stage');
            const generateIdeasBtn = document.getElementById('generate-ideas-btn');
            const generateOutlineBtn = document.getElementById('generate-outline-btn');
            const generateTreatmentBtn = document.getElementById('generate-treatment-btn');
            const generateStoryboardBtn = document.getElementById('generate-storyboard-btn');
            const saveStoryboardBtn = document.getElementById('save-storyboard-btn');
            const reiterateStoryboardBtn = document.getElementById('reiterate-storyboard-btn');
            const storyboardDescription = document.getElementById('storyboard-description');
            const storyboardPanels = document.getElementById('storyboard-panels');
            const storyboardLoader = document.getElementById('storyboard-loader');
            const loadTreatmentToStoryboardBtn = document.getElementById('load-treatment-to-storyboard');
            const loadStoryToStoryboardBtn = document.getElementById('load-story-to-storyboard');
            const storyboardSecondaryGuidance = document.getElementById('storyboard-secondary-guidance');
            const storyboardSaveContainer = document.getElementById('storyboard-save-container');
            
            function setActiveStage(stageName) {
                stages.forEach(s => s.classList.toggle('active', s.id === stageName)); 
                navButtons.forEach(b => b.classList.toggle('active', b.dataset.stage === stageName)); 
            }
            
            async function handleStoryboardGeneration() {
                const description = storyboardDescription.value.trim();
                if (!description) { showStatus("Please enter a scene description.", true); return; }
                const numPanels = parseInt(storyboardPanels.value, 10);
                const style = globalState.story.storyboardArtStyle;
                const substyle = globalState.story.storyboardSubstyle;

                storyboardLoader.classList.remove('hidden');
                storyboardOutput.innerHTML = '';
                generateStoryboardBtn.disabled = true;
                storyboardSaveContainer.classList.add('hidden');

                const assetContext = getAssetContextForAI('story');
                const secondaryGuidance = storyboardSecondaryGuidance.value.trim();

                const seedPrompt = `You are a film director's assistant creating a visual style guide. Synthesize all information into a concise, comma-separated list of keywords for an AI image generator to ensure visual consistency.
                **PRIORITIZE AND EXTRACT VISUAL DETAILS FROM THE FOLLOWING ASSET CONTEXT:** ${assetContext}
                **USE THE SCENE DESCRIPTION TO SET THE ACTION:** ${description}
                **APPLY THIS ADDITIONAL GUIDANCE:** ${secondaryGuidance}
                Your final output should be a single line of descriptive keywords.`;
                const visualSeed = await callGeminiAPI(seedPrompt);
                globalState.story.storyboardVisualSeed = visualSeed; // Store for reiteration
                
                const panelPrompt = `As a film director, break this scene into ${numPanels} storyboard panels based on the following description: "${description}".
                For each panel, provide only a concise visual description suitable for an AI image generator.
                Do not add any preamble, titles, or introductory text like "Here are the panels:".
                Your entire response should consist of the ${numPanels} descriptions, each separated by '---'.`;
                const panelDescriptionsText = await callGeminiAPI(panelPrompt);
                
                if (!panelDescriptionsText || panelDescriptionsText.startsWith("Error:")) {
                    showStatus(panelDescriptionsText || "Failed to generate panel descriptions.", true);
                    storyboardLoader.classList.add('hidden');
                    generateStoryboardBtn.disabled = false;
                    return;
                }
                const panelPrompts = panelDescriptionsText.split('---').map(p => p.trim()).filter(Boolean);
                globalState.story.storyboardPanelPrompts = panelPrompts; // Store for reiteration

                const imagePromises = panelPrompts.map(prompt => {
                    const fullPrompt = `${visualSeed}, ${prompt}, ${substyle}, ${style} style`;
                    return callImagenAPI(fullPrompt, "text, watermark, signature, ugly, deformed, blurry");
                });
                const generatedImages = await Promise.all(imagePromises);
                
                storyboardLoader.classList.add('hidden');
                generateStoryboardBtn.disabled = false;

                generatedImages.forEach((imageUrl, index) => {
                    const panelDiv = document.createElement('div');
                    panelDiv.className = 'storyboard-panel relative'; // Added relative positioning
                    panelDiv.dataset.index = index; // Store index for reiteration
                    panelDiv.innerHTML = `
                        <div class="aspect-video bg-gray-900 flex items-center justify-center">
                            ${imageUrl ? `<img src="${imageUrl}" class="w-full h-full object-cover">` : `<div class="p-4 text-red-400">Failed.</div>`}
                        </div>
                        <input type="checkbox" class="storyboard-checkbox absolute top-2 right-2 h-6 w-6 rounded text-blue-500 bg-gray-900/50 border-gray-500 focus:ring-blue-500">
                        <div class="p-3 text-xs text-gray-400">
                            <p>${index + 1}. ${panelPrompts[index] || ''}</p>
                        </div>`;
                    storyboardOutput.appendChild(panelDiv);
                });

                if (generatedImages.some(img => img)) {
                    storyboardSaveContainer.classList.remove('hidden');
                }
            }

            async function handleStoryboardReiteration() {
                const selectedCheckboxes = document.querySelectorAll('#storyboard-output .storyboard-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showStatus('Please select at least one image to reiterate.', true);
                    return;
                }

                reiterateStoryboardBtn.disabled = true;
                saveStoryboardBtn.disabled = true;
                reiterateStoryboardBtn.textContent = 'Reiterating...';

                const visualSeed = globalState.story.storyboardVisualSeed;
                if (!visualSeed) {
                    showStatus('Error: Visual seed not found. Please regenerate the storyboard.', true);
                    reiterateStoryboardBtn.disabled = false;
                    saveStoryboardBtn.disabled = false;
                    reiterateStoryboardBtn.textContent = 'Reiterate Selected Images';
                    return;
                }
                const style = globalState.story.storyboardArtStyle;
                const substyle = globalState.story.storyboardSubstyle;

                const reiterationPromises = Array.from(selectedCheckboxes).map(checkbox => {
                    const panelDiv = checkbox.closest('.storyboard-panel');
                    const panelIndex = parseInt(panelDiv.dataset.index, 10);
                    const originalPrompt = globalState.story.storyboardPanelPrompts[panelIndex];
                    
                    const imgContainer = panelDiv.querySelector('.aspect-video');
                    imgContainer.innerHTML = `<div class="panel-loader loader" style="margin: auto;"></div>`;

                    const newPrompt = `Reiterate and refine this image. Maintain strong visual consistency with the core theme: "${visualSeed}". The specific shot is: "${originalPrompt}". The art style is "${substyle}, ${style}".`;
                    
                    return callImagenAPI(newPrompt, "text, watermark, signature, ugly, deformed, blurry")
                        .then(imageUrl => ({ panelDiv, imageUrl }));
                });

                const results = await Promise.all(reiterationPromises);

                results.forEach(result => {
                    const { panelDiv, imageUrl } = result;
                    const imgContainer = panelDiv.querySelector('.aspect-video');
                    if (imageUrl) {
                        imgContainer.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover">`;
                    } else {
                        imgContainer.innerHTML = `<div class="p-4 text-red-400">Reiteration Failed.</div>`;
                    }
                    // Uncheck the box after reiteration
                    panelDiv.querySelector('.storyboard-checkbox').checked = false;
                });

                reiterateStoryboardBtn.disabled = false;
                saveStoryboardBtn.disabled = false;
                reiterateStoryboardBtn.textContent = 'Reiterate Selected Images';
                showStatus(`Reiterated ${results.length} image(s).`);
            }

            // --- Event Listeners ---
            navButtons.forEach(btn => btn.addEventListener('click', () => setActiveStage(btn.dataset.stage)));
            generateIdeasBtn.addEventListener('click', async () => {
                const brainstormInput = document.getElementById('brainstorm-input');
                const brainstormSecondaryGuidance = document.getElementById('brainstorm-secondary-guidance');
                const ideasLoader = document.getElementById('ideas-loader');

                const concept = brainstormInput.value.trim();
                if (!concept) {
                    showStatus("Please enter a theme or concept to brainstorm.", true);
                    return;
                }

                ideasLoader.classList.remove('hidden');
                ideasOutput.innerHTML = '';
                generateIdeasBtn.disabled = true;

                const assetContext = getAssetContextForAI('story');
                const secondaryGuidance = brainstormSecondaryGuidance.value.trim();
                const guidanceText = secondaryGuidance ? `\n**Secondary Guidance:** ${secondaryGuidance}` : '';

                const prompt = `You are a creative idea generator. Brainstorm 6 unique and detailed concepts based on the following theme.
                **Theme:** ${concept}
                **Brainstorm Type:** ${globalState.story.brainstormType || 'Story Ideas'}
                ${guidanceText}
                ${assetContext}
                For each concept, provide a title and a short paragraph. Do not add any preamble or introductory text. Your entire response should consist of the 6 concepts, each separated by '---'.`;

                const result = await callGeminiAPI(prompt, ideasLoader);
                generateIdeasBtn.disabled = false;

                if (result && !result.startsWith("Error:")) {
                    const ideas = result.split('---').map(idea => idea.trim()).filter(Boolean);
                    ideasOutput.innerHTML = ideas.map(idea => {
                        const titleMatch = idea.match(/^\s*(?:\*\*|#+\s*)?(.*?)(?:\*\*|#+)?\s*\n/);
                        const title = titleMatch ? titleMatch[1].replace(/\*/g, '').trim() : 'Concept';
                        const description = titleMatch ? idea.substring(titleMatch[0].length).trim() : idea;
                        return `
                            <div class="idea-card bg-gray-900 p-6 rounded-lg cursor-pointer hover:border-blue-500">
                                <h3 class="text-xl font-bold text-blue-400 mb-2">${title}</h3>
                                <p class="text-gray-400">${description}</p>
                            </div>`;
                    }).join('');
                } else {
                    ideasOutput.innerHTML = `<p class="text-red-400">Failed to generate ideas. ${result || ''}</p>`;
                }
            });
            
            ideasOutput.addEventListener('click', (e) => {
                const card = e.target.closest('.idea-card');
                if (!card) return;

                document.querySelectorAll('.idea-card').forEach(c => c.classList.remove('selected-card'));
                card.classList.add('selected-card');

                const title = card.querySelector('h3').textContent;
                const description = card.querySelector('p').textContent;
                globalState.story.brainstormConcept = `<h3>${title}</h3><p>${description}</p>`;
                chosenIdeaDisplay.innerHTML = globalState.story.brainstormConcept;
                showStatus(`Concept "${title}" selected.`);
                
                // Automatically switch to outline stage
                setActiveStage('outline');
            });
            
            generateOutlineBtn.addEventListener('click', async () => {
                const outlineLoader = document.getElementById('outline-loader');
                const outlineSecondaryGuidance = document.getElementById('outline-secondary-guidance');

                const concept = chosenIdeaDisplay.textContent.trim();
                if (!concept || concept.includes('Select a concept')) {
                    showStatus("Please select or enter a concept first.", true);
                    return;
                }

                outlineLoader.classList.remove('hidden');
                outlineOutput.innerHTML = '';
                generateOutlineBtn.disabled = true;

                const assetContext = getAssetContextForAI('story');
                const secondaryGuidance = outlineSecondaryGuidance.value.trim();
                const guidanceText = secondaryGuidance ? `\n**Secondary Guidance:** ${secondaryGuidance}` : '';

                const prompt = `You are a master storyteller. Create a detailed story outline based on the following concept.
                **Concept:** ${concept}
                **Narrative Structure:** ${globalState.story.outlineStructure || 'Three-Act Structure'}
                **Target Audience:** ${globalState.story.targetAudience || 'Young Adult'}
                ${guidanceText}
                ${assetContext}
                Format the output using Markdown with clear headings for each section (e.g., Act 1, Scene 1).`;

                const result = await callGeminiAPI(prompt, outlineLoader);
                generateOutlineBtn.disabled = false;

                if (result && !result.startsWith("Error:")) {
                    globalState.story.storyOutline = result;
                    const formattedResult = cleanAndFormat(result);
                    outlineOutput.innerHTML = `<div class="bg-gray-900 p-6 rounded-lg shadow-inner"><div class="prose prose-invert max-w-none">${formattedResult}</div></div><button id="use-outline-btn" class="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Develop Treatment </button>`;
                    chosenOutlineDisplay.innerHTML = `<div class="prose prose-invert max-w-none text-gray-300 text-sm">${formattedResult}</div>`;

                } else {
                    outlineOutput.innerHTML = `<p class="text-red-400">Failed to generate outline. ${result || ''}</p>`;
                }
            });

            outlineOutput.addEventListener('click', e => {
                if (e.target.id === 'use-outline-btn') {
                    setActiveStage('treatment');
                }
            });

            generateTreatmentBtn.addEventListener('click', async () => {
                const treatmentLoader = document.getElementById('treatment-loader');
                const treatmentSecondaryGuidance = document.getElementById('treatment-secondary-guidance');

                if (!globalState.story.storyOutline) {
                    showStatus("Please generate or enter an outline first.", true);
                    return;
                }

                treatmentLoader.classList.remove('hidden');
                treatmentOutput.innerHTML = '';
                generateTreatmentBtn.disabled = true;

                const assetContext = getAssetContextForAI('story');
                const secondaryGuidance = treatmentSecondaryGuidance.value.trim();
                const guidanceText = secondaryGuidance ? `\n**Secondary Guidance:** ${secondaryGuidance}` : '';

                const prompt = `You are a screenwriter. Expand the following story outline into a detailed story treatment (a prose summary of the story).
                **Outline:**\n${globalState.story.storyOutline}
                **Final Format:** ${globalState.story.writingFormat || 'Short Story'}
                **Writing Style:** ${globalState.story.writingStyle || 'Casual'}
                ${guidanceText}
                ${assetContext}
                Write the treatment in a narrative, paragraph-based format.`;
                
                const result = await callGeminiAPI(prompt, treatmentLoader);
                generateTreatmentBtn.disabled = false;

                if (result && !result.startsWith("Error:")) {
                    globalState.story.storyTreatment = result;
                    const formattedResult = cleanAndFormat(result);
                    treatmentOutput.innerHTML = `<div class="bg-gray-900 p-6 rounded-lg shadow-inner"><div class="prose prose-invert max-w-none">${formattedResult}</div></div><button id="use-treatment-btn" class="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Start Writing </button>`;
                    writeTreatmentReference.innerHTML = formattedResult;
                } else {
                    treatmentOutput.innerHTML = `<p class="text-red-400">Failed to generate treatment. ${result || ''}</p>`;
                }
            });
            
            treatmentOutput.addEventListener('click', e => {
                if (e.target.id === 'use-treatment-btn') {
                    setActiveStage('write');
                }
            });

            saveStoryboardBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('#storyboard-output .storyboard-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showStatus('Please select at least one image to save.', true);
                    return;
                }
                selectedCheckboxes.forEach((checkbox, index) => {
                    const panel = checkbox.closest('.storyboard-panel');
                    const img = panel.querySelector('img');
                    if (img && img.src) {
                        const a = document.createElement('a');
                        a.href = img.src;
                        const projectTitle = sanitizeFilename(globalState.projectTitle);
                        a.download = `${projectTitle}-storyboard-${index + 1}.png`;
                        a.click();
                    }
                });
            });
            generateStoryboardBtn.addEventListener('click', handleStoryboardGeneration);
            reiterateStoryboardBtn.addEventListener('click', handleStoryboardReiteration);
            updateStoryboardStyleGems();
        }

        // --- CHARACTER TOOL INITIALIZATION ---
        function initCharacterTool() {
            const container = document.getElementById('character-tool');
            if(!container) return;
            
            const outputContainer = container.querySelector('#char-outputs');
            const generateTextBtn = container.querySelector('#generate-text-btn-char');
            const generateImageBtn = container.querySelector('#generate-image-btn-char');
            const form = container.querySelector('#character-form-unified');
            
            const imageElements = {
                spinner: container.querySelector('#loading-spinner-image-char'),
                img: container.querySelector('#generated-image-char'),
                placeholder: container.querySelector('#image-placeholder-char'),
                downloadBtn: container.querySelector('#download-image-btn-char')
            };

            const fieldDefinitions = [ { name: 'name', label: 'Character Name' }, { name: 'genre', label: 'Genre' }, { name: 'core-description', label: 'Core Description' }, { name: 'backstory', label: 'Backstory' }, { name: 'personality', label: 'Personality' }, { name: 'skills', label: 'Skills' }, { name: 'abilities', label: 'Abilities' }, { name: 'goals', label: 'Goals' }, { name: 'motivations', label: 'Motivations' }, { name: 'weaknesses', label: 'Weaknesses' }, { name: 'equipment', label: 'Equipment' }, { name: 'relationships', label: 'Relationships' }, { name: 'notes', label: 'Notes' }];
            
            // Inject output HTML
            const outputFormats = ['Workup', 'Markdown', 'JSON'];
            if(outputContainer.children.length === 0) {
                outputFormats.forEach(format => {
                    const formatId = format.toLowerCase();
                    outputContainer.innerHTML += `
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg output-container">
                            <div class="flex justify-between items-center cursor-pointer toggle-btn">
                                <h2 class="text-xl font-bold text-white">${format}</h2>
                                <div class="flex items-center space-x-2">
                                     <button class="copy-btn btn-secondary py-1 px-2 text-xs rounded" data-target="output-${formatId}-char">Copy</button>
                                     <button class="save-btn btn-secondary py-1 px-2 text-xs rounded" data-target="output-${formatId}-char" data-format="${formatId === 'workup' ? 'txt' : formatId}">Save</button>
                                     <svg class="w-6 h-6 text-gray-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                     </svg>
                                </div>
                            </div>
                            <div class="collapsible-content hidden mt-4">
                                <div class="tool-output-box"><div id="loading-spinner-${formatId}-char" class="loader hidden"></div><pre id="output-${formatId}-char" class="whitespace-pre-wrap text-sm w-full h-full"></pre></div>
                            </div>
                        </div>`;
                });
            }
            
            async function handleTextGeneration() {
                if (!userApiKey) {
                    showStatus("API Key is missing. Please add it in Settings.", true);
                    openModal('settings');
                    return;
                }
                generateTextBtn.disabled = true;
                generateTextBtn.textContent = 'Generating...';
                
                const allFieldsData = [], sectionsToGenerate = [];
                const allInputs = form.querySelectorAll('input.tool-input, textarea.tool-input');

                allInputs.forEach(input => {
                    const fieldName = input.dataset.fieldName;
                    const labelEl = document.querySelector(`label[for="char-${fieldName}"]`);
                    const label = labelEl ? labelEl.textContent : fieldName;

                    const value = input.value.trim();
                    const toggle = input.closest('div').querySelector('.ai-toggle-btn');
                    
                    if (value || (toggle && toggle.classList.contains('active'))) {
                        allFieldsData.push(`- **${label}:** ${value}`);
                        if (toggle && toggle.classList.contains('active')) {
                            sectionsToGenerate.push(label);
                        }
                    }
                });
                
                const assetContext = getAssetContextForAI('character');
                const secondaryGuidance = document.getElementById('char-secondary-guidance').value.trim();

                try {
                    const basePrompt = `You are a creative writing assistant. Generate a complete and cohesive character profile by synthesizing all available information.
                    **1. USER-PROVIDED DATA (Highest Priority):**\n${allFieldsData.join('\n')}
                    **2. ASSET CONTEXT (For additional guidance and consistency):**\n${assetContext}
                    **3. SECONDARY GUIDANCE:**\n${secondaryGuidance}
                    **4. YOUR TASK:** Create a single, cohesive profile. Integrate all provided data. Generate new, compelling content for any empty fields, and specifically refine or expand upon these requested sections: **${sectionsToGenerate.join(', ')}**. Ensure the final character is consistent with the provided asset context.
                    **OUTPUT FORMAT:** Return a complete profile with each field as a bold heading (e.g., **Character Name:** Alistair).`;

                    const workupOutput = await callGeminiAPI(basePrompt, document.getElementById('loading-spinner-workup-char'));
                    if (workupOutput.startsWith("Error:")) throw new Error(workupOutput);
                    document.getElementById('output-workup-char').textContent = workupOutput;
                    
                    const markdownPrompt = `Condense the following detailed character workup into a concise Markdown format, suitable for a quick reference sheet. WORKUP:\n${workupOutput}`;
                    const jsonPrompt = `Based on the following Markdown, distill the character profile into a clean, simple JSON object. Use camelCase for keys (e.g., "characterName"). JSON:\n${workupOutput}`;

                    const markdownOutput = await callGeminiAPI(markdownPrompt, document.getElementById('loading-spinner-markdown-char'));
                    if (markdownOutput.startsWith("Error:")) throw new Error(markdownOutput);
                     document.getElementById('output-markdown-char').textContent = markdownOutput;

                    const jsonOutput = await callGeminiAPI(jsonPrompt, document.getElementById('loading-spinner-json-char'));
                    if (jsonOutput.startsWith("Error:")) throw new Error(jsonOutput);
                     document.getElementById('output-json-char').textContent = jsonOutput.replace(/```json/g, '').replace(/```/g, '');

                    showStatus('Character profile generated.');
                    
                } catch (error) { showStatus(`Text Gen Error: ${error.message}`, true); } 
                finally { generateTextBtn.disabled = false; generateTextBtn.textContent = 'Generate Full Profile'; }
            }

            async function handleImageGeneration() {
                if (!userApiKey) {
                    showStatus("API Key is missing. Please add it in Settings.", true);
                    openModal('settings');
                    return;
                }
                generateImageBtn.disabled = true; generateImageBtn.textContent = 'Generating...';
                imageElements.spinner.classList.remove('hidden');
                imageElements.placeholder.style.display = 'none';
                imageElements.img.style.display = 'none';
                imageElements.downloadBtn.style.display = 'none';

                try {
                    
                    const attributes = {};
                     form.querySelectorAll('input.tool-input, textarea.tool-input').forEach(input => {
                         attributes[input.dataset.fieldName] = input.value;
                     });

                    const style = globalState.character.artStyle;
                    const substyle = globalState.character.substyle;
                    const imageGuidance = document.getElementById('char-image-guidance').value.trim();
                    
                    const pose = globalState.character.pose;
                    let posePromptPrefix = '';
                    let corePrompt = `a ${attributes.gender || 'character'}. Build: ${attributes.build}. Hair: ${attributes.hairColor}. Eyes: ${attributes.eyeColor}. Details: ${attributes.details}. Clothing: ${attributes.clothing}. Expression: ${attributes.expression}.`;

                    switch (pose) {
                        case 'Concept Sheet':
                            posePromptPrefix = 'Character concept sheet, multiple views (front, back, side profile), full body, detailed face, clean background, reference sheet.';
                            break;
                        case 'In Scene':
                            posePromptPrefix = `Full body shot of the character in a dynamic scene.`;
                            corePrompt += ` Setting: ${attributes.background}.`;
                            break;
                        case 'Action Pose':
                            posePromptPrefix = `Dynamic action pose of the character.`;
                            corePrompt += ` Setting: ${attributes.background}.`;
                            break;
                        case 'Modeling Pose':
                            posePromptPrefix = `Full body, standing modeling pose of the character.`;
                            break;
                        case 'Close Up':
                        default:
                            if (!['Concept Sheet', 'In Scene', 'Action Pose', 'Modeling Pose', 'Close Up'].includes(pose)) {
                                 posePromptPrefix = `${pose} of a`; // For custom poses
                            } else {
                                 posePromptPrefix = 'Close up portrait from the chest up of the character.';
                            }
                            break;
                    }

                    const positivePrompt = `${posePromptPrefix} ${corePrompt.replace(/\s+/g, ' ').trim()}, ${substyle}, ${style} style, ${imageGuidance}`;
                    const negativePrompt = attributes.negative_prompts_char || 'blurry, low quality, text, watermark';

                    const imageUrl = await callImagenAPI(positivePrompt, negativePrompt);
                    if(imageUrl){
                        imageElements.img.src = imageUrl;
                        imageElements.img.style.display = 'block';
                        imageElements.downloadBtn.style.display = 'block';
                    } else {
                         imageElements.placeholder.innerHTML = `<span class="text-red-400">Image Error</span>`;
                         imageElements.placeholder.style.display = 'block';
                    }
                } catch (error) { 
                    showStatus(`Image Gen Error: ${error.message}`, true);
                    imageElements.placeholder.innerHTML = `<span class="text-red-400">Image Error</span>`;
                    imageElements.placeholder.style.display = 'block';
                } 
                finally {
                    imageElements.spinner.classList.add('hidden');
                    generateImageBtn.disabled = false; generateImageBtn.textContent = 'Generate Image';
                }
            }
            
            generateTextBtn.addEventListener('click', handleTextGeneration);
            generateImageBtn.addEventListener('click', handleImageGeneration);
            imageElements.downloadBtn.addEventListener('click', () => {
                const name = document.getElementById('char-name')?.value || 'character';
                const filename = `${sanitizeFilename(name)}.char.png`;
                const a = document.createElement('a'); a.href = imageElements.img.src; a.download = filename; a.click();
            });
        }

        // --- SCENE BUILDER INITIALIZATION ---
        function initSceneBuilder() {
            const container = document.getElementById('scene-builder');
            if(!container) return;
            
            const outputContainer = container.querySelector('#scene-outputs');
            const generateTextBtn = container.querySelector('#generate-text-btn-scene');
            const generateImageBtn = container.querySelector('#generate-image-btn-scene');
            const form = container.querySelector('#scene-form-unified');
            
            const imageElements = {
                spinner: container.querySelector('#loading-spinner-image-scene'),
                img: container.querySelector('#generated-image-scene'),
                placeholder: container.querySelector('#image-placeholder-scene'),
                downloadBtn: container.querySelector('#download-image-btn-scene')
            };

            const fieldDefinitions = [ { name: 'name', label: 'Scene Name' }, { name: 'genre', label: 'Genre' }, { name: 'overview', label: 'Overview' }, { name: 'atmosphere', label: 'Atmosphere / Mood' }, { name: 'exterior', label: 'Exterior Description' }, { name: 'interior', label: 'Interior Description' }, { name: 'history', label: 'History' }];
            
            const outputFormats = ['Workup', 'Markdown', 'JSON'];
             if(outputContainer.children.length === 0) {
                outputFormats.forEach(format => {
                    const formatId = format.toLowerCase();
                    outputContainer.innerHTML += `
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg output-container">
                             <div class="flex justify-between items-center cursor-pointer toggle-btn">
                                <h2 class="text-xl font-bold text-white">${format}</h2>
                                <div class="flex items-center space-x-2">
                                     <button class="copy-btn btn-secondary py-1 px-2 text-xs rounded" data-target="output-${formatId}-scene">Copy</button>
                                     <button class="save-btn btn-secondary py-1 px-2 text-xs rounded" data-target="output-${formatId}-scene" data-format="${formatId === 'workup' ? 'txt' : formatId}">Save</button>
                                     <svg class="w-6 h-6 text-gray-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                     </svg>
                                </div>
                            </div>
                            <div class="collapsible-content hidden mt-4">
                                <div class="tool-output-box"><div id="loading-spinner-${formatId}-scene" class="loader hidden"></div><pre id="output-${formatId}-scene" class="whitespace-pre-wrap text-sm w-full h-full"></pre></div>
                            </div>
                        </div>`;
                });
            }

            async function handleTextGeneration() {
                if (!userApiKey) {
                    showStatus("API Key is missing. Please add it in Settings.", true);
                    openModal('settings');
                    return;
                }
                generateTextBtn.disabled = true;
                generateTextBtn.textContent = 'Generating...';
                
                const allFieldsData = [], sectionsToGenerate = [];
                fieldDefinitions.forEach(field => {
                    const input = form.querySelector(`#scene-${field.name}`);
                    const value = input ? input.value.trim() : '';
                    const toggle = input.closest('div').querySelector('.ai-toggle-btn');

                    if (value || (toggle && toggle.classList.contains('active'))) {
                        allFieldsData.push(`- **${field.label}:** ${value}`);
                        if (toggle && toggle.classList.contains('active')) {
                            sectionsToGenerate.push(field.label);
                        }
                    }
                });
                const assetContext = getAssetContextForAI('scene');
                const secondaryGuidance = document.getElementById('scene-secondary-guidance').value.trim();

                try {
                    const basePrompt = `You are a creative writing assistant. Generate a complete and cohesive scene profile by synthesizing all available information.
                    **1. USER-PROVIDED DATA (Highest Priority):**\n${allFieldsData.join('\n')}
                    **2. ASSET CONTEXT (For additional guidance and consistency):**\n${assetContext}
                    **3. SECONDARY GUIDANCE:**\n${secondaryGuidance}
                    **4. YOUR TASK:** Create a single, cohesive profile. Integrate all provided data. Generate new, compelling content for any empty fields, and specifically refine or expand upon these requested sections: **${sectionsToGenerate.join(', ')}**. Ensure the final scene is consistent with the provided asset context.
                    **OUTPUT FORMAT:** Return a complete profile with each field as a bold heading (e.g., **Scene Name:** The Final Confrontation).`;

                    const workupOutput = await callGeminiAPI(basePrompt, document.getElementById('loading-spinner-workup-scene'));
                    if (workupOutput.startsWith("Error:")) throw new Error(workupOutput);
                    document.getElementById('output-workup-scene').textContent = workupOutput;
                    
                    const markdownPrompt = `Condense the following detailed scene workup into a concise Markdown format, suitable for a quick reference sheet. WORKUP:\n${workupOutput}`;
                    const jsonPrompt = `Based on the following Markdown, distill the scene profile into a clean, simple JSON object. Use camelCase for keys (e.g., "sceneName"). JSON:\n${workupOutput}`;

                    const markdownOutput = await callGeminiAPI(markdownPrompt, document.getElementById('loading-spinner-markdown-scene'));
                    if (markdownOutput.startsWith("Error:")) throw new Error(markdownOutput);
                    document.getElementById('output-markdown-scene').textContent = markdownOutput;

                    const jsonOutput = await callGeminiAPI(jsonPrompt, document.getElementById('loading-spinner-json-scene'));
                    if (jsonOutput.startsWith("Error:")) throw new Error(jsonOutput);
                    document.getElementById('output-json-scene').textContent = jsonOutput.replace(/```json/g, '').replace(/```/g, '');

                    showStatus('Scene profile generated.');
                    
                } catch (error) { showStatus(`Text Gen Error: ${error.message}`, true); } 
                finally { generateTextBtn.disabled = false; generateTextBtn.textContent = 'Generate Full Profile'; }
            }

            async function handleImageGeneration() { 
                if (!userApiKey) {
                    showStatus("API Key is missing. Please add it in Settings.", true);
                    openModal('settings');
                    return;
                }
                generateImageBtn.disabled = true; generateImageBtn.textContent = 'Generating...';
                imageElements.spinner.classList.remove('hidden');
                imageElements.placeholder.style.display = 'none';
                imageElements.img.style.display = 'none';
                imageElements.downloadBtn.style.display = 'none';

                try {
                    const attributes = {};
                     form.querySelectorAll('input.tool-input, textarea.tool-input').forEach(input => {
                         attributes[input.dataset.fieldName] = input.value;
                     });

                    const style = globalState.scene.artStyle;
                    const substyle = globalState.scene.substyle;
                    const imageGuidance = document.getElementById('scene-image-guidance').value.trim();
                    const corePrompt = `A wide-angle shot of a ${attributes.name || attributes.genre || 'scene'}, ${attributes.exterior}. Style: ${attributes.architectural_style}. Environment: ${attributes.time_of_day}, ${attributes.weather}. Atmosphere: ${attributes.atmosphere}. Details: ${attributes.other_details}`;
                    const positivePrompt = `${corePrompt.replace(/\s+/g, ' ').trim()}, ${substyle}, ${style} style, ${imageGuidance}`;
                    const negativePrompt = attributes.negative_prompts_scene || 'blurry, low quality, text, watermark, people, vehicles';

                    const imageUrl = await callImagenAPI(positivePrompt, negativePrompt);
                     if(imageUrl){
                        imageElements.img.src = imageUrl;
                        imageElements.img.style.display = 'block';
                        imageElements.downloadBtn.style.display = 'block';
                    } else {
                         imageElements.placeholder.innerHTML = `<span class="text-red-400">Image Error</span>`;
                         imageElements.placeholder.style.display = 'block';
                    }
                } catch (error) {
                     showStatus(`Image Gen Error: ${error.message}`, true);
                     imageElements.placeholder.innerHTML = `<span class="text-red-400">Image Error</span>`;
                     imageElements.placeholder.style.display = 'block';
                }
                finally {
                    imageElements.spinner.classList.add('hidden');
                    generateImageBtn.disabled = false; generateImageBtn.textContent = 'Generate Image';
                }
            }
            
            generateTextBtn.addEventListener('click', handleTextGeneration);
            generateImageBtn.addEventListener('click', handleImageGeneration);
            imageElements.downloadBtn.addEventListener('click', () => {
                const name = document.getElementById('scene-name')?.value || 'scene';
                const filename = `${sanitizeFilename(name)}.scen.png`;
                const a = document.createElement('a'); a.href = imageElements.img.src; a.download = filename; a.click();
            });
        }
        
        // --- SETTING TOOL INITIALIZATION ---
        function initSettingTool() {
            const container = document.getElementById('setting-tool');
            if(!container) return;
            
            const outputContainer = container.querySelector('#setting-outputs');
            const generateTextBtn = container.querySelector('#generate-text-btn-setting');
            const generateImageBtn = container.querySelector('#generate-image-btn-setting');
            const form = container.querySelector('#setting-form-unified');
            
            const imageElements = {
                spinner: container.querySelector('#loading-spinner-image-setting'),
                img: container.querySelector('#generated-image-setting'),
                placeholder: container.querySelector('#image-placeholder-setting'),
                downloadBtn: container.querySelector('#download-image-btn-setting')
            };

            const fieldDefinitions = [ { name: 'name', label: 'Setting Name' }, { name: 'genre', label: 'Genre' }, { name: 'timePeriod', label: 'Time Period / Era' }, { name: 'corePremise', label: 'Core Premise' }, { name: 'geography', label: 'Geography & Topography' }, { name: 'climate', label: 'Climate & Weather' }, { name: 'floraFauna', label: 'Flora & Fauna' }, { name: 'population', label: 'Population & Demographics' }, { name: 'government', label: 'Government & Politics' }, { name: 'economy', label: 'Economy & Trade' }, { name: 'culture', label: 'Arts & Culture' }, { name: 'technology', label: 'Technology Level' }, { name: 'magic', label: 'Magic System' }, { name: 'religion', label: 'Religion & Cosmology' }, { name: 'history', label: 'Key Historical Events' }, { name: 'lore', label: 'Myths & Legends' }];
            
            const outputFormats = ['Workup', 'Markdown', 'JSON'];
             if(outputContainer.children.length === 0) {
                outputFormats.forEach(format => {
                    const formatId = format.toLowerCase();
                    outputContainer.innerHTML += `
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg output-container">
                             <div class="flex justify-between items-center cursor-pointer toggle-btn">
                                <h2 class="text-xl font-bold text-white">${format}</h2>
                                <div class="flex items-center space-x-2">
                                     <button class="copy-btn btn-secondary py-1 px-2 text-xs rounded" data-target="output-${formatId}-setting">Copy</button>
                                     <button class="save-btn btn-secondary py-1 px-2 text-xs rounded" data-target="output-${formatId}-setting" data-format="${formatId === 'workup' ? 'txt' : formatId}">Save</button>
                                     <svg class="w-6 h-6 text-gray-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                     </svg>
                                </div>
                            </div>
                            <div class="collapsible-content hidden mt-4">
                                <div class="tool-output-box"><div id="loading-spinner-${formatId}-setting" class="loader hidden"></div><pre id="output-${formatId}-setting" class="whitespace-pre-wrap text-sm w-full h-full"></pre></div>
                            </div>
                        </div>`;
                });
            }

            async function handleTextGeneration() {
                if (!userApiKey) {
                    showStatus("API Key is missing. Please add it in Settings.", true);
                    openModal('settings');
                    return;
                }
                generateTextBtn.disabled = true;
                generateTextBtn.textContent = 'Generating...';
                
                const allFieldsData = [], sectionsToGenerate = [];
                fieldDefinitions.forEach(field => {
                    const input = form.querySelector(`#setting-${field.name}`);
                    const value = input ? input.value.trim() : '';
                    const toggle = input.closest('div').querySelector('.ai-toggle-btn');

                    if (value || (toggle && toggle.classList.contains('active'))) {
                        allFieldsData.push(`- **${field.label}:** ${value}`);
                        if (toggle && toggle.classList.contains('active')) {
                            sectionsToGenerate.push(field.label);
                        }
                    }
                });
                const assetContext = getAssetContextForAI('setting');
                const secondaryGuidance = document.getElementById('setting-secondary-guidance').value.trim();

                try {
                    const basePrompt = `You are a world-building assistant. Generate a complete and cohesive setting profile by synthesizing all available information.
                    **1. USER-PROVIDED DATA (Highest Priority):**\n${allFieldsData.join('\n')}
                    **2. ASSET CONTEXT (For additional guidance and consistency):**\n${assetContext}
                    **3. SECONDARY GUIDANCE:**\n${secondaryGuidance}
                    **4. YOUR TASK:** Create a single, cohesive profile. Integrate all provided data. Generate new, compelling content for any empty fields, and specifically refine or expand upon these requested sections: **${sectionsToGenerate.join(', ')}**. Ensure the final setting is consistent with the provided asset context.
                    **OUTPUT FORMAT:** Return a complete profile with each field as a bold heading (e.g., **Setting Name:** The Clockwork City).`;

                    const workupOutput = await callGeminiAPI(basePrompt, document.getElementById('loading-spinner-workup-setting'));
                    if (workupOutput.startsWith("Error:")) throw new Error(workupOutput);
                    document.getElementById('output-workup-setting').textContent = workupOutput;
                    
                    const markdownPrompt = `Condense the following detailed setting workup into a concise Markdown format, suitable for a quick reference sheet. WORKUP:\n${workupOutput}`;
                    const jsonPrompt = `Based on the following Markdown, distill the setting profile into a clean, simple JSON object. Use camelCase for keys (e.g., "settingName"). JSON:\n${workupOutput}`;

                    const markdownOutput = await callGeminiAPI(markdownPrompt, document.getElementById('loading-spinner-markdown-setting'));
                    if (markdownOutput.startsWith("Error:")) throw new Error(markdownOutput);
                    document.getElementById('output-markdown-setting').textContent = markdownOutput;

                    const jsonOutput = await callGeminiAPI(jsonPrompt, document.getElementById('loading-spinner-json-setting'));
                    if (jsonOutput.startsWith("Error:")) throw new Error(jsonOutput);
                    document.getElementById('output-json-setting').textContent = jsonOutput.replace(/```json/g, '').replace(/```/g, '');

                    showStatus('Setting profile generated.');
                    
                } catch (error) { showStatus(`Text Gen Error: ${error.message}`, true); } 
                finally { generateTextBtn.disabled = false; generateTextBtn.textContent = 'Generate Full Profile'; }
            }

            async function handleImageGeneration() { 
                if (!userApiKey) {
                    showStatus("API Key is missing. Please add it in Settings.", true);
                    openModal('settings');
                    return;
                }
                generateImageBtn.disabled = true; generateImageBtn.textContent = 'Generating...';
                imageElements.spinner.classList.remove('hidden');
                imageElements.placeholder.style.display = 'none';
                imageElements.img.style.display = 'none';
                imageElements.downloadBtn.style.display = 'none';

                try {
                    const attributes = {};
                     form.querySelectorAll('input.tool-input, textarea.tool-input').forEach(input => {
                         attributes[input.dataset.fieldName] = input.value;
                     });

                    const style = globalState.setting.artStyle;
                    const substyle = globalState.setting.substyle;
                    const imageGuidance = document.getElementById('setting-image-guidance').value.trim();
                    const corePrompt = `A wide-angle shot of a ${attributes.name || attributes.genre || 'setting'}. Style: ${attributes.architectural_style}. Environment: ${attributes.time_of_day}, ${attributes.weather_vis}. Details: ${attributes.other_details}`;
                    const positivePrompt = `${corePrompt.replace(/\s+/g, ' ').trim()}, ${substyle}, ${style} style, ${imageGuidance}`;
                    const negativePrompt = attributes.negative_prompts_setting || 'blurry, low quality, text, watermark, people, vehicles';

                    const imageUrl = await callImagenAPI(positivePrompt, negativePrompt);
                     if(imageUrl){
                        imageElements.img.src = imageUrl;
                        imageElements.img.style.display = 'block';
                        imageElements.downloadBtn.style.display = 'block';
                    } else {
                         imageElements.placeholder.innerHTML = `<span class="text-red-400">Image Error</span>`;
                         imageElements.placeholder.style.display = 'block';
                    }
                } catch (error) {
                     showStatus(`Image Gen Error: ${error.message}`, true);
                     imageElements.placeholder.innerHTML = `<span class="text-red-400">Image Error</span>`;
                     imageElements.placeholder.style.display = 'block';
                }
                finally {
                    imageElements.spinner.classList.add('hidden');
                    generateImageBtn.disabled = false; generateImageBtn.textContent = 'Generate Image';
                }
            }
            
            generateTextBtn.addEventListener('click', handleTextGeneration);
            generateImageBtn.addEventListener('click', handleImageGeneration);
            imageElements.downloadBtn.addEventListener('click', () => {
                const name = document.getElementById('setting-name')?.value || 'setting';
                const filename = `${sanitizeFilename(name)}.sett.png`;
                const a = document.createElement('a'); a.href = imageElements.img.src; a.download = filename; a.click();
            });
        }
        
        function resetAllToolForms() {
            const toolSelectors = ['#character-tool', '#scene-builder', '#setting-tool'];
            toolSelectors.forEach(selector => {
                const container = document.querySelector(selector);
                if (!container) return;

                container.querySelectorAll('input.tool-input, textarea.tool-input').forEach(input => {
                    input.value = '';
                    input.disabled = false;
                    if(input.tagName.toLowerCase() === 'textarea') autoResizeTextarea({target: input});
                });

                container.querySelectorAll('.ai-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                container.querySelectorAll('.accordion-header').forEach(header => {
                    header.classList.add('needs-attention');
                });

                // Set 'name' field AI to be on by default
                const nameInput = container.querySelector('input[data-field-name="name"]');
                if (nameInput) {
                    const toggle = nameInput.closest('div').querySelector('.ai-toggle-btn');
                    if(toggle){
                        toggle.classList.add('active');
                        nameInput.disabled = true;
                    }
                }
            });
        }
        
        function initToolInputs() {
            document.querySelectorAll('textarea.tool-input').forEach(textarea => {
                autoResizeTextarea({ target: textarea });
                textarea.addEventListener('input', autoResizeTextarea, false);
            });
        }
        
        function initToolForms() {
            const toolSelectors = ['#character-tool', '#scene-builder', '#setting-tool'];
            toolSelectors.forEach(selector => {
                 const container = document.querySelector(selector);
                if (!container) return;
                
                container.querySelectorAll('.accordion-header').forEach(header => {
                    header.classList.add('needs-attention');
                });

                 // Set 'name' field AI to be on by default on initial load
                const nameInput = container.querySelector('input[data-field-name="name"]');
                if (nameInput) {
                    const toggle = nameInput.closest('div').querySelector('.ai-toggle-btn');
                    if(toggle){
                        toggle.classList.add('active');
                        nameInput.disabled = true;
                    }
                }

                const form = container.querySelector('form');
                if(form) {
                    form.addEventListener('input', (e) => {
                        if (e.target.classList.contains('tool-input')) {
                             const section = e.target.closest('.accordion-section');
                             if(section) {
                                 section.querySelector('.accordion-header').classList.remove('needs-attention');
                             }
                        }
                    });
                }
            });
        }


        // --- APP START ---
        loadApiKey();
        initStoryWeaver();
        initCharacterTool();
        initSceneBuilder();
        initSettingTool();
        initToolInputs();
        initToolForms();
        loadStateFromLocalStorage();

        // Populate UI from initial state on first load
        updateAllSidebarGems();
        updateCharacterPathDisplay();
        updateScenePathDisplay();
        updateSettingPathDisplay();

        // Initial setup for layout
        document.getElementById('character-tool').style.display = 'none';
        document.getElementById('scene-builder').style.display = 'none';
        document.getElementById('setting-tool').style.display = 'none';
        
        // --- GLOBAL EVENT LISTENERS ---
        document.getElementById('settings-btn').addEventListener('click', () => openModal('settings'));
        document.getElementById('close-settings-modal-btn').addEventListener('click', () => closeModal('settings'));
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeModal('settings'); });
        document.getElementById('save-api-key-btn').addEventListener('click', saveApiKey);
        
        document.getElementById('project-options-btn').addEventListener('click', () => openModal('project'));
        document.getElementById('close-modal-btn').addEventListener('click', () => closeModal('project'));
        projectModal.addEventListener('click', (e) => { if (e.target === projectModal) closeModal('project'); });
        document.getElementById('load-json-btn').addEventListener('click', () => jsonFileInput.click());
        jsonFileInput.addEventListener('change', handleJsonLoad);
        document.getElementById('export-json-btn').addEventListener('click', exportToJson);
        document.getElementById('export-text-btn').addEventListener('click', exportAsText);
        document.getElementById('print-project-btn').addEventListener('click', printProject);
        document.getElementById('new-project-btn').addEventListener('click', clearProject);
        projectTitleEl.addEventListener('input', (e) => {
            globalState.projectTitle = e.target.textContent;
            saveStateToLocalStorage();
        });


        document.querySelectorAll('.copy-btn, .save-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const targetId = e.currentTarget.dataset.target;
                const text = document.getElementById(targetId)?.textContent;
                if (!text) return;

                if (e.currentTarget.classList.contains('copy-btn')) {
                    navigator.clipboard.writeText(text).then(() => showStatus('Copied to clipboard!'));
                } else {
                    const format = e.currentTarget.dataset.format;
                    let name = 'download';
                    let typeAbbr = 'file';
                    let nameFound = false;

                    try {
                        if (format === 'json') {
                            const jsonObj = JSON.parse(text);
                            if (targetId.includes('-char')) {
                                name = jsonObj.characterName || jsonObj.name;
                                typeAbbr = 'char';
                            } else if (targetId.includes('-scene')) {
                                name = jsonObj.sceneName || jsonObj.name;
                                typeAbbr = 'scen';
                            } else if (targetId.includes('-setting')) {
                                name = jsonObj.settingName || jsonObj.name;
                                typeAbbr = 'sett';
                            }
                            if (name) nameFound = true;
                        } else { // txt or md
                            let match;
                            if (targetId.includes('-char')) {
                                match = text.match(/\*\*Character Name:\*\*\s*(.*)/i);
                                typeAbbr = 'char';
                            } else if (targetId.includes('-scene')) {
                                match = text.match(/\*\*Scene Name:\*\*\s*(.*)/i);
                                typeAbbr = 'scen';
                            } else if (targetId.includes('-setting')) {
                                match = text.match(/\*\*Setting Name:\*\*\s*(.*)/i);
                                typeAbbr = 'sett';
                            }
                            if (match && match[1]) {
                                name = match[1].trim();
                                nameFound = true;
                            }
                        }
                    } catch (err) {
                        console.error("Error parsing content for filename:", err);
                        nameFound = false;
                    }

                    if (!nameFound) {
                         if (targetId.includes('-char')) {
                            name = document.getElementById('char-name')?.value || 'character';
                            typeAbbr = 'char';
                        } else if (targetId.includes('-scene')) {
                            name = document.getElementById('scene-name')?.value || 'scene';
                            typeAbbr = 'scen';
                        } else if (targetId.includes('-setting')) {
                            name = document.getElementById('setting-name')?.value || 'setting';
                            typeAbbr = 'sett';
                        }
                    }
                    
                    const filename = `${sanitizeFilename(name)}.${typeAbbr}.${format}`;
                    const blob = new Blob([text], { type: `text/${format};charset=utf-8` });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
        });

        const assetFileInput = document.getElementById('asset-file-input');
        
        function handleGlobalAssetLoad(event) {
            const files = event.target.files;
            if(!files.length) return;

            const activeTabButton = document.querySelector('.main-tab-btn.active');
            let assetType = 'story'; // default
            if (activeTabButton.id === 'tab-character') {
                assetType = 'character';
            } else if (activeTabButton.id === 'tab-scene') {
                assetType = 'scene';
            } else if (activeTabButton.id === 'tab-setting') {
                assetType = 'setting';
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (file.type.startsWith('image/')) {
                            addAssetToState({ type: 'image', content: e.target.result, fileName: file.name }, assetType);
                        } else if (file.name.endsWith('.json')) {
                            addAssetToState({ type: 'json', content: JSON.parse(e.target.result), fileName: file.name }, assetType);
                        } else if (file.name.endsWith('.txt') || file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                            addAssetToState({ type: 'text', content: e.target.result, fileName: file.name }, assetType);
                        }
                    } catch (error) { 
                        alert(`Error parsing ${file.name}: ${error.message}`); 
                    }
                };

                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else if (file.name.endsWith('.json') || file.name.endsWith('.txt') || file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                    reader.readAsText(file);
                } else {
                    showStatus(`Unsupported file type: ${file.name}`, true);
                }
            });
            event.target.value = null; // Reset file input
        }
        
        document.getElementById('load-asset-btn').addEventListener('click', () => assetFileInput.click());
        document.getElementById('load-asset-btn-char').addEventListener('click', () => assetFileInput.click());
        document.getElementById('load-asset-btn-scene').addEventListener('click', () => assetFileInput.click());
        document.getElementById('load-asset-btn-setting').addEventListener('click', () => assetFileInput.click());
        assetFileInput.addEventListener('change', handleGlobalAssetLoad);

        document.querySelectorAll('#asset-container, #asset-container-char, #asset-container-scene, #asset-container-setting').forEach(container => {
             container.addEventListener('click', e => {
                const card = e.target.closest('.asset-card');
                if (card) {
                    const assetType = card.dataset.assetType;
                    const assetId = card.dataset.id;
                    openAssetModal(assetId, assetType);
                }
            });
        });
        
        document.body.addEventListener('click', (e) => {
            // Path Gem handler
            const gemButton = e.target.closest('.path-gem');
            if (gemButton) {
                openPathModal(gemButton.dataset.setting);
                return; 
            }

            // Accordion handler for sections like Character form and Generation Controls
            const accordionHeader = e.target.closest('.accordion-header');
            if (accordionHeader) {
                accordionHeader.parentElement.classList.toggle('open');
                return;
            }

            // AI toggle button handler for Character Tool
            const aiToggleBtn = e.target.closest('.ai-toggle-btn');
            if(aiToggleBtn) {
                aiToggleBtn.classList.toggle('active');
                const input = aiToggleBtn.closest('div').querySelector('.tool-input');
                if(input) {
                    input.disabled = aiToggleBtn.classList.contains('active');
                    if (input.disabled) {
                        input.value = '';
                        if (input.tagName.toLowerCase() === 'textarea') {
                            autoResizeTextarea({ target: input });
                        }
                    }
                }
                const section = aiToggleBtn.closest('.accordion-section');
                if(section) {
                    section.querySelector('.accordion-header').classList.remove('needs-attention');
                }
                return;
            }
            
            // Output block toggler
            const toggleButton = e.target.closest('.toggle-btn');
            if (toggleButton) {
                if (e.target.closest('.copy-btn') || e.target.closest('.save-btn')) {
                    return;
                }
                const content = toggleButton.closest('.output-container').querySelector('.collapsible-content');
                const icon = toggleButton.querySelector('svg');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        });

        pathSettingsModal.addEventListener('click', (e) => { if (e.target === pathSettingsModal) closePathModal(); });
        
        closeAssetModalBtn.addEventListener('click', closeAssetModal);
        assetPreviewModal.addEventListener('click', (e) => {
            if (e.target === assetPreviewModal) closeAssetModal();
        });

        document.body.addEventListener('input', e => {
            // Auto-disable AI toggle when user types in a field in the character builder
             if (e.target.classList.contains('tool-input') && (e.target.closest('#character-accordion') || e.target.closest('#scene-accordion') || e.target.closest('#setting-accordion'))) {
                const toggleBtn = e.target.closest('div').querySelector('.ai-toggle-btn');
                if (toggleBtn && toggleBtn.classList.contains('active')) {
                    toggleBtn.classList.remove('active');
                    e.target.disabled = false;
                }
            }
        });
    });
    </script>
</body>
</html>
