<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Folio</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Global Theme --- */
        :root {
            --bg-main: #212121;
            --bg-section: #333333;
            --bg-header: #1f2937;
            --bg-input: #424242;
            --bg-input-focus: #616161;
            --bg-hover: #4f4f4f;
            --text-light: #f5f5f5;
            --text-subtle: #9e9e9e;
            --text-dark: #212121;
            --border-main: #9e9e9e;
            --border-subtle: #616161;
            --font-body: 'Trebuchet MS', sans-serif;
            --font-display: 'Trebuchet MS', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-light);
            font-family: 'Trebuchet MS', sans-serif;
            padding: 2rem;
        }

        /* --- Persona Folio Specific Styles --- */
        .persona-folio-container {
            font-family: var(--font-body); max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; 
            gap: 1.5rem; text-transform: none;
        }
        .persona-folio-container .main-section { 
            border: 2px solid var(--border-main); padding: 1.5rem; background-color: var(--bg-input); border-radius: 8px;
        }
        .persona-folio-container .sheet-header { 
            display: flex; justify-content: space-between; align-items: center; text-align: center; font-family: var(--font-display); 
            border-bottom: 2px solid var(--border-subtle); margin-bottom: 1.5rem; padding-bottom: 1rem; 
        }
        .persona-folio-container .sheet-header h1 { margin: 0; color: var(--text-light); font-size: 1.5rem; }
        .persona-folio-container #actor-display-header { 
            font-size: 1.8rem; /* Increased size */
            font-weight: bold; /* Ensured bold */
            color: #60a5fa; /* Changed to blue */
        }
        .persona-folio-container .creator-credit {
            text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: var(--text-light);
            font-family: var(--font-display); letter-spacing: 2px;
        }
        .file-menu { position: relative; }
        .file-menu-button {
            font-family: var(--font-body); font-weight: bold; font-size: 0.9rem; padding: 0.75rem 1rem; 
            border: 2px solid var(--text-light); border-radius: 5px; background-color: var(--bg-section); color: #ffffff; 
            cursor: pointer; transition: all 0.2s ease-in-out; text-shadow: 1px 1px 2px #000;
        }
        .file-menu-button:hover {
            background-color: #eeeeee; color: #212121; border-color: #eeeeee; text-shadow: none;
        }
        .file-menu-dropdown {
            display: none; position: absolute; left: 0; top: 100%;
            background-color: var(--bg-section); border: 2px solid var(--border-main);
            border-radius: 5px; padding: 0.5rem; z-index: 100; min-width: 200px;
        }
        .file-menu-dropdown.show { display: block; }
        .file-menu-dropdown button {
            display: block; width: 100%; text-align: left; background-color: var(--bg-input);
            color: var(--text-light); border-radius: 3px; border: none; padding: 0.5rem; cursor: pointer;
        }
        .file-menu-dropdown button:hover:not(:disabled) { filter: brightness(1.2); }
        
        .persona-folio-container .columns-2 { display: flex; gap: 1.5rem; }
        .persona-folio-container .columns-2 > .col-left, .persona-folio-container .columns-2 > .col-right { flex: 1; }
        .persona-folio-container .columns-2.equal-width > * { flex: 1; }
        .persona-folio-container fieldset { 
            border: 2px solid var(--border-main); border-radius: 4px; padding: 1rem; margin: 0 0 1.5rem 0; 
        }
        .persona-folio-container fieldset:last-child { margin-bottom: 0; }
        .persona-folio-container legend { 
            font-weight: bold; padding: 0 0.5rem; font-family: var(--font-display); text-transform: uppercase; 
        }
        .persona-folio-container .input-group { display: flex; flex-direction: column; }
        .persona-folio-container .input-group.full-width { grid-column: 1 / -1; }
        .persona-folio-container label { margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: bold; color: var(--text-light); }
        .persona-folio-container input, .persona-folio-container select, .persona-folio-container textarea { 
            width: 100%; padding: 0.5rem; border: 1.5px solid var(--border-main); border-radius: 4px;
            background-color: var(--bg-input); color: var(--text-light); font-family: var(--font-body); font-size: 1rem; 
        }
        .persona-folio-container textarea { resize: vertical; }

        /* --- Read-only Field Styling --- */
        .persona-folio-container input[readonly],
        .persona-folio-container textarea[readonly] {
            background-color: var(--bg-section);
            cursor: not-allowed;
        }

        .persona-folio-container .attack-grid { display: grid; grid-template-columns: 2fr 1fr 2fr 3fr auto; gap: 0.5rem; align-items: center; }
        .persona-folio-container .armor-grid { display: grid; grid-template-columns: 2fr 2fr 3fr auto; gap: 0.5rem; align-items: center; }
        .persona-folio-container .armor-grid label { font-weight: bold; margin-bottom: 0; }
        .persona-folio-container .attack-header, .persona-folio-container .armor-header { font-weight: bold; font-size: 0.8rem; color: var(--text-light); border-bottom: 1.5px solid var(--border-subtle); padding-bottom: 0.25rem; }
        .skills-column { display: flex; flex-direction: column; gap: 1.5rem; }
        .skill-group { break-inside: avoid; }
        .skill-group-header { background-color: var(--bg-section); padding: 0.5rem; margin: 0 0 0.5rem 0; text-align: center; font-family: var(--font-display); text-transform: uppercase; border: 1.5px solid var(--border-subtle);}
        .skill-subcategory-header { font-family: var(--font-body); font-weight: bold; text-transform: uppercase; font-size: 0.9rem; color: var(--text-light); padding-left: 0.5rem; margin: 1rem 0 0.5rem 0; border-bottom: 1.5px solid var(--border-subtle); }
        
        /* --- Skill & Specialization Styles --- */
        .skill-rows-container { margin-top: 0.5rem; }
        .skill-row { 
            display: grid; 
            grid-template-columns: 1.75fr 1fr 1.5fr 1fr 2fr; /* Adjusted first column width */
            gap: 0.5rem; 
            align-items: center; 
            margin-bottom: 0.5rem; 
        }
        .skill-row.header { font-weight: bold; text-align: center; font-size: 0.8rem; color: var(--text-light); }
        .skill-row.header span { border-bottom: 1.5px solid var(--border-subtle); padding-bottom: 0.25rem; }
        .skill-row label { font-weight: normal; margin-bottom: 0; }
        .skill-row input, .persona-folio-container .skill-row select { 
            text-align: center; 
            padding: 0.1rem 0.25rem; 
            font-size: 0.9rem;
            height: 1.8rem;
        }
        .skill-row .skill-total { font-weight: bold; }
        
        .skill-row.specialization {
            padding-left: 1.5rem;
            position: relative;
            background-color: rgba(0,0,0,0.1);
            font-style: italic; /* Make all text italic */
        }
        .skill-row.specialization::before {
            content: 'â†³';
            position: absolute;
            left: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-subtle);
        }
        .skill-row.specialization input {
            font-size: 0.85rem;
            height: 1.6rem;
        }
        .skill-row.specialization .skill-name-input {
            text-align: left;
            padding-left: 0.5rem;
        }

        .single-column-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; }
        .trait-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .trait-group h5 {
            font-family: var(--font-display);
            text-transform: uppercase;
            border-bottom: 1.5px solid var(--border-subtle);
            padding-bottom: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .primary-attribute-row {
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.75);
        }
        .modal-content {
            background-color: var(--bg-section);
            border: 2px solid var(--border-main);
        }
        #modal-choices input[type="number"] {
            color: var(--text-dark);
        }
        .btn {
            font-family: var(--font-body);
            font-weight: bold;
            padding: 0.75rem 1rem;
            border: 2px solid;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-shadow: 1px 1px 2px #000;
            text-transform: uppercase;
        }
        .btn:hover { text-shadow: none; }
        .btn-primary {
            background-color: #4f4f4f;
            border-color: #9e9e9e;
            color: #f5f5f5;
        }
        .btn-primary:hover {
            background-color: #616161;
            border-color: #f5f5f5;
        }
        .btn-danger {
            background-color: #b71c1c;
            border-color: #9e9e9e;
            color: #f5f5f5;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
            border-color: #f5f5f5;
        }
        .btn-secondary {
            background-color: var(--bg-section);
            border-color: var(--text-subtle);
            color: var(--text-light);
        }
        .btn-secondary:hover {
            background-color: var(--bg-hover);
            border-color: var(--border-focus);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--bg-input);
            border-color: var(--border-subtle);
        }

        /* Tab Styles */
        .tab-btn {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: var(--text-subtle);
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover {
            color: var(--text-light);
        }
        .tab-btn.active {
            color: var(--text-light);
            border-bottom-color: #4A90E2; /* A nice blue color */
        }
        .tab-panel {
            display: none;
            padding-top: 1.5rem;
        }
        .tab-panel.active {
            display: block;
        }

        /* Preview & Print Styles */
        #preview-modal-content {
            background-color: #fff;
            color: #000;
            max-width: 8.5in;
            padding: 0.5in;
            font-family: 'Times New Roman', Times, serif;
        }
        #preview-modal-content h2, #preview-modal-content h3 {
            font-family: var(--font-display);
            border-bottom: 2px solid #ccc;
            padding-bottom: 0.25rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #preview-modal-content ul {
            list-style: none;
            padding: 0;
        }
        #preview-modal-content li {
            padding: 0.1rem 0;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #preview-modal-content, #preview-modal-content * {
                visibility: visible;
            }
            #preview-modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                padding: 0;
            }
            #preview-print-btn, #preview-close-btn {
                display: none;
            }
        }

    </style>
</head>
<body>

    <div id="folio-container">
        </div>
    
    <div id="custom-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-[60] p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-lg p-8">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-center"></h2>
            <div id="modal-choices" class="flex flex-col gap-2 max-h-96 overflow-y-auto mt-4"></div>
            <div class="flex justify-center gap-4 flex-wrap mt-4">
                <button id="modal-ok-btn" class="btn btn-primary" style="display: none;">OK</button>
                <button id="modal-cancel-btn" style="display: none;" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-8">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="btn btn-secondary">CANCEL</button>
                <button id="confirm-ok-btn" class="btn btn-danger">CONFIRM</button>
            </div>
        </div>
    </div>
    
    <div id="preview-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-[70] p-4 hidden modal-backdrop">
        <div id="preview-modal-content" class="w-full p-8 rounded-lg shadow-lg relative">
            <div class="flex justify-end mb-4">
                <button id="preview-print-btn" class="btn btn-primary mr-2">Print</button>
                <button id="preview-close-btn" class="btn btn-secondary">Close</button>
            </div>
            <div id="preview-content"></div>
        </div>
    </div>

    <div id="economy-modal" class="fixed inset-0 overflow-y-auto h-full w-full flex items-center justify-center z-[70] p-4 hidden modal-backdrop">
        <div class="modal-content w-full max-w-2xl p-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Character Economy</h2>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="input-group">
                    <label for="starting-cp">Starting CP</label>
                    <input type="number" id="starting-cp" value="150" step="50" class="text-center">
                </div>
                 <div class="input-group">
                    <label>Spent CP</label>
                    <input type="number" id="economy-spent-cp" class="text-center" readonly>
                </div>
                 <div class="input-group">
                    <label>Remaining CP</label>
                    <input type="number" id="economy-remaining-cp" class="text-center" readonly>
                </div>
            </div>
            <div id="economy-details" class="space-y-4 max-h-96 overflow-y-auto bg-gray-800 p-4 rounded">
                </div>
            <div class="flex justify-end mt-4">
                 <button id="economy-close-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>


    <input type="file" id="json-file-input" class="hidden" accept=".json">

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signOut, 
            GoogleAuthProvider, signInWithPopup,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { 
            getFirestore, collection, getDocs, doc, setDoc, addDoc, getDoc, query, where 
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                // Fallback config for local development
                apiKey: "AIzaSyBA1CC4SXXtWM9UpU1XkAiBFr0RIgrPwGk",
                authDomain: "tangent-rpg-dbm.firebaseapp.com",
                projectId: "tangent-rpg-dbm",
                storageBucket: "tangent-rpg-dbm.appspot.com",
                messagingSenderId: "559983787369",
                appId: "1:559983787369:web:477e741d39d16d8fd211f8",
                measurementId: "G-RNTCSYY7HD"
              };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;


        // --- RPG System Configuration (from Database Manager) ---
        const categoryConfig = {
            species: { label: 'SPECIES' },
            factions: { label: 'FACTIONS' },
            origins: { label: 'ORIGINS' },
            occupations: { label: 'OCCUPATIONS' },
            disadvantages: { label: 'DISADVANTAGES' },
            features: { label: 'FEATURES' },
            skills: { label: 'SKILLS' },
            augmentations: { label: 'AUGMENTATIONS' },
            invocations: { label: 'INVOCATIONS' },
            equipment: { label: 'EQUIPMENT' },
            associates: { label: 'ASSOCIATES' },
        };

        // --- Application State ---
        const appState = {
            userId: null,
            isAnonymous: true,
            authReady: false,
            initialFormState: null,
            confirmCallback: null,
            allModifiersCache: null, // Cache for modifier definitions
            appInitialized: false,
            allFeatures: [],
            allOccupations: [],
            allSpecies: [],
            allFactions: [],
            allOrigins: [],
        };
        
        const SESSION_STORAGE_KEY = 'personaFolioData';

        // --- Authentication Promise ---
        let authReadyPromiseResolver;
        const authReadyPromise = new Promise(resolve => {
            authReadyPromiseResolver = resolve;
        });

        // --- Session & Data Functions ---
        function saveToSession() {
            const data = getPersonaFolioFormData();
            sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromSession() {
            const dataStr = sessionStorage.getItem(SESSION_STORAGE_KEY);
            return dataStr ? JSON.parse(dataStr) : null;
        }
        
        function clearSession() {
            sessionStorage.removeItem(SESSION_STORAGE_KEY);
        }

        // --- Firebase Functions ---
        async function getCollectionOptions(collectionName) {
            await authReadyPromise;

            if (collectionName === 'equipment') {
                const equipmentTypes = ['armoring', 'weaponry', 'mecha', 'gear'];
                let allOptions = [];
                for (const type of equipmentTypes) {
                    const options = await getCollectionOptions(type);
                    allOptions.push(...options);
                }
                return allOptions.sort((a,b) => a.name.localeCompare(b.name));
            }
            
            const collectionPath = `artifacts/${appId}/public/data/${collectionName}`;
            
            try {
                const querySnapshot = await getDocs(collection(db, collectionPath));
                return querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a,b) => (a.name || '').localeCompare(b.name || ''));
            } catch (error) {
                console.error(`FirebaseError reading '${collectionName}'. Path: '${collectionPath}'. Please ensure this path exists in your Firestore database and that your security rules allow read access.`, error);
                showCustomAlert(`Could not load data for ${collectionName}. Check console (F12) for details.`);
                return [];
            }
        }


        // --- NEW: Cache modifier data on startup ---
        async function cacheAllData() {
            appState.allModifiersCache = await getCollectionOptions('modifier');
            appState.allFeatures = await getCollectionOptions('features');
            appState.allOccupations = await getCollectionOptions('occupations');
            appState.allSpecies = await getCollectionOptions('species');
            appState.allFactions = await getCollectionOptions('factions');
            appState.allOrigins = await getCollectionOptions('origins');
        }


        // --- Persona Folio Logic (Adapted for Firebase) ---

        function getPersonaFolioFormData() {
            const form = document.getElementById('persona-folio-form');
            if (!form) return {};
            const data = {};
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }
            // Parse JSON data from hidden inputs
            ['features', 'disadvantages', 'augmentations', 'invocations', 'special_abilities', 'equipment', 'associates', 'attacks', 'armor', 'notes'].forEach(key => {
                const element = document.getElementById(`${key}-data`);
                if (element && element.value) {
                    try {
                        data[key] = JSON.parse(element.value);
                    } catch (e) {
                        data[key] = [];
                    }
                }
            });
            return data;
        }

        function populatePersonaFolioForm(data) {
            const sheet = document.getElementById('persona-folio-form');
            if (!sheet || !data) return;
            
            for (const key in data) {
                const elements = sheet.elements[key];
                if (!elements) continue;

                if (['features', 'disadvantages', 'augmentations', 'invocations', 'special_abilities', 'equipment', 'associates', 'attacks', 'armor', 'notes'].includes(key)) {
                    const dataInput = document.getElementById(`${key}-data`);
                    if(dataInput) {
                        const values = Array.isArray(data[key]) ? data[key] : [];
                        dataInput.value = JSON.stringify(values);
                        if (key === 'attacks') {
                            renderAttackRows(values);
                        } else if (key === 'armor') {
                            renderArmorRows(values);
                        } else if (key === 'notes') {
                            renderNoteRows(values);
                        }
                        else {
                            renderItemList(document.getElementById(`${key}-display`), values, key);
                        }
                    }
                } else if(elements.value !== undefined) {
                     if (elements.length > 1 && elements.type !== 'radio' && elements.type !== 'checkbox') {
                        // Handle NodeList for elements like radio buttons if needed
                     } else {
                        elements.value = data[key];
                     }
                }
            }

            const name = data['char-name'] || 'UNNAMED';
            document.getElementById('actor-display-header').textContent = name.toUpperCase();
            updateAllTraits();
        }

        function saveLocal() {
            const data = getPersonaFolioFormData();
            const name = data['char-name'];
            const fileName = (name || 'persona_folio').replace(/\s+/g, '_') + '.json';
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadLocal() {
            clearSession();
            document.getElementById('json-file-input').click();
        }

        document.getElementById('json-file-input').onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    renderPersonaFolioView(document.getElementById('folio-container'), data, false);
                } catch (err) {
                    showCustomAlert("Could not parse JSON file.");
                    console.error("Error parsing JSON:", err);
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        };
        
        const primaryToSubAttributeMap = {
            'attr-strength': 'attr-might',
            'attr-agility': 'attr-reflex',
            'attr-stamina': 'attr-fortitude',
            'attr-intellect': 'attr-logic',
            'attr-wisdom': 'attr-will',
            'attr-charisma': 'attr-etiquette',
        };

        function calculatePerceptionScores() {
            const getValue = (id) => parseInt(document.getElementById(id)?.value) || 0;
            
            const alertnessTotal = getValue('skill-mental-alertness-total');
            const perceptionInput = document.getElementById('perception');
            if (perceptionInput) perceptionInput.value = alertnessTotal;

            const intellectTotal = getValue('attr-intellect-total');
            const wisdomTotal = getValue('attr-wisdom-total');
            const alertnessMod = getValue('skill-mental-alertness-mod');
            const commonBase = intellectTotal + wisdomTotal + alertnessMod;

            const attuneRank = getValue('skill-meta-attune-rank');
            const attuneMod = getValue('skill-meta-attune-mod');
            const metaInput = document.getElementById('perception-meta');
            if (metaInput) metaInput.value = commonBase + attuneRank + attuneMod;

            const insightRank = getValue('skill-social-manipulation-insight-rank');
            const insightMod = getValue('skill-social-manipulation-insight-mod');
            const socialInput = document.getElementById('perception-social');
            if (socialInput) socialInput.value = commonBase + insightRank + insightMod;

            const technologyRank = getValue('skill-mental-knowledge-technology-rank');
            const technologyMod = getValue('skill-mental-knowledge-technology-mod');
            const techInput = document.getElementById('perception-tech');
            if (techInput) techInput.value = commonBase + technologyRank + technologyMod;
        }

        function calculateAlertness() {
            const intellectTotal = parseInt(document.getElementById('attr-intellect-total')?.value) || 0;
            const wisdomTotal = parseInt(document.getElementById('attr-wisdom-total')?.value) || 0;
            const alertnessRow = document.querySelector('[data-skill-id="mental-alertness"]');
            if (!alertnessRow) return;

            const baseInput = alertnessRow.querySelector('.skill-base-input');
            if (baseInput) {
                baseInput.value = intellectTotal + wisdomTotal;
            }

            calculateSkillTotal(alertnessRow);
        }

        function calculateInitiative() {
            const reflexTotalInput = document.getElementById('attr-reflex-total');
            const initiativeBaseInput = document.getElementById('initiative-base');
            const initiativeModInput = document.getElementById('initiative-mod');
            const initiativeTotalInput = document.getElementById('initiative-total');

            if (!reflexTotalInput || !initiativeBaseInput || !initiativeModInput || !initiativeTotalInput) {
                return;
            }

            const base = parseInt(reflexTotalInput.value) || 0;
            const mod = parseInt(initiativeModInput.value) || 0;

            initiativeBaseInput.value = base;
            initiativeTotalInput.value = base + mod;
        }

        function calculateAttributeTotal(attributeBaseId) {
            const valueInput = document.getElementById(attributeBaseId);
            const modInput = document.getElementById(`${attributeBaseId}-mod`);
            const totalInput = document.getElementById(`${attributeBaseId}-total`);

            if (!valueInput || !modInput || !totalInput) return;

            const value = parseInt(valueInput.value) || 0;
            const mod = parseInt(modInput.value) || 0;
            const total = value + mod;
            totalInput.value = total;

            if (attributeBaseId === 'attr-intellect' || attributeBaseId === 'attr-wisdom') {
                calculateAlertness();
            }

            if (attributeBaseId === 'attr-reflex') {
                calculateInitiative();
            }

            const subAttributeId = primaryToSubAttributeMap[attributeBaseId];
            if (subAttributeId) {
                const subValueInput = document.getElementById(subAttributeId);
                if (subValueInput) {
                    const primaryValue = parseInt(valueInput.value) || 0;
                    subValueInput.value = (primaryValue * 2) + 2;
                    calculateAttributeTotal(subAttributeId);
                }
            }

            document.querySelectorAll('.skill-row:not(.header)').forEach(skillRow => {
                const baseSelect = skillRow.querySelector('.skill-base-select');
                if (baseSelect && baseSelect.value === attributeBaseId) {
                    calculateSkillTotal(skillRow);
                }
            });
            calculatePerceptionScores();
        }

        function calculateSpecializationTotal(specRow) {
            if (!specRow) return;
            const parentSkillId = specRow.dataset.parentSkill;
            const parentRow = document.querySelector(`.skill-row[data-skill-id="${parentSkillId}"]`);
            if (!parentRow) return;

            const rank = parseInt(specRow.querySelector('.skill-rank')?.value) || 0;
            const mod = parseInt(specRow.querySelector('.skill-mod')?.value) || 0;
            const parentTotal = parseInt(parentRow.querySelector('.skill-total')?.value) || 0;

            const baseInput = specRow.querySelector('.spec-base-input');
            const totalInput = specRow.querySelector('.spec-total');
            
            if (baseInput) baseInput.value = parentTotal;
            if (totalInput) totalInput.value = rank + parentTotal + mod;
        }

        function calculateSkillTotal(skillRow) {
            if (!skillRow || skillRow.classList.contains('header') || skillRow.classList.contains('specialization')) return;

            const rankInput = skillRow.querySelector('.skill-rank');
            const baseSelect = skillRow.querySelector('.skill-base-select');
            const baseInput = skillRow.querySelector('.skill-base-input');
            const modInput = skillRow.querySelector('.skill-mod');
            const totalInput = skillRow.querySelector('.skill-total');
            
            if (!rankInput || (!baseSelect && !baseInput) || !modInput || !totalInput) {
                return;
            }

            const rank = parseInt(rankInput.value) || 0;
            const mod = parseInt(modInput.value) || 0;
            let baseValue = 0;

            if (baseInput) {
                baseValue = parseInt(baseInput.value) || 0;
            } else if (baseSelect) {
                const selectedBaseAttrId = baseSelect.value;
                if (selectedBaseAttrId) {
                    const attrTotalInput = document.getElementById(`${selectedBaseAttrId}-total`); 
                    if (attrTotalInput) {
                        baseValue = parseInt(attrTotalInput.value) || 0;
                    }
                }
            }
            
            const total = rank + baseValue + mod;
            totalInput.value = total;
            
            const skillId = skillRow.dataset.skillId;
            document.querySelectorAll(`.specialization-row[data-parent-skill="${skillId}"]`).forEach(specRow => {
                calculateSpecializationTotal(specRow);
            });
            
            if (['mental-alertness', 'meta-attune', 'social-manipulation-insight', 'mental-knowledge-technology'].includes(skillId)) {
                calculatePerceptionScores();
            }
        }
        
        async function recalculateAllModifiers() {
            // Ensure the modifier cache is populated
            if (!appState.allModifiersCache) {
                await cacheAllData();
            }

            document.querySelectorAll('.attribute-mod, .skill-mod, #initiative-mod').forEach(input => {
                input.value = 0;
            });
            
            const modifiers = {};

            const modifierSources = [
                { type: 'single', collection: 'occupations', elementId: 'char-occu' },
                { type: 'multi', collection: 'features', elementId: 'features-data' },
                { type: 'multi', collection: 'disadvantages', elementId: 'disadvantages-data' },
                { type: 'multi', collection: 'augmentations', elementId: 'augmentations-data' },
            ];

            for (const source of modifierSources) {
                const dbItems = await getCollectionOptions(source.collection);
                let selectedNames = [];

                if (source.type === 'single') {
                    const el = document.getElementById(source.elementId);
                    if (el && el.value) {
                        selectedNames.push(el.value);
                    }
                } else {
                    const el = document.getElementById(source.elementId);
                    if (el && el.value) {
                        try {
                            selectedNames = JSON.parse(el.value);
                        } catch (e) { /* ignore */ }
                    }
                }

                for (const name of selectedNames) {
                    const itemData = dbItems.find(item => item.name === name);
                    if (itemData && Array.isArray(itemData.modifier)) {
                        for (const modName of itemData.modifier) {
                            // **FIXED LOGIC**: Look up modifier details from the cache
                            const modDetails = appState.allModifiersCache.find(m => m.name === modName);
                            if (modDetails) {
                                const key = modDetails.aspect_subtype;
                                if (!modifiers[key]) {
                                    modifiers[key] = 0;
                                }
                                modifiers[key] += modDetails.value;
                            }
                        }
                    }
                }
            }

            for (const key in modifiers) {
                const value = modifiers[key];

                const statModInput = document.getElementById(`${key}-mod`);
                if(statModInput) {
                    statModInput.value = (parseInt(statModInput.value) || 0) + value;
                    continue;
                }

                const attrModInput = document.getElementById(`attr-${key}-mod`);
                if (attrModInput) {
                    attrModInput.value = (parseInt(attrModInput.value) || 0) + value;
                    continue;
                }

                document.querySelectorAll('.skill-row:not(.header)').forEach(row => {
                    const label = row.querySelector('label');
                    if (label && label.textContent.toLowerCase() === key.toLowerCase()) {
                        const skillModInput = row.querySelector('.skill-mod');
                        if (skillModInput) {
                            skillModInput.value = (parseInt(skillModInput.value) || 0) + value;
                        }
                    }
                });
            }

            Object.keys(primaryToSubAttributeMap).forEach(calculateAttributeTotal);
            document.querySelectorAll('.skill-row:not(.header)').forEach(calculateSkillTotal);
            calculateInitiative();
            calculateAlertness();
            calculatePerceptionScores();
            calculateCharacterPoints();
        }

        function getAggregatedBonuses() {
            const data = getPersonaFolioFormData();
            const allBonusSkillRanks = [];
            const allBonusFeatures = [];
            const allRecommendedFeatures = [];
            const allBonusSkillOptions = [];
            const allBonusFeatureOptions = [];
            let totalSkillChoices = 0;
            let totalFeatureChoices = 0;

            const sources = [
                { name: data['char-species'], db: appState.allSpecies },
                { name: data['char-occu'], db: appState.allOccupations },
                { name: data['char-origin'], db: appState.allOrigins },
                { name: data['char-faction'], db: appState.allFactions },
            ];

            sources.forEach(source => {
                if (source.name && source.db) {
                    const item = source.db.find(i => i.name === source.name);
                    if (item) {
                        if (item.bonus_skills) {
                            try {
                                const skills = JSON.parse(item.bonus_skills);
                                if (Array.isArray(skills)) {
                                    allBonusSkillRanks.push(...skills.map(s => ({ skill: s.name, ranks: s.value })));
                                }
                            } catch(e) {
                                console.error("Could not parse bonus_skills JSON", e);
                            }
                        }
                        if (item.bonus_features) allBonusFeatures.push(...item.bonus_features);
                        if (item.recommended_features) allRecommendedFeatures.push(...item.recommended_features);
                        if (item.bonus_skill_options) allBonusSkillOptions.push(...item.bonus_skill_options);
                        if (item.bonus_feature_options) allBonusFeatureOptions.push(...item.bonus_feature_options);
                        if (item.bonus_skill_choices) totalSkillChoices += item.bonus_skill_choices;
                        if (item.bonus_feature_choices) totalFeatureChoices += item.bonus_feature_choices;
                    }
                }
            });

            return { allBonusSkillRanks, allBonusFeatures, allRecommendedFeatures, allBonusSkillOptions, allBonusFeatureOptions, totalSkillChoices, totalFeatureChoices };
        }

        function calculateCharacterPoints() {
            if (!appState.allFeatures) return;

            let spentCP = 0;
            let economyDetails = {
                'Attributes': [],
                'Skills': [],
                'Features': [],
                'Disadvantages': [],
                'Special Abilities': [],
            };

            const data = getPersonaFolioFormData();
            const { allBonusSkillRanks, allBonusFeatures, allRecommendedFeatures, allBonusSkillOptions, allBonusFeatureOptions, totalSkillChoices, totalFeatureChoices } = getAggregatedBonuses();

            // Attributes
            document.querySelectorAll('.attribute-value').forEach(input => {
                if(input.readOnly) return; 
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    const cost = value * 5;
                    spentCP += cost;
                    const label = document.querySelector(`label[for="${input.id}"]`).textContent;
                    economyDetails['Attributes'].push({name: label, cost: cost});
                }
            });

            // Features, Disadvantages, Special Abilities
            const itemLists = {
                features: 'Features',
                disadvantages: 'Disadvantages',
                special_abilities: 'Special Abilities'
            };

            for (const [listKey, categoryName] of Object.entries(itemLists)) {
                const selectedItems = data[listKey] || [];
                let bonusChoicesMade = 0;
                selectedItems.forEach(itemName => {
                    if (listKey === 'features') {
                        if (allBonusFeatures.includes(itemName)) {
                            economyDetails[categoryName].push({ name: `${itemName} (Bonus)`, cost: 0 });
                            return;
                        }
                        if (allBonusFeatureOptions.includes(itemName) && bonusChoicesMade < totalFeatureChoices) {
                            economyDetails[categoryName].push({ name: `${itemName} (Bonus Choice)`, cost: 0 });
                            bonusChoicesMade++;
                            return;
                        }
                    }

                    const itemData = appState.allFeatures.find(f => f.name === itemName) || { cp_cost: 3 };
                    let cost = itemData.cp_cost !== undefined ? itemData.cp_cost : 3;
                    let nameSuffix = '';

                    if (listKey === 'features' && allRecommendedFeatures.includes(itemName)) {
                        cost = Math.max(1, cost - 1);
                        nameSuffix = ' (Recommended)';
                    }
                    spentCP += cost;
                    economyDetails[categoryName].push({ name: itemName + nameSuffix, cost: cost });
                });
            }

            // Skills
            let skillChoicesMade = 0;
            document.querySelectorAll('.skill-row:not(.header):not(.specialization)').forEach(row => {
                const label = row.querySelector('label');
                const skillName = label ? label.textContent : '';
                const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                
                if (rank > 0) {
                    const bonus = allBonusSkillRanks.find(b => b.skill === skillName);
                    let bonusRanks = bonus ? bonus.ranks : 0;

                    if (allBonusSkillOptions.includes(skillName) && skillChoicesMade < totalSkillChoices) {
                        bonusRanks += rank; // The chosen rank is free
                        skillChoicesMade++;
                        economyDetails['Skills'].push({ name: `${skillName} (Bonus Choice)`, cost: 0 });
                    }

                    const paidRanks = Math.max(0, rank - bonusRanks);
                    if (paidRanks > 0) {
                        spentCP += paidRanks;
                        economyDetails['Skills'].push({ name: `${skillName} (Ranks)`, cost: paidRanks });
                    }
                    if (bonusRanks > 0 && rank > 0 && !(allBonusSkillOptions.includes(skillName) && skillChoicesMade <= totalSkillChoices)) {
                         economyDetails['Skills'].push({ name: `${skillName} (Bonus Ranks)`, cost: 0 });
                    }
                }
            });
             document.querySelectorAll('.skill-row.specialization').forEach(row => {
                const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                 if (rank > 0) {
                    const name = row.querySelector('.skill-name-input')?.value;
                    spentCP += rank;
                    economyDetails['Skills'].push({ name: `${name} (Specialization)`, cost: rank });
                }
            });

            const totalCpInput = document.getElementById('starting-cp') || {value: 150};
            const spentCpHeader = document.getElementById('header-spent-cp');
            const economySpentCp = document.getElementById('economy-spent-cp');
            const economyRemainingCp = document.getElementById('economy-remaining-cp');

            const totalCP = parseInt(totalCpInput.value) || 150;
            
            if(spentCpHeader) spentCpHeader.textContent = `Spent CP: ${spentCP}`;
            if(economySpentCp) economySpentCp.value = spentCP;
            if(economyRemainingCp) economyRemainingCp.value = totalCP - spentCP;
            
            return economyDetails;
        }
        
        function showEconomyModal() {
            const modal = document.getElementById('economy-modal');
            const detailsContainer = document.getElementById('economy-details');
            
            const economyDetails = calculateCharacterPoints();
            
            let html = '';
            for(const category in economyDetails) {
                const items = economyDetails[category];
                if(items.length > 0) {
                    html += `<h4 class="font-bold text-lg border-b border-gray-600">${category}</h4><ul>`;
                    items.forEach(item => {
                        html += `<li class="flex justify-between"><span>${item.name}</span><span>${item.cost} CP</span></li>`;
                    });
                    html += `</ul>`;
                }
            }
            detailsContainer.innerHTML = html;
            modal.classList.remove('hidden');
        }

        async function initializePersonaFolio(folioData = {}) {
            const sheet = document.getElementById('persona-folio-form');
            if(!sheet) return;
            
            const skillData = {
                "Physical": { "skills": ["Acrobatics", "Athletics", "Piloting", "Stealth"] },
                "Mental": { "skills": ["Alertness"], "subcategories": { "Knowledge": ["Academics", "Appraisal", "Computers", "Culture", "History", "Investigation", "Language", "Medicine", "Nature", "Navigation", "Nobility", "Physics", "Religion", "Science", "Survival", "Tactics", "Technology"], "Vocation": ["Administrator", "Alchemist", "Ambassador", "Architect", "Archivist", "Armorer", "Artist", "Artificer", "Broker", "Celebrity", "Constable", "Courtesan", "Culinarian", "Demolitionist", "Electrician", "Engineer", "Groundskeeper", "Handler", "Laborer", "Mechanic", "Researcher", "Salvager", "Soldier", "Tailor", "Transporter", "Weaponsmith"]}},
                "Social": { "subcategories": { "Manipulation": ["Insight", "Bluff", "Diplomacy", "Intimidate", "Streetwise"], "Expression": ["Acting", "Comedy", "Dancing", "Disguise", "Keyboard", "Legerdemain", "Oratory", "Percussion", "Singing", "String", "Style", "Wind"]}},
                "Combat": { "subcategories": { "Archaic": ["Defense", "Melee", "Ranged", "Unarmed"], "Modern": ["Ballistic", "Heavy Weapons"],"Advanced": ["Energy", "Heavy Energy"]}}
            };
            const skillOrder = ['Physical', 'Mental', 'Social', 'Combat'];
            const skillsContainer = document.getElementById('skills-list');
            
            if(skillsContainer) skillsContainer.innerHTML = '';

            skillOrder.forEach(groupName => {
                const groupData = skillData[groupName];
                if (groupData) {
                    populateSkillGroup(skillsContainer, groupName, groupData);
                }
            });

            const metaData = { "Dimension": ["Summoning", "Teleport"], "Energy": ["Elemental", "Force"], "Entropy": ["Chaos", "Order"], "Illusion": ["Phantasmal", "Shadow"], "Matter": ["Enhancement", "Transmutation"], "Mental": ["Projection", "Sense"] };
            populateMeta(metaData);
            
            if (folioData && Object.keys(folioData).length > 0) {
                populatePersonaFolioForm(folioData);
            } else {
                renderAttackRows([]);
                renderArmorRows([]);
                renderNoteRows([]);
            }

            appState.initialFormState = JSON.stringify(getPersonaFolioFormData());

            Object.keys(primaryToSubAttributeMap).forEach(primaryId => {
                calculateAttributeTotal(primaryId);
            });
            
            if (folioData) {
                Object.keys(primaryToSubAttributeMap).forEach(primaryId => {
                    calculateAttributeTotal(primaryId);
                });
            }
            recalculateAllModifiers();
        }

        function populateSkillGroup(container, groupName, groupData) {
            if (!container || !groupData) return;

            const groupDiv = document.createElement('div');
            groupDiv.className = 'skill-group';

            const header = document.createElement('h4');
            header.className = 'skill-group-header';
            header.textContent = groupName.trim();
            groupDiv.appendChild(header);

            if (groupData.skills) {
                const skillRowsContainer = document.createElement('div');
                skillRowsContainer.className = 'skill-rows-container';
                skillRowsContainer.dataset.group = groupName.toLowerCase();
                groupData.skills.forEach(skillName => {
                    const skillId = `${groupName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                    const skillRow = createSkillRow(skillName, skillId);
                    if (skillName === 'Alertness') {
                        skillRow.querySelector('.skill-base-select').outerHTML = `<input type="number" id="skill-${skillId}-base" name="skill-${skillId}-base" class="skill-base-input" readonly placeholder="0">`;
                    }
                    skillRowsContainer.appendChild(skillRow);
                });
                groupDiv.appendChild(skillRowsContainer);
            }
            
            if (groupData.subcategories) {
                for (const subcatName in groupData.subcategories) {
                    const subcatHeader = document.createElement('h5');
                    subcatHeader.className = 'skill-subcategory-header';
                    subcatHeader.textContent = subcatName;
                    groupDiv.appendChild(subcatHeader);

                    const subcatRowsContainer = document.createElement('div');
                    subcatRowsContainer.className = 'skill-rows-container';
                    subcatRowsContainer.dataset.group = `${groupName.toLowerCase()}-${subcatName.toLowerCase()}`;
                    
                    groupData.subcategories[subcatName].forEach(skillName => {
                        const skillId = `${groupName}-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                        subcatRowsContainer.appendChild(createSkillRow(skillName, skillId));
                    });
                    groupDiv.appendChild(subcatRowsContainer);
                }
            }
            container.appendChild(groupDiv);
        }

        function populateMeta(metaData) {
            const container = document.getElementById('meta-skills-list');
            if(!container) return;
            container.innerHTML = '';

            const headerRow = document.createElement('div');
            headerRow.className = 'skill-row header';
            headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
            container.appendChild(headerRow);
            
            const attuneContainer = document.createElement('div');
            attuneContainer.className = 'skill-rows-container';
            attuneContainer.dataset.group = 'meta';
            const attuneRow = createSkillRow("Attune", "meta-attune");
            attuneContainer.appendChild(attuneRow);
            container.appendChild(attuneContainer);

            const metaOrder = ["Dimension", "Energy", "Entropy", "Illusion", "Matter", "Mental"];

            metaOrder.forEach(subcatName => {
                const skills = metaData[subcatName];
                if (skills && skills.length > 0) {
                    const subcatHeader = document.createElement('h5');
                    subcatHeader.className = 'skill-subcategory-header';
                    subcatHeader.textContent = subcatName;
                    container.appendChild(subcatHeader);
                    
                    const subcatRowsContainer = document.createElement('div');
                    subcatRowsContainer.className = 'skill-rows-container';
                    subcatRowsContainer.dataset.group = `meta-${subcatName.toLowerCase()}`;
                    
                    skills.forEach(skillName => {
                         const skillId = `meta-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                         subcatRowsContainer.appendChild(createSkillRow(skillName, skillId));
                    });
                    container.appendChild(subcatRowsContainer);
                }
            });
        }

        function createSkillRow(skillName, skillId) {
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.dataset.skillId = skillId;
            const attributeOptions = [{ value: 'attr-strength', text: 'Strength' }, { value: 'attr-agility', text: 'Agility' },{ value: 'attr-stamina', text: 'Stamina' }, { value: 'attr-intellect', text: 'Intellect' },{ value: 'attr-wisdom', text: 'Wisdom' }, { value: 'attr-charisma', text: 'Charisma' }];
            let optionsHtml = '<option value="">--</option>' + attributeOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
            
            row.innerHTML = `
                <label for="skill-${skillId}-rank">${skillName}</label>
                <input type="number" id="skill-${skillId}-rank" name="skill-${skillId}-rank" class="skill-rank" placeholder="0">
                <select id="skill-${skillId}-base" name="skill-${skillId}-base" class="skill-base-select">${optionsHtml}</select>
                <input type="number" id="skill-${skillId}-mod" name="skill-${skillId}-mod" class="skill-mod" placeholder="0" readonly>
                <input type="number" id="skill-${skillId}-total" name="skill-${skillId}-total" class="skill-total" readonly value="0">`;
            return row;
        };
        
        function createSpecializationRow(specName, specId, parentSkillId) {
            const row = document.createElement('div');
            row.className = 'skill-row specialization';
            row.dataset.specId = specId;
            row.dataset.parentSkill = parentSkillId;
            row.innerHTML = `
                <input type="text" class="skill-name-input" name="${specId}-name" value="${specName}" readonly>
                <input type="number" class="skill-rank" name="${specId}-rank" placeholder="0">
                <input type="number" class="spec-base-input" name="${specId}-base" readonly placeholder="0">
                <input type="number" class="skill-mod" name="${specId}-mod" placeholder="0" readonly>
                <input type="number" class="spec-total" name="${specId}-total" readonly value="0">
            `;
            return row;
        }

        async function showAddSkillModal() {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = 'ADD SKILL';
            modalChoices.innerHTML = ''; 

            // Reset modal state
            modalChoices.style.display = 'block';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            const allSkills = await getCollectionOptions('skills');
            const existingSkillElements = document.querySelectorAll('.skill-row:not(.header) label, .skill-row.specialization .skill-name-input');
            const existingSkillNames = Array.from(existingSkillElements).map(el => el.textContent || el.value);

            allSkills.sort((a, b) => a.name.localeCompare(b.name)).forEach(skill => {
                const isAdded = existingSkillNames.includes(skill.name);

                const skillRow = document.createElement('div');
                skillRow.className = 'grid grid-cols-3 gap-2 items-center w-full';
                
                const skillNameEl = document.createElement('span');
                skillNameEl.textContent = skill.name;
                skillNameEl.className = `text-left ${isAdded ? 'text-gray-500' : ''}`;

                const valueInput = document.createElement('input');
                valueInput.type = 'number';
                valueInput.placeholder = 'Rank';
                valueInput.className = 'global-form-input !text-sm !py-1 !px-2';
                valueInput.disabled = isAdded;

                const addButton = document.createElement('button');
                addButton.textContent = 'Add';
                addButton.className = 'btn btn-primary !text-xs !py-1 !px-2';
                addButton.disabled = isAdded;

                if (!isAdded) {
                    addButton.onclick = async () => {
                        const rank = parseInt(valueInput.value);
                        if (rank > 0) {
                            await addSkillToSheet(skill, rank);
                            modal.classList.add('hidden');
                        } else {
                            valueInput.classList.add('!border-red-500');
                            setTimeout(() => valueInput.classList.remove('!border-red-500'), 1000);
                        }
                    };
                }

                skillRow.appendChild(skillNameEl);
                skillRow.appendChild(valueInput);
                skillRow.appendChild(addButton);
                modalChoices.appendChild(skillRow);
            });

            cancelBtn.onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        async function addSkillToSheet(skillData, rank) {
            if (skillData.is_specialization) {
                const baseSkillName = skillData.base_skill;
                const allSkillRows = document.querySelectorAll('.skill-row:not(.specialization)');
                let parentRow = null;
                allSkillRows.forEach(row => {
                    const label = row.querySelector('label');
                    if (label && label.textContent === baseSkillName) {
                        parentRow = row;
                    }
                });

                if (parentRow) {
                    const parentSkillId = parentRow.dataset.skillId;
                    const specId = `spec-${parentSkillId}-${Date.now()}`;
                    const specRow = createSpecializationRow(skillData.name, specId, parentSkillId);
                    
                    let lastElement = parentRow;
                    let nextSibling = parentRow.nextElementSibling;
                    while(nextSibling && nextSibling.classList.contains('specialization') && nextSibling.dataset.parentSkill === parentSkillId) {
                        lastElement = nextSibling;
                        nextSibling = nextSibling.nextElementSibling;
                    }
                    lastElement.insertAdjacentElement('afterend', specRow);

                    const rankInput = specRow.querySelector('.skill-rank');
                    if(rankInput) rankInput.value = rank;

                    calculateSpecializationTotal(specRow);
                } else {
                    showCustomAlert(`Base skill "${baseSkillName}" not found on sheet. Please add it first.`);
                }
            } else {
                const skillId = `${skillData.type}-${skillData.name}`.toLowerCase().replace(/\s+/g, '-');
                if (document.querySelector(`[data-skill-id="${skillId}"]`)) {
                    showCustomAlert(`Skill "${skillData.name}" is already on the sheet.`);
                    return;
                }
                
                const subtype = skillData.subtype ? `-${skillData.subtype.toLowerCase()}` : '';
                const containerSelector = `[data-group="${skillData.type}${subtype}"]`;
                let container = document.querySelector(containerSelector);

                if (!container) {
                    container = document.querySelector(`[data-group="${skillData.type}"]`);
                }
                
                if (container) {
                    const newRow = createSkillRow(skillData.name, skillId);
                    container.appendChild(newRow);

                    const rankInput = newRow.querySelector('.skill-rank');
                    if(rankInput) rankInput.value = rank;

                    calculateSkillTotal(newRow);
                } else {
                    console.error(`Could not find container for skill:`, skillData);
                }
            }
        }

        async function showAttackSelectionModal() {
            const equipmentDataInput = document.getElementById('equipment-data');
            const invocationsDataInput = document.getElementById('invocations-data');

            let currentEquipment = [];
            let currentInvocations = [];

            try {
                if (equipmentDataInput && equipmentDataInput.value) currentEquipment = JSON.parse(equipmentDataInput.value);
                if (invocationsDataInput && invocationsDataInput.value) currentInvocations = JSON.parse(invocationsDataInput.value);
            } catch(e) {
                console.error("Could not parse equipment/invocations data", e);
            }
            
            const allEquipment = await getCollectionOptions('weaponry');
            const allInvocations = await getCollectionOptions('invocations');

            const availableAttacks = [];
            
            currentEquipment.forEach(name => {
                const item = allEquipment.find(eq => eq.name === name && eq.effect);
                if (item) availableAttacks.push({ ...item, source: 'Equipment' });
            });

            currentInvocations.forEach(name => {
                const item = allInvocations.find(inv => inv.name === name && inv.effect);
                if (item) availableAttacks.push({ ...item, source: 'Invocations' });
            });

            if (availableAttacks.length === 0) {
                showCustomAlert("No available attacks from equipment or invocations.");
                return;
            }

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const okBtn = document.getElementById('modal-ok-btn');

            modalTitle.textContent = "SELECT ATTACK";
            modalChoices.innerHTML = ''; 

            // Reset modal state
            modalChoices.style.display = 'flex';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            availableAttacks.forEach(attack => {
                const btn = document.createElement('button');
                btn.textContent = `${attack.name.toUpperCase()} (${attack.source})`;
                btn.className = 'btn btn-secondary w-full'; 
                btn.onclick = () => {
                    addAttackToList(attack);
                    modal.classList.add('hidden');
                };
                modalChoices.appendChild(btn);
            });
            
            modal.classList.remove('hidden');

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function addAttackToList(attackData) {
            const attacksDataInput = document.getElementById('attacks-data');
            let currentAttacks = [];
            try {
                if (attacksDataInput.value) currentAttacks = JSON.parse(attacksDataInput.value);
            } catch(e) {}

            const newAttack = {
                name: attackData.name,
                score: attackData.skill || '',
                damage: attackData.effect || '',
                notes: ''
            };

            currentAttacks.push(newAttack);
            attacksDataInput.value = JSON.stringify(currentAttacks);
            renderAttackRows(currentAttacks);
        }

        function renderAttackRows(attacks = []) {
            const container = document.getElementById('attack-rows');
            if (!container) return;
            
            while(container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            attacks.forEach((attack, index) => {
                const row = document.createElement('div');
                row.className = 'attack-grid';
                row.innerHTML = `
                    <input type="text" value="${attack.name}" readonly>
                    <input type="text" value="${attack.score}" readonly>
                    <input type="text" value="${attack.damage}" readonly>
                    <input type="text" placeholder="Notes...">
                    <button type="button" class="btn btn-danger btn-sm p-1 leading-none">&times;</button>
                `;
                container.appendChild(row);

                row.querySelector('button').addEventListener('click', () => {
                    attacks.splice(index, 1);
                    document.getElementById('attacks-data').value = JSON.stringify(attacks);
                    renderAttackRows(attacks);
                });
            });
        }

        async function showArmorSelectionModal() {
            const speciesInput = document.getElementById('char-species');
            const equipmentDataInput = document.getElementById('equipment-data');
            const augmentationsDataInput = document.getElementById('augmentations-data');

            let currentEquipment = [];
            let currentAugmentations = [];

            try {
                if (equipmentDataInput && equipmentDataInput.value) currentEquipment = JSON.parse(equipmentDataInput.value);
                if (augmentationsDataInput && augmentationsDataInput.value) currentAugmentations = JSON.parse(augmentationsDataInput.value);
            } catch(e) {}
            
            const allSpecies = await getCollectionOptions('species');
            const allEquipment = await getCollectionOptions('armoring');
            const allAugmentations = await getCollectionOptions('augmentations');

            const availableArmor = [];
            
            if (speciesInput && speciesInput.value) {
                const species = allSpecies.find(s => s.name === speciesInput.value && s.resistance);
                if (species) availableArmor.push({ ...species, source: 'Species' });
            }

            currentEquipment.forEach(name => {
                const item = allEquipment.find(eq => eq.name === name && eq.resistance);
                if (item) availableArmor.push({ ...item, source: 'Equipment' });
            });

            currentAugmentations.forEach(name => {
                const item = allAugmentations.find(aug => aug.name === name && aug.resistance);
                if (item) availableArmor.push({ ...item, source: 'Augmentations' });
            });

            if (availableArmor.length === 0) {
                showCustomAlert("No available armor from species, equipment, or augmentations.");
                return;
            }

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const okBtn = document.getElementById('modal-ok-btn');

            modalTitle.textContent = "SELECT ARMOR";
            modalChoices.innerHTML = ''; 
            
            // Reset modal state
            modalChoices.style.display = 'flex';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            availableArmor.forEach(armor => {
                const btn = document.createElement('button');
                btn.textContent = `${armor.name.toUpperCase()} (${armor.source})`;
                btn.className = 'btn btn-secondary w-full'; 
                btn.onclick = () => {
                    addArmorToList(armor);
                    modal.classList.add('hidden');
                };
                modalChoices.appendChild(btn);
            });
            
            modal.classList.remove('hidden');

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function addArmorToList(armorData) {
            const armorDataInput = document.getElementById('armor-data');
            let currentArmor = [];
            try {
                if (armorDataInput.value) currentArmor = JSON.parse(armorDataInput.value);
            } catch(e) {}

            const newArmor = {
                name: armorData.name,
                resistance: armorData.resistance || '',
                notes: armorData.source || ''
            };

            currentArmor.push(newArmor);
            armorDataInput.value = JSON.stringify(currentArmor);
            renderArmorRows(currentArmor);
        }

        function renderArmorRows(armorList = []) {
            const container = document.getElementById('armor-rows');
            if (!container) return;
            
            while(container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            armorList.forEach((armor, index) => {
                const row = document.createElement('div');
                row.className = 'armor-grid';
                row.innerHTML = `
                    <input type="text" value="${armor.name}" readonly>
                    <input type="text" value="${armor.resistance}" readonly>
                    <input type="text" value="${armor.notes}" readonly>
                    <button type="button" class="btn btn-danger btn-sm p-1 leading-none">&times;</button>
                `;
                container.appendChild(row);

                row.querySelector('button').addEventListener('click', () => {
                    armorList.splice(index, 1);
                    document.getElementById('armor-data').value = JSON.stringify(armorList);
                    renderArmorRows(armorList);
                });
            });
        }

        function addNoteToList() {
            const notesDataInput = document.getElementById('notes-data');
            let currentNotes = [];
            try {
                if(notesDataInput.value) currentNotes = JSON.parse(notesDataInput.value);
            } catch(e) {}

            currentNotes.push({ text: '' });
            notesDataInput.value = JSON.stringify(currentNotes);
            renderNoteRows(currentNotes);
        }

        function renderNoteRows(notes = []) {
            const container = document.getElementById('notes-list');
            if (!container) return;
            container.innerHTML = '';

            if (notes.length === 0) {
                    addNoteToList();
                    return;
            }

            notes.forEach((note, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = note.text;
                input.className = 'flex-grow';
                input.oninput = () => {
                    notes[index].text = input.value;
                    document.getElementById('notes-data').value = JSON.stringify(notes);
                };

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'btn btn-danger btn-sm p-1 leading-none';
                removeBtn.onclick = () => {
                    notes.splice(index, 1);
                    document.getElementById('notes-data').value = JSON.stringify(notes);
                    renderNoteRows(notes);
                };

                row.appendChild(input);
                row.appendChild(removeBtn);
                container.appendChild(row);
            });
        }


        async function updateTraitsDisplay(collectionName, selectElement, textareaId) {
            const selectedName = selectElement.value;
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            textarea.value = '';
            if (!selectedName) return;

            try {
                const options = await getCollectionOptions(collectionName);
                const selectedOption = options.find(opt => opt.name === selectedName);
                if (!selectedOption || !selectedOption.trait) return;

                textarea.value = selectedOption.trait.join('\n');

            } catch (error) {
                console.error(`Error updating traits for ${collectionName}:`, error);
            }
        };

        function updateAllTraits() {
            updateTraitsDisplay('species', document.getElementById('char-species'), 'species-traits-display');
            updateTraitsDisplay('occupations', document.getElementById('char-occu'), 'occupation-traits-display');
            updateTraitsDisplay('origins', document.getElementById('char-origin'), 'origin-traits-display');
            updateTraitsDisplay('factions', document.getElementById('char-faction'), 'faction-traits-display');
        }

        function showConfirmModal(message, onConfirm) {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            confirmMessage.textContent = message;
            appState.confirmCallback = onConfirm;

            confirmOkBtn.onclick = () => {
                if (appState.confirmCallback) appState.confirmCallback();
                confirmModal.classList.add('hidden');
            };
            confirmCancelBtn.onclick = () => {
                confirmModal.classList.add('hidden');
            };

            confirmModal.classList.remove('hidden');
        }

        async function showDirectoryModal(targetListKey, startPathKey) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = `BROWSE: ${categoryConfig[startPathKey]?.label || startPathKey.toUpperCase()}`;
            modalChoices.innerHTML = '<p class="text-center">Loading...</p>';
            
            // Reset modal state
            modalChoices.style.display = 'flex'; 
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            modal.classList.remove('hidden');

            const items = await getCollectionOptions(startPathKey);
            
            modalChoices.innerHTML = '';

            const dataInput = document.getElementById(`${targetListKey}-data`);
            const isMultiSelect = !!dataInput;

            let currentSelections = [];
            if (isMultiSelect && dataInput.value) {
                 try {
                    currentSelections = JSON.parse(dataInput.value);
                 } catch(e) {
                    currentSelections = [];
                 }
            }

            const availableItems = items.filter(item => !currentSelections.includes(item.name));

            if (availableItems.length === 0) {
                modalChoices.innerHTML = '<p class="text-gray-400 text-center">No available items to add.</p>';
            } else {
                availableItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item.name.toUpperCase();
                    btn.className = 'btn btn-primary w-full text-left';
                    btn.onclick = () => {
                        handleItemSelection(targetListKey, item.name, isMultiSelect);
                        modal.classList.add('hidden');
                    };
                    modalChoices.appendChild(btn);
                });
            }

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }
        
        function handleItemSelection(targetId, value, isMultiSelect) {
            if (isMultiSelect) {
                const displayContainer = document.getElementById(`${targetId}-display`);
                const dataInput = document.getElementById(`${targetId}-data`);

                let currentValues = [];
                if (dataInput.value) {
                    try {
                        currentValues = JSON.parse(dataInput.value);
                    } catch (e) {
                        currentValues = [];
                    }
                }

                if (!currentValues.includes(value)) {
                    currentValues.push(value);
                    dataInput.value = JSON.stringify(currentValues);
                    renderItemList(displayContainer, currentValues, targetId);
                }
            } else {
                const targetInput = document.getElementById(targetId);
                if (targetInput) {
                    targetInput.value = value;
                    targetInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        }

        function renderItemList(container, items, targetId) {
            if (!container) return;
            container.innerHTML = '';
            items.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                itemEl.textContent = item;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'font-bold text-red-500 hover:text-red-300 ml-4';
                removeBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent the event from bubbling up to parent listeners
                    items.splice(index, 1);
                    document.getElementById(`${targetId}-data`).value = JSON.stringify(items);
                    renderItemList(container, items, targetId);
                };
                itemEl.appendChild(removeBtn);
                container.appendChild(itemEl);
            });
            recalculateAllModifiers();
        }

        function showCustomAlert(text) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = text.toUpperCase();
            
            // Reset modal state for an alert
            modalChoices.innerHTML = '';
            modalChoices.style.display = 'none';
            okBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'none';
            
            okBtn.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        }

        async function saveToDb() {
            if (!appState.userId || appState.isAnonymous) {
                showCustomAlert("Please log in to save to the cloud.");
                return;
            }

            const charName = document.getElementById('char-name').value;
            if (!charName) {
                showCustomAlert("Please enter a character name before saving.");
                return;
            }

            const data = getPersonaFolioFormData();
            const docId = document.getElementById('character-doc-id').value || charName.replace(/\s+/g, '_');
            const personaRef = doc(db, `artifacts/${appId}/users/${appState.userId}/personas`, docId);

            try {
                await setDoc(personaRef, data, { merge: true });
                document.getElementById('character-doc-id').value = docId;
                showCustomAlert("Character Saved Successfully!");
            } catch (error) {
                console.error("Error saving character:", error);
                showCustomAlert("Could not save character. Check console for details.");
            }
        }

        async function showCharacterLoadModal() {
            if (!appState.userId || appState.isAnonymous) {
                showCustomAlert("Please log in to load from the cloud.");
                return;
            }

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = 'LOAD CHARACTER';
            modalChoices.innerHTML = '<p class="text-center">Loading...</p>';
            
            // Reset modal state
            modalChoices.style.display = 'block';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';
            
            modal.classList.remove('hidden');
            
            const collectionRef = collection(db, `artifacts/${appId}/users/${appState.userId}/personas`);
            try {
                const querySnapshot = await getDocs(collectionRef);
                modalChoices.innerHTML = '';
                if (querySnapshot.empty) {
                    modalChoices.innerHTML = '<p class="text-gray-400 text-center">No characters found in the cloud.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const charData = doc.data();
                        const btn = document.createElement('button');
                        btn.textContent = charData['char-name'] || doc.id;
                        btn.className = 'btn btn-primary w-full text-left';
                        btn.onclick = () => {
                            clearSession();
                            loadCharacterById(doc.id);
                            modal.classList.add('hidden');
                        };
                        modalChoices.appendChild(btn);
                    });
                }
            } catch (error) {
                console.error("Error loading characters:", error);
                modalChoices.innerHTML = '<p class="text-red-500 text-center">Could not load characters.</p>';
            }

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        async function loadCharacterById(docId) {
             if (!appState.userId) return;
             const personaRef = doc(db, `artifacts/${appId}/users/${appState.userId}/personas`, docId);
             try {
                const docSnap = await getDoc(personaRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderPersonaFolioView(document.getElementById('folio-container'), data, false);
                    const docIdInput = document.getElementById('character-doc-id');
                    if(docIdInput) docIdInput.value = docId;

                } else {
                    showCustomAlert("Character not found.");
                }
             } catch(error) {
                console.error("Error loading character:", error);
                showCustomAlert("Failed to load character.");
             }
        }

        function newCharacter() {
            showConfirmModal("Start a new character? Any unsaved changes will be lost.", () => {
                clearSession();
                renderPersonaFolioView(document.getElementById('folio-container'), {}, false);
            });
        }

        function showPreviewModal() {
            const data = getPersonaFolioFormData();
            const previewContent = document.getElementById('preview-content');
            if (!previewContent) return;

            let html = `<h2>${data['char-name'] || 'Unnamed Character'}</h2>`;
            html += `<p><strong>Concept:</strong> ${data['char-concept'] || 'N/A'}</p>`;
            html += `<p><strong>Species:</strong> ${data['char-species'] || 'N/A'}</p>`;
            html += `<p><strong>Occupation:</strong> ${data['char-occu'] || 'N/A'}</p>`;
            html += `<p><strong>Origin:</strong> ${data['char-origin'] || 'N/A'}</p>`;
            html += `<p><strong>Faction:</strong> ${data['char-faction'] || 'N/A'}</p>`;

            html += '<h3>Attributes</h3><ul>';
            const attributes = ['strength', 'agility', 'stamina', 'intellect', 'wisdom', 'charisma'];
            attributes.forEach(attr => {
                const total = document.getElementById(`attr-${attr}-total`)?.value || 0;
                html += `<li><strong>${attr.charAt(0).toUpperCase() + attr.slice(1)}:</strong> ${total}</li>`;
            });
            html += '</ul>';

            html += '<h3>Skills</h3><ul>';
            document.querySelectorAll('.skill-row:not(.header)').forEach(row => {
                const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                if (rank > 0) {
                    const skillName = row.querySelector('label')?.textContent || row.querySelector('.skill-name-input')?.value;
                    const total = row.querySelector('.skill-total')?.value || row.querySelector('.spec-total')?.value || 0;
                    html += `<li><strong>${skillName}:</strong> ${total} (Rank ${rank})</li>`;
                }
            });
            html += '</ul>';
            
            const createList = (title, items) => {
                if (items && items.length > 0) {
                    let listHtml = `<h3>${title}</h3><ul>`;
                    items.forEach(item => listHtml += `<li>${item}</li>`);
                    listHtml += '</ul>';
                    return listHtml;
                }
                return '';
            };

            html += createList('Features', data.features);
            html += createList('Disadvantages', data.disadvantages);
            html += createList('Augmentations', data.augmentations);
            html += createList('Equipment', data.equipment);

            previewContent.innerHTML = html;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        function setupGlobalEventListeners() {
            // This function sets up all listeners ONCE using event delegation.
        
            window.addEventListener('click', (event) => {
                if (!event.target.matches('.file-menu-button')) {
                    const dropdowns = document.querySelectorAll('.file-menu-dropdown');
                    dropdowns.forEach(dropdown => {
                        if (dropdown.classList.contains('show')) {
                            dropdown.classList.remove('show');
                        }
                    });
                }
            });

            const container = document.getElementById('folio-container');
            if (!container) return;
        
            container.addEventListener('click', (event) => {
                const target = event.target;
        
                if (target.matches('.file-menu-button')) {
                    event.stopPropagation();
                    const dropdown = target.nextElementSibling;
                    if (dropdown) dropdown.classList.toggle('show');
                    return;
                }
        
                if (target.closest('.file-menu-dropdown')) {
                    const dropdown = document.querySelector('.file-menu-dropdown');
                    if (dropdown) dropdown.classList.remove('show');
                }
        
                if (target.id === 'new-char-btn') newCharacter();
                if (target.id === 'local-save-btn') saveLocal();
                if (target.id === 'local-load-btn') loadLocal();
                if (target.id === 'cloud-save-btn') saveToDb();
                if (target.id === 'cloud-load-btn') showCharacterLoadModal();
                if (target.id === 'preview-btn') showPreviewModal();
                if (target.id === 'economy-btn') showEconomyModal();
                if (target.id === 'add-attack-btn') showAttackSelectionModal();
                if (target.id === 'add-armor-btn') showArmorSelectionModal();
                if (target.id === 'add-note-btn') addNoteToList();
                if (target.id === 'add-skill-btn') showAddSkillModal();
                
                const browseButton = target.closest('[data-browse-path]');
                if (browseButton) {
                    const targetList = browseButton.dataset.targetList || browseButton.id;
                    if(browseButton.hasAttribute('readonly')) {
                        showDirectoryModal(browseButton.id, browseButton.dataset.browsePath);
                    } else {
                         showDirectoryModal(targetList, browseButton.dataset.browsePath);
                    }
                }
        
                if (target.matches('.tab-btn')) {
                    const tabsContainer = document.getElementById('tabs-container');
                    const tabPanelsContainer = document.getElementById('tab-panels');
                    const currentActiveTab = tabsContainer.querySelector('.active');
                    const currentActivePanel = tabPanelsContainer.querySelector('.active');
                    
                    if(currentActiveTab) currentActiveTab.classList.remove('active');
                    if(currentActivePanel) currentActivePanel.classList.remove('active');
                    
                    target.classList.add('active');
                    const targetPanelId = target.dataset.tabTarget;
                    const targetPanel = document.querySelector(targetPanelId);
                    if(targetPanel) targetPanel.classList.add('active');
                }
            });
        
            container.addEventListener('input', (event) => {
                const form = event.target.closest('#persona-folio-form');
                if (form) {
                    if (event.target.matches('#char-name')) {
                        const header = document.getElementById('actor-display-header');
                        if (header) header.textContent = event.target.value.toUpperCase() || 'UNNAMED';
                    }

                    if (event.target.matches('.skill-rank, .attribute-value') || event.target.closest('.single-column-grid')) {
                         recalculateAllModifiers();
                    }
                    saveToSession();
                }
            });

            container.addEventListener('change', (event) => {
                const form = event.target.closest('#persona-folio-form');
                 if (form) {
                    if (event.target.matches('#char-occu, #char-species, #char-origin, #char-faction, .skill-base-select')) {
                        recalculateAllModifiers();
                    }
                     if (event.target.matches('[data-browse-path]')) {
                        updateAllTraits();
                    }
                    saveToSession();
                }
            });
        }


        function renderPersonaFolioView(container, folioData = {}, useSession = true) {
            
            const sessionData = useSession ? loadFromSession() : null;
            const finalData = sessionData || folioData;

            container.innerHTML = `
             <div class="persona-folio-container">
                 <form id="persona-folio-form" onsubmit="return false;">
                    <input type="hidden" id="character-doc-id" name="character-doc-id" value="${finalData['character-doc-id'] || ''}">
                     <header class="sheet-header">
                         <div class="file-menu" style="min-width: 100px;">
                             <button type="button" class="file-menu-button">DATA</button>
                             <div class="file-menu-dropdown">
                                 <button type="button" id="new-char-btn">New</button>
                                 <hr class="border-gray-600 my-1">
                                 <button type="button" id="preview-btn">Preview</button>
                                 <hr class="border-gray-600 my-1">
                                 <button type="button" id="cloud-save-btn">Save to Cloud</button>
                                 <button type="button" id="cloud-load-btn">Load from Cloud</button>
                                 <hr class="border-gray-600 my-1">
                                 <button type="button" id="local-save-btn">Save to File</button>
                                 <button type="button" id="local-load-btn">Load from File</button>
                             </div>
                         </div>
                         <div class="flex-grow text-center">
                            <h1>Tangent SFF RPG</h1>
                            <div id="actor-display-header" class="text-sm uppercase"></div>
                         </div>
                         <div class="flex items-center" style="min-width: 100px;">
                            <div id="header-cp-tracker" class="mr-4 text-right">
                                <div id="header-spent-cp" class="font-bold">Spent CP: 0</div>
                                <button type="button" id="economy-btn" class="text-xs text-blue-400 hover:underline">Economy</button>
                            </div>
                            <div id="auth-container"></div>
                         </div>
                     </header>

                    <div id="tabs-container" class="flex border-b border-gray-600 mb-4">
                        <button class="tab-btn active" data-tab-target="#identity-tab">Identity</button>
                        <button class="tab-btn" data-tab-target="#core-stats-tab">Core Stats</button>
                        <button class="tab-btn" data-tab-target="#skills-tab">Skills</button>
                        <button class="tab-btn" data-tab-target="#abilities-tab">Abilities</button>
                        <button class="tab-btn" data-tab-target="#combat-gear-tab">Combat & Gear</button>
                        <button class="tab-btn" data-tab-target="#other-tab">Other</button>
                    </div>

                    <div id="tab-panels">
                        <div id="identity-tab" class="tab-panel active">
                            <section class="main-section" id="bio-section">
                                <fieldset><legend>Bio</legend>
                                    <div class="space-y-4">
                                        <div class="input-group"><label for="char-name">Name</label><input type="text" id="char-name" name="char-name"></div>
                                        <div class="input-group"><label for="char-concept">Concept</label><input type="text" id="char-concept" name="char-concept"></div>
                                        <div class="input-group"><label for="char-species">Species</label><input type="text" id="char-species" name="char-species" data-browse-path="species" readonly class="cursor-pointer" placeholder="-- SELECT --"></div>
                                        <div class="input-group"><label for="char-occu">Occupation</label><input type="text" id="char-occu" name="char-occu" data-browse-path="occupations" readonly class="cursor-pointer" placeholder="-- SELECT --"></div>
                                        <div class="input-group"><label for="char-origin">Origin</label><input type="text" id="char-origin" name="char-origin" data-browse-path="origins" readonly class="cursor-pointer" placeholder="-- SELECT --"></div>
                                        <div class="input-group"><label for="char-faction">Faction</label><input type="text" id="char-faction" name="char-faction" data-browse-path="factions" readonly class="cursor-pointer" placeholder="-- SELECT --"></div>
                                    </div>
                                </fieldset>
                                <fieldset><legend>Facade</legend>
                                    <div class="space-y-4">
                                        <div class="input-group"><label for="char-age">Age</label><input type="text" id="char-age" name="char-age"></div>
                                        <div class="input-group"><label for="char-gender">Gender</label><input type="text" id="char-gender" name="char-gender"></div>
                                        <div class="input-group"><label for="char-height">Height</label><input type="text" id="char-height" name="char-height"></div>
                                        <div class="input-group"><label for="char-weight">Weight</label><input type="text" id="char-weight" name="char-weight"></div>
                                        <div class="input-group"><label for="char-style">Description / Style</label><textarea id="char-style" name="char-style" rows="2"></textarea></div>
                                        <div class="input-group"><label for="char-motive">Personality / Motive</label><textarea id="char-motive" name="char-motive" rows="2"></textarea></div>
                                    </div>
                                </fieldset>
                                 <fieldset><legend>Traits</legend>
                                     <div class="single-column-grid space-y-4">
                                         <div class="trait-group">
                                             <h5>Species</h5>
                                             <textarea id="species-traits-display" name="species-traits-display" readonly rows="2"></textarea>
                                         </div>
                                         <div class="trait-group">
                                             <h5>Origin</h5>
                                             <textarea id="origin-traits-display" name="origin-traits-display" readonly rows="2"></textarea>
                                         </div>
                                         <div class="trait-group">
                                             <h5>Occupation</h5>
                                             <textarea id="occupation-traits-display" name="occupation-traits-display" readonly rows="2"></textarea>
                                         </div>
                                         <div class="trait-group">
                                             <h5>Faction</h5>
                                             <textarea id="faction-traits-display" name="faction-traits-display" readonly rows="2"></textarea>
                                         </div>
                                     </div>
                                 </fieldset>
                            </section>
                        </div>
                        <div id="core-stats-tab" class="tab-panel">
                             <section class="main-section" id="attributes-stats-section">
                                 <fieldset><legend>Attributes</legend>
                                     <div class="space-y-1">
                                         <div class="grid grid-cols-5 gap-x-2 text-center font-bold text-xs uppercase">
                                             <span class="col-span-2 text-left">Attribute</span>
                                             <span>Value</span>
                                             <span>Mod</span>
                                             <span>Total</span>
                                         </div>
                                         ${[
                                             { name: 'Strength', id: 'attr-strength' }, { name: 'Might', id: 'attr-might', sub: true },
                                             { name: 'Agility', id: 'attr-agility' }, { name: 'Reflex', id: 'attr-reflex', sub: true },
                                             { name: 'Stamina', id: 'attr-stamina' }, { name: 'Fortitude', id: 'attr-fortitude', sub: true },
                                             { name: 'Intellect', id: 'attr-intellect' }, { name: 'Logic', id: 'attr-logic', sub: true },
                                             { name: 'Wisdom', id: 'attr-wisdom' }, { name: 'Will', id: 'attr-will', sub: true },
                                             { name: 'Charisma', id: 'attr-charisma' }, { name: 'Etiquette', id: 'attr-etiquette', sub: true }
                                         ].map(attr => `
                                             <div class="grid grid-cols-5 gap-x-2 items-center ${!attr.sub ? 'primary-attribute-row' : ''} ${attr.sub ? 'mb-2' : ''}">
                                                 <label for="${attr.id}" class="col-span-2 ${attr.sub ? 'italic pl-4' : 'text-lg font-semibold'}">${attr.name}</label>
                                                 <input type="number" id="${attr.id}" name="${attr.id}" class="attribute-value text-center ${attr.sub ? 'w-16 mx-auto' : ''}" value="0" ${attr.sub ? 'readonly' : ''}>
                                                 <input type="number" id="${attr.id}-mod" name="${attr.id}-mod" class="attribute-mod italic text-center" value="0" readonly>
                                                 <input type="number" id="${attr.id}-total" name="${attr.id}-total" class="attribute-total font-bold text-center ${!attr.sub ? 'text-lg' : ''} ${attr.sub ? 'w-16 mx-auto' : ''}" readonly value="0">
                                             </div>
                                             ${attr.sub ? '<div class="col-span-5 border-b-2 border-gray-500 my-2"></div>' : ''}
                                         `).join('')}
                                     </div>
                                 </fieldset>
                                 <fieldset><legend>Stats</legend>
                                     <div class="space-y-4">
                                         <div class="grid grid-cols-4 gap-x-2 items-center">
                                             <label for="initiative-total" class="col-span-1 font-bold">Initiative</label>
                                             <input type="number" id="initiative-base" name="initiative-base" class="text-center" readonly>
                                             <input type="number" id="initiative-mod" name="initiative-mod" class="text-center" value="0" readonly>
                                             <input type="number" id="initiative-total" name="initiative-total" class="font-bold text-center" readonly>
                                         </div>
                                         <div class="grid grid-cols-4 gap-x-2 text-center text-xs -mt-3 pb-2">
                                             <span></span>
                                             <span class="text-gray-400">Base</span>
                                             <span class="text-gray-400">Mod</span>
                                             <span class="text-gray-400">Total</span>
                                         </div>
                                         <div class="input-group"><label for="health">Health</label><input type="number" id="health" name="health"></div>
                                         <div class="input-group"><label for="vitality">Vitality</label><input type="number" id="vitality" name="vitality"></div>
                                     </div>
                                 </fieldset>
                                 <fieldset><legend>Ratings</legend>
                                     <div class="space-y-4">
                                         <div class="input-group"><label for="karma">Karma</label><input type="number" id="karma" name="karma"></div>
                                         <div class="input-group"><label for="plot-points">Plot Points</label><input type="number" id="plot-points" name="plot-points"></div>
                                         <div class="border-b border-gray-600"></div>
                                         <div class="input-group"><label for="tech-level">Tech Level</label><input type="text" id="tech-level" name="tech-level" readonly></div>
                                         <div class="border-b border-gray-600"></div>
                                         <div class="input-group"><label for="wealth">Wealth</label><input type="text" id="wealth" name="wealth"></div>
                                     </div>
                                 </fieldset>
                                 <fieldset><legend>Perception</legend>
                                     <div class="space-y-4">
                                         <div class="input-group">
                                             <label for="perception">Perception</label>
                                             <input type="number" id="perception" name="perception" readonly>
                                         </div>
                                         <div class="pl-4 space-y-4 border-l-2 border-gray-600 ml-2">
                                             <div class="input-group">
                                                 <label for="perception-meta" class="text-sm italic">Meta</label>
                                                 <input type="number" id="perception-meta" name="perception-meta" readonly>
                                             </div>
                                             <div class="input-group">
                                                 <label for="perception-social" class="text-sm italic">Social</label>
                                                 <input type="number" id="perception-social" name="perception-social" readonly>
                                             </div>
                                             <div class="input-group">
                                                 <label for="perception-tech" class="text-sm italic">Technical</label>
                                                 <input type="number" id="perception-tech" name="perception-tech" readonly>
                                             </div>
                                         </div>
                                     </div>
                                 </fieldset>
                             </section>
                        </div>
                        <div id="skills-tab" class="tab-panel">
                             <section class="main-section" id="skills-section">
                                     <fieldset><legend>Skills</legend>
                                         <div id="skills-list" class="skills-column space-y-8"></div>
                                         <div class="flex gap-2 mt-4 pt-4 border-t border-gray-700">
                                             <button type="button" id="add-skill-btn" class="btn btn-secondary w-full">Add Skill</button>
                                         </div>
                                     </fieldset>
                             </section>
                             <section class="main-section" id="meta-section">
                                     <fieldset><legend>Meta</legend>
                                        <div id="meta-skills-list" class="space-y-4"></div>
                                     </fieldset>
                             </section>
                        </div>
                        <div id="abilities-tab" class="tab-panel">
                            <section class="main-section">
                                <fieldset><legend>Invocations</legend>
                                 <div id="invocations-display" class="single-column-grid"></div>
                                 <button type="button" data-target-list="invocations" data-browse-path="invocations" class="btn btn-secondary mt-4 w-full">Add Invocation</button>
                                 <input type="hidden" id="invocations-data" name="invocations">
                                </fieldset>
                            </section>
                             <section class="main-section" id="special-abilities-section">
                                 <fieldset><legend>Special Abilities</legend>
                                     <div id="special_abilities-display" class="single-column-grid"></div>
                                     <button type="button" data-target-list="special_abilities" data-browse-path="invocations" class="btn btn-secondary mt-4 w-full">Add Special Ability</button>
                                     <input type="hidden" id="special_abilities-data" name="special_abilities">
                                 </fieldset>
                            </section>
                            <section class="main-section">
                                 <fieldset><legend>Features</legend>
                                     <div id="features-display" class="single-column-grid"></div>
                                     <button type="button" data-target-list="features" data-browse-path="features" class="btn btn-secondary mt-4 w-full">Add Feature</button>
                                     <input type="hidden" id="features-data" name="features">
                                 </fieldset>
                            </section>
                            <section class="main-section">
                                 <fieldset><legend>Disadvantages</legend>
                                     <div id="disadvantages-display" class="single-column-grid"></div>
                                     <button type="button" data-target-list="disadvantages" data-browse-path="disadvantages" class="btn btn-secondary mt-4 w-full">Add Disadvantage</button>
                                     <input type="hidden" id="disadvantages-data" name="disadvantages">
                                 </fieldset>
                            </section>
                        </div>
                         <div id="combat-gear-tab" class="tab-panel">
                             <section class="main-section" id="combat-section">
                                 <fieldset><legend>Combat</legend>
                                     <div id="attack-rows">
                                         <div class="attack-grid">
                                             <div class="attack-header">Attack</div>
                                             <div class="attack-header">Score</div>
                                             <div class="attack-header">Effect</div>
                                             <div class="attack-header">Notes</div>
                                             <div></div>
                                         </div>
                                     </div>
                                     <input type="hidden" id="attacks-data" name="attacks">
                                     <button type="button" id="add-attack-btn" class="btn btn-secondary mt-4 w-full">Add Attack</button>
                                     
                                     <hr class="my-6 border-t-2 border-gray-600">
        
                                     <div id="armor-rows">
                                         <div class="armor-grid">
                                             <div class="armor-header">Armor</div>
                                             <div class="armor-header">Resistance</div>
                                             <div class="armor-header">Notes</div>
                                             <div></div>
                                         </div>
                                     </div>
                                     <input type="hidden" id="armor-data" name="armor">
                                     <button type="button" id="add-armor-btn" class="btn btn-secondary mt-4 w-full">Add Armor</button>
                                 </fieldset>
                             </section>
                            <section class="main-section">
                                 <fieldset><legend>Augmentations</legend>
                                     <div id="augmentations-display" class="single-column-grid"></div>
                                     <button type="button" data-target-list="augmentations" data-browse-path="augmentations" class="btn btn-secondary mt-4 w-full">Add Augmentation</button>
                                     <input type="hidden" id="augmentations-data" name="augmentations">
                                 </fieldset>
                            </section>
                             <section class="main-section">
                                 <fieldset>
                                     <legend>Equipment</legend>
                                    <div id="equipment-display" class="single-column-grid"></div>
                                    <button type="button" data-target-list="equipment" data-browse-path="equipment" class="btn btn-secondary mt-4 w-full">Add Equipment</button>
                                    <input type="hidden" id="equipment-data" name="equipment">
                                 </fieldset>
                             </section>
                         </div>
                         <div id="other-tab" class="tab-panel">
                             <section class="main-section">
                                 <fieldset>
                                     <legend>Associates</legend>
                                    <div id="associates-display" class="single-column-grid"></div>
                                    <button type="button" data-target-list="associates" data-browse-path="associates" class="btn btn-secondary mt-4 w-full">Add Associate</button>
                                    <input type="hidden" id="associates-data" name="associates">
                                 </fieldset>
                             </section>
                             <section class="main-section" id="notes-section">
                                 <fieldset><legend>Notes</legend>
                                     <div id="notes-list" class="single-column-grid space-y-2">
                                     </div>
                                     <input type="hidden" id="notes-data" name="notes">
                                     <button type="button" id="add-note-btn" class="btn btn-secondary mt-4 w-full">Add Note</button>
                                 </fieldset>
                             </section>
                         </div>
                    </div>
                     
                     <footer class="creator-credit">
                         WOLFE.BT@TANGENTLLC
                     </footer>
                 </form>
               </div>
            `;
            
            updateUIAfterAuthChange();
            initializePersonaFolio(finalData);
        }

        // --- Authentication ---
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
                showCustomAlert("Could not sign in with Google.");
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // *** FIX: Do not modify appInitialized state here.
                // onAuthStateChanged will handle the UI update.
                clearSession();
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }
        
        function updateUIAfterAuthChange() {
            const authContainer = document.getElementById('auth-container');
            if (!authContainer) return;

            authContainer.innerHTML = ''; 
            if (appState.isAnonymous) {
                const loginButton = document.createElement('button');
                loginButton.className = 'btn btn-primary !py-1 !px-3';
                loginButton.textContent = 'LOGIN';
                loginButton.addEventListener('click', handleLogin);
                authContainer.appendChild(loginButton);
            } else {
                const logoutButton = document.createElement('button');
                logoutButton.className = 'btn btn-secondary !py-1 !px-3';
                logoutButton.textContent = 'LOGOUT';
                logoutButton.addEventListener('click', handleLogout);
                authContainer.appendChild(logoutButton);
            }
        }

        // *** FIX: Refactored onAuthStateChanged for robust, one-time initialization.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in (either newly or already).
                appState.userId = user.uid;
                appState.isAnonymous = user.isAnonymous;
                
                if (!appState.authReady) {
                    appState.authReady = true;
                    authReadyPromiseResolver();
                }

                if (!appState.appInitialized) {
                    // This block runs ONLY ONCE per page load.
                    appState.appInitialized = true;
                    await cacheAllData();
                    renderPersonaFolioView(document.getElementById('folio-container'), {});
                    setupGlobalEventListeners();
                }
                
                updateUIAfterAuthChange();

            } else {
                // No user is signed in.
                appState.userId = null;
                appState.isAnonymous = true;
                
                if (appState.appInitialized) {
                    // The app was already running, so this is a logout.
                    // Render an empty sheet. The listeners will persist.
                    renderPersonaFolioView(document.getElementById('folio-container'), {});
                } else {
                    // The app has not run yet, so this is the initial state.
                    // Try to sign in anonymously. This will re-trigger onAuthStateChanged.
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        showCustomAlert("Could not connect to the authentication service.");
                    }
                }
            }
        });

        // Setup listeners for modals that are always in the DOM
        document.getElementById('preview-print-btn').addEventListener('click', () => window.print());
        document.getElementById('preview-close-btn').addEventListener('click', () => {
            document.getElementById('preview-modal').classList.add('hidden');
        });
        document.getElementById('economy-close-btn').addEventListener('click', () => {
            document.getElementById('economy-modal').classList.add('hidden');
        });
        document.getElementById('starting-cp').addEventListener('input', calculateCharacterPoints);

    </script>
</body>
</html>
