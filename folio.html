<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Folio</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="dbm-style.css">
    <style>
        body > .folio-container {
            padding: 0 1.5rem 1.5rem 0;
        }
        .sheet-header {
            border-bottom: 1px solid var(--panel-border);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .columns-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
        .columns-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .row-2-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .skills-column {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
        .skill-group {
            break-inside: avoid;
            margin-bottom: 1rem;
        }
        .skill-row, .attack-grid, .armor-grid {
            display: grid;
            gap: 0.5rem;
            align-items: center;
        }
        .skill-row { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        .attack-grid { grid-template-columns: 2fr 1fr 2fr 3fr auto; }
        .armor-grid { grid-template-columns: 2fr 2fr 3fr auto; }
        .single-column-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; }
        #main-content {
            padding-top: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .app-container {
            display: flex;
            gap: 1.5rem;
        }
        #app-sidebar {
            width: 300px;
            flex-shrink: 0;
            padding: 0 1.5rem 1.5rem 0;
            height: 100vh;
            overflow-y: auto;
        }
        .perception-container {
            display: grid;
            grid-template-columns: .5fr 1fr;
            gap: 1rem;
            align-items: center;
        }
        .stat-sub-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.25rem 0.5rem;
            align-items: center;
        }
        .move-sub-grid {
            grid-template-columns: auto 1fr auto 1fr;
        }
    </style>
</head>
<body>
    <div class="folio-container">
        <div id="folio-container" class="app-container"></div>
    
        <div id="custom-modal" class="modal-overlay hidden">
            <div class="modal-content glass-panel">
                <div class="modal-header">
                    <h3 id="modal-title"></h3>
                    <button id="modal-close-btn" class="modal-close-btn modal-close-trigger">&times;</button>
                </div>
                <div id="modal-choices"></div>
                <div class="modal-controls">
                    <button id="modal-ok-btn" class="action-btn hidden">OK</button>
                    <button id="modal-cancel-btn" class="action-btn hidden">Cancel</button>
                </div>
            </div>
        </div>
    
        <div id="confirm-modal" class="modal-overlay hidden">
            <div class="modal-content glass-panel">
                 <div class="modal-header">
                    <h3 id="confirm-title">Are you sure?</h3>
                </div>
                <p id="confirm-message">This action cannot be undone.</p>
                <div class="modal-controls" style="justify-content: flex-end;">
                    <button id="confirm-cancel-btn" class="action-btn">CANCEL</button>
                    <button id="confirm-ok-btn" class="action-btn">CONFIRM</button>
                </div>
            </div>
        </div>

        <div id="preview-modal" class="modal-overlay hidden">
            <div id="preview-modal-content" class="glass-panel" style="color: var(--text-light); max-width: 8.5in;">
                <div class="modal-controls" style="justify-content: flex-end; margin-bottom: 1rem;">
                    <button id="preview-print-btn" class="action-btn" style="margin-right: 1rem;">Print</button>
                    <button id="preview-close-btn" class="action-btn modal-close-trigger">Close</button>
                </div>
                <div id="preview-content"></div>
            </div>
        </div>

        <div id="economy-modal" class="modal-overlay hidden">
            <div class="modal-content glass-panel">
                <div class="modal-header">
                    <h3>Character Economy</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="starting-cp">Starting CP</label>
                        <input type="number" id="starting-cp" value="150" step="50" class="global-form-input">
                    </div>
                     <div class="form-group">
                        <label>Spent CP</label>
                        <input type="number" id="economy-spent-cp" class="global-form-input" readonly>
                    </div>
                     <div class="form-group">
                        <label>Remaining CP</label>
                        <input type="number" id="economy-remaining-cp" class="global-form-input" readonly>
                    </div>
                </div>
                <div class="skill-point-economy" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--panel-border);">
                    <h4 style="margin-bottom: .5rem;">Skill Point Economy</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem; text-align: center; margin-bottom: .5rem; font-weight: bold;">
                        <span>Category</span>
                        <span>Awarded</span>
                        <span>Spent</span>
                        <span>Remaining</span>
                    </div>
                    <div id="skill-point-pools-display" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem .5rem; text-align: center;">
                        <!-- Rows will be dynamically inserted here by showEconomyModal -->
                    </div>
                </div>
                <div id="economy-details" class="economy-details-panel"></div>
                <div class="modal-controls" style="justify-content: flex-end;">
                     <button id="economy-close-btn" class="action-btn modal-close-trigger">Close</button>
                </div>
            </div>
        </div>
    </div>


    <input type="file" id="json-file-input" class="hidden" accept=".json">

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signOut, 
            GoogleAuthProvider, signInWithPopup,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { 
            getFirestore, collection, getDocs, doc, setDoc, addDoc, getDoc, query, where 
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                // Fallback config for local development
                apiKey: "AIzaSyBA1CC4SXXtWM9UpU1XkAiBFr0RIgrPwGk",
                authDomain: "tangent-rpg-dbm.firebaseapp.com",
                projectId: "tangent-rpg-dbm",
                storageBucket: "tangent-rpg-dbm.appspot.com",
                messagingSenderId: "559983787369",
                appId: "1:559983787369:web:477e741d39d16d8fd211f8",
                measurementId: "G-RNTCSYY7HD"
              };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;


        // --- RPG System Configuration (from Database Manager) ---
        const categoryConfig = {
            species: { label: 'SPECIES' },
            factions: { label: 'FACTIONS' },
            origins: { label: 'ORIGINS' },
            occupations: { label: 'OCCUPATIONS' },
            disadvantages: { label: 'DISADVANTAGES' },
            features: { label: 'FEATURES' },
            skills: { label: 'SKILLS' },
            augmentations: { label: 'AUGMENTATIONS' },
            invocations: { label: 'INVOCATIONS' },
            equipment: { label: 'EQUIPMENT' },
            associates: { label: 'ASSOCIATES' },
        };

        // --- Application State ---
        const appState = {
            userId: null,
            isAnonymous: true,
            authReady: false,
            initialFormState: null,
            confirmCallback: null,
            allModifiersCache: null, // Cache for modifier definitions
            appInitialized: false,
            allFeatures: [],
            allOccupations: [],
            allSpecies: [],
            allFactions: [],
            allOrigins: [],
        };
        
        const SESSION_STORAGE_KEY = 'personaFolioData';

        // --- Authentication Promise ---
        let authReadyPromiseResolver;
        const authReadyPromise = new Promise(resolve => {
            authReadyPromiseResolver = resolve;
        });

        // --- Session & Data Functions ---
        function saveToSession() {
            const data = getPersonaFolioFormData();
            sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromSession() {
            const dataStr = sessionStorage.getItem(SESSION_STORAGE_KEY);
            return dataStr ? JSON.parse(dataStr) : null;
        }
        
        function clearSession() {
            sessionStorage.removeItem(SESSION_STORAGE_KEY);
        }

        // --- Firebase Functions ---
        async function getCollectionOptions(collectionName) {
            await authReadyPromise;

            if (collectionName === 'equipment') {
                const equipmentTypes = ['armoring', 'weaponry', 'mecha', 'gear', 'other'];
                let allOptions = [];
                for (const type of equipmentTypes) {
                    const options = await getCollectionOptions(type);
                    options.forEach(o => o.category = type);
                    allOptions.push(...options);
                }
                return allOptions.sort((a,b) => a.name.localeCompare(b.name));
            }
            
            const collectionPath = `artifacts/${appId}/public/data/${collectionName}`;
            
            try {
                const querySnapshot = await getDocs(collection(db, collectionPath));
                return querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a,b) => (a.name || '').localeCompare(b.name || ''));
            } catch (error) {
                console.error(`FirebaseError reading '${collectionName}'. Path: '${collectionPath}'. Please ensure this path exists in your Firestore database and that your security rules allow read access.`, error);
                showCustomAlert(`Could not load data for ${collectionName}. Check console (F12) for details.`);
                return [];
            }
        }


        // --- NEW: Cache modifier data on startup ---
        async function cacheAllData() {
            appState.allModifiersCache = await getCollectionOptions('modifier');
            appState.allFeatures = await getCollectionOptions('features');
            appState.allOccupations = await getCollectionOptions('occupations');
            appState.allSpecies = await getCollectionOptions('species');
            appState.allFactions = await getCollectionOptions('factions');
            appState.allOrigins = await getCollectionOptions('origins');
        }


        // --- Persona Folio Logic (Adapted for Firebase) ---

        function getPersonaFolioFormData() {
            const form = document.getElementById('persona-folio-form');
            if (!form) return {};
            const data = {};
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }
            // Parse JSON data from hidden inputs
            ['features', 'disadvantages', 'augmentations', 'invocations', 'special_abilities', 'awakened', 'gear', 'weapons', 'armoring', 'mecha', 'other', 'associates', 'attacks', 'armor', 'notes'].forEach(key => {
                const element = document.getElementById(`${key}-data`);
                if (element && element.value) {
                    try {
                        data[key] = JSON.parse(element.value);
                    } catch (e) {
                        data[key] = [];
                    }
                }
            });
            return data;
        }

        function populatePersonaFolioForm(data) {
            const sheet = document.getElementById('persona-folio-form');
            if (!sheet || !data) return;
            
            for (const key in data) {
                const elements = sheet.elements[key];
                if (!elements) continue;

                if (['features', 'disadvantages', 'augmentations', 'invocations', 'special_abilities', 'awakened', 'gear', 'weapons', 'armoring', 'mecha', 'other', 'associates', 'attacks', 'armor', 'notes'].includes(key)) {
                    const dataInput = document.getElementById(`${key}-data`);
                    if(dataInput) {
                        const values = Array.isArray(data[key]) ? data[key] : [];
                        dataInput.value = JSON.stringify(values);
                        if (key === 'attacks') {
                            renderAttackRows(values);
                        } else if (key === 'armor') {
                            renderArmorRows(values);
                        } else if (key === 'notes') {
                            renderNoteRows(values);
                        }
                        else {
                            renderItemList(document.getElementById(`${key}-display`), values, key);
                        }
                    }
                } else if(elements.value !== undefined) {
                     if (elements.length > 1 && elements.type !== 'radio' && elements.type !== 'checkbox') {
                        // Handle NodeList for elements like radio buttons if needed
                     } else {
                        elements.value = data[key];
                     }
                }
            }

            const name = data['char-name'] || 'UNNAMED';
            const headerSpan = document.getElementById('actor-display-header');
            if (headerSpan) {
                headerSpan.textContent = name.toUpperCase();
            }
            updateAllTraits();
            setMovementPlaceholders();
        }

        function setMovementPlaceholders() {
            const movementIds = ['move-walk', 'move-swim', 'move-climb', 'move-fly'];
            movementIds.forEach(id => {
                const input = document.getElementById(id);
                if (input && !input.value) {
                    input.placeholder = "---";
                }
            });
        }

        function saveLocal() {
            const data = getPersonaFolioFormData();
            const name = data['char-name'];
            const fileName = (name || 'persona_folio').replace(/\s+/g, '_') + '.json';
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadLocal() {
            clearSession();
            document.getElementById('json-file-input').click();
        }

        document.getElementById('json-file-input').onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    renderPersonaFolioView(document.getElementById('folio-container'), data, false);
                } catch (err) {
                    showCustomAlert("Could not parse JSON file.");
                    console.error("Error parsing JSON:", err);
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        };
        
        const primaryToSubAttributeMap = {
            'attr-strength': 'attr-might',
            'attr-agility': 'attr-reflex',
            'attr-stamina': 'attr-fortitude',
            'attr-intellect': 'attr-logic',
            'attr-wisdom': 'attr-will',
            'attr-charisma': 'attr-etiquette',
        };

        function calculatePerceptionScores() {
            const getValue = (id) => parseInt(document.getElementById(id)?.value) || 0;
            
            const alertnessTotal = getValue('skill-mental-alertness-total');
            const perceptionInput = document.getElementById('perception');
            if (perceptionInput) perceptionInput.value = alertnessTotal;

            const intellectTotal = getValue('attr-intellect-total');
            const wisdomTotal = getValue('attr-wisdom-total');
            const alertnessMod = getValue('skill-mental-alertness-mod');
            const commonBase = intellectTotal + wisdomTotal + alertnessMod;

            const attuneRank = getValue('skill-meta-attune-rank');
            const attuneMod = getValue('skill-meta-attune-mod');
            const metaInput = document.getElementById('perception-meta');
            if (metaInput) metaInput.value = commonBase + attuneRank + attuneMod;

            const insightRank = getValue('skill-social-manipulation-insight-rank');
            const insightMod = getValue('skill-social-manipulation-insight-mod');
            const socialInput = document.getElementById('perception-social');
            if (socialInput) socialInput.value = commonBase + insightRank + insightMod;

            const technologyRank = getValue('skill-mental-knowledge-technology-rank');
            const technologyMod = getValue('skill-mental-knowledge-technology-mod');
            const techInput = document.getElementById('perception-tech');
            if (techInput) techInput.value = commonBase + technologyRank + technologyMod;
        }

        function calculateAlertness() {
            const intellectTotal = parseInt(document.getElementById('attr-intellect-total')?.value) || 0;
            const wisdomTotal = parseInt(document.getElementById('attr-wisdom-total')?.value) || 0;
            const alertnessRow = document.querySelector('[data-skill-id="mental-alertness"]');
            if (!alertnessRow) return;

            const baseInput = alertnessRow.querySelector('.skill-base-input');
            if (baseInput) {
                baseInput.value = intellectTotal + wisdomTotal;
            }

            calculateSkillTotal(alertnessRow);
        }

        function calculateInitiative() {
            const reflexTotalInput = document.getElementById('attr-reflex-total');
            const initiativeBaseInput = document.getElementById('initiative-base');
            const initiativeModInput = document.getElementById('initiative-mod');
            const initiativeTotalInput = document.getElementById('initiative-total');

            if (!reflexTotalInput || !initiativeBaseInput || !initiativeModInput || !initiativeTotalInput) {
                return;
            }

            const base = parseInt(reflexTotalInput.value) || 0;
            const mod = parseInt(initiativeModInput.value) || 0;

            initiativeBaseInput.value = base;
            initiativeTotalInput.value = base + mod;
        }

        function calculateAttributeTotal(attributeBaseId) {
            const valueInput = document.getElementById(attributeBaseId);
            const modInput = document.getElementById(`${attributeBaseId}-mod`);
            const totalInput = document.getElementById(`${attributeBaseId}-total`);

            if (!valueInput || !modInput || !totalInput) return;

            const value = parseInt(valueInput.value) || 0;
            const mod = parseInt(modInput.value) || 0;
            const total = value + mod;
            totalInput.value = total;

            if (attributeBaseId === 'attr-intellect' || attributeBaseId === 'attr-wisdom') {
                calculateAlertness();
            }

            if (attributeBaseId === 'attr-reflex') {
                calculateInitiative();
            }


            document.querySelectorAll('.skill-row:not(.header)').forEach(skillRow => {
                const baseSelect = skillRow.querySelector('.skill-base-select');
                if (baseSelect && baseSelect.value === attributeBaseId) {
                    calculateSkillTotal(skillRow);
                }
            });
            calculatePerceptionScores();
        }

        function calculateSpecializationTotal(specRow) {
            if (!specRow) return;
            const parentSkillId = specRow.dataset.parentSkill;
            const parentRow = document.querySelector(`.skill-row[data-skill-id="${parentSkillId}"]`);
            if (!parentRow) return;

            const rank = parseInt(specRow.querySelector('.skill-rank')?.value) || 0;
            const mod = parseInt(specRow.querySelector('.skill-mod')?.value) || 0;
            const parentTotal = parseInt(parentRow.querySelector('.skill-total')?.value) || 0;

            const baseInput = specRow.querySelector('.spec-base-input');
            const totalInput = specRow.querySelector('.spec-total');
            
            if (baseInput) baseInput.value = parentTotal;
            if (totalInput) totalInput.value = rank + parentTotal + mod;
        }

        function calculateSkillTotal(skillRow) {
            if (!skillRow || skillRow.classList.contains('header') || skillRow.classList.contains('specialization')) return;

            const rankInput = skillRow.querySelector('.skill-rank');
            const baseSelect = skillRow.querySelector('.skill-base-select');
            const baseInput = skillRow.querySelector('.skill-base-input');
            const modInput = skillRow.querySelector('.skill-mod');
            const totalInput = skillRow.querySelector('.skill-total');
            
            if (!rankInput || (!baseSelect && !baseInput) || !modInput || !totalInput) {
                return;
            }

            const rank = parseInt(rankInput.value) || 0;
            const mod = parseInt(modInput.value) || 0;
            let baseValue = 0;

            if (baseInput) {
                baseValue = parseInt(baseInput.value) || 0;
            } else if (baseSelect) {
                const selectedBaseAttrId = baseSelect.value;
                if (selectedBaseAttrId) {
                    const attrTotalInput = document.getElementById(`${selectedBaseAttrId}-total`); 
                    if (attrTotalInput) {
                        baseValue = parseInt(attrTotalInput.value) || 0;
                    }
                }
            }
            
            const total = rank + baseValue + mod;
            totalInput.value = total;
            
            const skillId = skillRow.dataset.skillId;
            document.querySelectorAll(`.specialization-row[data-parent-skill="${skillId}"]`).forEach(specRow => {
                calculateSpecializationTotal(specRow);
            });
            
            if (['mental-alertness', 'meta-attune', 'social-manipulation-insight', 'mental-knowledge-technology'].includes(skillId)) {
                calculatePerceptionScores();
            }
        }
        
        async function recalculateAllModifiers() {
            // Ensure the modifier cache is populated
            if (!appState.allModifiersCache) {
                await cacheAllData();
            }

            document.querySelectorAll('.attribute-mod, .skill-mod, #initiative-mod').forEach(input => {
                input.value = 0;
            });
            
            const modifiers = {};

            const modifierSources = [
                { type: 'single', collection: 'occupations', elementId: 'char-occu' },
                { type: 'multi', collection: 'features', elementId: 'features-data' },
                { type: 'multi', collection: 'disadvantages', elementId: 'disadvantages-data' },
                { type: 'multi', collection: 'augmentations', elementId: 'augmentations-data' },
            ];

            for (const source of modifierSources) {
                const dbItems = await getCollectionOptions(source.collection);
                let selectedNames = [];

                if (source.type === 'single') {
                    const el = document.getElementById(source.elementId);
                    if (el && el.value) {
                        selectedNames.push(el.value);
                    }
                } else {
                    const el = document.getElementById(source.elementId);
                    if (el && el.value) {
                        try {
                            selectedNames = JSON.parse(el.value);
                        } catch (e) { /* ignore */ }
                    }
                }

                for (const name of selectedNames) {
                    const itemData = dbItems.find(item => item.name === name);
                    if (itemData && Array.isArray(itemData.modifier)) {
                        for (const modName of itemData.modifier) {
                            // **FIXED LOGIC**: Look up modifier details from the cache
                            const modDetails = appState.allModifiersCache.find(m => m.name === modName);
                            if (modDetails) {
                                const key = modDetails.aspect_subtype;
                                if (!modifiers[key]) {
                                    modifiers[key] = 0;
                                }
                                modifiers[key] += modDetails.value;
                            }
                        }
                    }
                }
            }

            for (const key in modifiers) {
                const value = modifiers[key];

                const statModInput = document.getElementById(`${key}-mod`);
                if(statModInput) {
                    statModInput.value = (parseInt(statModInput.value) || 0) + value;
                    continue;
                }

                const attrModInput = document.getElementById(`attr-${key}-mod`);
                if (attrModInput) {
                    attrModInput.value = (parseInt(attrModInput.value) || 0) + value;
                    continue;
                }

                document.querySelectorAll('.skill-row:not(.header)').forEach(row => {
                    const label = row.querySelector('label');
                    if (label && label.textContent.toLowerCase() === key.toLowerCase()) {
                        const skillModInput = row.querySelector('.skill-mod');
                        if (skillModInput) {
                            skillModInput.value = (parseInt(skillModInput.value) || 0) + value;
                        }
                    }
                });
            }

            Object.keys(primaryToSubAttributeMap).forEach(calculateAttributeTotal);
            document.querySelectorAll('.skill-row:not(.header)').forEach(calculateSkillTotal);
            calculateInitiative();
            calculateAlertness();
            calculatePerceptionScores();
            calculateCharacterPoints();
            updateAbilityCounters();
        }

        function getAggregatedBonuses() {
            const data = getPersonaFolioFormData();
            const bonuses = {
                bonusSkillRanks: [],
                bonusFeatures: [],
                recommendedFeatures: [],
                skillOptions: [],
                skillChoiceTotals: { total: 0, sources: {} },
                featureOptions: [],
                featureChoiceTotals: { total: 0, sources: {} },
                totalDisciplines: 0,
                totalSpecialAbilities: 0,
                skillPointPools: {
                    physical: { total: 0, sources: {} },
                    mental: { total: 0, sources: {} },
                    social: { total: 0, sources: {} },
                    combat: { total: 0, sources: {} },
                    meta: { total: 0, sources: {} },
                    general: { total: 0, sources: {} },
                }
            };

            const sources = [
                { name: data['char-species'], db: appState.allSpecies, label: 'Species' },
                { name: data['char-occu'], db: appState.allOccupations, label: 'Occupation' },
                { name: data['char-origin'], db: appState.allOrigins, label: 'Origin' },
                { name: data['char-faction'], db: appState.allFactions, label: 'Faction' },
            ];

            const selectedFeatures = data.features || [];
            selectedFeatures.forEach(featureName => {
                const featureData = appState.allFeatures.find(f => f.name === featureName);
                if (featureData) {
                    sources.push({ name: featureName, db: [featureData], label: 'Feature' });
                }
            });


            const skillPointCategories = ['physical', 'mental', 'social', 'combat', 'meta', 'general'];

            sources.forEach(source => {
                const item = source.db.find(i => i.name === source.name);
                if (item) {
                    // Handle categorized skill points
                    skillPointCategories.forEach(category => {
                        const key = (category === 'general') ? `bonus_skill_points` : `bonus_skill_points_${category}`;
                        if (item[key] && typeof item[key] === 'number') {
                            const points = item[key];
                            bonuses.skillPointPools[category].total += points;
                            if (points > 0) {
                                const sourceLabel = (source.label === 'Feature') ? item.name : source.label;
                                bonuses.skillPointPools[category].sources[sourceLabel] = (bonuses.skillPointPools[category].sources[sourceLabel] || 0) + points;
                            }
                        }
                    });

                    if (item.bonus_skills) {
                        try {
                            const skills = Array.isArray(item.bonus_skills) ? item.bonus_skills : JSON.parse(item.bonus_skills);
                            if (Array.isArray(skills)) {
                                bonuses.bonusSkillRanks.push(...skills.map(s => ({ skill: s.name, ranks: s.value, source: source.label })));
                            }
                        } catch (e) {
                            console.error(`Could not parse bonus_skills for ${source.label} '${source.name}':`, item.bonus_skills, e);
                        }
                    }
                    if (item.bonus_features) bonuses.bonusFeatures.push(...item.bonus_features);
                    if (item.recommended_features) bonuses.recommendedFeatures.push(...item.recommended_features);
                    if (item.bonus_skill_options) bonuses.skillOptions.push(...item.bonus_skill_options);
                    if (item.bonus_skill_choices) {
                        bonuses.skillChoiceTotals.total += item.bonus_skill_choices;
                        bonuses.skillChoiceTotals.sources[source.label] = (bonuses.skillChoiceTotals.sources[source.label] || 0) + item.bonus_skill_choices;
                    }
                    if (item.bonus_feature_options) bonuses.featureOptions.push(...item.bonus_feature_options);
                    if (item.bonus_feature_choices) {
                        bonuses.featureChoiceTotals.total += item.bonus_feature_choices;
                        bonuses.featureChoiceTotals.sources[source.label] = (bonuses.featureChoiceTotals.sources[source.label] || 0) + item.bonus_feature_choices;
                    }
                    if (item.bonus_disciplines) bonuses.totalDisciplines += item.bonus_disciplines;
                    if (item.bonus_special_abilities) bonuses.totalSpecialAbilities += item.bonus_special_abilities;
                }
            });

            bonuses.skillOptions = [...new Set(bonuses.skillOptions)];
            bonuses.featureOptions = [...new Set(bonuses.featureOptions)];

            return bonuses;
        }

        function calculateCharacterPoints() {
            if (!appState.allFeatures) return;

            let spentCP = 0;
            let economyDetails = {
                'Attributes': [],
                'Sub-Attributes': [],
                'Skills': [],
                'Features': [],
                'Disadvantages': [],
                'Special Abilities': [],
                'Awakened': []
            };

            const data = getPersonaFolioFormData();
            const bonuses = getAggregatedBonuses();

            // Primary Attributes (5 CP per point)
            const primaryAttrIds = ['attr-strength', 'attr-agility', 'attr-stamina', 'attr-intellect', 'attr-wisdom', 'attr-charisma'];
            primaryAttrIds.forEach(attrId => {
                const input = document.getElementById(attrId);
                if (input) {
                    const value = parseInt(input.value) || 0;
                    if (value > 0) {
                        const cost = value * 5;
                        spentCP += cost;
                        const label = document.querySelector(`label[for="${attrId}"]`).textContent;
                        economyDetails['Attributes'].push({ name: label, cost: cost, value: value });
                    }
                }
            });

            // Sub-Attributes (2 CP per point of change from base)
            const subAttrIds = ['attr-might', 'attr-reflex', 'attr-fortitude', 'attr-logic', 'attr-will', 'attr-etiquette'];
            subAttrIds.forEach(attrId => {
                const subAttrInput = document.getElementById(attrId);
                if (subAttrInput) {
                    const subAttrValue = parseInt(subAttrInput.value) || 0;
                    const primaryAttrId = Object.keys(primaryToSubAttributeMap).find(key => primaryToSubAttributeMap[key] === attrId);
                    const primaryAttrInput = document.getElementById(primaryAttrId);
                    const primaryAttrValue = primaryAttrInput ? (parseInt(primaryAttrInput.value) || 0) : 0;
                    const calculatedBase = (primaryAttrValue * 2) + 2;
                    if (subAttrValue > calculatedBase) {
                        const pointsOfChange = subAttrValue - calculatedBase;
                        const cost = pointsOfChange * 2;
                        spentCP += cost;
                        const label = document.querySelector(`label[for="${attrId}"]`).textContent;
                        economyDetails['Sub-Attributes'].push({ name: label, cost: cost, value: subAttrValue });
                    }
                }
            });

            // Features, Disadvantages, Special Abilities (Cost specified in data or defaults)
            const itemLists = {
                features: 'Features',
                disadvantages: 'Disadvantages',
                special_abilities: 'Special Abilities',
                awakened: 'Awakened'
            };

            for (const [listKey, categoryName] of Object.entries(itemLists)) {
                const selectedItems = data[listKey] || [];
                let bonusChoicesMade = 0;
                selectedItems.forEach(itemName => {
                    if (listKey === 'features') {
                        if (bonuses.bonusFeatures.includes(itemName)) {
                            economyDetails[categoryName].push({ name: `${itemName} (Bonus)`, cost: 0, value: 1 });
                            return;
                        }
                        if (bonuses.featureOptions.includes(itemName) && bonusChoicesMade < bonuses.featureChoiceTotals.total) {
                            economyDetails[categoryName].push({ name: `${itemName} (Bonus Choice)`, cost: 0, value: 1 });
                            bonusChoicesMade++;
                            return;
                        }
                    }

                    const itemData = appState.allFeatures.find(f => f.name === itemName) || { cp: 3 };
                    let cost = itemData.cp !== undefined ? itemData.cp : 3;
                    let nameSuffix = '';

                    if (listKey === 'features' && bonuses.recommendedFeatures.includes(itemName)) {
                        cost = Math.max(1, cost - 1); // Recommended features get a 1 CP discount, minimum 1.
                        nameSuffix = ' (Recommended)';
                    }

                    spentCP += cost;
                    economyDetails[categoryName].push({ name: itemName + nameSuffix, cost: cost, value: 1 });
                });
            }

            // --- Skills Costing ---
            let skillChoicesMade = 0;
            let spentSkillPoints = { physical: 0, mental: 0, social: 0, combat: 0, meta: 0, general: 0 };

            document.querySelectorAll('.skill-row:not(.header):not(.specialization)').forEach(row => {
                const label = row.querySelector('label');
                const skillName = label ? label.textContent : '';
                const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                const skillGroup = row.dataset.skillGroup;

                if (rank > 0) {
                    // 1. Apply free ranks from specific bonuses (e.g., Species)
                    const bonus = bonuses.bonusSkillRanks.find(b => b.skill === skillName);
                    let ranksToPay = rank;

                    if (bonus && bonus.ranks > 0) {
                        const freeRanks = Math.min(ranksToPay, bonus.ranks);
                        ranksToPay -= freeRanks;
                        economyDetails['Skills'].push({ name: `${skillName} (Bonus Ranks)`, cost: 0, source: bonus.source, value: freeRanks });
                    }

                    // 2. Apply free ranks from Skill Choices (e.g., Occupation)
                    if (ranksToPay > 0 && bonuses.skillOptions.includes(skillName) && skillChoicesMade < bonuses.skillChoiceTotals.total) {
                        skillChoicesMade++;
                        const freeRanks = ranksToPay;
                        ranksToPay = 0; // The entire rank is free
                        economyDetails['Skills'].push({ name: `${skillName} (Bonus Choice)`, cost: 0, value: freeRanks });
                    }

                    // 3. Spend from categorized skill point pool
                    if (ranksToPay > 0 && skillGroup && bonuses.skillPointPools[skillGroup] && (bonuses.skillPointPools[skillGroup].total - spentSkillPoints[skillGroup]) > 0) {
                        const availablePoints = bonuses.skillPointPools[skillGroup].total - spentSkillPoints[skillGroup];
                        const pointsToSpend = Math.min(ranksToPay, availablePoints);
                        spentSkillPoints[skillGroup] += pointsToSpend;
                        ranksToPay -= pointsToSpend;
                        economyDetails['Skills'].push({ name: `${skillName} (SP)`, cost: 0, source: `${skillGroup.charAt(0).toUpperCase() + skillGroup.slice(1)} Pool`, value: pointsToSpend });
                    }

                    // 4. Spend from general skill point pool
                    if (ranksToPay > 0 && (bonuses.skillPointPools.general.total - spentSkillPoints.general) > 0) {
                        const availablePoints = bonuses.skillPointPools.general.total - spentSkillPoints.general;
                        const pointsToSpend = Math.min(ranksToPay, availablePoints);
                        spentSkillPoints.general += pointsToSpend;
                        ranksToPay -= pointsToSpend;
                        economyDetails['Skills'].push({ name: `${skillName} (SP)`, cost: 0, source: 'General Pool', value: pointsToSpend });
                    }

                    // 5. Pay with CP
                    if (ranksToPay > 0) {
                        spentCP += ranksToPay;
                        economyDetails['Skills'].push({ name: `${skillName} (CP)`, cost: ranksToPay, value: ranksToPay });
                    }
                }
            });

            document.querySelectorAll('.skill-row.specialization').forEach(row => {
                const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                if (rank > 0) {
                    const name = row.querySelector('.skill-name-input')?.value;
                    let ranksToPay = rank;

                    // Specializations can only be paid for with General SP or CP
                    if (ranksToPay > 0 && (bonuses.skillPointPools.general.total - spentSkillPoints.general) > 0) {
                        const availablePoints = bonuses.skillPointPools.general.total - spentSkillPoints.general;
                        const pointsToSpend = Math.min(ranksToPay, availablePoints);
                        spentSkillPoints.general += pointsToSpend;
                        ranksToPay -= pointsToSpend;
                        economyDetails['Skills'].push({ name: `${name} (Spec. SP)`, cost: 0, source: 'General Pool', value: pointsToSpend });
                    }

                    if (ranksToPay > 0) {
                        spentCP += ranksToPay;
                        economyDetails['Skills'].push({ name: `${name} (Spec. CP)`, cost: ranksToPay, value: ranksToPay });
                    }
                }
            });

            // Store spent skill points for the modal
            economyDetails.spentSkillPoints = spentSkillPoints;

            // Update UI
            const totalCpInput = document.getElementById('starting-cp') || {value: 150};
            const spentCpHeader = document.getElementById('header-spent-cp');
            const economySpentCp = document.getElementById('economy-spent-cp');
            const economyRemainingCp = document.getElementById('economy-remaining-cp');

            const totalCP = parseInt(totalCpInput.value) || 150;
            
            if(spentCpHeader) spentCpHeader.textContent = spentCP;
            if(economySpentCp) economySpentCp.value = spentCP;
            if(economyRemainingCp) economyRemainingCp.value = totalCP - spentCP;
            
            return economyDetails;
        }
        
        function showEconomyModal() {
            const modal = document.getElementById('economy-modal');
            const detailsContainer = document.getElementById('economy-details');
            const skillPoolsContainer = document.getElementById('skill-point-pools-display');
            
            const economyDetails = calculateCharacterPoints();
            const bonuses = getAggregatedBonuses();
            const data = getPersonaFolioFormData();

            // --- Populate Skill Point Pools ---
            skillPoolsContainer.innerHTML = '';
            for(const poolName in bonuses.skillPointPools) {
                const awarded = bonuses.skillPointPools[poolName].total;
                const spent = economyDetails.spentSkillPoints[poolName] || 0;
                const remaining = awarded - spent;
                const name = poolName.charAt(0).toUpperCase() + poolName.slice(1);

                skillPoolsContainer.innerHTML += `
                    <span style="text-align: left; padding-left: .5rem;">${name}</span>
                    <span>${awarded}</span>
                    <span>${spent}</span>
                    <span>${remaining}</span>
                `;
            }


            let countersHtml = '<div class="economy-counters" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--panel-border);">';
            countersHtml += '<h3>Bonus Point Allocation</h3>';
            
            // --- Skill Choices Counter ---
            if (bonuses.skillChoiceTotals.total > 0) {
                let skillChoicesMade = 0;
                document.querySelectorAll('.skill-row:not(.header):not(.specialization)').forEach(row => {
                    if (skillChoicesMade >= bonuses.skillChoiceTotals.total) return;
                    const label = row.querySelector('label');
                    const skillName = label ? label.textContent : '';
                    const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                    if (rank > 0 && bonuses.skillOptions.includes(skillName)) {
                        skillChoicesMade++;
                    }
                });
                const remainingSkillChoices = bonuses.skillChoiceTotals.total - skillChoicesMade;
                countersHtml += `<h4>Skill Choices [${remainingSkillChoices}]</h4><ul>`;
                for(const source in bonuses.skillChoiceTotals.sources) {
                    countersHtml += `<li class="flex justify-between"><span>From ${source}</span><span>${bonuses.skillChoiceTotals.sources[source]}</span></li>`;
                }
                countersHtml += `</ul>`;
            }

            // --- Feature Choices Counter ---
            if (bonuses.featureChoiceTotals.total > 0) {
                let featureChoicesMade = 0;
                const selectedFeatures = data.features || [];
                selectedFeatures.forEach(featureName => {
                    if (featureChoicesMade >= bonuses.featureChoiceTotals.total) return;
                    if(bonuses.featureOptions.includes(featureName)) {
                        featureChoicesMade++;
                    }
                });
                const remainingFeatureChoices = bonuses.featureChoiceTotals.total - featureChoicesMade;
                countersHtml += `<h4>Feature Choices [${remainingFeatureChoices}]</h4><ul>`;
                 for(const source in bonuses.featureChoiceTotals.sources) {
                    countersHtml += `<li class="flex justify-between"><span>From ${source}</span><span>${bonuses.featureChoiceTotals.sources[source]}</span></li>`;
                }
                countersHtml += `</ul>`;
            }

            // --- Disciplines Counter ---
            const awakenedCount = data.awakened ? data.awakened.length : 0;
            const remainingDisciplines = bonuses.totalDisciplines - awakenedCount;
            if (bonuses.totalDisciplines > 0) {
                countersHtml += `<h4>Disciplines [${remainingDisciplines}]</h4><ul>`;
                countersHtml += `<li class="flex justify-between"><span>Total</span><span>${bonuses.totalDisciplines}</span></li>`;
                countersHtml += `</ul>`;
            }


            // --- Special Abilities Counter ---
            const specialAbilitiesCount = data.special_abilities ? data.special_abilities.length : 0;
            const remainingSpecialAbilities = bonuses.totalSpecialAbilities - specialAbilitiesCount;
            if (bonuses.totalSpecialAbilities > 0) {
                countersHtml += `<h4>Special Abilities [${remainingSpecialAbilities}]</h4><ul>`;
                countersHtml += `<li class="flex justify-between"><span>Total</span><span>${bonuses.totalSpecialAbilities}</span></li>`;
                countersHtml += `</ul>`;
            }

            countersHtml += '</div>';

            let detailsHtml = '<h3>CP & SP Expenditures</h3>';
            const categoriesToDisplay = ['Attributes', 'Sub-Attributes', 'Skills', 'Features', 'Disadvantages', 'Special Abilities', 'Awakened'];
            categoriesToDisplay.forEach(category => {
                const items = economyDetails[category];
                if (items && items.length > 0) {
                    detailsHtml += `<h4>${category}</h4><ul>`;
                    items.forEach(item => {
                        const cost = item.cost > 0 ? `${item.cost} CP` : (item.cost === 0 ? `0 CP` : 'N/A');
                        const valueDisplay = item.value ? ` (Rank ${item.value})` : '';
                        detailsHtml += `<li class="flex justify-between"><span>${item.name}${valueDisplay}</span><span>${cost}</span></li>`;
                    });
                    detailsHtml += `</ul>`;
                }
            });

            detailsContainer.innerHTML = countersHtml + detailsHtml;
            modal.classList.remove('hidden');
        }

        async function initializePersonaFolio(folioData = {}) {
            const sheet = document.getElementById('persona-folio-form');
            if(!sheet) return;
            
            const skillData = {
                "Physical": { "skills": ["Acrobatics", "Athletics", "Piloting", "Stealth"] },
                "Mental": {
                    "skills": ["Alertness", "Academics"],
                    "subcategories": {
                        "Knowledge": ["Appraisal", "Computers", "Culture", "History", "Investigation", "Language", "Medicine", "Nature", "Navigation", "Nobility", "Physics", "Religion", "Science", "Survival", "Tactics", "Technology"],
                        "Vocation": ["Administrator", "Alchemist", "Ambassador", "Architect", "Archivist", "Armorer", "Artist", "Artificer", "Broker", "Celebrity", "Constable", "Courtesan", "Culinarian", "Demolitionist", "Electrician", "Engineer", "Groundskeeper", "Handler", "Laborer", "Mechanic", "Researcher", "Salvager", "Soldier", "Tailor", "Transporter", "Weaponsmith"]
                    }
                },
                "Social": {
                    "subcategories": {
                        "Manipulation": ["Insight", "Bluff", "Diplomacy", "Intimidate", "Streetwise"],
                        "Expression": ["Acting", "Comedy", "Dancing", "Disguise", "Keyboard", "Legerdemain", "Oratory", "Percussion", "Singing", "String", "Style", "Wind"]
                    }
                },
                "Combat": {
                    "subcategories": {
                        "Archaic": ["Defense", "Melee", "Ranged", "Unarmed"],
                        "Modern": ["Ballistic", "Heavy Weapons"],
                        "Advanced": ["Energy", "Heavy Energy"]
                    }
                }
            };
            const skillsCol1 = document.getElementById('skills-col-1');
            const skillsCol2 = document.getElementById('skills-col-2');
            
            const headerHtml = `
                <div class="skill-row header" style="font-weight: bold; border-bottom: 1px solid var(--panel-border); margin-bottom: 0.5rem; padding-bottom: 0.5rem;">
                    <span>SKILL</span>
                    <span style="text-align: center;">RANK</span>
                    <span style="text-align: center;">ATT</span>
                    <span style="text-align: center;">MOD</span>
                    <span style="text-align: center;">TTL</span>
                </div>
            `;

            if(skillsCol1) skillsCol1.innerHTML = headerHtml;
            if(skillsCol2) skillsCol2.innerHTML = headerHtml;

            ['Physical', 'Mental'].forEach(groupName => {
                const groupData = skillData[groupName];
                if (groupData) {
                    populateSkillGroup(skillsCol1, groupName, groupData);
                }
            });

            ['Social', 'Combat'].forEach(groupName => {
                const groupData = skillData[groupName];
                if (groupData) {
                    populateSkillGroup(skillsCol2, groupName, groupData);
                }
            });

            const metaData = { "Dimension": ["Summoning", "Teleport"], "Energy": ["Elemental", "Force"], "Entropy": ["Chaos", "Order"], "Illusion": ["Phantasmal", "Shadow"], "Matter": ["Enhancement", "Transmutation"], "Mental": ["Projection", "Sense"] };
            populateMeta(metaData);
            
            if (folioData && Object.keys(folioData).length > 0) {
                populatePersonaFolioForm(folioData);
            } else {
                renderAttackRows([]);
                renderArmorRows([]);
                renderNoteRows([]);
            }

            appState.initialFormState = JSON.stringify(getPersonaFolioFormData());

            Object.keys(primaryToSubAttributeMap).forEach(primaryId => {
                calculateAttributeTotal(primaryId);
            });
            
            if (folioData) {
                Object.keys(primaryToSubAttributeMap).forEach(primaryId => {
                    calculateAttributeTotal(primaryId);
                });
            }
            recalculateAllModifiers();
            updateAbilityCounters();
        }

        function populateSkillGroup(container, groupName, groupData) {
            if (!container || !groupData) return;

            const groupDiv = document.createElement('div');
            groupDiv.className = 'skill-group';

            const header = document.createElement('h4');
            header.className = 'skill-group-header';
            header.textContent = groupName.trim();
            groupDiv.appendChild(header);

            if (groupData.skills) {
                const skillRowsContainer = document.createElement('div');
                skillRowsContainer.className = 'skill-rows-container';
                skillRowsContainer.dataset.group = groupName.toLowerCase();
                groupData.skills.forEach(skillName => {
                    const skillId = `${groupName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                    const skillRow = createSkillRow(skillName, skillId, groupName.toLowerCase());
                    skillRowsContainer.appendChild(skillRow);
                    if (skillName === 'Alertness') {
                        const baseSelect = skillRow.querySelector('.skill-base-select');
                        if (baseSelect) {
                            baseSelect.outerHTML = `<input type="number" id="skill-${skillId}-base" name="skill-${skillId}-base" class="skill-base-input" readonly placeholder="0">`;
                        }
                    }
                });
                groupDiv.appendChild(skillRowsContainer);
            }

            if (groupData.subcategories) {
                for (const subcatName in groupData.subcategories) {
                    const subcatHeader = document.createElement('h5');
                    subcatHeader.className = 'skill-subcategory-header';
                    subcatHeader.textContent = subcatName;
                    groupDiv.appendChild(subcatHeader);

                    const subcatRowsContainer = document.createElement('div');
                    subcatRowsContainer.className = 'skill-rows-container';
                    subcatRowsContainer.dataset.group = `${groupName.toLowerCase()}-${subcatName.toLowerCase()}`;

                    groupData.subcategories[subcatName].forEach(skillName => {
                        const skillId = `${groupName}-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                        subcatRowsContainer.appendChild(createSkillRow(skillName, skillId, groupName.toLowerCase()));
                    });
                    groupDiv.appendChild(subcatRowsContainer);
                }
            }
            container.appendChild(groupDiv);
        }

        function populateMeta(metaData) {
            const container = document.getElementById('meta-skills-list');
            if (!container) return;
            container.innerHTML = '';

            const headerRow = document.createElement('div');
            headerRow.className = 'skill-row header';
            headerRow.innerHTML = `<span>Skill</span><span>Rank</span><span>Base</span><span>Mod</span><span>Total</span>`;
            container.appendChild(headerRow);

            const attuneContainer = document.createElement('div');
            attuneContainer.className = 'skill-rows-container';
            attuneContainer.dataset.group = 'meta';
            const attuneRow = createSkillRow("Attune", "meta-attune", 'meta');
            attuneContainer.appendChild(attuneRow);
            container.appendChild(attuneContainer);

            const metaOrder = ["Dimension", "Energy", "Entropy", "Illusion", "Matter", "Mental"];

            metaOrder.forEach(subcatName => {
                const skills = metaData[subcatName];
                if (skills && skills.length > 0) {
                    const subcatHeader = document.createElement('h5');
                    subcatHeader.className = 'skill-subcategory-header';
                    subcatHeader.textContent = subcatName;
                    container.appendChild(subcatHeader);

                    const subcatRowsContainer = document.createElement('div');
                    subcatRowsContainer.className = 'skill-rows-container';
                    subcatRowsContainer.dataset.group = `meta-${subcatName.toLowerCase()}`;

                    skills.forEach(skillName => {
                        const skillId = `meta-${subcatName}-${skillName}`.toLowerCase().replace(/\s+/g, '-');
                        subcatRowsContainer.appendChild(createSkillRow(skillName, skillId, 'meta'));
                    });
                    container.appendChild(subcatRowsContainer);
                }
            });
        }

        function createSkillRow(skillName, skillId, skillGroup) {
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.dataset.skillId = skillId;
            if (skillGroup) {
                row.dataset.skillGroup = skillGroup;
            }
            const attributeOptions = [{ value: 'attr-strength', text: 'STR' }, { value: 'attr-agility', text: 'AGI' }, { value: 'attr-stamina', text: 'STA' }, { value: 'attr-intellect', text: 'INT' }, { value: 'attr-wisdom', text: 'WIS' }, { value: 'attr-charisma', text: 'CHA' }];
            let optionsHtml = '<option value="">--</option>' + attributeOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');

            row.innerHTML = `
                <label for="skill-${skillId}-rank">${skillName}</label>
                <input type="number" id="skill-${skillId}-rank" name="skill-${skillId}-rank" class="global-form-input skill-rank" placeholder="0">
                <select id="skill-${skillId}-base" name="skill-${skillId}-base" class="global-form-select skill-base-select">${optionsHtml}</select>
                <input type="number" id="skill-${skillId}-mod" name="skill-${skillId}-mod" class="global-form-input skill-mod" placeholder="0" readonly>
                <input type="number" id="skill-${skillId}-total" name="skill-${skillId}-total" class="global-form-input skill-total" style="font-weight: bold;" readonly value="0">`;
            return row;
        };
        
        function createSpecializationRow(specName, specId, parentSkillId) {
            const row = document.createElement('div');
            row.className = 'skill-row specialization';
            row.dataset.specId = specId;
            row.dataset.parentSkill = parentSkillId;
            row.innerHTML = `
                <input type="text" class="skill-name-input" name="${specId}-name" value="${specName}" readonly>
                <input type="number" class="skill-rank" name="${specId}-rank" placeholder="0">
                <input type="number" class="spec-base-input" name="${specId}-base" readonly placeholder="0">
                <input type="number" class="skill-mod" name="${specId}-mod" placeholder="0" readonly>
                <input type="number" class="spec-total" name="${specId}-total" readonly value="0">
            `;
            return row;
        }

        async function showAddSkillModal() {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = 'ADD SKILL';
            modalChoices.innerHTML = ''; 
            cancelBtn.classList.remove('hidden');

            const allSkills = await getCollectionOptions('skills');
            const existingSkillElements = document.querySelectorAll('.skill-row:not(.header) label, .skill-row.specialization .skill-name-input');
            const existingSkillNames = Array.from(existingSkillElements).map(el => el.textContent || el.value);

            allSkills.sort((a, b) => a.name.localeCompare(b.name)).forEach(skill => {
                const isAdded = existingSkillNames.includes(skill.name);
                const skillRow = document.createElement('div');
                skillRow.className = 'add-skill-modal-row';
                
                skillRow.innerHTML = `
                    <span class="${isAdded ? 'text-disabled' : ''}">${skill.name}</span>
                    <input type="number" placeholder="Rank" class="global-form-input" ${isAdded ? 'disabled' : ''}>
                    <button class="action-btn" ${isAdded ? 'disabled' : ''}>Add</button>
                `;

                if (!isAdded) {
                    skillRow.querySelector('button').onclick = async () => {
                        const rank = parseInt(skillRow.querySelector('input').value);
                        if (rank > 0) {
                            await addSkillToSheet(skill, rank);
                            modal.classList.add('hidden');
                        }
                    };
                }
                modalChoices.appendChild(skillRow);
            });

            cancelBtn.onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        async function addSkillToSheet(skillData, rank) {
            if (skillData.is_specialization) {
                const baseSkillName = skillData.base_skill;
                const allSkillRows = document.querySelectorAll('.skill-row:not(.specialization)');
                let parentRow = null;
                allSkillRows.forEach(row => {
                    const label = row.querySelector('label');
                    if (label && label.textContent === baseSkillName) {
                        parentRow = row;
                    }
                });

                if (parentRow) {
                    const parentSkillId = parentRow.dataset.skillId;
                    const specId = `spec-${parentSkillId}-${Date.now()}`;
                    const specRow = createSpecializationRow(skillData.name, specId, parentSkillId);
                    
                    let lastElement = parentRow;
                    let nextSibling = parentRow.nextElementSibling;
                    while(nextSibling && nextSibling.classList.contains('specialization') && nextSibling.dataset.parentSkill === parentSkillId) {
                        lastElement = nextSibling;
                        nextSibling = nextSibling.nextElementSibling;
                    }
                    lastElement.insertAdjacentElement('afterend', specRow);

                    const rankInput = specRow.querySelector('.skill-rank');
                    if(rankInput) rankInput.value = rank;

                    calculateSpecializationTotal(specRow);
                } else {
                    showCustomAlert(`Base skill "${baseSkillName}" not found on sheet. Please add it first.`);
                }
            } else {
                const skillId = `${skillData.type}-${skillData.name}`.toLowerCase().replace(/\s+/g, '-');
                if (document.querySelector(`[data-skill-id="${skillId}"]`)) {
                    showCustomAlert(`Skill "${skillData.name}" is already on the sheet.`);
                    return;
                }
                
                const subtype = skillData.subtype ? `-${skillData.subtype.toLowerCase()}` : '';
                const containerSelector = `[data-group="${skillData.type}${subtype}"]`;
                let container = document.querySelector(containerSelector);

                if (!container) {
                    container = document.querySelector(`[data-group="${skillData.type}"]`);
                }
                
                if (container) {
                    const newRow = createSkillRow(skillData.name, skillId);
                    container.appendChild(newRow);

                    const rankInput = newRow.querySelector('.skill-rank');
                    if(rankInput) rankInput.value = rank;

                    calculateSkillTotal(newRow);
                } else {
                    console.error(`Could not find container for skill:`, skillData);
                }
            }
        }

        async function showAttackSelectionModal() {
            const equipmentDataInput = document.getElementById('equipment-data');
            const invocationsDataInput = document.getElementById('invocations-data');

            let currentEquipment = [];
            let currentInvocations = [];

            try {
                if (equipmentDataInput && equipmentDataInput.value) currentEquipment = JSON.parse(equipmentDataInput.value);
                if (invocationsDataInput && invocationsDataInput.value) currentInvocations = JSON.parse(invocationsDataInput.value);
            } catch(e) {}
            
            const allEquipment = await getCollectionOptions('weaponry');
            const allInvocations = await getCollectionOptions('invocations');

            const availableAttacks = [];
            currentEquipment.forEach(name => {
                const item = allEquipment.find(eq => eq.name === name && eq.effect);
                if (item) availableAttacks.push({ ...item, source: 'Equipment' });
            });
            currentInvocations.forEach(name => {
                const item = allInvocations.find(inv => inv.name === name && inv.effect);
                if (item) availableAttacks.push({ ...item, source: 'Invocations' });
            });

            if (availableAttacks.length === 0) {
                showCustomAlert("No available attacks from equipment or invocations.");
                return;
            }

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = "SELECT ATTACK";
            modalChoices.innerHTML = ''; 
            cancelBtn.style.display = 'block';

            availableAttacks.forEach(attack => {
                const btn = document.createElement('button');
                btn.textContent = `${attack.name.toUpperCase()} (${attack.source})`;
                btn.className = 'action-btn';
                btn.onclick = () => {
                    addAttackToList(attack);
                    modal.classList.add('hidden');
                };
                modalChoices.appendChild(btn);
            });
            
            modal.classList.remove('hidden');
            cancelBtn.onclick = () => modal.classList.add('hidden');
        }

        function addAttackToList(attackData) {
            const attacksDataInput = document.getElementById('attacks-data');
            let currentAttacks = [];
            try {
                if (attacksDataInput.value) currentAttacks = JSON.parse(attacksDataInput.value);
            } catch(e) {}

            const newAttack = {
                name: attackData.name,
                score: attackData.skill || '',
                damage: attackData.effect || '',
                notes: ''
            };

            currentAttacks.push(newAttack);
            attacksDataInput.value = JSON.stringify(currentAttacks);
            renderAttackRows(currentAttacks);
        }

        function renderAttackRows(attacks = []) {
            const container = document.getElementById('attack-rows');
            if (!container) return;
            
            while(container.children.length > 1) container.removeChild(container.lastChild);

            attacks.forEach((attack, index) => {
                const row = document.createElement('div');
                row.className = 'attack-grid';
                row.innerHTML = `
                    <input type="text" class="global-form-input" value="${attack.name}" readonly>
                    <input type="text" class="global-form-input" value="${attack.score}" readonly>
                    <input type="text" class="global-form-input" value="${attack.damage}" readonly>
                    <input type="text" class="global-form-input" placeholder="Notes...">
                    <button type="button" class="action-btn remove-btn-icon">&times;</button>
                `;
                row.querySelector('button').addEventListener('click', () => {
                    attacks.splice(index, 1);
                    document.getElementById('attacks-data').value = JSON.stringify(attacks);
                    renderAttackRows(attacks);
                });
                container.appendChild(row);
            });
        }

        async function showArmorSelectionModal() {
            const speciesInput = document.getElementById('char-species');
            const equipmentDataInput = document.getElementById('equipment-data');
            const augmentationsDataInput = document.getElementById('augmentations-data');

            let currentEquipment = [];
            let currentAugmentations = [];

            try {
                if (equipmentDataInput && equipmentDataInput.value) currentEquipment = JSON.parse(equipmentDataInput.value);
                if (augmentationsDataInput && augmentationsDataInput.value) currentAugmentations = JSON.parse(augmentationsDataInput.value);
            } catch(e) {}

            const allSpecies = await getCollectionOptions('species');
            const allEquipment = await getCollectionOptions('armoring');
            const allAugmentations = await getCollectionOptions('augmentations');

            const availableArmor = [];

            if (speciesInput && speciesInput.value) {
                const species = allSpecies.find(s => s.name === speciesInput.value && s.resistance);
                if (species) availableArmor.push({ ...species, source: 'Species' });
            }
            currentEquipment.forEach(name => {
                const item = allEquipment.find(eq => eq.name === name && eq.resistance);
                if (item) availableArmor.push({ ...item, source: 'Equipment' });
            });
            currentAugmentations.forEach(name => {
                const item = allAugmentations.find(aug => aug.name === name && aug.resistance);
                if (item) availableArmor.push({ ...item, source: 'Augmentations' });
            });

            if (availableArmor.length === 0) {
                showCustomAlert("No available armor from species, equipment, or augmentations.");
                return;
            }

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = "SELECT ARMOR";
            modalChoices.innerHTML = '';
            cancelBtn.style.display = 'block';

            availableArmor.forEach(armor => {
                const btn = document.createElement('button');
                btn.textContent = `${armor.name.toUpperCase()} (${armor.source})`;
                btn.className = 'action-btn';
                btn.onclick = () => {
                    addArmorToList(armor);
                    modal.classList.add('hidden');
                };
                modalChoices.appendChild(btn);
            });

            modal.classList.remove('hidden');
            cancelBtn.onclick = () => modal.classList.add('hidden');
        }

        function addArmorToList(armorData) {
            const armorDataInput = document.getElementById('armor-data');
            let currentArmor = [];
            try {
                if (armorDataInput.value) currentArmor = JSON.parse(armorDataInput.value);
            } catch(e) {}

            const newArmor = {
                name: armorData.name,
                resistance: armorData.resistance || '',
                notes: armorData.source || ''
            };

            currentArmor.push(newArmor);
            armorDataInput.value = JSON.stringify(currentArmor);
            renderArmorRows(currentArmor);
        }

        function renderArmorRows(armorList = []) {
            const container = document.getElementById('armor-rows');
            if (!container) return;

            while(container.children.length > 1) container.removeChild(container.lastChild);

            armorList.forEach((armor, index) => {
                const row = document.createElement('div');
                row.className = 'armor-grid';
                row.innerHTML = `
                    <input type="text" class="global-form-input" value="${armor.name}" readonly>
                    <input type="text" class="global-form-input" value="${armor.resistance}" readonly>
                    <input type="text" class="global-form-input" value="${armor.notes}" readonly>
                    <button type="button" class="action-btn remove-btn-icon">&times;</button>
                `;
                row.querySelector('button').addEventListener('click', () => {
                    armorList.splice(index, 1);
                    document.getElementById('armor-data').value = JSON.stringify(armorList);
                    renderArmorRows(armorList);
                });
                container.appendChild(row);
            });
        }

        function addNoteToList() {
            const notesDataInput = document.getElementById('notes-data');
            let currentNotes = [];
            try {
                if(notesDataInput.value) currentNotes = JSON.parse(notesDataInput.value);
            } catch(e) {}

            currentNotes.push({ text: '' });
            notesDataInput.value = JSON.stringify(currentNotes);
            renderNoteRows(currentNotes);
        }

        function renderNoteRows(notes = []) {
            const container = document.getElementById('notes-list');
            if (!container) return;
            container.innerHTML = '';

            if (notes.length === 0) {
                addNoteToList();
                return;
            }

            notes.forEach((note, index) => {
                const row = document.createElement('div');
                row.className = 'note-row';

                row.innerHTML = `
                    <input type="text" class="global-form-input note-input" value="${note.text}">
                    <button type="button" class="action-btn remove-btn-icon">&times;</button>
                `;

                row.querySelector('input').oninput = () => {
                    notes[index].text = row.querySelector('input').value;
                    document.getElementById('notes-data').value = JSON.stringify(notes);
                };

                row.querySelector('button').onclick = () => {
                    notes.splice(index, 1);
                    document.getElementById('notes-data').value = JSON.stringify(notes);
                    renderNoteRows(notes);
                };
                container.appendChild(row);
            });
        }


        async function updateTraitsDisplay(collectionName, selectElement, textareaId) {
            const selectedName = selectElement.value;
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            textarea.value = '';
            if (!selectedName) return;

            try {
                const options = await getCollectionOptions(collectionName);
                const selectedOption = options.find(opt => opt.name === selectedName);
                if (!selectedOption || !selectedOption.trait) return;

                textarea.value = selectedOption.trait.join('\n');

            } catch (error) {
                console.error(`Error updating traits for ${collectionName}:`, error);
            }
        };

        function updateAllTraits() {
            updateTraitsDisplay('species', document.getElementById('char-species'), 'species-traits-display');
            updateTraitsDisplay('occupations', document.getElementById('char-occu'), 'occupation-traits-display');
            updateTraitsDisplay('origins', document.getElementById('char-origin'), 'origin-traits-display');
            updateTraitsDisplay('factions', document.getElementById('char-faction'), 'faction-traits-display');
        }

        function showConfirmModal(message, onConfirm) {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            confirmMessage.textContent = message;
            appState.confirmCallback = onConfirm;

            confirmOkBtn.onclick = () => {
                if (appState.confirmCallback) appState.confirmCallback();
                confirmModal.classList.add('hidden');
            };
            confirmCancelBtn.onclick = () => {
                confirmModal.classList.add('hidden');
            };

            confirmModal.classList.remove('hidden');
        }

        async function showDirectoryModal(targetListKey, startPathKey, triggerElement) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = `BROWSE: ${categoryConfig[startPathKey]?.label || startPathKey.toUpperCase()}`;
            modalChoices.innerHTML = '<p class="text-center">Loading...</p>';
            
            modalChoices.style.display = 'flex'; 
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            modal.classList.remove('hidden');

            let items = await getCollectionOptions(startPathKey);

            const filterCategory = triggerElement ? triggerElement.dataset.filterCategory : null;
            const filterCategoryExclude = triggerElement ? triggerElement.dataset.filterCategoryExclude : null;

            if (filterCategory) {
                items = items.filter(item => item.category === filterCategory);
            }
            if (filterCategoryExclude) {
                items = items.filter(item => item.category !== filterCategoryExclude);
            }
            
            modalChoices.innerHTML = '';

            const dataInput = document.getElementById(`${targetListKey}-data`);
            const isMultiSelect = !!dataInput;

            let currentSelections = [];
            if (isMultiSelect && dataInput.value) {
                 try {
                    currentSelections = JSON.parse(dataInput.value);
                 } catch(e) {
                    currentSelections = [];
                 }
            }

            const availableItems = items.filter(item => !currentSelections.includes(item.name));

            if (availableItems.length === 0) {
                modalChoices.innerHTML = '<p class="text-gray-400 text-center">No available items to add.</p>';
            } else {
                availableItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item.name.toUpperCase();
                    btn.className = 'gem-style-button';
                    btn.onclick = () => {
                        handleItemSelection(targetListKey, item.name, isMultiSelect);
                        modal.classList.add('hidden');
                    };
                    modalChoices.appendChild(btn);
                });
            }

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }
        
        async function handleItemSelection(targetId, value, isMultiSelect) {
            if (isMultiSelect) {
                const displayContainer = document.getElementById(`${targetId}-display`);
                const dataInput = document.getElementById(`${targetId}-data`);

                let currentValues = [];
                if (dataInput.value) {
                    try {
                        currentValues = JSON.parse(dataInput.value);
                    } catch (e) {
                        currentValues = [];
                    }
                }

                if (!currentValues.includes(value)) {
                    currentValues.push(value);
                    dataInput.value = JSON.stringify(currentValues);

                    if (targetId === 'awakened') {
                        const allDisciplines = await getCollectionOptions('discipline');
                        const disciplineData = allDisciplines.find(d => d.name === value);

                        if (disciplineData) {
                            const allSkills = await getCollectionOptions('skills');
                            const focusSkill = allSkills.find(s => s.name === 'Focus');
                            if (focusSkill) await addSkillToSheet(focusSkill, 1);

                            if (disciplineData.discipline_skills && disciplineData.discipline_skills.length > 0) {
                                for (const skillName of disciplineData.discipline_skills) {
                                    const skillData = allSkills.find(s => s.name === skillName);
                                    if (skillData) await addSkillToSheet(skillData, 1);
                                }
                            }
                        }
                    }

                    renderItemList(displayContainer, currentValues, targetId);
                }
            } else {
                const targetInput = document.getElementById(targetId);
                if (targetInput) {
                    targetInput.value = value;
                    targetInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        }

        async function renderItemList(container, items, targetId) {
            if (!container) return;
            container.innerHTML = '';
            items.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'item-list-row';
                itemEl.textContent = item;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'action-btn remove-btn-compact';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    items.splice(index, 1);
                    document.getElementById(`${targetId}-data`).value = JSON.stringify(items);
                    renderItemList(container, items, targetId);
                };
                itemEl.appendChild(removeBtn);
                container.appendChild(itemEl);
            });

            recalculateAllModifiers();
            updateAbilityCounters();
        }

        function updateAbilityCounters() {
            const data = getPersonaFolioFormData();
            const { totalDisciplines, totalSpecialAbilities } = getAggregatedBonuses();

            // Awakened (Disciplines)
            const awakenedCount = data.awakened ? data.awakened.length : 0;
            const awakenedCounter = document.getElementById('awakened-counter');
            const addAwakenedBtn = document.getElementById('add-awakened-btn');
            const addInvocationBtn = document.getElementById('add-invocation-btn');

            if (awakenedCounter) {
                awakenedCounter.textContent = `[${awakenedCount}/${totalDisciplines}]`;
            }
            if (addAwakenedBtn) {
                addAwakenedBtn.disabled = awakenedCount >= totalDisciplines;
            }
            if (addInvocationBtn) {
                addInvocationBtn.disabled = awakenedCount >= totalDisciplines;
            }

            // Special Abilities
            const specialAbilitiesCount = data.special_abilities ? data.special_abilities.length : 0;
            const specialAbilitiesCounter = document.getElementById('special-abilities-counter');
            const addSpecialAbilityBtn = document.getElementById('add-special-ability-btn');

            if (specialAbilitiesCounter) {
                specialAbilitiesCounter.textContent = `[${specialAbilitiesCount}/${totalSpecialAbilities}]`;
            }
            if (addSpecialAbilityBtn) {
                addSpecialAbilityBtn.disabled = specialAbilitiesCount >= totalSpecialAbilities;
            }
        }

        async function showAwakenedModal() {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = 'SELECT DISCIPLINE';
            modalChoices.innerHTML = '<p class="text-center">Loading...</p>';

            modalChoices.style.display = 'flex';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            modal.classList.remove('hidden');

            const allDisciplines = await getCollectionOptions('discipline');
            const awakenedDataInput = document.getElementById('awakened-data');
            let currentDisciplines = [];
            if (awakenedDataInput.value) {
                try {
                    currentDisciplines = JSON.parse(awakenedDataInput.value);
                } catch(e) {}
            }

            const availableDisciplines = allDisciplines.filter(d => !currentDisciplines.includes(d.name));

            modalChoices.innerHTML = '';

            if (availableDisciplines.length === 0) {
                modalChoices.innerHTML = '<p class="text-gray-400 text-center">No available disciplines to add.</p>';
            } else {
                availableDisciplines.forEach(discipline => {
                    const btn = document.createElement('button');
                    btn.textContent = discipline.name.toUpperCase();
                    btn.className = 'gem-style-button';
                    btn.onclick = () => {
                        handleDisciplineSelection(discipline.name);
                        modal.classList.add('hidden');
                    };
                    modalChoices.appendChild(btn);
                });
            }

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        async function handleDisciplineSelection(disciplineName) {
            handleItemSelection('awakened', disciplineName, true);
        }

        async function handleSpecialAbilitySelection(abilityName) {
            handleItemSelection('special_abilities', abilityName, true);
        }

        async function showSpecialAbilityModal() {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = 'SELECT SPECIAL ABILITY';
            modalChoices.innerHTML = '<p class="text-center">Loading...</p>';

            modalChoices.style.display = 'flex';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';

            modal.classList.remove('hidden');

            const allFeatures = await getCollectionOptions('features');
            const specialAbilities = allFeatures.filter(f => f.category === 'Special Ability');

            const specialAbilitiesDataInput = document.getElementById('special_abilities-data');
            let currentAbilities = [];
            if (specialAbilitiesDataInput.value) {
                try {
                    currentAbilities = JSON.parse(specialAbilitiesDataInput.value);
                } catch(e) {}
            }

            const availableAbilities = specialAbilities.filter(a => !currentAbilities.includes(a.name));

            modalChoices.innerHTML = '';

            if (availableAbilities.length === 0) {
                modalChoices.innerHTML = '<p class="text-gray-400 text-center">No available special abilities to add.</p>';
            } else {
                availableAbilities.forEach(ability => {
                    const btn = document.createElement('button');
                    btn.textContent = ability.name.toUpperCase();
                    btn.className = 'gem-style-button';
                    btn.onclick = () => {
                        handleSpecialAbilitySelection(ability.name);
                        modal.classList.add('hidden');
                    };
                    modalChoices.appendChild(btn);
                });
            }

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function showCustomAlert(text) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = text.toUpperCase();
            
            // Reset modal state for an alert
            modalChoices.innerHTML = '';
            modalChoices.style.display = 'none';
            okBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'none';
            
            okBtn.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        }

        async function saveToDb() {
            if (!appState.userId || appState.isAnonymous) {
                showCustomAlert("Please log in to save to the cloud.");
                return;
            }

            const charName = document.getElementById('char-name').value;
            if (!charName) {
                showCustomAlert("Please enter a character name before saving.");
                return;
            }

            const data = getPersonaFolioFormData();
            const docId = document.getElementById('character-doc-id').value || charName.replace(/\s+/g, '_');
            const personaRef = doc(db, `artifacts/${appId}/users/${appState.userId}/personas`, docId);

            try {
                await setDoc(personaRef, data, { merge: true });
                document.getElementById('character-doc-id').value = docId;
                showCustomAlert("Character Saved Successfully!");
            } catch (error) {
                console.error("Error saving character:", error);
                showCustomAlert("Could not save character. Check console for details.");
            }
        }

        async function showCharacterLoadModal() {
            if (!appState.userId || appState.isAnonymous) {
                showCustomAlert("Please log in to load from the cloud.");
                return;
            }

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalChoices = document.getElementById('modal-choices');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalTitle.textContent = 'LOAD CHARACTER';
            modalChoices.innerHTML = '<p class="text-center">Loading...</p>';
            
            // Reset modal state
            modalChoices.style.display = 'block';
            okBtn.style.display = 'none';
            cancelBtn.style.display = 'block';
            
            modal.classList.remove('hidden');
            
            const collectionRef = collection(db, `artifacts/${appId}/users/${appState.userId}/personas`);
            try {
                const querySnapshot = await getDocs(collectionRef);
                modalChoices.innerHTML = '';
                if (querySnapshot.empty) {
                    modalChoices.innerHTML = '<p class="text-gray-400 text-center">No characters found in the cloud.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const charData = doc.data();
                        const btn = document.createElement('button');
                        btn.textContent = charData['char-name'] || doc.id;
                        btn.className = 'btn btn-primary w-full text-left';
                        btn.onclick = () => {
                            clearSession();
                            loadCharacterById(doc.id);
                            modal.classList.add('hidden');
                        };
                        modalChoices.appendChild(btn);
                    });
                }
            } catch (error) {
                console.error("Error loading characters:", error);
                modalChoices.innerHTML = '<p class="text-red-500 text-center">Could not load characters.</p>';
            }

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        async function loadCharacterById(docId) {
             if (!appState.userId) return;
             const personaRef = doc(db, `artifacts/${appId}/users/${appState.userId}/personas`, docId);
             try {
                const docSnap = await getDoc(personaRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderPersonaFolioView(document.getElementById('folio-container'), data, false);
                    const docIdInput = document.getElementById('character-doc-id');
                    if(docIdInput) docIdInput.value = docId;

                } else {
                    showCustomAlert("Character not found.");
                }
             } catch(error) {
                console.error("Error loading character:", error);
                showCustomAlert("Failed to load character.");
             }
        }

        function newCharacter() {
            showConfirmModal("Start a new character? Any unsaved changes will be lost.", () => {
                clearSession();
                renderPersonaFolioView(document.getElementById('folio-container'), {}, false);
            });
        }

        function showPreviewModal() {
            const data = getPersonaFolioFormData();
            const previewContent = document.getElementById('preview-content');
            if (!previewContent) return;

            let html = `<h2>${data['char-name'] || 'Unnamed Character'}</h2>`;
            html += `<p><strong>Concept:</strong> ${data['char-concept'] || 'N/A'}</p>`;
            html += `<p><strong>Species:</strong> ${data['char-species'] || 'N/A'}</p>`;
            html += `<p><strong>Occupation:</strong> ${data['char-occu'] || 'N/A'}</p>`;
            html += `<p><strong>Origin:</strong> ${data['char-origin'] || 'N/A'}</p>`;
            html += `<p><strong>Faction:</strong> ${data['char-faction'] || 'N/A'}</p>`;

            html += '<h3>Attributes</h3><ul>';
            const attributes = ['strength', 'agility', 'stamina', 'intellect', 'wisdom', 'charisma'];
            attributes.forEach(attr => {
                const total = document.getElementById(`attr-${attr}-total`)?.value || 0;
                html += `<li><strong>${attr.charAt(0).toUpperCase() + attr.slice(1)}:</strong> ${total}</li>`;
            });
            html += '</ul>';

            html += '<h3>Skills</h3><ul>';
            document.querySelectorAll('.skill-row:not(.header)').forEach(row => {
                const rank = parseInt(row.querySelector('.skill-rank')?.value) || 0;
                if (rank > 0) {
                    const skillName = row.querySelector('label')?.textContent || row.querySelector('.skill-name-input')?.value;
                    const total = row.querySelector('.skill-total')?.value || row.querySelector('.spec-total')?.value || 0;
                    html += `<li><strong>${skillName}:</strong> ${total} (Rank ${rank})</li>`;
                }
            });
            html += '</ul>';
            
            const createList = (title, items) => {
                if (items && items.length > 0) {
                    let listHtml = `<h3>${title}</h3><ul>`;
                    items.forEach(item => listHtml += `<li>${item}</li>`);
                    listHtml += '</ul>';
                    return listHtml;
                }
                return '';
            };

            html += createList('Features', data.features);
            html += createList('Disadvantages', data.disadvantages);
            html += createList('Augmentations', data.augmentations);
            html += createList('Equipment', data.equipment);

            previewContent.innerHTML = html;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        function setupGlobalEventListeners() {
            // This function sets up all listeners ONCE using event delegation.
        
            window.addEventListener('click', (event) => {
                if (!event.target.matches('.file-menu-button')) {
                    const dropdowns = document.querySelectorAll('.file-menu-dropdown');
                    dropdowns.forEach(dropdown => {
                        if (dropdown.classList.contains('show')) {
                            dropdown.classList.remove('show');
                        }
                    });
                }

                // Click-out functionality for all modals
                if (event.target.classList.contains('modal-overlay')) {
                    event.target.classList.add('hidden');
                }
            });

            const container = document.getElementById('folio-container');
            if (!container) return;
        
            container.addEventListener('click', (event) => {
                const target = event.target;
        
                if (target.matches('.file-menu-button')) {
                    event.stopPropagation();
                    const dropdown = target.nextElementSibling;
                    if (dropdown) dropdown.classList.toggle('show');
                    return;
                }
        
                if (target.closest('.file-menu-dropdown')) {
                    const dropdown = document.querySelector('.file-menu-dropdown');
                    if (dropdown) dropdown.classList.remove('show');
                }
        
                if (target.id === 'new-char-btn') newCharacter();
                if (target.id === 'local-save-btn') saveLocal();
                if (target.id === 'local-load-btn') loadLocal();
                if (target.id === 'cloud-save-btn') saveToDb();
                if (target.id === 'cloud-load-btn') showCharacterLoadModal();
                if (target.id === 'preview-btn') showPreviewModal();
                if (target.id === 'economy-btn') showEconomyModal();
                if (target.id === 'add-attack-btn') showAttackSelectionModal();
                if (target.id === 'add-armor-btn') showArmorSelectionModal();
                if (target.id === 'add-note-btn') addNoteToList();
                if (target.id === 'add-skill-btn') showAddSkillModal();
                if (target.id === 'add-awakened-btn') showAwakenedModal();
                if (target.id === 'add-special-ability-btn') showSpecialAbilityModal();
                
                const browseButton = target.closest('[data-browse-path]');
                if (browseButton) {
                    const targetList = browseButton.dataset.targetList || browseButton.id;
                    const path = browseButton.dataset.browsePath;
                    showDirectoryModal(targetList, path, browseButton);
                }
        
                if (target.matches('.sidebar-tab')) {
                    const tabsContainer = document.getElementById('tabs-container');
                    const tabPanelsContainer = document.getElementById('tab-panels');
                    const currentActiveTab = tabsContainer.querySelector('.active');
                    const currentActivePanel = tabPanelsContainer.querySelector('.active');
                    
                    if(currentActiveTab) currentActiveTab.classList.remove('active');
                    if(currentActivePanel) currentActivePanel.classList.remove('active');
                    
                    target.classList.add('active');
                    const targetPanelId = target.dataset.tabTarget;
                    const targetPanel = document.querySelector(targetPanelId);
                    if(targetPanel) targetPanel.classList.add('active');
                }
            });
        
            container.addEventListener('input', (event) => {
                const form = event.target.closest('#persona-folio-form');
                if (form) {
                    if (event.target.matches('#char-name')) {
                        const headerSpan = document.getElementById('actor-display-header');
                        if (headerSpan) {
                            headerSpan.textContent = event.target.value.toUpperCase() || 'UNNAMED';
                        }
                    }

                    if (event.target.matches('.skill-rank') || event.target.closest('.single-column-grid')) {
                        recalculateAllModifiers();
                    } else if (event.target.matches('.attribute-value')) {
                        const attributeId = event.target.id;
                        const primaryValue = parseInt(event.target.value) || 0;
                        const subAttributeId = primaryToSubAttributeMap[attributeId];
                        if (subAttributeId) {
                            const subValueInput = document.getElementById(subAttributeId);
                            if (subValueInput) {
                                subValueInput.value = (primaryValue * 2) + 2;
                                calculateAttributeTotal(subAttributeId);
                            }
                        }
                        calculateAttributeTotal(attributeId);
                        calculateCharacterPoints();
                    }
                    saveToSession();
                }
            });

            container.addEventListener('change', (event) => {
                const form = event.target.closest('#persona-folio-form');
                 if (form) {
                    if (event.target.matches('#char-occu, #char-species, #char-origin, #char-faction, .skill-base-select')) {
                        recalculateAllModifiers();
                    }
                     if (event.target.matches('[data-browse-path]')) {
                        updateAllTraits();
                    }
                    saveToSession();
                }
            });
        }


        function renderPersonaFolioView(container, folioData = {}, useSession = true) {
            const sessionData = useSession ? loadFromSession() : null;
            const finalData = sessionData || folioData;

            container.innerHTML = `
                    <div id="app-sidebar">
                        <div class="header-title-container">
                            <h1 class="tangent-title">Tangent SFF RPG</h1>
                            <p class="tangent-subtitle">Persona Folio</p>
                            <h2 class="character-name-header" id="actor-display-header">${finalData['char-name'] ? finalData['char-name'].toUpperCase() : 'UNNAMED'}</h2>
                        </div>
                        <div id="tabs-container">
                            <button class="sidebar-tab active" data-tab-target="#identity-tab">Identity</button>
                            <button class="sidebar-tab" data-tab-target="#core-stats-tab">Core Stats</button>
                            <button class="sidebar-tab" data-tab-target="#skills-tab">Skills</button>
                            <button class="sidebar-tab" data-tab-target="#abilities-tab">Abilities</button>
                            <button class="sidebar-tab" data-tab-target="#combat-gear-tab">Combat & Gear</button>
                            <button class="sidebar-tab" data-tab-target="#other-tab">Other</button>
                        </div>
                    </div>
                    <div id="main-content">
                        <header class="folio-header">
                            <div class="folio-header-left">
                            </div>
                            <div class="folio-header-center">
                                <button type="button" id="economy-btn" class="action-btn">
                                    Spent CP: <span id="header-spent-cp">0</span>
                                </button>
                            </div>
                            <div class="folio-header-right">
                                <div class="file-menu">
                                    <button type="button" class="file-menu-button action-btn">DATA</button>
                                    <div class="file-menu-dropdown glass-panel">
                                        <button type="button" id="new-char-btn">New</button>
                                        <hr class="menu-divider">
                                        <button type="button" id="preview-btn">Preview</button>
                                        <hr class="menu-divider">
                                        <button type="button" id="cloud-save-btn">Save to Cloud</button>
                                        <button type="button" id="cloud-load-btn">Load from Cloud</button>
                                        <hr class="menu-divider">
                                        <button type="button" id="local-save-btn">Save to File</button>
                                        <button type="button" id="local-load-btn">Load from File</button>
                                    </div>
                                </div>
                                <div id="auth-container"></div>
                            </div>
                        </header>
                        <form id="persona-folio-form" onsubmit="return false;" class="glass-panel folio-form">
                            <input type="hidden" id="character-doc-id" name="character-doc-id" value="${finalData['character-doc-id'] || ''}">
                            <div id="tab-panels">
                            <div id="identity-tab" class="tab-panel active">
                                <section id="bio-section" class="columns-2">
                                    <div>
                                        <div class="form-group"><label for="char-name">Name</label><input type="text" id="char-name" name="char-name" class="global-form-input"></div>
                                        <div class="form-group"><label for="char-concept">Concept</label><input type="text" id="char-concept" name="char-concept" class="global-form-input"></div>
                                        <div class="form-group"><label for="char-species">Species</label><input type="text" id="char-species" name="char-species" data-browse-path="species" readonly class="global-form-input browse-input" placeholder="-- SELECT --"></div>
                                        <div class="form-group"><label for="char-occu">Occupation</label><input type="text" id="char-occu" name="char-occu" data-browse-path="occupations" readonly class="global-form-input browse-input" placeholder="-- SELECT --"></div>
                                        <div class="form-group"><label for="char-origin">Origin</label><input type="text" id="char-origin" name="char-origin" data-browse-path="origins" readonly class="global-form-input browse-input" placeholder="-- SELECT --"></div>
                                        <div class="form-group"><label for="char-faction">Faction</label><input type="text" id="char-faction" name="char-faction" data-browse-path="factions" readonly class="global-form-input browse-input" placeholder="-- SELECT --"></div>
                                    </div>
                                    <div>
                                        <div class="form-group"><label for="char-age">Age</label><input type="text" id="char-age" name="char-age" class="global-form-input"></div>
                                        <div class="form-group"><label for="char-gender">Gender</label><input type="text" id="char-gender" name="char-gender" class="global-form-input"></div>
                                        <div class="form-group"><label for="char-height">Height</label><input type="text" id="char-height" name="char-height" class="global-form-input"></div>
                                        <div class="form-group"><label for="char-weight">Weight</label><input type="text" id="char-weight" name="char-weight" class="global-form-input"></div>
                                        <div class="form-group"><label for="char-style">Description / Style</label><textarea id="char-style" name="char-style" rows="2" class="global-form-textarea"></textarea></div>
                                        <div class="form-group"><label for="char-motive">Personality / Motive</label><textarea id="char-motive" name="char-motive" rows="2" class="global-form-textarea"></textarea></div>
                                    </div>
                                </section>
                            </div>
                            <div id="core-stats-tab" class="tab-panel">
                                <section id="attributes-stats-section" class="columns-2">
                                    <div>
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; text-align: center;">
                                            <span style="text-align: left;">Attribute</span>
                                            <span>Value</span>
                                            <span>Mod</span>
                                            <span>Total</span>
                                        </div>
                                        ${[
                                            { name: 'Strength', id: 'attr-strength' }, { name: 'Might', id: 'attr-might', sub: true },
                                            { name: 'Agility', id: 'attr-agility' }, { name: 'Reflex', id: 'attr-reflex', sub: true },
                                            { name: 'Stamina', id: 'attr-stamina' }, { name: 'Fortitude', id: 'attr-fortitude', sub: true },
                                            { name: 'Intellect', id: 'attr-intellect' }, { name: 'Logic', id: 'attr-logic', sub: true },
                                            { name: 'Wisdom', id: 'attr-wisdom' }, { name: 'Will', id: 'attr-will', sub: true },
                                            { name: 'Charisma', id: 'attr-charisma' }, { name: 'Etiquette', id: 'attr-etiquette', sub: true }
                                        ].map(attr => `
                                            <div class="attribute-row ${!attr.sub ? 'primary-attribute' : ''}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 0.5rem; align-items: center; ${!attr.sub ? 'background: rgba(0,0,0,0.2); padding: 0.25rem; border-radius: 4px;' : ''}">
                                                <label for="${attr.id}" style="${attr.sub ? 'font-style: italic; padding-left: 1rem;' : 'font-weight: bold;'}">${attr.name}</label>
                                                <input type="number" id="${attr.id}" name="${attr.id}" class="global-form-input attribute-value" style="text-align: center;" value="0">
                                                <input type="number" id="${attr.id}-mod" name="${attr.id}-mod" class="global-form-input" style="text-align: center;" value="0" readonly>
                                                <input type="number" id="${attr.id}-total" name="${attr.id}-total" class="global-form-input" style="text-align: center; font-weight: bold;" readonly value="0">
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div>
                                        <div class="form-group"><label for="initiative-total">Initiative</label><input type="number" id="initiative-total" name="initiative-total" class="global-form-input" readonly></div>
                                        <div class="row-2-columns" style="margin-bottom: 1rem;">
                                            <div class="form-group"><label for="health">Health</label><input type="number" id="health" name="health" class="global-form-input"></div>
                                            <div class="form-group"><label for="vitality">Vitality</label><input type="number" id="vitality" name="vitality" class="global-form-input"></div>
                                        </div>
                                        <div class="row-2-columns" style="margin-bottom: 1rem;">
                                            <div class="form-group"><label for="karma">Karma</label><input type="number" id="karma" name="karma" class="global-form-input"></div>
                                            <div class="form-group"><label for="plot-points">Plot Points</label><input type="number" id="plot-points" name="plot-points" class="global-form-input"></div>
                                        </div>
                                        <div class="row-2-columns" style="margin-bottom: 1rem;">
                                            <div class="form-group"><label for="tech-level">Tech Level</label><input type="number" id="tech-level" name="tech-level" class="global-form-input"></div>
                                            <div class="form-group"><label for="wealth-rating">Wealth Rating</label><input type="number" id="wealth-rating" name="wealth-rating" class="global-form-input"></div>
                                        </div>

                                        <div class="form-group stat-block">
                                            <label for="perception">Perception</label>
                                            <div class="perception-container">
                                                <input type="number" id="perception" name="perception" readonly class="global-form-input stat-main-value">
                                                <div class="stat-sub-grid">
                                                    <label for="perception-meta">Meta</label>
                                                    <input type="number" id="perception-meta" name="perception-meta" class="global-form-input">
                                                    <label for="perception-social">Social</label>
                                                    <input type="number" id="perception-social" name="perception-social" class="global-form-input">
                                                    <label for="perception-tech">Technology</label>
                                                    <input type="number" id="perception-tech" name="perception-tech" class="global-form-input">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group stat-block">
                                            <label>Move</label>
                                            <div class="stat-sub-grid move-sub-grid">
                                                <label for="move-walk">Walk</label>
                                                <input type="number" id="move-walk" name="move-walk" class="global-form-input">
                                                <label for="move-swim">Swim</label>
                                                <input type="number" id="move-swim" name="move-swim" class="global-form-input">
                                                <label for="move-climb">Climb</label>
                                                <input type="number" id="move-climb" name="move-climb" class="global-form-input">
                                                <label for="move-fly">Fly</label>
                                                <input type="number" id="move-fly" name="move-fly" class="global-form-input">
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                            <div id="skills-tab" class="tab-panel">
                                <section id="skills-section">
                                    <div class="skills-column">
                                        <div id="skills-col-1"></div>
                                        <div id="skills-col-2"></div>
                                    </div>
                                    <button type="button" id="add-skill-btn" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Skill</button>
                                </section>
                            </div>
                             <div id="abilities-tab" class="tab-panel">
                                <section class="columns-3">
                                    <div>
                                        <h4>Features</h4>
                                        <div id="features-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="features" data-browse-path="features" data-filter-category-exclude="Special Ability" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Feature</button>
                                        <input type="hidden" id="features-data" name="features">
                                    </div>
                                    <div>
                                        <h4>Disadvantages</h4>
                                        <div id="disadvantages-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="disadvantages" data-browse-path="disadvantages" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Disadvantage</button>
                                        <input type="hidden" id="disadvantages-data" name="disadvantages">
                                    </div>
                                    <div>
                                        <h4>Augmentations</h4>
                                        <div id="augmentations-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="augmentations" data-browse-path="augmentations" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Augmentation</button>
                                        <input type="hidden" id="augmentations-data" name="augmentations">
                                    </div>
                                    <div>
                                        <h4>Awakened <span id="awakened-counter"></span></h4>
                                        <div id="awakened-display" class="single-column-grid"></div>
                                        <button type="button" id="add-awakened-btn" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Discipline</button>
                                        <input type="hidden" id="awakened-data" name="awakened">
                                    </div>
                                    <div>
                                        <h4>Invocations</h4>
                                        <div id="invocations-display" class="single-column-grid"></div>
                                        <button type="button" id="add-invocation-btn" data-target-list="invocations" data-browse-path="invocations" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Invocation</button>
                                        <input type="hidden" id="invocations-data" name="invocations">
                                    </div>
                                    <div>
                                        <h4>Special Abilities <span id="special-abilities-counter"></span></h4>
                                        <div id="special_abilities-display" class="single-column-grid"></div>
                                        <button type="button" id="add-special-ability-btn" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Special Ability</button>
                                        <input type="hidden" id="special_abilities-data" name="special_abilities">
                                    </div>
                                </section>
                            </div>
                             <div id="combat-gear-tab" class="tab-panel">
                                <h4>COMBAT</h4>
                                <section class="columns-2">
                                     <div>
                                        <h5>Attack</h5>
                                        <div id="attack-rows">
                                            <div class="attack-grid">
                                                <span>Attack</span><span>Score</span><span>Effect</span><span>Notes</span><span></span>
                                            </div>
                                        </div>
                                        <input type="hidden" id="attacks-data" name="attacks">
                                        <button type="button" id="add-attack-btn" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Attack</button>
                                     </div>
                                      <div>
                                        <h5>Defense</h5>
                                        <div id="armor-rows">
                                            <div class="armor-grid">
                                                <span>Defense</span><span>Resistance</span><span>Notes</span><span></span>
                                            </div>
                                        </div>
                                        <input type="hidden" id="armor-data" name="armor">
                                        <button type="button" id="add-armor-btn" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Defense</button>
                                      </div>
                                </section>
                                <hr style="border-color: var(--panel-border); margin: 1rem 0;">
                                <h4>PERSONAL PROPERTY</h4>
                                <section>
                                    <div>
                                        <h5>Gear</h5>
                                        <div id="gear-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="gear" data-browse-path="equipment" data-filter-category="gear" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Gear</button>
                                        <input type="hidden" id="gear-data" name="gear">
                                    </div>
                                    <div>
                                        <h5>Weapons</h5>
                                        <div id="weapons-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="weapons" data-browse-path="equipment" data-filter-category="weaponry" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Weapon</button>
                                        <input type="hidden" id="weapons-data" name="weapons">
                                    </div>
                                    <div>
                                        <h5>Armor</h5>
                                        <div id="armoring-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="armoring" data-browse-path="equipment" data-filter-category="armoring" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Armor</button>
                                        <input type="hidden" id="armoring-data" name="armoring">
                                    </div>
                                    <div>
                                        <h5>Mecha</h5>
                                        <div id="mecha-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="mecha" data-browse-path="equipment" data-filter-category="mecha" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Mecha</button>
                                        <input type="hidden" id="mecha-data" name="mecha">
                                    </div>
                                    <div>
                                        <h5>Other</h5>
                                        <div id="other-display" class="single-column-grid"></div>
                                        <button type="button" data-target-list="other" data-browse-path="equipment" data-filter-category="other" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Other</button>
                                        <input type="hidden" id="other-data" name="other">
                                    </div>
                                </section>
                             </div>
                             <div id="other-tab" class="tab-panel">
                                 <section>
                                     <h4>Notes</h4>
                                     <div id="notes-list" class="single-column-grid"></div>
                                     <input type="hidden" id="notes-data" name="notes">
                                     <button type="button" id="add-note-btn" class="action-btn" style="width: 100%; margin-top: 1rem;">Add Note</button>
                                 </section>
                             </div>
                        </div>
                         <footer class="creator-credit">
                             WOLFE.BT@TANGENTLLC
                         </footer>
                        </form>
                    </div>
`;
            
            updateUIAfterAuthChange();
            initializePersonaFolio(finalData);
        }

        // --- Authentication ---
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
                showCustomAlert("Could not sign in with Google.");
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // *** FIX: Do not modify appInitialized state here.
                // onAuthStateChanged will handle the UI update.
                clearSession();
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }
        
        function updateUIAfterAuthChange() {
            const authContainer = document.getElementById('auth-container');
            if (!authContainer) return;

            authContainer.innerHTML = ''; 
            if (appState.isAnonymous) {
                const loginButton = document.createElement('button');
                loginButton.className = 'action-btn action-btn-small';
                loginButton.textContent = 'LOGIN';
                loginButton.addEventListener('click', handleLogin);
                authContainer.appendChild(loginButton);
            } else {
                const logoutButton = document.createElement('button');
                logoutButton.className = 'action-btn action-btn-small';
                logoutButton.textContent = 'LOGOUT';
                logoutButton.addEventListener('click', handleLogout);
                authContainer.appendChild(logoutButton);
            }
        }

        // *** FIX: Refactored onAuthStateChanged for robust, one-time initialization.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in (either newly or already).
                appState.userId = user.uid;
                appState.isAnonymous = user.isAnonymous;
                
                if (!appState.authReady) {
                    appState.authReady = true;
                    authReadyPromiseResolver();
                }

                if (!appState.appInitialized) {
                    // This block runs ONLY ONCE per page load.
                    appState.appInitialized = true;
                    await cacheAllData();
                    renderPersonaFolioView(document.getElementById('folio-container'), {});
                    setupGlobalEventListeners();
                }
                
                updateUIAfterAuthChange();

            } else {
                // No user is signed in.
                appState.userId = null;
                appState.isAnonymous = true;
                
                if (appState.appInitialized) {
                    // The app was already running, so this is a logout.
                    // Render an empty sheet. The listeners will persist.
                    renderPersonaFolioView(document.getElementById('folio-container'), {});
                } else {
                    // The app has not run yet, so this is the initial state.
                    // Try to sign in anonymously. This will re-trigger onAuthStateChanged.
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        showCustomAlert("Could not connect to the authentication service.");
                    }
                }
            }
        });

        // Setup listeners for modals that are always in the DOM
        document.getElementById('preview-print-btn').addEventListener('click', () => window.print());
        document.addEventListener('click', function(event) {
            if (event.target.matches('.modal-close-trigger')) {
                const modal = event.target.closest('.modal-overlay');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }
        });
        document.getElementById('starting-cp').addEventListener('input', calculateCharacterPoints);

    </script>
</body>
</html>
